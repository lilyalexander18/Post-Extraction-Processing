{smcl}
{com}{sf}{ul off}{txt}
{com}. 
. 
. * ----------------------------
. * load/install packages
. * ----------------------------
. 
. /* 
> If needed, install necessary packages to compile notebook document (e.g., html, docx, pdf)
> these packages include: markdoc, kethcup, weaver, synlight, and statax
> note: if get any error messages, follow on-screen instructions in Stata console to 
> complete correct installation
> 
> * once install following packages once, do not need to re-install; 
> * here, commented out
> */
. *packages for MarkDoc
. *ssc install Markdoc
. *ssc install weaver
. *ssc install synlight
. *ssc install statax
. *markdocpandoc // installs pandoc
. *packages for analysis and presentation of results
. *ssc install estout, replace
. *ssc install outreg
. *ssc install pandoc
. *ssc install coefplot 
. 
. *-----------------------
. *-----------------------
. 
. 
. /* Template: 
> MI 20170122: 
> comments from Stata do-file will not appear in final markdoc.
> The text included in this do-file will only appear if it
> is blocked between a forward slash '/' and 3 asterisks '***', as done below
> immediately before start of latex syntax.
> */
.         
. 
. /***
> 
> \documentclass{c -(}article{c )-}
> 
> \usepackage{c -(}graphicx{c )-}  % this is a package for inserting graphics
> \usepackage{c -(}hyperref{c )-}
> \hypersetup{c -(}
>     colorlinks=true,
>     linkcolor=blue,
>     filecolor=blue,      
>     urlcolor=blue
>         {c )-}
>         
> \usepackage{c -(}geometry{c )-}   % useful package for formatting document
> \geometry{c -(}
>         letterpaper,
>         total={c -(}6.5in, 9in{c )-},
>         left=1in,
>         right=1in,
>         top=1in,
>         bottom=1in
>         {c )-}
> 
> \begin{c -(}document{c )-}
> 
> \title{c -(}Data Validation Exercise before Entry into UCSR{c )-}
> \author{c -(}
>   Lily Alexander
>   {c )-}
> 
>  \date{c -(}
>   \bigskip
>   \today
>   {c )-}
> 
> \maketitle
>         
> \begin{c -(}abstract{c )-}
> \textbf{c -(}Summary{c )-}. This is a document to validate and check variables before they are integrated into the UCSR.
> \end{c -(}abstract{c )-}
> 
> \section{c -(}High-level codebook for all variables{c )-}
> 
> \begin{c -(}verbatim{c )-}
> ***/
. 
. /* ------------------------
> load dataset
> ---------------------------
> */
. 
. /**/ use Retention_clean_wide_file_Mar2018.dta, clear 
{txt}
{com}. 
. 
. /* ------------------------
> codebook generation
> ---------------------------
> */
. /**/ codebook 

{txt}{hline}
{res}disease{right:Disease}
{txt}{hline}

{col 19}type:  string ({res}str3{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"HIV"

{txt}{hline}
{res}collapsed{right:Collapsed}
{txt}{hline}

{col 19}type:  string ({res}str3{txt}), but longest is str2

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"No"

{txt}{hline}
{res}lead_author{right:Lead Author}
{txt}{hline}

{col 19}type:  string ({res}str12{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"Marseille, E"
{col 21}        10{col 33}"Rodrigues, R"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}ref_year{right:Reference Year}
{txt}{hline}

{col 19}type:  numeric ({res}int{txt})

{col 18}range:  [{res}2011{txt},{res}2014{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}2{col 51}{txt}missing .:  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}2011
{col 21}        10{col 33}2014

{txt}{hline}
{res}output_unit2{right:Output unit}
{txt}{hline}

{col 19}type:  string ({res}str29{txt})

{col 10}unique values:  {res}3{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        14{col 33}"cost per person served"
{col 21}        14{col 33}"cost per person-quarter of CM"
{col 21}        10{col 33}"cost per person-year"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}title{right:Title}
{txt}{hline}

{col 19}type:  string ({res}str130{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"Case management to improve adherence
{col 33}for HIV-infected patients receiving
{col 33}antiretroviral therapy in Ethiopia: a
{col 33}micro-costing study"
{col 21}        10{col 33}"Mobile phones to support adherence to
{col 33}antiretroviral therapy: what would it
{col 33}cost the Indian National AIDS Control
{col 33}Program?"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}journal_etc{right:Journal}
{txt}{hline}

{col 19}type:  string ({res}str34{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"Cost Eff Resour Alloc. 2011; 9: 18"
{col 21}        10{col 33}"J Int AIDS Soc. 2014; 17(1): 19036"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}url{right:URL}
{txt}{hline}

{col 19}type:  string ({res}str56{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"<https://www.ncbi.nlm.nih.gov/pmc/artic
{col 33}les/PMC3264532/>."
{col 21}        10{col 33}"<https://www.ncbi.nlm.nih.gov/pmc/artic
{col 33}les/PMC4154142/>."

{txt}{hline}
{res}iso_name{right:Country}
{txt}{hline}

{col 19}type:  string ({res}str8{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"Ethiopia"
{col 21}        10{col 33}"IndiaÂ "

{txt}{hline}
{res}location{right:Location}
{txt}{hline}

{col 19}type:  string ({res}str12{txt})

{col 10}unique values:  {res}15{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 15}examples:  {res}"Axum"
{col 26}"Dessie"
{col 26}"Gondar"
{col 26}"Karnataka"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}no_sites{right:Sites}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}1{txt},{res}2{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}2{col 51}{txt}missing .:  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}1
{col 21}        10{col 33}2

{txt}{hline}
{res}pop_density{right:Urbanicity}
{txt}{hline}

{col 19}type:  string ({res}str5{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         6{col 33}"rural"
{col 21}        32{col 33}"urban"

{txt}{hline}
{res}ownership{right:Ownership}
{txt}{hline}

{col 19}type:  string ({res}str17{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"international NGO"
{col 21}        10{col 33}"mixed"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}platform{right:Platform}
{txt}{hline}

{col 19}type:  string ({res}str15{txt}), but longest is str14

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"Fixed facility"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}facility_cat{right:Platform specificity}
{txt}{hline}

{col 19}type:  string ({res}str68{txt}), but longest is str37

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"Hospital - Tertiary (teaching)"
{col 21}        28{col 33}"Unspecified health care facility type"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}id_class{right:Intervention Category}
{txt}{hline}

{col 19}type:  string ({res}str18{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"Treatment and Care"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}id_int{right:Intervention}
{txt}{hline}

{col 19}type:  string ({res}str23{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"Retention and Adherence"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}int_description_long{right:Intervention Description (Long)}
{txt}{hline}

{col 19}type:  string ({res}str298{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"The case management services consist of
{col 33}adherence counseling and support; health
{col 33}education; peer support; and referral of
{col 33}clients to community-based organizations
{col 33}equipped to address specific barriers to
{col 33}adherence such as malnutrition,
{col 33}substance abuse or material needs for
{col 33}clothin, rent, and food."
{col 21}        10{col 33}"The mHealth intervention deployed in
{col 33}the HIVIND trial had two components; the
{col 33}first was an automated IVR call and the
{col 33}second was a passive, neutral, picture
{col 33}message (SMS). Every patient in the
{col 33}intervention arm of the trial received
{col 33}each component of the mHealth
{col 33}intervention once a week."

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}clinical_monitoring{right:Clinical monitoring}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}demand_generation{right:Demand generation}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}counseling_content{right:Counseling content}
{txt}{hline}

{col 19}type:  string ({res}str52{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"adherence counseling"
{col 21}        28{col 33}"adherence counseling, peer-support;
{col 33}health education"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}staff_type{right:Staff type & number}
{txt}{hline}

{col 19}type:  string ({res}str78{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"Case Manager (NR), Adherence Supporters
{col 33}(NR), Case Management Supervisors (NR)"
{col 21}        10{col 33}"Counselors (NR)"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}supportive_care{right:Supportive care}
{txt}{hline}

{col 19}type:  string ({res}str67{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"nutrition support; substance abuse;
{col 33}material needs (clothing, rent)"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}visits{right:Visit type & number}
{txt}{hline}

{col 19}type:  string ({res}str24{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"monthly follow-up visits"
{col 21}        28{col 33}"visits (NR)"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}referrals{right:Referrals}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}method{right:Method}
{txt}{hline}

{col 19}type:  string ({res}str1{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}id_tech{right:Technology}
{txt}{hline}

{col 19}type:  string ({res}str39{txt})

{col 10}unique values:  {res}4{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"."
{col 21}         3{col 33}"SMS reminders"
{col 21}         4{col 33}"SMS+IVR"
{col 21}         3{col 33}"interactive voice response (IVR)
{col 33}system"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}treatment_phase{right:Treatment phase}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}arv_regimen{right:ARV Regimen}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}treatment{right:Treatment}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}screening_diagnoses{right:Screening and diagnosis}
{txt}{hline}

{col 19}type:  string ({res}str3{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}community_awareness{right:Community awareness}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}health_system{right:Health system}
{txt}{hline}

{col 19}type:  string ({res}str39{txt})

{col 10}unique values:  {res}4{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"."
{col 21}         3{col 33}"SMS reminders"
{col 21}         4{col 33}"SMS+IVR"
{col 21}         3{col 33}"interactive voice response (IVR)
{col 33}system"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}id_activities{right:Costed activities}
{txt}{hline}

{col 19}type:  string ({res}str63{txt})

{col 10}unique values:  {res}4{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         3{col 33}"adherence counseling, IVR"
{col 21}         3{col 33}"adherence counseling, SMS"
{col 21}         4{col 33}"adherence counseling, SMS+IVR"
{col 21}        28{col 33}"adherence counseling; health education;
{col 33}peer support; referrals"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}start_month{right:Start Month}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}10{txt},{res}10{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}10{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}10
{col 21}        10{col 33}.

{txt}{hline}
{res}start_year{right:Start Year}
{txt}{hline}

{col 19}type:  numeric ({res}int{txt})

{col 18}range:  [{res}2008{txt},{res}2008{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}10{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}2008
{col 21}        10{col 33}.

{txt}{hline}
{res}end_month{right:End Month}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}9{txt},{res}9{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}10{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}9
{col 21}        10{col 33}.

{txt}{hline}
{res}end_year{right:End Year}
{txt}{hline}

{col 19}type:  numeric ({res}int{txt})

{col 18}range:  [{res}2009{txt},{res}2009{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}10{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}2009
{col 21}        10{col 33}.

{txt}{hline}
{res}period_portrayed{right:Total Months}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}12{txt},{res}12{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}12

{txt}{hline}
{res}year_intro{right:Year introduced at study site}
{txt}{hline}

{col 19}type:  numeric ({res}int{txt})

{col 18}range:  [{res}2006{txt},{res}2006{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}10{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}2006
{col 21}        10{col 33}.

{txt}{hline}
{res}coverage{right:Coverage}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}id_pop_dem_std{right:Target group (demographic)}
{txt}{hline}

{col 19}type:  string ({res}str18{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"General Population"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}id_pop_clin_std{right:Target group (clinical)}
{txt}{hline}

{col 19}type:  string ({res}str12{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"HIV positive"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}pop_age{right:Average Age}
{txt}{hline}

{col 19}type:  string ({res}str30{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"85% aged 20-45; 15% aged 46-65"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}pop_sex{right:Gender}
{txt}{hline}

{col 19}type:  string ({res}str11{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"58% females"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}pop_ses{right:SES}
{txt}{hline}

{col 19}type:  string ({res}str14{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"75% unemployed"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}pop_education{right:Education}
{txt}{hline}

{col 19}type:  string ({res}str14{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"37% illiterate"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}hiv_prev{right:HIV Prevalence}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}tb_prev{right:TB Prevalence}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}tb_rx_resistance{right:TB Drug Resistance}
{txt}{hline}

{col 19}type:  string ({res}str1{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}costing_purpose{right:Costing Purpose}
{txt}{hline}

{col 19}type:  string ({res}str213{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"To estimate unit costs of case
{col 33}management services for ART patients in
{col 33}three provinces in Ethiopia, document
{col 33}the variation in costs, and explore
{col 33}opportunities for greater efficiency in
{col 33}the provision of CM services"
{col 21}        10{col 33}"To study the costs of mobile phone
{col 33}reminder strategies (mHealth
{col 33}interventions) to support adherence in
{col 33}the context of India's National AIDS
{col 33}Control Program (NACP)."

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}timing{right:Timing}
{txt}{hline}

{col 19}type:  string ({res}str15{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"cross-sectional"

{txt}{hline}
{res}country_sampling{right:Country Sampling}
{txt}{hline}

{col 19}type:  string ({res}str3{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}geo_sampling_incountry{right:Geographic Area In Country Sampling}
{txt}{hline}

{col 19}type:  string ({res}str9{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"purposive"

{txt}{hline}
{res}site_sampling{right:Site Sampling}
{txt}{hline}

{col 19}type:  string ({res}str1{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}px_sampling{right:Patient Sampling}
{txt}{hline}

{col 19}type:  string ({res}str14{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"entire program"
{col 21}        10{col 33}"random"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}sample_size_derived{right:Sample size formally derived}
{txt}{hline}

{col 19}type:  string ({res}str3{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"no"
{col 21}        10{col 33}"yes"

{txt}{hline}
{res}controls{right:Controls}
{txt}{hline}

{col 19}type:  string ({res}str3{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"no"
{col 21}        10{col 33}"yes"

{txt}{hline}
{res}econ_perspective_actual{right:Perspective}
{txt}{hline}

{col 19}type:  string ({res}str8{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"provider"

{txt}{hline}
{res}econ_costing{right:Economic / Financial}
{txt}{hline}

{col 19}type:  string ({res}str14{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"economic"
{col 21}        10{col 33}"financial only"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}real_world{right:Real World / Per Protocol}
{txt}{hline}

{col 19}type:  string ({res}str12{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"per protocol"
{col 21}        28{col 33}"real world"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}asd_costs{right:Above Service Costs Included}
{txt}{hline}

{col 19}type:  string ({res}str19{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"some costs included"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}list_asd_costs{right:Above Service Cost List}
{txt}{hline}

{col 19}type:  string ({res}str177{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"development of intervention and web
{col 33}interface, recording intervention
{col 33}messages in different languages,
{col 33}equipment (laptop), hardware
{col 33}maintenance, program officer salary,
{col 33}overhead"
{col 21}        28{col 33}"overhead & administrative costs  at
{col 33}headquarters"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}omitted_costs{right:Omitted Costs}
{txt}{hline}

{col 19}type:  string ({res}str29{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"Patient costs"
{col 21}        10{col 33}"Patient costs, Buliding/space"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}sensitivity_analysis{right:Sensitivity Analysis}
{txt}{hline}

{col 19}type:  string ({res}str7{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"limited"
{col 21}        28{col 33}"none"

{txt}{hline}
{res}scale{right:Economies of scale}
{txt}{hline}

{col 19}type:  string ({res}str8{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"analyzed"
{col 21}        10{col 33}"ignored"

{txt}{hline}
{res}research_costs{right:Research Costs Included}
{txt}{hline}

{col 19}type:  string ({res}str8{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"excluded"

{txt}{hline}
{res}unrelated_costs{right:Unrelated Costs Included}
{txt}{hline}

{col 19}type:  string ({res}str2{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"no"

{txt}{hline}
{res}overhead{right:Overhead Costs Included}
{txt}{hline}

{col 19}type:  string ({res}str3{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"yes"

{txt}{hline}
{res}overhead_costs{right:Overhead Costs List}
{txt}{hline}

{col 19}type:  string ({res}str108{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"equipment (laptop, phone) for
{col 33}demonstration, management personnel, "
{col 21}        28{col 33}"management personnel, curriculum
{col 33}development, office rental, travel
{col 33}costs, telecommunications, IT,
{col 33}utilities"

{txt}{col 16}warning:  variable has embedded and trailing blanks

{txt}{hline}
{res}pot_distortions{right:Potential distortions}
{txt}{hline}

{col 19}type:  string ({res}str4{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"."
{col 21}        28{col 33}"none"

{txt}{hline}
{res}volunteer_time{right:Valuing Volunteer Time}
{txt}{hline}

{col 19}type:  string ({res}str3{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}family_time{right:Valuing Family Time}
{txt}{hline}

{col 19}type:  string ({res}str3{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}px_costs_measured{right:Patient-Incurred Costs Measured}
{txt}{hline}

{col 19}type:  string ({res}str12{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"not included"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}cat_cost{right:Catastrophic Cost Calculated}
{txt}{hline}

{col 19}type:  string ({res}str4{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"none"

{txt}{hline}
{res}currency_yr{right:Reported Currency Year}
{txt}{hline}

{col 19}type:  numeric ({res}int{txt})

{col 18}range:  [{res}2009{txt},{res}2013{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}2{col 51}{txt}missing .:  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}2009
{col 21}        10{col 33}2013

{txt}{hline}
{res}iso_code{right:Reported Currency}
{txt}{hline}

{col 19}type:  string ({res}str3{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        10{col 33}"INR"
{col 21}        28{col 33}"USD"

{txt}{hline}
{res}currency_iso{right:Currency of Data Collection}
{txt}{hline}

{col 19}type:  string ({res}str3{txt})

{col 10}unique values:  {res}2{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}"ETB"
{col 21}        10{col 33}"INR"

{txt}{hline}
{res}currency_x{right:Currency Exchange Method}
{txt}{hline}

{col 19}type:  string ({res}str11{txt})

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"market only"

{txt}{col 16}warning:  variable has embedded blanks

{txt}{hline}
{res}current_x_rate{right:Currency Exchange Rate}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}11.2{txt},{res}61.95{txt}]{col 55}units:  {res}.01
{col 10}{txt}unique values:  {res}2{col 51}{txt}missing .:  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        28{col 33}11.2
{col 21}        10{col 33}61.95

{txt}{hline}
{res}discount_rate{right:Discount Rate}
{txt}{hline}

{col 19}type:  numeric ({res}byte{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}inflation{right:Inflation rate}
{txt}{hline}

{col 19}type:  string ({res}str2{txt}), but longest is str1

{col 10}unique values:  {res}1{col 51}{txt}missing "":  {res}0{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}"."

{txt}{hline}
{res}mean_cost{right:Mean Unit Cost}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}11.1416{txt},{res}1537.0665{txt}]{col 55}units:  {res}1.000e-08
{col 10}{txt}unique values:  {res}36{col 51}{txt}missing .:  {res}0{txt}/{res}38

{txt}{col 19}mean:{res}{col 26} 175.994
{txt}{col 15}std. dev:{res}{col 26} 396.569

{txt}{col 12}percentiles:{col 32}10%{col 42}25%{col 52}50%{col 62}75%{col 72}90%
{res}{col 27} 20.0549{col 37} 28.9682{col 47} 57.3792{col 57} 100.523{col 67} 160.439

{txt}{hline}
{res}si_personnel{right:Personnel (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}355193.53{txt},{res}355193.53{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}355193.53
{col 21}        34{col 33}.

{txt}{hline}
{res}si_per_service_delivery{right:Personnel: Direct Service Delivery (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}39.600498{txt},{res}39.600498{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}39.600498
{col 21}        34{col 33}.

{txt}{hline}
{res}si_per_support{right:Personnel: Support (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}355153.93{txt},{res}355153.93{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}355153.93
{col 21}        34{col 33}.

{txt}{hline}
{res}si_per_mixed_unspec{right:Personnel: Mixed Unspecified (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}si_recurrent{right:Recurrent Goods (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}60599.6{txt},{res}60680.885{txt}]{col 55}units:  {res}.001
{col 10}{txt}unique values:  {res}3{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         1{col 33}60599.6
{col 21}         1{col 33}60670.047
{col 21}         2{col 33}60680.885
{col 21}        34{col 33}.

{txt}{hline}
{res}si_rec_key_drugs{right:Recurring: Supplies (key drugs) (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{p 0 39}{res}si_rec_med_int_supplies{space 16}Recurring: Medical Supplies (excluding drugs) (SI){p_end}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}10.838031{txt},{res}92.123263{txt}]{col 55}units:  {res}1.000e-06
{col 10}{txt}unique values:  {res}3{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         1{col 33}10.838031
{col 21}         1{col 33}81.285233
{col 21}         2{col 33}92.123263
{col 21}        34{col 33}.

{txt}{hline}
{res}si_rec_nonmed_int_supplies{right:Recurring: Non-medical Supplies (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}si_rec_building_space{right:Recurring: Building Space (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}si_rec_other{right:Recurring: Other (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}60588.762{txt},{res}60588.762{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}60588.762
{col 21}        34{col 33}.

{txt}{hline}
{res}si_capital{right:Capital (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}28345.617{txt},{res}28345.617{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}28345.617
{col 21}        34{col 33}.

{txt}{hline}
{res}si_cap_medical_equip{right:Capital: Equipment (medical) (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}11671.725{txt},{res}11671.725{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}11671.725
{col 21}        34{col 33}.

{txt}{hline}
{res}si_cap_equip_non_medical_inter{right:Capital: Equipment (non-medical) (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}16673.893{txt},{res}16673.893{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}16673.893
{col 21}        34{col 33}.

{txt}{hline}
{res}si_cap_build{right:Capital: Building/space (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}si_cap_vehic{right:Capital: Vehicles (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}si_cap_other{right:Capital: Other (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}si_mixed{right:Mixed (SI)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_primary_sd{right:Primary Service Delivery (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}39.6005{txt},{res}131.72376{txt}]{col 55}units:  {res}.00001
{col 10}{txt}unique values:  {res}3{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         1{col 33}39.600498
{col 21}         1{col 33}120.88573
{col 21}         2{col 33}131.72376
{col 21}        34{col 33}.

{txt}{hline}
{res}a_prisd_rc_counseling{right:Primary SD: R&C Counseling (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}39.600498{txt},{res}39.600498{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}39.600498
{col 21}        34{col 33}.

{txt}{hline}
{res}a_prisd_unspecified{right:Primary SD: Unspecified (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}81.28523{txt},{res}92.12326{txt}]{col 55}units:  {res}.00001
{col 10}{txt}unique values:  {res}2{col 51}{txt}missing .:  {res}35{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         1{col 33}81.285233
{col 21}         2{col 33}92.123263
{col 21}        35{col 33}.

{txt}{hline}
{res}a_secondary_sd{right:Secondary Service Delivery (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_ancillary{right:Ancillary (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_anc_demand_generation{right:Ancillary: Demand Generation (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_anc_lab_services{right:Ancillary: Lab Services (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_anc_adhreten{right:Ancillary: Adherence/Retention (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_anc_unspecified{right:Ancillary: Unspecified (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_operational{right:Operational (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}444088.31{txt},{res}444099.15{txt}]{col 55}units:  {res}.01
{col 10}{txt}unique values:  {res}2{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         3{col 33}444088.31
{col 21}         1{col 33}444099.15
{col 21}        34{col 33}.

{txt}{hline}
{res}a_ope_bldg_equip{right:Operational: Buildings and Equipment (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}18132.858{txt},{res}18132.858{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}18132.858
{col 21}        34{col 33}.

{txt}{hline}
{res}a_ope_logistics{right:Operational: Logistics (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_ope_program_mgmt{right:Operational: Program Management (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}322639.84{txt},{res}322639.84{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}322639.84
{col 21}        34{col 33}.

{txt}{hline}
{res}a_ope_supervision{right:Operational: Supervision (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}32514.092{txt},{res}32514.092{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}32514.092
{col 21}        34{col 33}.

{txt}{hline}
{res}a_ope_training{right:Operational: Training (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_ope_transportation{right:Operational: Transportation (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_ope_massed{right:Operational: Mass Education (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_ope_hmis{right:Operational: HMIS and Record-Keeping (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.

{txt}{hline}
{res}a_ope_technology_development{right:Operational: Technology development (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}11671.725{txt},{res}11671.725{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}11671.725
{col 21}        34{col 33}.

{txt}{hline}
{res}a_ope_unspecified{right:Operational: Unspecified (A)}
{txt}{hline}

{col 19}type:  numeric ({res}double{txt})

{col 18}range:  [{res}40371.666{txt},{res}40371.666{txt}]{col 55}units:  {res}1
{col 10}{txt}unique values:  {res}1{col 51}{txt}missing .:  {res}34{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}         4{col 33}40371.666
{col 21}        34{col 33}.

{txt}{hline}
{res}a_mixed{right:Mixed (A)}
{txt}{hline}

{col 19}type:  numeric ({res}float{txt})

{col 18}range:  [{res}.{txt},{res}.{txt}]{col 55}units:  {res}.
{col 10}{txt}unique values:  {res}0{col 51}{txt}missing .:  {res}38{txt}/{res}38

{txt}{col 13}tabulation:  Freq.  Value
{col 21}{res}        38{col 33}.
{txt}
{com}. /*
> 
> \end{c -(}verbatim{c )-}
> 
> 
> 
> \begin{c -(}verbatim{c )-}
> ***/
. 
. * can generate clean tables
. 
. /**/ quietly cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/Retention_and_adherence/checks"
{txt}
{com}. /**/ quietly eststo sumstats: quietly estpost summarize
{txt}
{com}. 
. /**/ quietly esttab sumstats using sumstats, ///
>         cells("count mean sd min max") ///
>         title("Summary Statistics") tex  replace
{txt}
{com}. * note: do not use 'fragment' with esttab; doing so removes centering and 
. * tabular syntax
. 
. 
. * go back to main dir
. /**/ quietly cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/Retention_and_adherence/checks"
{txt}
{com}. 
. 
. /***
> \end{c -(}verbatim{c )-}
> 
> Here we import the table of summary statistics.\\
> 
> \input{c -(}./checks/sumstats{c )-} 
> 
> Now lets generate and add a figure that visualizing one of these variables.\\
> 
> ----------------------
> export final tex document
> -----------------------------
> */
. 
. /* Exporting in several formats */
. *markdoc example1, replace              /* exporting a markdown file */
. *markdoc example1, replace export(html) 
. *markdoc example1, replace export(odt) 
. *markdoc example1, replace export(txt) 
. *markdoc example1, replace export(epub) 
. *markdoc mytemplatelatex, replace author() affiliation() export(docx) 
. /* could add date option (no parentheses) */
. *markdoc mytemplatelatex, replace author() affiliation() export(pdf)
. 
. * markdoc mytemplatelatex, replace author() affiliation() export(docx) markup()
. * markdoc mytemplatelatex, replace author() affiliation() export(html) markup()
. markdoc data_check, replace author() affiliation() export(tex) markup()
{txt}
{p}(MarkDoc created {bf:{browse "data_check.tex"}})


{com}. 
. /*
> can also produce pdf slides:
> markdoc example1, replace author(Matthew C. Ingram) affiliation(University at Albany, SUNY) date export(slide)
> NOTE: this will replace any existing pdf file with same name, so be cautious
> */
. 
. * end
. 
. 
{txt}end of do-file

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "C:/Users/Lily/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{err}file C:/Users/Lily/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/OBSTET.csv not found
{txt}{search r(601), local:r(601);}

end of do-file

{search r(601), local:r(601);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{err}file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/SAEH_BD2014/EGRESOS/Base de Datos/OBSTET.csv not found
{txt}{search r(601), local:r(601);}

end of do-file

{search r(601), local:r(601);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}.         tempfile afec
{txt}
{com}.         save `afec', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 saved

{com}.         
.         // Bring in egresos section 
.         import delimited using "`data'/EGRESO.csv", clear 
{res}{text}(45 vars, 2,959,197 obs)

{com}.         merge 1:1 id using `obstet', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,676,504
{txt}{col 9}from master{col 30}{res}       1,676,504{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,282,693{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `productos', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,819,777
{txt}{col 9}from master{col 30}{res}       1,819,777{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,139,420{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `defunc', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       2,894,274
{txt}{col 9}from master{col 30}{res}       2,894,274{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}          64,923{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `proced', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}         358,224
{txt}{col 9}from master{col 30}{res}         358,224{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       2,600,973{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `afec', nogen
{res}{err}{p 0 4 2}
variable{err} id
does not uniquely identify observations in the
using data
{p_end}
{txt}{search r(459), local:r(459);}

end of do-file

{search r(459), local:r(459);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
{err}values of variable {bf:numafec} not unique within {bf:id}
{p 4 4 2}
Your data are currently long.
You are performing a {bf:reshape wide}.
You specified {bf:i(id)} and
{bf:j(numafec)}.
There are observations within
{bf:i(id)} with the same value of
{bf:j(numafec)}.  In the long data,
variables {bf:i()} and {bf:j()} together
must uniquely identify the observations.

{col 9} {it:long}                                {it:wide}
{col 9}{c TLC}{hline 15}{c TRC}                   {c TLC}{hline 18}{c TRC}
{col 9}{c |} {it:i   j}   a   b {c |}                   {c |} {it:i}   a1 a2  b1 b2 {c |}
{col 9}{c |}{hline 15}{c |} <--- {bf:reshape} ---> {c |}{hline 18}{c |}
{col 9}{c |} 1   1   1   2 {c |}                   {c |} 1   1   3   2  4 {c |}
{col 9}{c |} 1   2   3   4 {c |}                   {c |} 2   5   7   6  8 {c |}
{col 9}{c |} 2   1   5   6 {c |}                   {c BLC}{hline 18}{c BRC}
{col 9}{c |} 2   2   7   8 {c |}
{col 9}{c BLC}{hline 15}{c BRC}
{p 4 4 2}
Type {bf:reshape error} for a list
of the problem variables.
{p_end}
{txt}{search r(9), local:r(9);}

end of do-file

{search r(9), local:r(9);}

{com}. duplicates tag id numafec, gen(dup)

{p 0 4}{txt}Duplicates in terms of {res} id numafec{p_end}

{com}. tab dup 

        {txt}dup {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}  2,766,204       99.96       99.96
{txt}          1 {c |}{res}      1,240        0.04      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,767,444      100.00

{com}. br if dup != 0 

. sort id numafec 

. br if dup != 0 

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         duplicates drop id numafec afec
{err}force option required with {cmd}duplicates drop {it}varlist{rm}
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         duplicates drop id numafec afec, force

{p 0 4}{txt}Duplicates in terms of {res} id numafec afec{p_end}

{txt}(620 observations deleted)

{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)
{err}variable {bf:dup} not constant within {bf:id}
{p 4 4 2}
Your data are currently long.
You are performing a {bf:reshape wide}.
You typed something like

{p 8 8 2}
{bf:. reshape wide a b, i(id) j(numafec)}

{p 4 4 2}
There are variables other than {bf:a},
{bf:b}, {bf:id}, {bf:numafec} in your data.
They must be constant within
{bf:id} because that is the only way they can
fit into wide data without loss of information.

{p 4 4 2}
The variable or variables listed above are
not constant within {bf:id}.
Perhaps the values are in error.
Type {bf:reshape error} for a list of the
problem observations.

{p 4 4 2}
Either that, or the values vary because
they should vary, in which
case you must either add the variables
to the list of xij variables to be reshaped,
or {bf:drop} them.
{p_end}
{txt}{search r(9), local:r(9);}

end of do-file

{search r(9), local:r(9);}

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}.         
.         duplicates drop id numafec afec, force

{p 0 4}{txt}Duplicates in terms of {res} id numafec afec{p_end}

{txt}(620 observations deleted)

{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 2.8e+06   {txt}->{res} 1.9e+06
{txt}Number of variables            {res}       3   {txt}->{res}      16
{txt}j variable (15 values)          {res}numafec   {txt}->   (dropped)
xij variables:
                                   {res}afec   {txt}->   {res}afec1 afec2 ... afec15
{txt}{hline 77}

{com}. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}.         
.         duplicates drop id numafec afec, force

{p 0 4}{txt}Duplicates in terms of {res} id numafec afec{p_end}

{txt}(620 observations deleted)

{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 2.8e+06   {txt}->{res} 1.9e+06
{txt}Number of variables            {res}       3   {txt}->{res}      16
{txt}j variable (15 values)          {res}numafec   {txt}->   (dropped)
xij variables:
                                   {res}afec   {txt}->   {res}afec1 afec2 ... afec15
{txt}{hline 77}

{com}.         tempfile afec
{txt}
{com}.         save `afec', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 saved

{com}.         
.         // Bring in egresos section 
.         import delimited using "`data'/EGRESO.csv", clear 
{res}{text}(45 vars, 2,959,197 obs)

{com}.         merge 1:1 id using `obstet', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,676,504
{txt}{col 9}from master{col 30}{res}       1,676,504{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,282,693{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `productos', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,819,777
{txt}{col 9}from master{col 30}{res}       1,819,777{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,139,420{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `defunc', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       2,894,274
{txt}{col 9}from master{col 30}{res}       2,894,274{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}          64,923{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `proced', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}         358,224
{txt}{col 9}from master{col 30}{res}         358,224{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       2,600,973{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `afec', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,077,091
{txt}{col 9}from master{col 30}{res}       1,077,091{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,882,106{txt}  
{col 5}{hline 41}

{com}.         
.         
.         
.         
.         
.         
.         
.         
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 rename egreso egreso_string
{res}{txt}
{com}.                 gen egreso_string2 = substr(egreso_string,1,10)
{txt}
{com}.                 replace egreso_string2 = subinstr(egreso_string2," ","",.)
{txt}(0 real changes made)

{com}.                 gen long egreso = date(egreso_string2,"MDY")
{txt}(2,959,197 missing values generated)

{com}.                 replace egreso_string2 = substr(egreso_string2,1,8) if egreso==. 
{txt}(2,959,197 real changes made)

{com}.                 drop egreso
{txt}
{com}.                 gen long egreso = date(egreso_string2,"MDY")
{txt}(2,959,197 missing values generated)

{com}.                 //mdesc egreso
.                 format egreso %td       
{txt}
{com}.                 
. 
{txt}end of do-file

{com}. br egreso

. tab egreso
{txt}no observations

{com}. drop egreso

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 rename egreso egreso_string
{res}{bf}{err}egreso{sf} ambiguous abbreviation
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. br egreso*

. drop egreso_string

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 rename egreso egreso_string
{res}{txt}
{com}.                 gen egreso_string2 = substr(egreso_string,1,10)
{txt}
{com}. 
{txt}end of do-file

{com}. br egreso_string*

. drop egreso_string*

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 rename egreso egreso_string
{res}{err}variable {bf}egreso{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. br egreso
{err}variable {bf}egreso{sf} not found
{txt}{search r(111), local:r(111);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}.         
.         duplicates drop id numafec afec, force

{p 0 4}{txt}Duplicates in terms of {res} id numafec afec{p_end}

{txt}(620 observations deleted)

{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 2.8e+06   {txt}->{res} 1.9e+06
{txt}Number of variables            {res}       3   {txt}->{res}      16
{txt}j variable (15 values)          {res}numafec   {txt}->   (dropped)
xij variables:
                                   {res}afec   {txt}->   {res}afec1 afec2 ... afec15
{txt}{hline 77}

{com}.         
.         tempfile afec
{txt}
{com}.         save `afec', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 saved

{com}.         
.         // Bring in egresos section 
.         import delimited using "`data'/EGRESO.csv", clear 
{res}{text}(45 vars, 2,959,197 obs)

{com}. 
{txt}end of do-file

{com}. br egreso

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 split egreso, p(" ")
{res}variables created as string: 
{txt}{col 1}egreso1{col 10}egreso2

{com}. 
{txt}end of do-file

{com}. br egreso*

. br egreso1

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 gen long egreso = date(egreso1,"MDY")
{err}variable {bf}egreso{sf} already defined
{txt}{search r(110), local:r(110);}

end of do-file

{search r(110), local:r(110);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                 gen long egreso_new = date(egreso1,"MDY")
{txt}(2,959,197 missing values generated)

{com}. 
{txt}end of do-file

{com}. br egreso_new 

. drop egreso_new

. format egreso %td
{err}string %fmt required for string variables
{txt}{search r(120), local:r(120);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}.         
.         duplicates drop id numafec afec, force

{p 0 4}{txt}Duplicates in terms of {res} id numafec afec{p_end}

{txt}(620 observations deleted)

{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 2.8e+06   {txt}->{res} 1.9e+06
{txt}Number of variables            {res}       3   {txt}->{res}      16
{txt}j variable (15 values)          {res}numafec   {txt}->   (dropped)
xij variables:
                                   {res}afec   {txt}->   {res}afec1 afec2 ... afec15
{txt}{hline 77}

{com}.         
.         tempfile afec
{txt}
{com}.         save `afec', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 saved

{com}.         
.         // Bring in egresos section 
.         import delimited using "`data'/EGRESO.csv", clear 
{res}{text}(45 vars, 2,959,197 obs)

{com}.                 
.                 split egreso, p(" ")
{res}variables created as string: 
{txt}{col 1}egreso1{col 10}egreso2

{com}.                 drop egreso egreso2 
{txt}
{com}.                 rename egreso1 egreso 
{res}{txt}
{com}.                 
.         
.         // Merge iwth other datasets 
.         merge 1:1 id using `obstet', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,676,504
{txt}{col 9}from master{col 30}{res}       1,676,504{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,282,693{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `productos', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,819,777
{txt}{col 9}from master{col 30}{res}       1,819,777{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,139,420{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `defunc', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       2,894,274
{txt}{col 9}from master{col 30}{res}       2,894,274{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}          64,923{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `proced', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}         358,224
{txt}{col 9}from master{col 30}{res}         358,224{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       2,600,973{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `afec', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,077,091
{txt}{col 9}from master{col 30}{res}       1,077,091{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,882,106{txt}  
{col 5}{hline 41}

{com}.         
.         
.         
.         
.         
.         
.         
.         
. 
{txt}end of do-file

{com}. br afecprin

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         
. // Save compiled dataset 
.         save "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", replace
{txt}(note: file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta not found)
file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta saved

{com}.         
. 
{txt}end of do-file

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. 
.         gen afec_nos16 = substr(afecprin,1,3)
{txt}
{com}. 
. 
.         gen claswho = .
{txt}(2,959,197 missing values generated)

{com}.         
.                 *Ectopic pregnancy
.                 replace claswho = 1 if afec_nos16 == "O00" | afec_nos16 == "O01" 
{txt}(7,906 real changes made)

{com}.                 
.                 *Miscarriage 
.                 replace claswho = 2 if afec_nos16 == "O02" | afec_nos16 == "O03"
{txt}(37,192 real changes made)

{com}.                 
.                 *Abortion
.                 replace claswho = 3 if afec_nos16 == "O04" | afec_nos16 == "O05" | afec_nos16 == "O06" | afec_nos16 == "O07" | afec_nos16 == "O08" 
{txt}(82,628 real changes made)

{com}.                 replace claswho = 3 if tipaten == 1 & (afec_nos16 != "O00" & afec_nos16 != "O01" & afec_nos16 != "O02" & afec_nos16 != "O03" & afec_nos16 != "O04" & afec_nos16 != "O05" & afec_nos16 != "O06" & afec_nos16 != "O07" & afec_nos16 != "O08" )    
{txt}(2,849 real changes made)

{com}.                 
.                 *Other direct causes
.                 replace claswho = 4 if (afec_nos16 == "F53"|afec_nos16 == "O21"|afec_nos16 == "O26"|afec_nos16 == "O28"|afec_nos16 == "O30"|afec_nos16 == "O31"|afec_nos16 == "O32"|afec_nos16 == "O34"|afec_nos16 == "O35"|afec_nos16 == "O36"|afec_nos16 == "O40"|afec_nos16 == "O41"|afec_nos16 == "O410"|afec_nos16 == "O418"|afec_nos16 == "O419"|afec_nos16 == "O42"|afec_nos16 == "O43 "|afec_nos16 == "O47"|afec_nos16 == "O48"|afec_nos16 == "O60"|afec_nos16 == "O61"|afec_nos16 == "O68"|afec_nos16 == "O69"|afec_nos16 == "O73"|afec_nos16 == "O80"|afec_nos16 == "O81"|afec_nos16 == "O82"|afec_nos16 == "O83"|afec_nos16 == "O84"|afec_nos16 == "O90"|afec_nos16 == "O91"|afec_nos16 == "O92"|afec_nos16 == "Y87"|afecprin== "O717"|afecprin == "O440"|afecprin == "O244") 
{txt}(907,447 real changes made)

{com}.                 
.                 *Complicactions of anethesia
.                 replace claswho = 5 if (afec_nos16 == "O29"|afec_nos16 == "O74"|afec_nos16 == "O89")
{txt}(705 real changes made)

{com}.                 
.                 *Complications - obstetric trauma
.                 replace claswho = 6 if (afec_nos16 == "O71"|afecprin== "O715"|afecprin == "O716"|afecprin == "O718"|afecprin == "O719")
{txt}(1,006 real changes made)

{com}.                 
.                 *Complications -other-not specified
.                 replace claswho = 7 if (afec_nos16 == "O75"|afec_nos16 == "Y60"|afecprin == "O750"|afecprin == "O751"|afecprin == "O752"|afecprin== "O754"|afecprin == "O755"|afecprin == "O756"|afecprin == "O758"|afecprin == "O759")
{txt}(8,059 real changes made)

{com}.                 
.                 *Obstructed labor
.                 replace claswho = 8 if (afec_nos16 == "O33"|afec_nos16 == "O62"|afec_nos16 == "O63"|afec_nos16 == "O64"|afec_nos16 == "O65"|afec_nos16 == "O66")
{txt}(97,812 real changes made)

{com}.                 
.                 *Embolism
.                 replace claswho = 9 if (afec_nos16 == "O22"|afec_nos16 == "O87"|afec_nos16 == "O88")
{txt}(337 real changes made)

{com}.                 
.                 *Antenatal obstetric Haemorrage
.                 replace claswho = 10 if (afec_nos16 == "O44"|afec_nos16 == "O45"|afec_nos16 == "O46"|afecprin== "O710"|afecprin == "O441")
{txt}(5,509 real changes made)

{com}.                 
.                 *Intrapartum obstetric Haemorrage
.                 replace claswho = 11 if (afec_nos16 == "O67"|afec_nos16 == "O70"|afecprin == "O711"|afecprin == "O757")
{txt}(6,545 real changes made)

{com}.                 
.                 *Postpartum obstetric haemorrage
.                 replace claswho = 12 if (afec_nos16 == "O72"|afecprin == "O712")
{txt}(3,756 real changes made)

{com}.                 
.                 *Obstetric haemorrage - other
.                 replace claswho = 13 if (afec_nos16 == "O20"|afec_nos16 == "O713"|afec_nos16 == "O714")
{txt}(15,493 real changes made)

{com}.                 
.                 *Hypertensive disorders
.                 replace claswho = 14 if (afec_nos16 == "O10"|afec_nos16 == "O11"|afec_nos16 == "O12"|afec_nos16 == "O13"|afec_nos16 == "O14"|afec_nos16 == "O15"|afec_nos16 == "O16")
{txt}(56,424 real changes made)

{com}.                 
.                 *Pregnancy related sepsys
.                 replace claswho = 15 if (afec_nos16 == "A34"|afec_nos16 == "O85"|afec_nos16 == "O86"|afecprin == "O411"|afecprin == "O753")
{txt}(2,861 real changes made)

{com}.                 
.                 *Direct causes - other
.                 replace claswho = 16 if (afec_nos16 == "O95")
{txt}(0 real changes made)

{com}.                 
.                 *Indirect causes â medical disorders
.                 replace claswho = 17 if (afec_nos16 == "O99" | afec_nos16 == "O24" & afecprin!="O244") 
{txt}(19,362 real changes made)

{com}.                 
.                 *Indirect causes â HIV related
.                 replace claswho = 18 if (afecprin == "O987")
{txt}(153 real changes made)

{com}.                 
.                 *Indirect causes - other
.                 replace claswho = 19 if (afec_nos16 == "I40"|afec_nos16 == "O23"|afec_nos16 == "O25"|afec_nos16 == "O98"|afecprin == "O980"|afecprin== "O981"|afecprin== "O982"|afecprin== "O983"|afecprin== "O984"|afecprin== "O985"|afecprin== "O986"|afecprin == "O988"|afecprin== "O989")
{txt}(27,097 real changes made)

{com}. 
. 
.         *labels clas_who
.         label define claswhOOO 1 "Ectopic pregnancy" 2 "Miscarriage" 3 "Abortion" 4 "Other direct" 5 "Compl anethesia" 6 "Comp obs trauma" 7 "Comp OthNotSpec" 8 "Obstru labor" 9 "Embolism" 10 "AntenObst Haemor" 11 "IntraparObste Haemor" 12 "PostparObst Haemor" 13 "ObstHaemor Other" 14 "Hypertensive disorders" 15 "PregRelat Sepsys" 16 "DireCaus Other" 17 "IndiCau MedDisorders" 18 "IndiCaus HIV rel" 19 "IndiCaus Other"
{txt}
{com}.         label values claswho claswhOOO
{txt}
{com}.         
.         **
. * ABORTO NOSOTROS por afeccion (sustituye a abort_nos) version LARGO
. **
. *drop aborto_nos
. gen aborto_nos =.
{txt}(2,959,197 missing values generated)

{com}. replace aborto_nos = 0 if afec_nos16 =="O00" 
{txt}(6,726 real changes made)

{com}. replace aborto_nos = 1 if afec_nos16 =="O01" 
{txt}(1,180 real changes made)

{com}. replace aborto_nos = 2 if afec_nos16 =="O02" 
{txt}(23,013 real changes made)

{com}. replace aborto_nos = 3 if afec_nos16 =="O03" 
{txt}(14,179 real changes made)

{com}. replace aborto_nos = 4 if afec_nos16 =="O04" 
{txt}(260 real changes made)

{com}. replace aborto_nos = 5 if afec_nos16 =="O05" 
{txt}(4,107 real changes made)

{com}. replace aborto_nos = 6 if afec_nos16 =="O06" 
{txt}(77,923 real changes made)

{com}. replace aborto_nos = 7 if afec_nos16 =="O07" 
{txt}(22 real changes made)

{com}. replace aborto_nos = 8 if afec_nos16 =="O08"
{txt}(316 real changes made)

{com}. replace aborto_nos = 9 if tipaten ==1 & aborto_nos==.  
{txt}(2,849 real changes made)

{com}. 
. tab aborto_nos

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. label define obortonos16 0"O00 Ectopic" 1 "O01 Molar" 2 "O02 OthrProd" 3 "O03 Spontaneous" 4 "O04 Medical" 5 "O05 OthrAbort" 6 "O06 Unspecified" 7 "O07 FailAttem" 8 "O08 ComplEcMoAbo" 9 "TipAtenAbort" 
{txt}
{com}. label values aborto_nos obortonos16
{txt}
{com}. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. tab aborto_nos year

                 {txt}{c |}    year
      aborto_nos {c |}      2014 {c |}     Total
{hline 17}{c +}{hline 11}{c +}{hline 10}
     O00 Ectopic {c |}{res}     6,562 {txt}{c |}{res}     6,562 
{txt}       O01 Molar {c |}{res}     1,139 {txt}{c |}{res}     1,139 
{txt}    O02 OthrProd {c |}{res}    22,960 {txt}{c |}{res}    22,960 
{txt} O03 Spontaneous {c |}{res}    14,128 {txt}{c |}{res}    14,128 
{txt}     O04 Medical {c |}{res}       249 {txt}{c |}{res}       249 
{txt}   O05 OthrAbort {c |}{res}     4,097 {txt}{c |}{res}     4,097 
{txt} O06 Unspecified {c |}{res}    77,872 {txt}{c |}{res}    77,872 
{txt}   O07 FailAttem {c |}{res}        22 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}       313 {txt}{c |}{res}       313 
{txt}    TipAtenAbort {c |}{res}     2,849 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 11}{c +}{hline 10}
           Total {c |}{res}   130,191 {txt}{c |}{res}   130,191 

{txt}
{com}. 
. * Eliminando duplicados para tipo de atencion aborto
. duplicates drop egreso clues folio if aborto_nos==9, force

{p 0 4}{txt}Duplicates in terms of {res} egreso clues folio{p_end}

{txt}(0 observations are duplicates)

{com}. **SOLO 1 DUPLICADO! EN TEORIA ESTA BIEN, PORQUE YA PEGAMOS SOLO CASOS UNICOS DE TIPO DE ATENCION ABORTO Y NO ABORTO NOSOTROS!!
. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. 
. 
. **
. *OBSTETRICAS NOSOTROS por afeccion (sustituye a obs_nos)
. **
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" POR BLOQUE, version LARGO
. **      
. *drop obste_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obste_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obste_nos16=1 if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obste_nos16=2 if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obste_nos16=3 if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obste_nos16=4 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obste_nos16=5 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obste_nos16=6 if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obste_nos16=7 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obste_nos16=8 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obste_nos16 = 9 if (tipaten==0 & obste_nos16==.)
{txt}(0 real changes made)

{com}.         replace obste_nos16 = 10 if (tipaten==1 & obste_nos16==.)
{txt}(782 real changes made)

{com}.         
. label define obtetcnos16 1"O0-O0Abortive" 2 "O10-O16Edema" 3 "O20-O29RelPreg" 4 "O30-O48Fetus" 5 "O60-O75Labour" 6 "O80-O84Delivery" 7 "O85-O92Puerperium" 8 "O94-O99OthObst" 9 "TipAtenParto" 10 "TipAtenAborto"
{txt}
{com}. label values obste_nos16 obtetcnos16
{txt}
{com}. 
. tab obste_nos16

      {txt}obste_nos16 {c |}      Freq.     Percent        Cum.
{hline 18}{c +}{hline 35}
    O0-O0Abortive {c |}{res}    127,726       10.00       10.00
{txt}     O10-O16Edema {c |}{res}     56,424        4.42       14.42
{txt}   O20-O29RelPreg {c |}{res}     51,573        4.04       18.45
{txt}     O30-O48Fetus {c |}{res}    268,751       21.04       39.49
{txt}    O60-O75Labour {c |}{res}    123,594        9.68       49.17
{txt}  O80-O84Delivery {c |}{res}    623,339       48.80       97.96
{txt}O85-O92Puerperium {c |}{res}      5,945        0.47       98.43
{txt}   O94-O99OthObst {c |}{res}     19,308        1.51       99.94
{txt}    TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 18}{c +}{hline 35}
            Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
. **
. *PARTO NOSOTROS (sustituye a part_nos)
. **
. * CREACION DE VARIABLE "PArto SEGUN NOSOTROS"
. *
. *drop part_nos16
. gen part_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. 
. ***Delivery ICD-10      
. replace part_nos16=0 if afec_nos16=="O80" 
{txt}(562,010 real changes made)

{com}. replace part_nos16=1 if afec_nos16=="O81" 
{txt}(2,041 real changes made)

{com}. replace part_nos16=2 if afec_nos16=="O82" 
{txt}(47,672 real changes made)

{com}. replace part_nos16=3 if afec_nos16=="O83" 
{txt}(10,810 real changes made)

{com}. replace part_nos16=4 if afec_nos16=="O84" 
{txt}(806 real changes made)

{com}. replace part_nos16 = 5 if (tipaten==0 & part_nos16==.)
{txt}(0 real changes made)

{com}. 
. tab part_nos if prueb==0
{err}prueb not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", clear

. 
. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         
.         
. 
. // Initial descriptive analysis of abortions
.         gen abortion=0
{txt}
{com}.         replace abortion = 1 if (substr(afecprin,1,3) =="O02" | | substr(afecprin,1,3) =="O03" | | substr(afecprin,1,3) =="O04" | | substr(afecprin,1,3) =="O05" | | substr(afecprin,1,3) =="O06" | | substr(afecprin,1,3) =="O07" | | substr(afecprin,1,3) =="O08")
{txt}(119,820 real changes made)

{com}. 
.         forvalues i= 1(1)6{c -(}
{txt}  2{com}.                 replace abortion = 1 if (substr(AFEC0`i',1,3) =="O02" | | substr(AFEC0`i',1,3) =="O03" | | substr(AFEC0`i',1,3) =="O04" | | substr(AFEC0`i',1,3) =="O05" | | substr(AFEC0`i',1,3) =="O06" | | substr(AFEC0`i',1,3) =="O07" | | substr(AFEC0`i',1,3) =="O08") & abortion==0
{txt}  3{com}.         {c )-}
{err}AFEC01 not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. br afec*

. br afec*

. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", clear

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. 
. // Initial descriptive analysis of abortions
.         gen abortion=0
{txt}
{com}.         replace abortion = 1 if (substr(afecprin,1,3) =="O02" | | substr(afecprin,1,3) =="O03" | | substr(afecprin,1,3) =="O04" | | substr(afecprin,1,3) =="O05" | | substr(afecprin,1,3) =="O06" | | substr(afecprin,1,3) =="O07" | | substr(afecprin,1,3) =="O08")
{txt}(119,820 real changes made)

{com}.         
.         forvalues i=1(1)15 {c -(} 
{txt}  2{com}.                 rename afec`i' AFEC0`i'
{txt}  3{com}.         {c )-} 
{res}{txt}
{com}.         
.         forvalues i= 1(1)6{c -(}
{txt}  2{com}.                 replace abortion = 1 if (substr(AFEC0`i',1,3) =="O02" | | substr(AFEC0`i',1,3) =="O03" | | substr(AFEC0`i',1,3) =="O04" | | substr(AFEC0`i',1,3) =="O05" | | substr(AFEC0`i',1,3) =="O06" | | substr(AFEC0`i',1,3) =="O07" | | substr(AFEC0`i',1,3) =="O08") & abortion==0
{txt}  3{com}.         {c )-}
{txt}(693 real changes made)
(60 real changes made)
(12 real changes made)
(2 real changes made)
(0 real changes made)
(2 real changes made)

{com}.         
.         // Attention for abortion 
.         gen atten_abortion = 0 
{txt}
{com}.         replace atten_abortion = 1 if tipaten == 1 
{txt}(117,921 real changes made)

{com}.         
.         // Distinguish between abortion types 
.         gen type_abortion = . 
{txt}(2,959,197 missing values generated)

{com}.         replace type_abortion = 1 if abortion == 1 
{txt}(120,589 real changes made)

{com}.         replace type_abortion = 2 if abortion != 1 & atten_abortion == 1 
{txt}(7,646 real changes made)

{com}.         
.         label define type_abortion 1 "O00-O08" 2 "Tipo Att Aborto" 
{txt}
{com}.         label values type_abortion type_abortion
{txt}
{com}.         
. 
{txt}end of do-file

{com}. tab abortion

   {txt}abortion {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}  2,838,608       95.92       95.92
{txt}          1 {c |}{res}    120,589        4.08      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. di 120589/2969197
{res}.04061334

{com}. tab type_abortion

  {txt}type_abortion {c |}      Freq.     Percent        Cum.
{hline 16}{c +}{hline 35}
        O00-O08 {c |}{res}    120,589       94.04       94.04
{txt}Tipo Att Aborto {c |}{res}      7,646        5.96      100.00
{txt}{hline 16}{c +}{hline 35}
          Total {c |}{res}    128,235      100.00

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         duplicates drop clues edad afecprin egreso ingre year id folio, force

{p 0 4}{txt}Duplicates in terms of {res} clues edad afecprin egreso ingre year id folio{p_end}

{txt}(0 observations are duplicates)

{com}. 
{txt}end of do-file

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         gen afec_nos16 = substr(afecprin,1,3)
{txt}
{com}. 
. 
.         gen claswho = .
{txt}(2,959,197 missing values generated)

{com}.         
.                 *Ectopic pregnancy
.                 replace claswho = 1 if afec_nos16 == "O00" | afec_nos16 == "O01" 
{txt}(7,906 real changes made)

{com}.                 
.                 *Miscarriage 
.                 replace claswho = 2 if afec_nos16 == "O02" | afec_nos16 == "O03"
{txt}(37,192 real changes made)

{com}.                 
.                 *Abortion
.                 replace claswho = 3 if afec_nos16 == "O04" | afec_nos16 == "O05" | afec_nos16 == "O06" | afec_nos16 == "O07" | afec_nos16 == "O08" 
{txt}(82,628 real changes made)

{com}.                 replace claswho = 3 if tipaten == 1 & (afec_nos16 != "O00" & afec_nos16 != "O01" & afec_nos16 != "O02" & afec_nos16 != "O03" & afec_nos16 != "O04" & afec_nos16 != "O05" & afec_nos16 != "O06" & afec_nos16 != "O07" & afec_nos16 != "O08" )    
{txt}(2,849 real changes made)

{com}.                 
.                 *Other direct causes
.                 replace claswho = 4 if (afec_nos16 == "F53"|afec_nos16 == "O21"|afec_nos16 == "O26"|afec_nos16 == "O28"|afec_nos16 == "O30"|afec_nos16 == "O31"|afec_nos16 == "O32"|afec_nos16 == "O34"|afec_nos16 == "O35"|afec_nos16 == "O36"|afec_nos16 == "O40"|afec_nos16 == "O41"|afec_nos16 == "O410"|afec_nos16 == "O418"|afec_nos16 == "O419"|afec_nos16 == "O42"|afec_nos16 == "O43 "|afec_nos16 == "O47"|afec_nos16 == "O48"|afec_nos16 == "O60"|afec_nos16 == "O61"|afec_nos16 == "O68"|afec_nos16 == "O69"|afec_nos16 == "O73"|afec_nos16 == "O80"|afec_nos16 == "O81"|afec_nos16 == "O82"|afec_nos16 == "O83"|afec_nos16 == "O84"|afec_nos16 == "O90"|afec_nos16 == "O91"|afec_nos16 == "O92"|afec_nos16 == "Y87"|afecprin== "O717"|afecprin == "O440"|afecprin == "O244") 
{txt}(907,447 real changes made)

{com}.                 
.                 *Complicactions of anethesia
.                 replace claswho = 5 if (afec_nos16 == "O29"|afec_nos16 == "O74"|afec_nos16 == "O89")
{txt}(705 real changes made)

{com}.                 
.                 *Complications - obstetric trauma
.                 replace claswho = 6 if (afec_nos16 == "O71"|afecprin== "O715"|afecprin == "O716"|afecprin == "O718"|afecprin == "O719")
{txt}(1,006 real changes made)

{com}.                 
.                 *Complications -other-not specified
.                 replace claswho = 7 if (afec_nos16 == "O75"|afec_nos16 == "Y60"|afecprin == "O750"|afecprin == "O751"|afecprin == "O752"|afecprin== "O754"|afecprin == "O755"|afecprin == "O756"|afecprin == "O758"|afecprin == "O759")
{txt}(8,059 real changes made)

{com}.                 
.                 *Obstructed labor
.                 replace claswho = 8 if (afec_nos16 == "O33"|afec_nos16 == "O62"|afec_nos16 == "O63"|afec_nos16 == "O64"|afec_nos16 == "O65"|afec_nos16 == "O66")
{txt}(97,812 real changes made)

{com}.                 
.                 *Embolism
.                 replace claswho = 9 if (afec_nos16 == "O22"|afec_nos16 == "O87"|afec_nos16 == "O88")
{txt}(337 real changes made)

{com}.                 
.                 *Antenatal obstetric Haemorrage
.                 replace claswho = 10 if (afec_nos16 == "O44"|afec_nos16 == "O45"|afec_nos16 == "O46"|afecprin== "O710"|afecprin == "O441")
{txt}(5,509 real changes made)

{com}.                 
.                 *Intrapartum obstetric Haemorrage
.                 replace claswho = 11 if (afec_nos16 == "O67"|afec_nos16 == "O70"|afecprin == "O711"|afecprin == "O757")
{txt}(6,545 real changes made)

{com}.                 
.                 *Postpartum obstetric haemorrage
.                 replace claswho = 12 if (afec_nos16 == "O72"|afecprin == "O712")
{txt}(3,756 real changes made)

{com}.                 
.                 *Obstetric haemorrage - other
.                 replace claswho = 13 if (afec_nos16 == "O20"|afec_nos16 == "O713"|afec_nos16 == "O714")
{txt}(15,493 real changes made)

{com}.                 
.                 *Hypertensive disorders
.                 replace claswho = 14 if (afec_nos16 == "O10"|afec_nos16 == "O11"|afec_nos16 == "O12"|afec_nos16 == "O13"|afec_nos16 == "O14"|afec_nos16 == "O15"|afec_nos16 == "O16")
{txt}(56,424 real changes made)

{com}.                 
.                 *Pregnancy related sepsys
.                 replace claswho = 15 if (afec_nos16 == "A34"|afec_nos16 == "O85"|afec_nos16 == "O86"|afecprin == "O411"|afecprin == "O753")
{txt}(2,861 real changes made)

{com}.                 
.                 *Direct causes - other
.                 replace claswho = 16 if (afec_nos16 == "O95")
{txt}(0 real changes made)

{com}.                 
.                 *Indirect causes â medical disorders
.                 replace claswho = 17 if (afec_nos16 == "O99" | afec_nos16 == "O24" & afecprin!="O244") 
{txt}(19,362 real changes made)

{com}.                 
.                 *Indirect causes â HIV related
.                 replace claswho = 18 if (afecprin == "O987")
{txt}(153 real changes made)

{com}.                 
.                 *Indirect causes - other
.                 replace claswho = 19 if (afec_nos16 == "I40"|afec_nos16 == "O23"|afec_nos16 == "O25"|afec_nos16 == "O98"|afecprin == "O980"|afecprin== "O981"|afecprin== "O982"|afecprin== "O983"|afecprin== "O984"|afecprin== "O985"|afecprin== "O986"|afecprin == "O988"|afecprin== "O989")
{txt}(27,097 real changes made)

{com}. 
. 
.         *labels clas_who
.         label define claswhOOO 1 "Ectopic pregnancy" 2 "Miscarriage" 3 "Abortion" 4 "Other direct" 5 "Compl anethesia" 6 "Comp obs trauma" 7 "Comp OthNotSpec" 8 "Obstru labor" 9 "Embolism" 10 "AntenObst Haemor" 11 "IntraparObste Haemor" 12 "PostparObst Haemor" 13 "ObstHaemor Other" 14 "Hypertensive disorders" 15 "PregRelat Sepsys" 16 "DireCaus Other" 17 "IndiCau MedDisorders" 18 "IndiCaus HIV rel" 19 "IndiCaus Other"
{txt}
{com}.         label values claswho claswhOOO
{txt}
{com}.         
.         **
. * ABORTO NOSOTROS por afeccion (sustituye a abort_nos) version LARGO
. **
. *drop aborto_nos
. gen aborto_nos =.
{txt}(2,959,197 missing values generated)

{com}. replace aborto_nos = 0 if afec_nos16 =="O00" 
{txt}(6,726 real changes made)

{com}. replace aborto_nos = 1 if afec_nos16 =="O01" 
{txt}(1,180 real changes made)

{com}. replace aborto_nos = 2 if afec_nos16 =="O02" 
{txt}(23,013 real changes made)

{com}. replace aborto_nos = 3 if afec_nos16 =="O03" 
{txt}(14,179 real changes made)

{com}. replace aborto_nos = 4 if afec_nos16 =="O04" 
{txt}(260 real changes made)

{com}. replace aborto_nos = 5 if afec_nos16 =="O05" 
{txt}(4,107 real changes made)

{com}. replace aborto_nos = 6 if afec_nos16 =="O06" 
{txt}(77,923 real changes made)

{com}. replace aborto_nos = 7 if afec_nos16 =="O07" 
{txt}(22 real changes made)

{com}. replace aborto_nos = 8 if afec_nos16 =="O08"
{txt}(316 real changes made)

{com}. replace aborto_nos = 9 if tipaten ==1 & aborto_nos==.  
{txt}(2,849 real changes made)

{com}. 
. tab aborto_nos

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. label define obortonos16 0"O00 Ectopic" 1 "O01 Molar" 2 "O02 OthrProd" 3 "O03 Spontaneous" 4 "O04 Medical" 5 "O05 OthrAbort" 6 "O06 Unspecified" 7 "O07 FailAttem" 8 "O08 ComplEcMoAbo" 9 "TipAtenAbort" 
{txt}
{com}. label values aborto_nos obortonos16
{txt}
{com}. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. tab aborto_nos year

                 {txt}{c |}    year
      aborto_nos {c |}      2014 {c |}     Total
{hline 17}{c +}{hline 11}{c +}{hline 10}
     O00 Ectopic {c |}{res}     6,562 {txt}{c |}{res}     6,562 
{txt}       O01 Molar {c |}{res}     1,139 {txt}{c |}{res}     1,139 
{txt}    O02 OthrProd {c |}{res}    22,960 {txt}{c |}{res}    22,960 
{txt} O03 Spontaneous {c |}{res}    14,128 {txt}{c |}{res}    14,128 
{txt}     O04 Medical {c |}{res}       249 {txt}{c |}{res}       249 
{txt}   O05 OthrAbort {c |}{res}     4,097 {txt}{c |}{res}     4,097 
{txt} O06 Unspecified {c |}{res}    77,872 {txt}{c |}{res}    77,872 
{txt}   O07 FailAttem {c |}{res}        22 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}       313 {txt}{c |}{res}       313 
{txt}    TipAtenAbort {c |}{res}     2,849 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 11}{c +}{hline 10}
           Total {c |}{res}   130,191 {txt}{c |}{res}   130,191 

{txt}
{com}. 
. * Eliminando duplicados para tipo de atencion aborto
. duplicates drop egreso clues folio if aborto_nos==9, force

{p 0 4}{txt}Duplicates in terms of {res} egreso clues folio{p_end}

{txt}(0 observations are duplicates)

{com}. **SOLO 1 DUPLICADO! EN TEORIA ESTA BIEN, PORQUE YA PEGAMOS SOLO CASOS UNICOS DE TIPO DE ATENCION ABORTO Y NO ABORTO NOSOTROS!!
. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. 
. 
. **
. *OBSTETRICAS NOSOTROS por afeccion (sustituye a obs_nos)
. **
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" POR BLOQUE, version LARGO
. **      
. *drop obste_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obste_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obste_nos16=1 if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obste_nos16=2 if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obste_nos16=3 if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obste_nos16=4 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obste_nos16=5 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obste_nos16=6 if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obste_nos16=7 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obste_nos16=8 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obste_nos16 = 9 if (tipaten==0 & obste_nos16==.)
{txt}(0 real changes made)

{com}.         replace obste_nos16 = 10 if (tipaten==1 & obste_nos16==.)
{txt}(782 real changes made)

{com}.         
. label define obtetcnos16 1"O0-O0Abortive" 2 "O10-O16Edema" 3 "O20-O29RelPreg" 4 "O30-O48Fetus" 5 "O60-O75Labour" 6 "O80-O84Delivery" 7 "O85-O92Puerperium" 8 "O94-O99OthObst" 9 "TipAtenParto" 10 "TipAtenAborto"
{txt}
{com}. label values obste_nos16 obtetcnos16
{txt}
{com}. 
. tab obste_nos16

      {txt}obste_nos16 {c |}      Freq.     Percent        Cum.
{hline 18}{c +}{hline 35}
    O0-O0Abortive {c |}{res}    127,726       10.00       10.00
{txt}     O10-O16Edema {c |}{res}     56,424        4.42       14.42
{txt}   O20-O29RelPreg {c |}{res}     51,573        4.04       18.45
{txt}     O30-O48Fetus {c |}{res}    268,751       21.04       39.49
{txt}    O60-O75Labour {c |}{res}    123,594        9.68       49.17
{txt}  O80-O84Delivery {c |}{res}    623,339       48.80       97.96
{txt}O85-O92Puerperium {c |}{res}      5,945        0.47       98.43
{txt}   O94-O99OthObst {c |}{res}     19,308        1.51       99.94
{txt}    TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 18}{c +}{hline 35}
            Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
. **
. *PARTO NOSOTROS (sustituye a part_nos)
. **
. * CREACION DE VARIABLE "PArto SEGUN NOSOTROS"
. *
. *drop part_nos16
. gen part_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. 
. ***Delivery ICD-10      
. replace part_nos16=0 if afec_nos16=="O80" 
{txt}(562,010 real changes made)

{com}. replace part_nos16=1 if afec_nos16=="O81" 
{txt}(2,041 real changes made)

{com}. replace part_nos16=2 if afec_nos16=="O82" 
{txt}(47,672 real changes made)

{com}. replace part_nos16=3 if afec_nos16=="O83" 
{txt}(10,810 real changes made)

{com}. replace part_nos16=4 if afec_nos16=="O84" 
{txt}(806 real changes made)

{com}. replace part_nos16 = 5 if (tipaten==0 & part_nos16==.)
{txt}(0 real changes made)

{com}. 
. tab part_nos16

 {txt}part_nos16 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}    562,010       90.16       90.16
{txt}          1 {c |}{res}      2,041        0.33       90.49
{txt}          2 {c |}{res}     47,672        7.65       98.14
{txt}          3 {c |}{res}     10,810        1.73       99.87
{txt}          4 {c |}{res}        806        0.13      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    623,339      100.00
{txt}
{com}. 
. label define partonso16 0 "O80 Un solo parto espontaneo" 1 "O81 Un solo parto con forceps y aspirad" 2 "O82 Un solo parto por cesarea" 3 "O83 Otro parto unico asistido" 4 "O84 Parto multiple" 5 "TipoAtencion Parto" 
{txt}
{com}. label values part_nos16 partonso16
{txt}
{com}. 
. 
. 
. **
. * CREACION VARIANLE "MISSING NOSOTROS16" si no tiene aborto_nos ni part_nos16 entonces es miss_nos16
. **
. *drop miss_nos16
. gen miss_nos16 = .
{txt}(2,959,197 missing values generated)

{com}. replace miss_nos16 = 1 if aborto_nos==. & part_nos16==.
{txt}(2,205,283 real changes made)

{com}. 
. label define missnsot16 1 "Missing nosotros" 
{txt}
{com}. label values miss_nos16 missnsot16
{txt}
{com}. 
. tab miss_nos16

      {txt}miss_nos16 {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
Missing nosotros {c |}{res}  2,205,283      100.00      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}  2,205,283      100.00
{txt}
{com}. 
. tab afec_nos16 miss_nos16
{err}too many values
{txt}{search r(134), local:r(134);}

end of do-file

{search r(134), local:r(134);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. 
. 
. 
. **
. *TIPO DE ATENCION NOSOTROS, por todas las afecciones, version largo
. **
. *Aborto nosotros, Parto nosotros, AbortParto Nosotros y Missing Nosotros
. *drop tipaten_nos16
. gen tipaten_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. replace tipaten_nos16 = 0 if aborto_nos!=. & part_nos16==. & miss_nos16==. /*aborto*/
{txt}(130,575 real changes made)

{com}. replace tipaten_nos16 = 1 if part_nos16!=. & aborto_nos==. & miss_nos16==. /*parto*/
{txt}(623,339 real changes made)

{com}. replace tipaten_nos16 = 2 if aborto_nos!=. & part_nos16!=. & miss_nos16==. /*abortoParto*/
{txt}(0 real changes made)

{com}. replace tipaten_nos16 = 3 if aborto_nos==. & part_nos16==.
{txt}(2,205,283 real changes made)

{com}. 
. label define tipatenos 0 "Aborto Nosotros" 1 "Parto Nosotros" 2 "Aborto&Parto Nosotros" 3 "Missing Nosotros" 
{txt}
{com}. label values tipaten_nos16 tipatenos
{txt}
{com}. 
. tab tipaten_nos16

        {txt}tipaten_nos16 {c |}      Freq.     Percent        Cum.
{hline 22}{c +}{hline 35}
      Aborto Nosotros {c |}{res}    130,575        4.41        4.41
{txt}       Parto Nosotros {c |}{res}    623,339       21.06       25.48
{txt}     Missing Nosotros {c |}{res}  2,205,283       74.52      100.00
{txt}{hline 22}{c +}{hline 35}
                Total {c |}{res}  2,959,197      100.00
{txt}
{com}. 
. 
. 
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" individual
. **      
. *drop obsteInd_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obsteInd_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=10+`i'  if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=20+`i'  if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=80+`i' if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obsteInd_nos16 = 100 if (tipaten==0 & obsteInd_nos16==.)
{txt}(0 real changes made)

{com}.         replace obsteInd_nos16 = 101 if (tipaten==1 & obsteInd_nos16==.)
{txt}(782 real changes made)

{com}.         
. 
. **** A valores de categorÓ¡s ****
. label define obtetIncnos /* Primera categoria */ 0 "O00 Embarazo ectopico" 1 "O01 Mola Hidaltiforme" 2 "O02 Otros productos anormales" 3 "O03 Aborto espontaneo" 4 "O04 Aborto medico" 5 "O05 Otro aborto" 6 "O06 Aborto inespecifico" 7 "O07 Intento fallido" 8 "O08 Complicaciones despues de aborto/ect/molar" /* Segunda categoria */ 10 "O10 Hipertension pre-existente complicada con embarazo, parto y puerperio" 11 "O11 Pre-eclampsia superpuesta a hipertension cronica" 12 "O12 Edema y proteinuria gestacional sin hipertension" 13 "O13 Hipertension gestacional" 14 "O14 Pre-eclampsia" 15 "O15 Eclampsia" 16 "O16 Hipertension materna inespecificada"  /* Tercera categoria */ 20 "O20 Hemorragia temprana" 21 "O21 Vomito excesivo" 22 "O22 Complicaciones en venas y hemorroides" 23 "O23 Infecciones en tracto genitourinario" 24 "O24 Diabetes mellitus" 25 "O25 Malnutricion en embarazo" 26 "O26 Atencion para otras condiciones" 28 "O28 Hallazgos anormales en atencion pre-natal" 29 "O29 Complicaciones de anestesia durante el embarazo"/* Cuarta categoria */ 30 "O30 Gestacion multiple" 31 "O31 Complicaciones de gestacion multiple" 32 "O32 Atencion para malpresentacion del feto" 33 "O33 Atencion para desproporcion del feto" 34 "O34 Atencion para anormalidad de los organos pelvicos" 35 "O35 Atencion para anormalidad del feto" 36 "O36 Atencion para otros problemas fetales" 40 "O40 Polyhydramnios" 41 "O41 Otros desordenes de fluido amniotico y membranas" 42 "O42 Ruptura prematura de membranas" 43 "O43 Desordenes de placenta" 44 "O44 Placenta praevia" 45 "O45 Separacion prematura de placenta" 46 "O46 Hemorragia antes del parto no clasificada" 47 "O47 Falsa labor" 48 "O48 Embarazo prolongado" /* Quinta categoria */ 60 "O60 Labor y parto pretermino" 61 "O61 Induccion de labor fallida" 62 "O62 Anormalidades en las impulsoras de labor" 63 "O63 Labor extendida" 64 "O64 Labor obstruida por malposicion o malpresentacion de feto" 65 "O65 Labor obstruida por anormalidad pelvica de la madre" 66 "O66 Otra labor obstruida" 67 "O67 Labor y parto complicados por hemorragia intraparto no clasificada en otra parte" 68 "O68 Labor y parto complicados por estres fetal" 69 "O69 Labor y parto complicados por complicaciones con el cordon umbilical" 70 "O70 Laceracion perineal durante el parto" 71 "O71 Otro trauma obstetrico" 72 "O72 Hemorragia post-parto" 73 "O73 Placenta y membranas retenidos sin hemorragia" 74 "O74 Complicaciones de anestesia durante labor y parto" 75 "O75 Otras complicaciones de parto y labor no clasificadas" /* Sexta categoria */ 80 "O80 Un solo parto espontaneo" 81 "O81 Un solo parto con forceps y aspirado" 82 "O82 Un solo parto por cesarea" 83 "O83 Otro parto unico asistido" 84 "O84 Parto multiple" /* Septima categoria */ 85 "O85 Sepsis puerperal" 86 "O86 Otras infecciones puerperales" 87 "O87 Complicaciones en venas y hemorroides en el puerperio" 88 "O88 Embolia obstetrica" 89 "O89 Complicaciones de anestesia durante el puerperio" 90 "O90 Complicaciones del puerperio no clasificadas" 91 "O91 Infecciones de pecho asociadas con el nacimiento" 92 "O92 Otros desordenes de pecho y lactancia asociados al nacimiento"  /* Octava categoria */94 "O94 Secuela de complicacion en embarazo, parto y puerperio" 95 "O95 Muerte obstetrica de causa inespecifica" 96 "O96 Muerte por alguna causa obstetrica ocurrida despues de 42 dias pero antes de un despues del parto" 97 "O97 Muerte por secuela de causas obstetricas" 98 "O98 Infeccion materna y enfermedades parasitarias complicando el embarazo, parto y puerperio" 99 "O99 Otras enfermedades maternas complicando el embarazo, parto y puerperio" 100 "TipAtenPArto" 101 "TipAtenAborto"
{txt}
{com}. label values obsteInd_nos16 obtetIncnos
{txt}
{com}. 
. tab obsteInd_nos16

                         {txt}obsteInd_nos16 {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                  O00 Embarazo ectopico {c |}{res}      6,726        0.53        0.53
{txt}                  O01 Mola Hidaltiforme {c |}{res}      1,180        0.09        0.62
{txt}          O02 Otros productos anormales {c |}{res}     23,013        1.80        2.42
{txt}                  O03 Aborto espontaneo {c |}{res}     14,179        1.11        3.53
{txt}                      O04 Aborto medico {c |}{res}        260        0.02        3.55
{txt}                        O05 Otro aborto {c |}{res}      4,107        0.32        3.87
{txt}                O06 Aborto inespecifico {c |}{res}     77,923        6.10        9.97
{txt}                    O07 Intento fallido {c |}{res}         22        0.00        9.97
{txt}O08 Complicaciones despues de aborto/ec {c |}{res}        316        0.02       10.00
{txt}O10 Hipertension pre-existente complica {c |}{res}      2,349        0.18       10.18
{txt}O11 Pre-eclampsia superpuesta a hiperte {c |}{res}        156        0.01       10.19
{txt}O12 Edema y proteinuria gestacional sin {c |}{res}         29        0.00       10.20
{txt}           O13 Hipertension gestacional {c |}{res}     21,374        1.67       11.87
{txt}                      O14 Pre-eclampsia {c |}{res}     25,703        2.01       13.88
{txt}                          O15 Eclampsia {c |}{res}      1,988        0.16       14.04
{txt}O16 Hipertension materna inespecificada {c |}{res}      4,825        0.38       14.42
{txt}                O20 Hemorragia temprana {c |}{res}     15,493        1.21       15.63
{txt}                    O21 Vomito excesivo {c |}{res}      1,249        0.10       15.73
{txt}O22 Complicaciones en venas y hemorroid {c |}{res}        196        0.02       15.74
{txt}O23 Infecciones en tracto genitourinari {c |}{res}     23,557        1.84       17.59
{txt}                  O24 Diabetes mellitus {c |}{res}      9,035        0.71       18.29
{txt}           O25 Malnutricion en embarazo {c |}{res}         32        0.00       18.30
{txt}    O26 Atencion para otras condiciones {c |}{res}      1,928        0.15       18.45
{txt}O28 Hallazgos anormales en atencion pre {c |}{res}         34        0.00       18.45
{txt}O29 Complicaciones de anestesia durante {c |}{res}         49        0.00       18.45
{txt}                 O30 Gestacion multiple {c |}{res}      3,891        0.30       18.76
{txt}O31 Complicaciones de gestacion multipl {c |}{res}        208        0.02       18.77
{txt}O32 Atencion para malpresentacion del f {c |}{res}     14,087        1.10       19.88
{txt}O33 Atencion para desproporcion del fet {c |}{res}     51,451        4.03       23.90
{txt}O34 Atencion para anormalidad de los or {c |}{res}     56,666        4.44       28.34
{txt} O35 Atencion para anormalidad del feto {c |}{res}        599        0.05       28.39
{txt}O36 Atencion para otros problemas fetal {c |}{res}     27,324        2.14       30.53
{txt}                     O40 Polyhydramnios {c |}{res}      1,322        0.10       30.63
{txt}O41 Otros desordenes de fluido amniotic {c |}{res}     29,890        2.34       32.97
{txt}     O42 Ruptura prematura de membranas {c |}{res}     41,819        3.27       36.24
{txt}             O43 Desordenes de placenta {c |}{res}        400        0.03       36.27
{txt}                   O44 Placenta praevia {c |}{res}      2,888        0.23       36.50
{txt}   O45 Separacion prematura de placenta {c |}{res}      2,145        0.17       36.67
{txt}O46 Hemorragia antes del parto no clasi {c |}{res}        410        0.03       36.70
{txt}                        O47 Falsa labor {c |}{res}     33,600        2.63       39.33
{txt}                O48 Embarazo prolongado {c |}{res}      2,051        0.16       39.49
{txt}           O60 Labor y parto pretermino {c |}{res}     20,044        1.57       41.06
{txt}         O61 Induccion de labor fallida {c |}{res}      4,366        0.34       41.40
{txt}O62 Anormalidades en las impulsoras de  {c |}{res}     11,553        0.90       42.31
{txt}                    O63 Labor extendida {c |}{res}      9,937        0.78       43.08
{txt}O64 Labor obstruida por malposicion o m {c |}{res}      8,975        0.70       43.79
{txt}O65 Labor obstruida por anormalidad pel {c |}{res}     10,923        0.86       44.64
{txt}               O66 Otra labor obstruida {c |}{res}      4,973        0.39       45.03
{txt}O67 Labor y parto complicados por hemor {c |}{res}        977        0.08       45.11
{txt}O68 Labor y parto complicados por estre {c |}{res}     27,968        2.19       47.30
{txt}O69 Labor y parto complicados por compl {c |}{res}      5,092        0.40       47.70
{txt}O70 Laceracion perineal durante el part {c |}{res}      3,897        0.31       48.00
{txt}             O71 Otro trauma obstetrico {c |}{res}      1,006        0.08       48.08
{txt}              O72 Hemorragia post-parto {c |}{res}      3,700        0.29       48.37
{txt}O73 Placenta y membranas retenidos sin  {c |}{res}      1,875        0.15       48.52
{txt}O74 Complicaciones de anestesia durante {c |}{res}        249        0.02       48.54
{txt}O75 Otras complicaciones de parto y lab {c |}{res}      8,059        0.63       49.17
{txt}           O80 Un solo parto espontaneo {c |}{res}    562,010       43.99       93.16
{txt}O81 Un solo parto con forceps y aspirad {c |}{res}      2,041        0.16       93.32
{txt}          O82 Un solo parto por cesarea {c |}{res}     47,672        3.73       97.05
{txt}          O83 Otro parto unico asistido {c |}{res}     10,810        0.85       97.90
{txt}                     O84 Parto multiple {c |}{res}        806        0.06       97.96
{txt}                   O85 Sepsis puerperal {c |}{res}        751        0.06       98.02
{txt}      O86 Otras infecciones puerperales {c |}{res}      1,354        0.11       98.13
{txt}O87 Complicaciones en venas y hemorroid {c |}{res}         97        0.01       98.13
{txt}                 O88 Embolia obstetrica {c |}{res}         44        0.00       98.14
{txt}O89 Complicaciones de anestesia durante {c |}{res}        407        0.03       98.17
{txt}O90 Complicaciones del puerperio no cla {c |}{res}      2,935        0.23       98.40
{txt}O91 Infecciones de pecho asociadas con  {c |}{res}        337        0.03       98.43
{txt}O92 Otros desordenes de pecho y lactanc {c |}{res}         20        0.00       98.43
{txt}O94 Secuela de complicacion en embarazo {c |}{res}         34        0.00       98.43
{txt}O98 Infeccion materna y enfermedades pa {c |}{res}      3,455        0.27       98.70
{txt}O99 Otras enfermedades maternas complic {c |}{res}     15,819        1.24       99.94
{txt}                          TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
.         
. 
. *******************
. *PARTE 7
. ******************
. 
. *VARIABLES Y TABLAS PARA MANUSCRITO 
. 
. **CREACIÃN DE VARIABLES
. **
. 
. *generando Grandes Grupos de EDAD
. *drop edad_nos
. gen edad_nos=.
{txt}(2,959,197 missing values generated)

{com}. replace edad_nos=1 if edad <18 & edad!=.
{txt}(644,872 real changes made)

{com}. replace edad_nos=2 if edad <26 & edad_nos==.
{txt}(828,955 real changes made)

{com}. replace edad_nos=3 if edad <31 & edad_nos==.
{txt}(341,467 real changes made)

{com}. replace edad_nos=4 if edad <41 & edad_nos==.
{txt}(405,141 real changes made)

{com}. replace edad_nos=5 if edad >40 & edad_nos==.
{txt}(738,762 real changes made)

{com}. 
. label define edadnos 1  "< 18" 2  "18 - 25" 3  "26 - 30" 4  "31 - 40" 5  "> 40" 
{txt}
{com}. label values edad_nos edadnos
{txt}
{com}. 
. *generando la vairble de 2do trimestre tardio hasta semana 24 con tres categorias
. *drop trim23
. gen trim23 = .
{txt}(2,959,197 missing values generated)

{com}. replace trim23 = 1 if  gestac < 17 & gestac > 12
{txt}(10,345 real changes made)

{com}. replace trim23 = 2 if  gestac < 21 & gestac > 16
{txt}(6,055 real changes made)

{com}. replace trim23 = 3 if  gestac < 25 & gestac > 20
{txt}(3,059 real changes made)

{com}. 
. label define trimeSS23 1  "13-16" 2  "17-20" 3 "21-24"
{txt}
{com}. label values trim23 trimeSS23
{txt}
{com}. 
. **
. **TABLAS
. **
. 
. *total de EGERESOS de 2007 a 2014
. count if year!=. & year >2006
  {res}1,282,693
{txt}
{com}. 
. *total de abortos
. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}     23,013       18.76       18.76
{txt} O03 Spontaneous {c |}{res}     14,179       11.56       30.32
{txt}     O04 Medical {c |}{res}        260        0.21       30.53
{txt}   O05 OthrAbort {c |}{res}      4,107        3.35       33.88
{txt} O06 Unspecified {c |}{res}     77,923       63.52       97.40
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.42
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.26       97.68
{txt}    TipAtenAbort {c |}{res}      2,849        2.32      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    122,669      100.00
{txt}
{com}. 
. *aborto que tienen edad gestacional de 2007 a 2014
. tab aborto_nos if gestac!=. & aborto_nos!=0     & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}     20,744       18.39       18.39
{txt} O03 Spontaneous {c |}{res}     12,342       10.94       29.33
{txt}     O04 Medical {c |}{res}        186        0.16       29.50
{txt}   O05 OthrAbort {c |}{res}      3,413        3.03       32.52
{txt} O06 Unspecified {c |}{res}     73,046       64.76       97.29
{txt}   O07 FailAttem {c |}{res}          1        0.00       97.29
{txt}O08 ComplEcMoAbo {c |}{res}        212        0.19       97.47
{txt}    TipAtenAbort {c |}{res}      2,849        2.53      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    112,793      100.00
{txt}
{com}. 
. 
. *aborto que tienen edad gestacional de 2007 a 2014 en SEGUNDO TRIMESTRE
. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=.

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}      2,154       13.33       13.33
{txt} O03 Spontaneous {c |}{res}      1,949       12.06       25.39
{txt}     O04 Medical {c |}{res}         28        0.17       25.56
{txt}   O05 OthrAbort {c |}{res}        469        2.90       28.47
{txt} O06 Unspecified {c |}{res}     11,007       68.12       96.58
{txt}O08 ComplEcMoAbo {c |}{res}         21        0.13       96.71
{txt}    TipAtenAbort {c |}{res}        531        3.29      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}     16,159      100.00
{txt}
{com}. tab trim23     if aborto_nos!=0 & aborto_nos!=1 & year >2006 & aborto_nos!=.

     {txt}trim23 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      13-16 {c |}{res}     10,182       63.01       63.01
{txt}      17-20 {c |}{res}      5,976       36.98       99.99
{txt}      21-24 {c |}{res}          1        0.01      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     16,159      100.00
{txt}
{com}. 
. *tabla por semanas de gestacion
. *(tab aborto_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1)
. tab aborto_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006

                 {txt}{c |}              trim23
      aborto_nos {c |}     13-16      17-20      21-24 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
    O02 OthrProd {c |}{res}     1,617        537          0 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}     1,155        794          0 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}        12         16          0 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}       277        192          0 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}     6,896      4,111          0 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}        12          8          1 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}       213        318          0 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}    10,182      5,976          1 {txt}{c |}{res}    16,159 

{txt}
{com}. 
. 
. * tablas por edad, aborto en senguno trimestre
. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=. 

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}      2,022       12.51       12.51
{txt}    18 - 25 {c |}{res}      7,395       45.76       58.28
{txt}    26 - 30 {c |}{res}      3,054       18.90       77.18
{txt}    31 - 40 {c |}{res}      3,279       20.29       97.47
{txt}       > 40 {c |}{res}        409        2.53      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     16,159      100.00
{txt}
{com}. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23==1

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}      1,263       12.40       12.40
{txt}    18 - 25 {c |}{res}      4,610       45.28       57.68
{txt}    26 - 30 {c |}{res}      1,935       19.00       76.68
{txt}    31 - 40 {c |}{res}      2,096       20.59       97.27
{txt}       > 40 {c |}{res}        278        2.73      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     10,182      100.00
{txt}
{com}. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23==2

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}        758       12.68       12.68
{txt}    18 - 25 {c |}{res}      2,785       46.60       59.29
{txt}    26 - 30 {c |}{res}      1,119       18.72       78.01
{txt}    31 - 40 {c |}{res}      1,183       19.80       97.81
{txt}       > 40 {c |}{res}        131        2.19      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}      5,976      100.00
{txt}
{com}. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23==3

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}          1      100.00      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}          1      100.00
{txt}
{com}. 
. tab edad_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006

           {txt}{c |}              trim23
  edad_nos {c |}     13-16      17-20      21-24 {c |}     Total
{hline 11}{c +}{hline 33}{c +}{hline 10}
      < 18 {c |}{res}     1,263        758          1 {txt}{c |}{res}     2,022 
{txt}   18 - 25 {c |}{res}     4,610      2,785          0 {txt}{c |}{res}     7,395 
{txt}   26 - 30 {c |}{res}     1,935      1,119          0 {txt}{c |}{res}     3,054 
{txt}   31 - 40 {c |}{res}     2,096      1,183          0 {txt}{c |}{res}     3,279 
{txt}      > 40 {c |}{res}       278        131          0 {txt}{c |}{res}       409 
{txt}{hline 11}{c +}{hline 33}{c +}{hline 10}
     Total {c |}{res}    10,182      5,976          1 {txt}{c |}{res}    16,159 

{txt}
{com}. tab edad_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006, chi2

           {txt}{c |}              trim23
  edad_nos {c |}     13-16      17-20      21-24 {c |}     Total
{hline 11}{c +}{hline 33}{c +}{hline 10}
      < 18 {c |}{res}     1,263        758          1 {txt}{c |}{res}     2,022 
{txt}   18 - 25 {c |}{res}     4,610      2,785          0 {txt}{c |}{res}     7,395 
{txt}   26 - 30 {c |}{res}     1,935      1,119          0 {txt}{c |}{res}     3,054 
{txt}   31 - 40 {c |}{res}     2,096      1,183          0 {txt}{c |}{res}     3,279 
{txt}      > 40 {c |}{res}       278        131          0 {txt}{c |}{res}       409 
{txt}{hline 11}{c +}{hline 33}{c +}{hline 10}
     Total {c |}{res}    10,182      5,976          1 {txt}{c |}{res}    16,159 

{txt}          Pearson chi2({res}8{txt}) = {res} 14.2987  {txt} Pr = {res}0.074
{txt}
{com}. 
. *tablas por indice de marginacion
. tab quint if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim2!=.
{err}variable {bf}quint{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. lookfor quint

. br

. lookfor estado

. tab edad

       {txt}EDAD {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}    118,914        4.02        4.02
{txt}          2 {c |}{res}     44,542        1.51        5.52
{txt}          3 {c |}{res}     35,932        1.21        6.74
{txt}          4 {c |}{res}     31,286        1.06        7.80
{txt}          5 {c |}{res}     28,028        0.95        8.74
{txt}          6 {c |}{res}     24,697        0.83        9.58
{txt}          7 {c |}{res}     22,393        0.76       10.33
{txt}          8 {c |}{res}     21,004        0.71       11.04
{txt}          9 {c |}{res}     18,972        0.64       11.68
{txt}         10 {c |}{res}     18,443        0.62       12.31
{txt}         11 {c |}{res}     18,189        0.61       12.92
{txt}         12 {c |}{res}     15,739        0.53       13.45
{txt}         13 {c |}{res}     17,514        0.59       14.05
{txt}         14 {c |}{res}     26,830        0.91       14.95
{txt}         15 {c |}{res}     41,777        1.41       16.36
{txt}         16 {c |}{res}     68,291        2.31       18.67
{txt}         17 {c |}{res}     92,321        3.12       21.79
{txt}         18 {c |}{res}    107,352        3.63       25.42
{txt}         19 {c |}{res}    115,206        3.89       29.31
{txt}         20 {c |}{res}    116,921        3.95       33.26
{txt}         21 {c |}{res}    108,692        3.67       36.94
{txt}         22 {c |}{res}    105,531        3.57       40.50
{txt}         23 {c |}{res}    100,465        3.40       43.90
{txt}         24 {c |}{res}     91,048        3.08       46.98
{txt}         25 {c |}{res}     83,740        2.83       49.80
{txt}         26 {c |}{res}     75,882        2.56       52.37
{txt}         27 {c |}{res}     71,884        2.43       54.80
{txt}         28 {c |}{res}     68,435        2.31       57.11
{txt}         29 {c |}{res}     62,929        2.13       59.24
{txt}         30 {c |}{res}     62,337        2.11       61.34
{txt}         31 {c |}{res}     51,668        1.75       63.09
{txt}         32 {c |}{res}     52,008        1.76       64.85
{txt}         33 {c |}{res}     46,945        1.59       66.43
{txt}         34 {c |}{res}     42,850        1.45       67.88
{txt}         35 {c |}{res}     39,463        1.33       69.22
{txt}         36 {c |}{res}     38,149        1.29       70.50
{txt}         37 {c |}{res}     35,327        1.19       71.70
{txt}         38 {c |}{res}     35,075        1.19       72.88
{txt}         39 {c |}{res}     32,372        1.09       73.98
{txt}         40 {c |}{res}     31,284        1.06       75.04
{txt}         41 {c |}{res}     25,905        0.88       75.91
{txt}         42 {c |}{res}     26,818        0.91       76.82
{txt}         43 {c |}{res}     24,158        0.82       77.63
{txt}         44 {c |}{res}     22,265        0.75       78.39
{txt}         45 {c |}{res}     23,430        0.79       79.18
{txt}         46 {c |}{res}     20,789        0.70       79.88
{txt}         47 {c |}{res}     21,668        0.73       80.61
{txt}         48 {c |}{res}     22,015        0.74       81.36
{txt}         49 {c |}{res}     21,647        0.73       82.09
{txt}         50 {c |}{res}     24,158        0.82       82.90
{txt}         51 {c |}{res}     17,837        0.60       83.51
{txt}         52 {c |}{res}     20,776        0.70       84.21
{txt}         53 {c |}{res}     20,020        0.68       84.89
{txt}         54 {c |}{res}     20,474        0.69       85.58
{txt}         55 {c |}{res}     18,896        0.64       86.22
{txt}         56 {c |}{res}     19,159        0.65       86.86
{txt}         57 {c |}{res}     18,680        0.63       87.49
{txt}         58 {c |}{res}     19,298        0.65       88.15
{txt}         59 {c |}{res}     18,739        0.63       88.78
{txt}         60 {c |}{res}     18,653        0.63       89.41
{txt}         61 {c |}{res}     15,117        0.51       89.92
{txt}         62 {c |}{res}     15,996        0.54       90.46
{txt}         63 {c |}{res}     16,709        0.56       91.03
{txt}         64 {c |}{res}     16,258        0.55       91.58
{txt}         65 {c |}{res}     16,541        0.56       92.13
{txt}         66 {c |}{res}     14,137        0.48       92.61
{txt}         67 {c |}{res}     13,864        0.47       93.08
{txt}         68 {c |}{res}     13,880        0.47       93.55
{txt}         69 {c |}{res}     12,394        0.42       93.97
{txt}         70 {c |}{res}     13,484        0.46       94.42
{txt}         71 {c |}{res}     10,620        0.36       94.78
{txt}         72 {c |}{res}     12,208        0.41       95.20
{txt}         73 {c |}{res}     12,001        0.41       95.60
{txt}         74 {c |}{res}     12,256        0.41       96.02
{txt}         75 {c |}{res}     10,596        0.36       96.37
{txt}         76 {c |}{res}      9,931        0.34       96.71
{txt}         77 {c |}{res}      9,467        0.32       97.03
{txt}         78 {c |}{res}     10,577        0.36       97.39
{txt}         79 {c |}{res}      8,034        0.27       97.66
{txt}         80 {c |}{res}      8,171        0.28       97.93
{txt}         81 {c |}{res}      6,297        0.21       98.15
{txt}         82 {c |}{res}      6,925        0.23       98.38
{txt}         83 {c |}{res}      7,023        0.24       98.62
{txt}         84 {c |}{res}      6,977        0.24       98.85
{txt}         85 {c |}{res}      5,506        0.19       99.04
{txt}         86 {c |}{res}      4,888        0.17       99.21
{txt}         87 {c |}{res}      4,016        0.14       99.34
{txt}         88 {c |}{res}      3,928        0.13       99.47
{txt}         89 {c |}{res}      3,382        0.11       99.59
{txt}         90 {c |}{res}      2,638        0.09       99.68
{txt}         91 {c |}{res}      1,676        0.06       99.73
{txt}         92 {c |}{res}      1,707        0.06       99.79
{txt}         93 {c |}{res}      1,578        0.05       99.84
{txt}         94 {c |}{res}      1,352        0.05       99.89
{txt}         95 {c |}{res}        734        0.02       99.92
{txt}         96 {c |}{res}        692        0.02       99.94
{txt}         97 {c |}{res}        487        0.02       99.96
{txt}         98 {c |}{res}        431        0.01       99.97
{txt}         99 {c |}{res}        307        0.01       99.98
{txt}        100 {c |}{res}        155        0.01       99.99
{txt}        101 {c |}{res}         94        0.00       99.99
{txt}        102 {c |}{res}         83        0.00       99.99
{txt}        103 {c |}{res}         43        0.00       99.99
{txt}        104 {c |}{res}         55        0.00       99.99
{txt}        105 {c |}{res}         23        0.00      100.00
{txt}        106 {c |}{res}         15        0.00      100.00
{txt}        107 {c |}{res}          7        0.00      100.00
{txt}        108 {c |}{res}          8        0.00      100.00
{txt}        109 {c |}{res}         13        0.00      100.00
{txt}        110 {c |}{res}          7        0.00      100.00
{txt}        111 {c |}{res}          1        0.00      100.00
{txt}        112 {c |}{res}          5        0.00      100.00
{txt}        113 {c |}{res}          7        0.00      100.00
{txt}        114 {c |}{res}          8        0.00      100.00
{txt}        115 {c |}{res}          2        0.00      100.00
{txt}        116 {c |}{res}          1        0.00      100.00
{txt}        121 {c |}{res}          1        0.00      100.00
{txt}        122 {c |}{res}          1        0.00      100.00
{txt}        123 {c |}{res}          1        0.00      100.00
{txt}        125 {c |}{res}          1        0.00      100.00
{txt}        130 {c |}{res}          9        0.00      100.00
{txt}        999 {c |}{res}         52        0.00      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. br edad

. tab entidad

    {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}     43,187        1.46        1.46
{txt}          2 {c |}{res}     52,122        1.76        3.22
{txt}          3 {c |}{res}     18,131        0.61        3.83
{txt}          4 {c |}{res}     30,082        1.02        4.85
{txt}          5 {c |}{res}     49,492        1.67        6.52
{txt}          6 {c |}{res}     20,371        0.69        7.21
{txt}          7 {c |}{res}    139,371        4.71       11.92
{txt}          8 {c |}{res}     77,235        2.61       14.53
{txt}          9 {c |}{res}    205,745        6.95       21.48
{txt}         10 {c |}{res}     50,341        1.70       23.18
{txt}         11 {c |}{res}    162,737        5.50       28.68
{txt}         12 {c |}{res}     94,962        3.21       31.89
{txt}         13 {c |}{res}     64,633        2.18       34.08
{txt}         14 {c |}{res}    215,566        7.28       41.36
{txt}         15 {c |}{res}    397,698       13.44       54.80
{txt}         16 {c |}{res}    137,206        4.64       59.44
{txt}         17 {c |}{res}     51,739        1.75       61.19
{txt}         18 {c |}{res}     28,236        0.95       62.14
{txt}         19 {c |}{res}     57,795        1.95       64.09
{txt}         20 {c |}{res}     94,853        3.21       67.30
{txt}         21 {c |}{res}    124,250        4.20       71.50
{txt}         22 {c |}{res}     55,048        1.86       73.36
{txt}         23 {c |}{res}     39,978        1.35       74.71
{txt}         24 {c |}{res}     67,229        2.27       76.98
{txt}         25 {c |}{res}     75,875        2.56       79.54
{txt}         26 {c |}{res}     77,296        2.61       82.16
{txt}         27 {c |}{res}    109,024        3.68       85.84
{txt}         28 {c |}{res}     86,244        2.91       88.76
{txt}         29 {c |}{res}     46,400        1.57       90.32
{txt}         30 {c |}{res}    176,466        5.96       96.29
{txt}         31 {c |}{res}     53,680        1.81       98.10
{txt}         32 {c |}{res}     44,871        1.52       99.62
{txt}         33 {c |}{res}         78        0.00       99.62
{txt}         34 {c |}{res}        842        0.03       99.65
{txt}         35 {c |}{res}         44        0.00       99.65
{txt}         99 {c |}{res}     10,370        0.35      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. tab gestational
{err}variable {bf}gestational{sf} not found
{txt}{search r(111), local:r(111);}

{com}. lookfor edad

              {txt}storage   display    value
variable name   type    format     label      variable label
{hline}
{p 0 48}{res}{bind:cveedad        }{txt}{bind: byte    }{bind:{txt}%8.0g     }{space 1}{bind:         }{bind:  }{res}{res}CVEEDAD{p_end}
{p 0 48}{bind:edad           }{txt}{bind: int     }{bind:{txt}%8.0g     }{space 1}{bind:         }{bind:  }{res}{res}EDAD{p_end}
{p 0 48}{bind:edad_nos       }{txt}{bind: float   }{bind:{txt}%9.0g     }{space 1}{bind:edadnos  }{bind:  }{res}{res}{p_end}

{com}. tab edad

       {txt}EDAD {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}    118,914        4.02        4.02
{txt}          2 {c |}{res}     44,542        1.51        5.52
{txt}          3 {c |}{res}     35,932        1.21        6.74
{txt}          4 {c |}{res}     31,286        1.06        7.80
{txt}          5 {c |}{res}     28,028        0.95        8.74
{txt}          6 {c |}{res}     24,697        0.83        9.58
{txt}          7 {c |}{res}     22,393        0.76       10.33
{txt}          8 {c |}{res}     21,004        0.71       11.04
{txt}          9 {c |}{res}     18,972        0.64       11.68
{txt}         10 {c |}{res}     18,443        0.62       12.31
{txt}         11 {c |}{res}     18,189        0.61       12.92
{txt}         12 {c |}{res}     15,739        0.53       13.45
{txt}         13 {c |}{res}     17,514        0.59       14.05
{txt}         14 {c |}{res}     26,830        0.91       14.95
{txt}         15 {c |}{res}     41,777        1.41       16.36
{txt}         16 {c |}{res}     68,291        2.31       18.67
{txt}         17 {c |}{res}     92,321        3.12       21.79
{txt}         18 {c |}{res}    107,352        3.63       25.42
{txt}         19 {c |}{res}    115,206        3.89       29.31
{txt}         20 {c |}{res}    116,921        3.95       33.26
{txt}         21 {c |}{res}    108,692        3.67       36.94
{txt}         22 {c |}{res}    105,531        3.57       40.50
{txt}         23 {c |}{res}    100,465        3.40       43.90
{txt}         24 {c |}{res}     91,048        3.08       46.98
{txt}         25 {c |}{res}     83,740        2.83       49.80
{txt}         26 {c |}{res}     75,882        2.56       52.37
{txt}         27 {c |}{res}     71,884        2.43       54.80
{txt}         28 {c |}{res}     68,435        2.31       57.11
{txt}         29 {c |}{res}     62,929        2.13       59.24
{txt}         30 {c |}{res}     62,337        2.11       61.34
{txt}         31 {c |}{res}     51,668        1.75       63.09
{txt}         32 {c |}{res}     52,008        1.76       64.85
{txt}         33 {c |}{res}     46,945        1.59       66.43
{txt}         34 {c |}{res}     42,850        1.45       67.88
{txt}         35 {c |}{res}     39,463        1.33       69.22
{txt}         36 {c |}{res}     38,149        1.29       70.50
{txt}         37 {c |}{res}     35,327        1.19       71.70
{txt}         38 {c |}{res}     35,075        1.19       72.88
{txt}         39 {c |}{res}     32,372        1.09       73.98
{txt}         40 {c |}{res}     31,284        1.06       75.04
{txt}         41 {c |}{res}     25,905        0.88       75.91
{txt}         42 {c |}{res}     26,818        0.91       76.82
{txt}         43 {c |}{res}     24,158        0.82       77.63
{txt}         44 {c |}{res}     22,265        0.75       78.39
{txt}         45 {c |}{res}     23,430        0.79       79.18
{txt}         46 {c |}{res}     20,789        0.70       79.88
{txt}         47 {c |}{res}     21,668        0.73       80.61
{txt}         48 {c |}{res}     22,015        0.74       81.36
{txt}         49 {c |}{res}     21,647        0.73       82.09
{txt}         50 {c |}{res}     24,158        0.82       82.90
{txt}         51 {c |}{res}     17,837        0.60       83.51
{txt}         52 {c |}{res}     20,776        0.70       84.21
{txt}         53 {c |}{res}     20,020        0.68       84.89
{txt}         54 {c |}{res}     20,474        0.69       85.58
{txt}         55 {c |}{res}     18,896        0.64       86.22
{txt}         56 {c |}{res}     19,159        0.65       86.86
{txt}         57 {c |}{res}     18,680        0.63       87.49
{txt}         58 {c |}{res}     19,298        0.65       88.15
{txt}         59 {c |}{res}     18,739        0.63       88.78
{txt}         60 {c |}{res}     18,653        0.63       89.41
{txt}         61 {c |}{res}     15,117        0.51       89.92
{txt}         62 {c |}{res}     15,996        0.54       90.46
{txt}         63 {c |}{res}     16,709        0.56       91.03
{txt}         64 {c |}{res}     16,258        0.55       91.58
{txt}         65 {c |}{res}     16,541        0.56       92.13
{txt}         66 {c |}{res}     14,137        0.48       92.61
{txt}         67 {c |}{res}     13,864        0.47       93.08
{txt}         68 {c |}{res}     13,880        0.47       93.55
{txt}         69 {c |}{res}     12,394        0.42       93.97
{txt}         70 {c |}{res}     13,484        0.46       94.42
{txt}         71 {c |}{res}     10,620        0.36       94.78
{txt}         72 {c |}{res}     12,208        0.41       95.20
{txt}         73 {c |}{res}     12,001        0.41       95.60
{txt}         74 {c |}{res}     12,256        0.41       96.02
{txt}         75 {c |}{res}     10,596        0.36       96.37
{txt}         76 {c |}{res}      9,931        0.34       96.71
{txt}         77 {c |}{res}      9,467        0.32       97.03
{txt}         78 {c |}{res}     10,577        0.36       97.39
{txt}         79 {c |}{res}      8,034        0.27       97.66
{txt}         80 {c |}{res}      8,171        0.28       97.93
{txt}         81 {c |}{res}      6,297        0.21       98.15
{txt}         82 {c |}{res}      6,925        0.23       98.38
{txt}         83 {c |}{res}      7,023        0.24       98.62
{txt}         84 {c |}{res}      6,977        0.24       98.85
{txt}         85 {c |}{res}      5,506        0.19       99.04
{txt}         86 {c |}{res}      4,888        0.17       99.21
{txt}         87 {c |}{res}      4,016        0.14       99.34
{txt}         88 {c |}{res}      3,928        0.13       99.47
{txt}         89 {c |}{res}      3,382        0.11       99.59
{txt}         90 {c |}{res}      2,638        0.09       99.68
{txt}         91 {c |}{res}      1,676        0.06       99.73
{txt}         92 {c |}{res}      1,707        0.06       99.79
{txt}         93 {c |}{res}      1,578        0.05       99.84
{txt}         94 {c |}{res}      1,352        0.05       99.89
{txt}         95 {c |}{res}        734        0.02       99.92
{txt}         96 {c |}{res}        692        0.02       99.94
{txt}         97 {c |}{res}        487        0.02       99.96
{txt}         98 {c |}{res}        431        0.01       99.97
{txt}         99 {c |}{res}        307        0.01       99.98
{txt}        100 {c |}{res}        155        0.01       99.99
{txt}        101 {c |}{res}         94        0.00       99.99
{txt}        102 {c |}{res}         83        0.00       99.99
{txt}        103 {c |}{res}         43        0.00       99.99
{txt}        104 {c |}{res}         55        0.00       99.99
{txt}        105 {c |}{res}         23        0.00      100.00
{txt}        106 {c |}{res}         15        0.00      100.00
{txt}        107 {c |}{res}          7        0.00      100.00
{txt}        108 {c |}{res}          8        0.00      100.00
{txt}        109 {c |}{res}         13        0.00      100.00
{txt}        110 {c |}{res}          7        0.00      100.00
{txt}        111 {c |}{res}          1        0.00      100.00
{txt}        112 {c |}{res}          5        0.00      100.00
{txt}        113 {c |}{res}          7        0.00      100.00
{txt}        114 {c |}{res}          8        0.00      100.00
{txt}        115 {c |}{res}          2        0.00      100.00
{txt}        116 {c |}{res}          1        0.00      100.00
{txt}        121 {c |}{res}          1        0.00      100.00
{txt}        122 {c |}{res}          1        0.00      100.00
{txt}        123 {c |}{res}          1        0.00      100.00
{txt}        125 {c |}{res}          1        0.00      100.00
{txt}        130 {c |}{res}          9        0.00      100.00
{txt}        999 {c |}{res}         52        0.00      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. br entidad

. tab entidad

    {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}     43,187        1.46        1.46
{txt}          2 {c |}{res}     52,122        1.76        3.22
{txt}          3 {c |}{res}     18,131        0.61        3.83
{txt}          4 {c |}{res}     30,082        1.02        4.85
{txt}          5 {c |}{res}     49,492        1.67        6.52
{txt}          6 {c |}{res}     20,371        0.69        7.21
{txt}          7 {c |}{res}    139,371        4.71       11.92
{txt}          8 {c |}{res}     77,235        2.61       14.53
{txt}          9 {c |}{res}    205,745        6.95       21.48
{txt}         10 {c |}{res}     50,341        1.70       23.18
{txt}         11 {c |}{res}    162,737        5.50       28.68
{txt}         12 {c |}{res}     94,962        3.21       31.89
{txt}         13 {c |}{res}     64,633        2.18       34.08
{txt}         14 {c |}{res}    215,566        7.28       41.36
{txt}         15 {c |}{res}    397,698       13.44       54.80
{txt}         16 {c |}{res}    137,206        4.64       59.44
{txt}         17 {c |}{res}     51,739        1.75       61.19
{txt}         18 {c |}{res}     28,236        0.95       62.14
{txt}         19 {c |}{res}     57,795        1.95       64.09
{txt}         20 {c |}{res}     94,853        3.21       67.30
{txt}         21 {c |}{res}    124,250        4.20       71.50
{txt}         22 {c |}{res}     55,048        1.86       73.36
{txt}         23 {c |}{res}     39,978        1.35       74.71
{txt}         24 {c |}{res}     67,229        2.27       76.98
{txt}         25 {c |}{res}     75,875        2.56       79.54
{txt}         26 {c |}{res}     77,296        2.61       82.16
{txt}         27 {c |}{res}    109,024        3.68       85.84
{txt}         28 {c |}{res}     86,244        2.91       88.76
{txt}         29 {c |}{res}     46,400        1.57       90.32
{txt}         30 {c |}{res}    176,466        5.96       96.29
{txt}         31 {c |}{res}     53,680        1.81       98.10
{txt}         32 {c |}{res}     44,871        1.52       99.62
{txt}         33 {c |}{res}         78        0.00       99.62
{txt}         34 {c |}{res}        842        0.03       99.65
{txt}         35 {c |}{res}         44        0.00       99.65
{txt}         99 {c |}{res}     10,370        0.35      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. br gestac

. tab gestac

     {txt}GESTAC {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}        347        0.03        0.03
{txt}          2 {c |}{res}        193        0.02        0.05
{txt}          3 {c |}{res}        271        0.02        0.07
{txt}          4 {c |}{res}      1,139        0.10        0.17
{txt}          5 {c |}{res}      3,109        0.27        0.44
{txt}          6 {c |}{res}      7,854        0.69        1.13
{txt}          7 {c |}{res}      8,672        0.76        1.89
{txt}          8 {c |}{res}     14,324        1.26        3.15
{txt}          9 {c |}{res}     15,068        1.32        4.47
{txt}         10 {c |}{res}     19,948        1.75        6.22
{txt}         11 {c |}{res}      6,646        0.58        6.81
{txt}         12 {c |}{res}     10,309        0.90        7.71
{txt}         13 {c |}{res}      3,650        0.32        8.03
{txt}         14 {c |}{res}      2,760        0.24        8.28
{txt}         15 {c |}{res}      2,056        0.18        8.46
{txt}         16 {c |}{res}      1,879        0.16        8.62
{txt}         17 {c |}{res}      1,310        0.11        8.74
{txt}         18 {c |}{res}      1,605        0.14        8.88
{txt}         19 {c |}{res}      1,310        0.11        8.99
{txt}         20 {c |}{res}      1,830        0.16        9.15
{txt}         21 {c |}{res}          9        0.00        9.15
{txt}         22 {c |}{res}      1,174        0.10        9.26
{txt}         23 {c |}{res}        894        0.08        9.33
{txt}         24 {c |}{res}        982        0.09        9.42
{txt}         25 {c |}{res}      1,030        0.09        9.51
{txt}         26 {c |}{res}      1,106        0.10        9.61
{txt}         27 {c |}{res}      1,230        0.11        9.72
{txt}         28 {c |}{res}      1,564        0.14        9.85
{txt}         29 {c |}{res}      1,511        0.13        9.99
{txt}         30 {c |}{res}      2,957        0.26       10.25
{txt}         31 {c |}{res}      2,538        0.22       10.47
{txt}         32 {c |}{res}      4,479        0.39       10.86
{txt}         33 {c |}{res}      5,226        0.46       11.32
{txt}         34 {c |}{res}      8,265        0.73       12.05
{txt}         35 {c |}{res}     13,428        1.18       13.22
{txt}         36 {c |}{res}     29,431        2.58       15.81
{txt}         37 {c |}{res}     72,297        6.35       22.15
{txt}         38 {c |}{res}    175,388       15.39       37.54
{txt}         39 {c |}{res}    283,517       24.88       62.43
{txt}         40 {c |}{res}    328,815       28.86       91.29
{txt}         41 {c |}{res}     72,338        6.35       97.63
{txt}         42 {c |}{res}     12,004        1.05       98.69
{txt}         43 {c |}{res}        456        0.04       98.73
{txt}         44 {c |}{res}        126        0.01       98.74
{txt}         45 {c |}{res}         88        0.01       98.75
{txt}         99 {c |}{res}     14,287        1.25      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  1,139,420      100.00

{com}. count if gestac == . 
  {res}1,819,777

{com}. count if gestac != . 
  {res}1,139,420

{com}. lookfor trimest

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************
. 
. *VARIABLES Y TABLAS PARA MANUSCRITO 
. 
. label define entidad 1 "Aguascalientes" 2 "Baja California" 3 "Baja California Sur" 4 "Campeche" 5 "Coahuila de Zaragoza" 6 "Colima" 7 "Chiapas" 8 "Chihuahua" 9 "Distrito Federal" 10 "Durango" 11 "Guanajuato" 12 "Guerrero" 13 "Hidalgo" 14 "Jalisco" 15 "Mexico" 16 "Michoacan de Ocampo" 17 "Morelos" 18 "Nayarit" 19 "Nuevo Leon" 20 "Oaxaca" 21 "Puebla" 22 "Queretaro" 23 "Quintana Roo" 24 "San Luis Potosi" 25 "Sinaloa" 26 "Sonora" 27 "Tabasco" 28 "Tamaulipas" 29 "Tlaxcala" 30 "Veracruz de Ignacio de la Llave" 31 "Yucatan" 32 "Zacatecas"
{txt}
{com}. 
. label vals entidad entidad
{err}invalid syntax
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. label values entidad entidad
{txt}
{com}. 
{txt}end of do-file

{com}. tan entidad
{err}command {bf}tan{sf} is unrecognized
{txt}{search r(199), local:r(199);}

{com}. tab entidad

                        {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 32}{c +}{hline 35}
                 Aguascalientes {c |}{res}     43,187        1.46        1.46
{txt}                Baja California {c |}{res}     52,122        1.76        3.22
{txt}            Baja California Sur {c |}{res}     18,131        0.61        3.83
{txt}                       Campeche {c |}{res}     30,082        1.02        4.85
{txt}           Coahuila de Zaragoza {c |}{res}     49,492        1.67        6.52
{txt}                         Colima {c |}{res}     20,371        0.69        7.21
{txt}                        Chiapas {c |}{res}    139,371        4.71       11.92
{txt}                      Chihuahua {c |}{res}     77,235        2.61       14.53
{txt}               Distrito Federal {c |}{res}    205,745        6.95       21.48
{txt}                        Durango {c |}{res}     50,341        1.70       23.18
{txt}                     Guanajuato {c |}{res}    162,737        5.50       28.68
{txt}                       Guerrero {c |}{res}     94,962        3.21       31.89
{txt}                        Hidalgo {c |}{res}     64,633        2.18       34.08
{txt}                        Jalisco {c |}{res}    215,566        7.28       41.36
{txt}                         Mexico {c |}{res}    397,698       13.44       54.80
{txt}            Michoacan de Ocampo {c |}{res}    137,206        4.64       59.44
{txt}                        Morelos {c |}{res}     51,739        1.75       61.19
{txt}                        Nayarit {c |}{res}     28,236        0.95       62.14
{txt}                     Nuevo Leon {c |}{res}     57,795        1.95       64.09
{txt}                         Oaxaca {c |}{res}     94,853        3.21       67.30
{txt}                         Puebla {c |}{res}    124,250        4.20       71.50
{txt}                      Queretaro {c |}{res}     55,048        1.86       73.36
{txt}                   Quintana Roo {c |}{res}     39,978        1.35       74.71
{txt}                San Luis Potosi {c |}{res}     67,229        2.27       76.98
{txt}                        Sinaloa {c |}{res}     75,875        2.56       79.54
{txt}                         Sonora {c |}{res}     77,296        2.61       82.16
{txt}                        Tabasco {c |}{res}    109,024        3.68       85.84
{txt}                     Tamaulipas {c |}{res}     86,244        2.91       88.76
{txt}                       Tlaxcala {c |}{res}     46,400        1.57       90.32
{txt}Veracruz de Ignacio de la Llave {c |}{res}    176,466        5.96       96.29
{txt}                        Yucatan {c |}{res}     53,680        1.81       98.10
{txt}                      Zacatecas {c |}{res}     44,871        1.52       99.62
{txt}                             33 {c |}{res}         78        0.00       99.62
{txt}                             34 {c |}{res}        842        0.03       99.65
{txt}                             35 {c |}{res}         44        0.00       99.65
{txt}                             99 {c |}{res}     10,370        0.35      100.00
{txt}{hline 32}{c +}{hline 35}
                          Total {c |}{res}  2,959,197      100.00

{com}. count if entidad == 9 & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=.
  {res}1,203

{com}. br aborto_nos

. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00

{com}. tab aborto_nos, nola

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00

{com}. br trim23

. count if trim23 != . 
  {res}19,459

{com}. count if trim23 == . 
  {res}2,939,738

{com}. br gestac*

. tab gestac

     {txt}GESTAC {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}        347        0.03        0.03
{txt}          2 {c |}{res}        193        0.02        0.05
{txt}          3 {c |}{res}        271        0.02        0.07
{txt}          4 {c |}{res}      1,139        0.10        0.17
{txt}          5 {c |}{res}      3,109        0.27        0.44
{txt}          6 {c |}{res}      7,854        0.69        1.13
{txt}          7 {c |}{res}      8,672        0.76        1.89
{txt}          8 {c |}{res}     14,324        1.26        3.15
{txt}          9 {c |}{res}     15,068        1.32        4.47
{txt}         10 {c |}{res}     19,948        1.75        6.22
{txt}         11 {c |}{res}      6,646        0.58        6.81
{txt}         12 {c |}{res}     10,309        0.90        7.71
{txt}         13 {c |}{res}      3,650        0.32        8.03
{txt}         14 {c |}{res}      2,760        0.24        8.28
{txt}         15 {c |}{res}      2,056        0.18        8.46
{txt}         16 {c |}{res}      1,879        0.16        8.62
{txt}         17 {c |}{res}      1,310        0.11        8.74
{txt}         18 {c |}{res}      1,605        0.14        8.88
{txt}         19 {c |}{res}      1,310        0.11        8.99
{txt}         20 {c |}{res}      1,830        0.16        9.15
{txt}         21 {c |}{res}          9        0.00        9.15
{txt}         22 {c |}{res}      1,174        0.10        9.26
{txt}         23 {c |}{res}        894        0.08        9.33
{txt}         24 {c |}{res}        982        0.09        9.42
{txt}         25 {c |}{res}      1,030        0.09        9.51
{txt}         26 {c |}{res}      1,106        0.10        9.61
{txt}         27 {c |}{res}      1,230        0.11        9.72
{txt}         28 {c |}{res}      1,564        0.14        9.85
{txt}         29 {c |}{res}      1,511        0.13        9.99
{txt}         30 {c |}{res}      2,957        0.26       10.25
{txt}         31 {c |}{res}      2,538        0.22       10.47
{txt}         32 {c |}{res}      4,479        0.39       10.86
{txt}         33 {c |}{res}      5,226        0.46       11.32
{txt}         34 {c |}{res}      8,265        0.73       12.05
{txt}         35 {c |}{res}     13,428        1.18       13.22
{txt}         36 {c |}{res}     29,431        2.58       15.81
{txt}         37 {c |}{res}     72,297        6.35       22.15
{txt}         38 {c |}{res}    175,388       15.39       37.54
{txt}         39 {c |}{res}    283,517       24.88       62.43
{txt}         40 {c |}{res}    328,815       28.86       91.29
{txt}         41 {c |}{res}     72,338        6.35       97.63
{txt}         42 {c |}{res}     12,004        1.05       98.69
{txt}         43 {c |}{res}        456        0.04       98.73
{txt}         44 {c |}{res}        126        0.01       98.74
{txt}         45 {c |}{res}         88        0.01       98.75
{txt}         99 {c |}{res}     14,287        1.25      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  1,139,420      100.00

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Aborto en 2trimestre.dta", clear

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. 
. // Initial descriptive analysis of abortions
.         gen abortion=0
{txt}
{com}.         replace abortion = 1 if (substr(afecprin,1,3) =="O02" | | substr(afecprin,1,3) =="O03" | | substr(afecprin,1,3) =="O04" | | substr(afecprin,1,3) =="O05" | | substr(afecprin,1,3) =="O06" | | substr(afecprin,1,3) =="O07" | | substr(afecprin,1,3) =="O08")
{txt}(140,048 real changes made)

{com}. 
.         forvalues i= 1(1)6{c -(}
{txt}  2{com}.                 replace abortion = 1 if (substr(AFEC0`i',1,3) =="O02" | | substr(AFEC0`i',1,3) =="O03" | | substr(AFEC0`i',1,3) =="O04" | | substr(AFEC0`i',1,3) =="O05" | | substr(AFEC0`i',1,3) =="O06" | | substr(AFEC0`i',1,3) =="O07" | | substr(AFEC0`i',1,3) =="O08") & abortion==0
{txt}  3{com}.         {c )-}
{txt}(1,953 real changes made)
(496 real changes made)
(38 real changes made)
(10 real changes made)
(0 real changes made)
(1 real change made)

{com}.         
.         // Attention for abortion 
.         gen atten_abortion = 0 
{txt}
{com}.         replace atten_abortion = 1 if tipaten == 1 
{txt}(156,482 real changes made)

{com}.         
.         // Distinguish between abortion types 
.         gen type_abortion = . 
{txt}(1,256,101 missing values generated)

{com}.         replace type_abortion = 1 if abortion == 1 
{txt}(142,546 real changes made)

{com}.         replace type_abortion = 2 if abortion != 1 & atten_abortion == 1 
{txt}(16,756 real changes made)

{com}.         
.         label define type_abortion 1 "O00-O08" 2 "Tipo Att Aborto" 
{txt}
{com}.         label values type_abortion type_abortion
{txt}
{com}.         
. // Drop duplicates (only 2) 
.         duplicates drop clues edad afecprin egreso ingre year id folio, force

{p 0 4}{txt}Duplicates in terms of {res} clues edad afecprin egreso ingre year id folio{p_end}

{txt}(1 observation deleted)

{com}. 
.         
.         /*
> // Take a look at how many abortions we capture using the afeccion principal versus the other 6 afecciones at the code level 
> 
>  // Create flags to look at #s by year
>         
>         gen flag_prin = 1 if regexm(afecprin, "O00") | regexm(afecprin, "O01") | regexm(afecprin, "O02") | regexm(afecprin, "O03") | regexm(afecprin, "O04") | regexm(afecprin, "O05") | regexm(afecprin, "O06") | regexm(afecprin, "O07") | regexm(afecprin, "O08") 
>         
>         gen flag_1 = 1 if flag_prin == . & (regexm(AFEC01, "O00") | regexm(AFEC01, "O01") | regexm(AFEC01, "O02") | regexm(AFEC01, "O03") | regexm(AFEC01, "O04") | regexm(AFEC01, "O05") | regexm(AFEC01, "O06") | regexm(AFEC01, "O07") | regexm(AFEC01, "O08"))
>         
>         gen flag_2 = 1 if flag_prin == . & flag_1 == . & (regexm(AFEC02, "O00") | regexm(AFEC02, "O01") | regexm(AFEC02, "O02") | regexm(AFEC02, "O03") | regexm(AFEC02, "O04") | regexm(AFEC02, "O05") | regexm(AFEC02, "O06") | regexm(AFEC02, "O07") | regexm(AFEC02, "O08")) 
>         
>         gen flag_3 = 1 if flag_prin == . & flag_1 == . & flag_2 == . & (regexm(AFEC03, "O00") | regexm(AFEC03, "O01") | regexm(AFEC03, "O02") | regexm(AFEC03, "O03") | regexm(AFEC03, "O04") | regexm(AFEC03, "O05") | regexm(AFEC03, "O06") | regexm(AFEC03, "O07") | regexm(AFEC03, "O08"))
>         
>         gen flag_4 = 1 if flag_prin == . & flag_1 == . & flag_2 == . & flag_3 == . & (regexm(AFEC04, "O00") | regexm(AFEC04, "O01") | regexm(AFEC04, "O02") | regexm(AFEC04, "O03") | regexm(AFEC04, "O04") | regexm(AFEC04, "O05") | regexm(AFEC04, "O06") | regexm(AFEC04, "O07") | regexm(AFEC04, "O08"))
>         
>         gen flag_5 = 1 if flag_prin == . & flag_1 == . & flag_2 == . & flag_3 == . & flag_4 == . & (regexm(AFEC05, "O00") | regexm(AFEC05, "O01") | regexm(AFEC05, "O02") | regexm(AFEC05, "O03") | regexm(AFEC05, "O04") | regexm(AFEC05, "O05") | regexm(AFEC05, "O06") | regexm(AFEC05, "O07") | regexm(AFEC05, "O08"))
>         
>         gen flag_6 = 1 if flag_prin == . & flag_1 == . & flag_2 == . & flag_3 == . & flag_4 == . & flag_5 == . & (regexm(AFEC06, "O00") | regexm(AFEC06, "O01") | regexm(AFEC06, "O02") | regexm(AFEC06, "O03") | regexm(AFEC06, "O04") | regexm(AFEC06, "O05") | regexm(AFEC06, "O06") | regexm(AFEC06, "O07") | regexm(AFEC06, "O08"))
>         
>         gen prin_or_other = 1 if flag_prin == 1 | flag_1 == 1 | flag_2 == 1 | flag_3 == 1| flag_4 == 1 | flag_5 == 1 | flag_6 == 1
>         
>         // Now create flags by code (O00, O01, etc.)
>         
>         forvalues i=0(1)8 {c -(}
>         
>         gen flag_prin_0`i' = 1 if regexm(afecprin, "O0`i'")
>         
>         gen flag_1_0`i' = 1 if flag_prin_0`i' == . & regexm(AFEC01, "O0`i'")
>         
>         gen flag_2_0`i' = 1 if flag_prin_0`i' == . & flag_1_0`i' == . & regexm(AFEC02, "O0`i'")
>         
>         gen flag_3_0`i' = 1 if flag_prin_0`i' == . & flag_1_0`i' == . & flag_2_0`i' == . & regexm(AFEC03, "O0`i'") 
>         
>         gen flag_4_0`i' = 1 if flag_prin_0`i' == . & flag_1_0`i' == . & flag_2_0`i' == . & flag_3_0`i'  == . & regexm(AFEC04, "O0`i'")
>         
>         gen flag_5_0`i' = 1 if flag_prin_0`i' == . & flag_1_0`i' == . & flag_2_0`i' == . & flag_3_0`i' & flag_4_0`i' == . & regexm(AFEC05, "O0`i'")
>         
>         gen flag_6_0`i' = 1 if flag_prin_0`i' == . & flag_1_0`i' == . & flag_2_0`i' == . & flag_3_0`i' & flag_4_0`i' == . & flag_5_0`i' == . & regexm(AFEC06, "O0`i'")
>         
>         gen prin_or_other_0`i' = 1 if flag_prin_0`i' == 1 | flag_1_0`i' == 1 | flag_2_0`i' == 1 | flag_3_0`i' == 1| flag_4_0`i' == 1 | flag_5_0`i' == 1 | flag_6_0`i' == 1
>         
> {c )-}
> *
>         
>         
> // Reshape long 
> 
>         forvalues i=1(1)6 {c -(} 
>                 rename AFEC0`i' AFEC`i'
>         {c )-}
>                 
>         rename afecprin AFEC0
>         
>         reshape long AFEC, i(clues edad afecprin egreso ingre year id folio) j(afec_num)
>          
>         save "`lily_data'/long_dataset.dta", replace 
>         
> 
> // Take a look at how many abortions we capture using the afeccion principal versus the other 6 afecciones at the woman-level 
> 
>         
>         use "`lily_data'/long_dataset.dta", clear 
>                 
>         replace AFEC = "" if regexm(afecprin, "O01|O02|O03|O04|O05|O06|O07|O08") & AFEC != afecprin
>         
>         gen abortion_afec1 = 1 if regexm(AFEC, "O01|O02|O03|O04|O05|O06|O07|O08") & afec_num == 1 
>         bysort clues edad afecprin egreso ingre year id folio: gen sum_abortion_afec1 = sum(abortion_afec1)
>         
>         forvalues i=2/6 {c -(} 
>                 replace AFEC = "" if regexm(AFEC, "O01|O02|O03|O04|O05|O06|O07|O08") & afec_num == `i' & sum_abortion_afec1 == 1
>         {c )-}
>         
>         
>         forvalues i=0/8 {c -(}
>                 bysort clues edad afecprin egreso ingre year id folio: gen count_prin_O0`i' = 1 if regexm(afecprin, "O0`i'") 
>                 bysort clues edad afecprin egreso ingre year id folio: gen count_prin_other_O0`i' = 1 if count_prin_O0`i' == 1 | regexm(AFEC, "O0`i'")
>         {c )-}
>         
>         
>         preserve                
>         collapse (mean) count_prin_other_O00 count_prin_O00 count_prin_other_O01 count_prin_O01 count_prin_other_O02 count_prin_O02 count_prin_other_O03 count_prin_O03 count_prin_other_O04 count_prin_O04 count_prin_other_O05 count_prin_O05 count_prin_other_O06 count_prin_O06 count_prin_other_O07 count_prin_O07 count_prin_other_O08 count_prin_O08, by(clues edad afecprin egreso ingre year id folio)
>         collapse (sum) count_prin_other_O00 count_prin_O00 count_prin_other_O01 count_prin_O01 count_prin_other_O02 count_prin_O02 count_prin_other_O03 count_prin_O03 count_prin_other_O04 count_prin_O04 count_prin_other_O05 count_prin_O05 count_prin_other_O06 count_prin_O06 count_prin_other_O07 count_prin_O07 count_prin_other_O08 count_prin_O08
>         
> 
>         
> // WHO CLASSIFICATION
>         
>         //use "`lily_data'/long_dataset.dta", clear
>         
> 
> */
.         gen afec_nos16 = substr(afecprin,1,3)
{txt}
{com}. 
. 
.         gen claswho = .
{txt}(1,256,100 missing values generated)

{com}.         
.                 *Ectopic pregnancy
.                 replace claswho = 1 if afec_nos16 == "O00" | afec_nos16 == "O01" 
{txt}(7,368 real changes made)

{com}.                 
.                 *Miscarriage 
.                 replace claswho = 2 if afec_nos16 == "O02" | afec_nos16 == "O03"
{txt}(49,833 real changes made)

{com}.                 
.                 *Abortion
.                 replace claswho = 3 if afec_nos16 == "O04" | afec_nos16 == "O05" | afec_nos16 == "O06" | afec_nos16 == "O07" | afec_nos16 == "O08" 
{txt}(90,215 real changes made)

{com}.                 replace claswho = 3 if tipaten == 1 & (afec_nos16 != "O00" & afec_nos16 != "O01" & afec_nos16 != "O02" & afec_nos16 != "O03" & afec_nos16 != "O04" & afec_nos16 != "O05" & afec_nos16 != "O06" & afec_nos16 != "O07" & afec_nos16 != "O08" )    
{txt}(13,628 real changes made)

{com}.                 
.                 *Other direct causes
.                 replace claswho = 4 if (afec_nos16 == "F53"|afec_nos16 == "O21"|afec_nos16 == "O26"|afec_nos16 == "O28"|afec_nos16 == "O30"|afec_nos16 == "O31"|afec_nos16 == "O32"|afec_nos16 == "O34"|afec_nos16 == "O35"|afec_nos16 == "O36"|afec_nos16 == "O40"|afec_nos16 == "O41"|afec_nos16 == "O410"|afec_nos16 == "O418"|afec_nos16 == "O419"|afec_nos16 == "O42"|afec_nos16 == "O43 "|afec_nos16 == "O47"|afec_nos16 == "O48"|afec_nos16 == "O60"|afec_nos16 == "O61"|afec_nos16 == "O68"|afec_nos16 == "O69"|afec_nos16 == "O73"|afec_nos16 == "O80"|afec_nos16 == "O81"|afec_nos16 == "O82"|afec_nos16 == "O83"|afec_nos16 == "O84"|afec_nos16 == "O90"|afec_nos16 == "O91"|afec_nos16 == "O92"|afec_nos16 == "Y87"|afecprin== "O717"|afecprin == "O440"|afecprin == "O244") 
{txt}(947,730 real changes made)

{com}.                 
.                 *Complicactions of anethesia
.                 replace claswho = 5 if (afec_nos16 == "O29"|afec_nos16 == "O74"|afec_nos16 == "O89")
{txt}(434 real changes made)

{com}.                 
.                 *Complications - obstetric trauma
.                 replace claswho = 6 if (afec_nos16 == "O71"|afecprin== "O715"|afecprin == "O716"|afecprin == "O718"|afecprin == "O719")
{txt}(388 real changes made)

{com}.                 
.                 *Complications -other-not specified
.                 replace claswho = 7 if (afec_nos16 == "O75"|afec_nos16 == "Y60"|afecprin == "O750"|afecprin == "O751"|afecprin == "O752"|afecprin== "O754"|afecprin == "O755"|afecprin == "O756"|afecprin == "O758"|afecprin == "O759")
{txt}(3,069 real changes made)

{com}.                 
.                 *Obstructed labor
.                 replace claswho = 8 if (afec_nos16 == "O33"|afec_nos16 == "O62"|afec_nos16 == "O63"|afec_nos16 == "O64"|afec_nos16 == "O65"|afec_nos16 == "O66")
{txt}(53,903 real changes made)

{com}.                 
.                 *Embolism
.                 replace claswho = 9 if (afec_nos16 == "O22"|afec_nos16 == "O87"|afec_nos16 == "O88")
{txt}(393 real changes made)

{com}.                 
.                 *Antenatal obstetric Haemorrage
.                 replace claswho = 10 if (afec_nos16 == "O44"|afec_nos16 == "O45"|afec_nos16 == "O46"|afecprin== "O710"|afecprin == "O441")
{txt}(4,453 real changes made)

{com}.                 
.                 *Intrapartum obstetric Haemorrage
.                 replace claswho = 11 if (afec_nos16 == "O67"|afec_nos16 == "O70"|afecprin == "O711"|afecprin == "O757")
{txt}(2,808 real changes made)

{com}.                 
.                 *Postpartum obstetric haemorrage
.                 replace claswho = 12 if (afec_nos16 == "O72"|afecprin == "O712")
{txt}(1,672 real changes made)

{com}.                 
.                 *Obstetric haemorrage - other
.                 replace claswho = 13 if (afec_nos16 == "O20"|afec_nos16 == "O713"|afec_nos16 == "O714")
{txt}(4,434 real changes made)

{com}.                 
.                 *Hypertensive disorders
.                 replace claswho = 14 if (afec_nos16 == "O10"|afec_nos16 == "O11"|afec_nos16 == "O12"|afec_nos16 == "O13"|afec_nos16 == "O14"|afec_nos16 == "O15"|afec_nos16 == "O16")
{txt}(40,792 real changes made)

{com}.                 
.                 *Pregnancy related sepsys
.                 replace claswho = 15 if (afec_nos16 == "A34"|afec_nos16 == "O85"|afec_nos16 == "O86"|afecprin == "O411"|afecprin == "O753")
{txt}(1,644 real changes made)

{com}.                 
.                 *Direct causes - other
.                 replace claswho = 16 if (afec_nos16 == "O95")
{txt}(1 real change made)

{com}.                 
.                 *Indirect causes â medical disorders
.                 replace claswho = 17 if (afec_nos16 == "O99" | afec_nos16 == "O24" & afecprin!="O244") 
{txt}(21,442 real changes made)

{com}.                 
.                 *Indirect causes â HIV related
.                 replace claswho = 18 if (afecprin == "O987")
{txt}(14 real changes made)

{com}.                 
.                 *Indirect causes - other
.                 replace claswho = 19 if (afec_nos16 == "I40"|afec_nos16 == "O23"|afec_nos16 == "O25"|afec_nos16 == "O98"|afecprin == "O980"|afecprin== "O981"|afecprin== "O982"|afecprin== "O983"|afecprin== "O984"|afecprin== "O985"|afecprin== "O986"|afecprin == "O988"|afecprin== "O989")
{txt}(8,463 real changes made)

{com}. 
. 
.         *labels clas_who
.         label define claswhOOO 1 "Ectopic pregnancy" 2 "Miscarriage" 3 "Abortion" 4 "Other direct" 5 "Compl anethesia" 6 "Comp obs trauma" 7 "Comp OthNotSpec" 8 "Obstru labor" 9 "Embolism" 10 "AntenObst Haemor" 11 "IntraparObste Haemor" 12 "PostparObst Haemor" 13 "ObstHaemor Other" 14 "Hypertensive disorders" 15 "PregRelat Sepsys" 16 "DireCaus Other" 17 "IndiCau MedDisorders" 18 "IndiCaus HIV rel" 19 "IndiCaus Other"
{txt}
{com}.         label values claswho claswhOOO
{txt}
{com}.         
.         **
. * ABORTO NOSOTROS por afeccion (sustituye a abort_nos) version LARGO
. **
. *drop aborto_nos
. gen aborto_nos =.
{txt}(1,256,100 missing values generated)

{com}. replace aborto_nos = 0 if afec_nos16 =="O00" 
{txt}(5,878 real changes made)

{com}. replace aborto_nos = 1 if afec_nos16 =="O01" 
{txt}(1,490 real changes made)

{com}. replace aborto_nos = 2 if afec_nos16 =="O02" 
{txt}(13,822 real changes made)

{com}. replace aborto_nos = 3 if afec_nos16 =="O03" 
{txt}(36,011 real changes made)

{com}. replace aborto_nos = 4 if afec_nos16 =="O04" 
{txt}(414 real changes made)

{com}. replace aborto_nos = 5 if afec_nos16 =="O05" 
{txt}(596 real changes made)

{com}. replace aborto_nos = 6 if afec_nos16 =="O06" 
{txt}(88,922 real changes made)

{com}. replace aborto_nos = 7 if afec_nos16 =="O07" 
{txt}(45 real changes made)

{com}. replace aborto_nos = 8 if afec_nos16 =="O08"
{txt}(238 real changes made)

{com}. replace aborto_nos = 9 if tipaten ==1 & aborto_nos==.  
{txt}(13,628 real changes made)

{com}. 
. tab aborto_nos

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      5,878        3.65        3.65
{txt}          1 {c |}{res}      1,490        0.93        4.58
{txt}          2 {c |}{res}     13,822        8.58       13.16
{txt}          3 {c |}{res}     36,011       22.36       35.52
{txt}          4 {c |}{res}        414        0.26       35.78
{txt}          5 {c |}{res}        596        0.37       36.15
{txt}          6 {c |}{res}     88,922       55.22       91.36
{txt}          7 {c |}{res}         45        0.03       91.39
{txt}          8 {c |}{res}        238        0.15       91.54
{txt}          9 {c |}{res}     13,628        8.46      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    161,044      100.00
{txt}
{com}. 
. label define obortonos16 0"O00 Ectopic" 1 "O01 Molar" 2 "O02 OthrProd" 3 "O03 Spontaneous" 4 "O04 Medical" 5 "O05 OthrAbort" 6 "O06 Unspecified" 7 "O07 FailAttem" 8 "O08 ComplEcMoAbo" 9 "TipAtenAbort" 
{txt}
{com}. label values aborto_nos obortonos16
{txt}
{com}. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      5,878        3.65        3.65
{txt}       O01 Molar {c |}{res}      1,490        0.93        4.58
{txt}    O02 OthrProd {c |}{res}     13,822        8.58       13.16
{txt} O03 Spontaneous {c |}{res}     36,011       22.36       35.52
{txt}     O04 Medical {c |}{res}        414        0.26       35.78
{txt}   O05 OthrAbort {c |}{res}        596        0.37       36.15
{txt} O06 Unspecified {c |}{res}     88,922       55.22       91.36
{txt}   O07 FailAttem {c |}{res}         45        0.03       91.39
{txt}O08 ComplEcMoAbo {c |}{res}        238        0.15       91.54
{txt}    TipAtenAbort {c |}{res}     13,628        8.46      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    161,044      100.00
{txt}
{com}. tab aborto_nos year

                 {txt}{c |}               year
      aborto_nos {c |}      2000       2001       2002 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}        32         13        100 {txt}{c |}{res}     5,878 
{txt}       O01 Molar {c |}{res}        44         29         79 {txt}{c |}{res}     1,490 
{txt}    O02 OthrProd {c |}{res}       497        351        636 {txt}{c |}{res}    13,822 
{txt} O03 Spontaneous {c |}{res}       771        905      1,928 {txt}{c |}{res}    36,011 
{txt}     O04 Medical {c |}{res}         6          0          2 {txt}{c |}{res}       414 
{txt}   O05 OthrAbort {c |}{res}         4         20          7 {txt}{c |}{res}       596 
{txt} O06 Unspecified {c |}{res}     3,802      3,191      4,150 {txt}{c |}{res}    88,922 
{txt}   O07 FailAttem {c |}{res}         1          3          0 {txt}{c |}{res}        45 
{txt}O08 ComplEcMoAbo {c |}{res}        12         26         24 {txt}{c |}{res}       238 
{txt}    TipAtenAbort {c |}{res}        50         98        194 {txt}{c |}{res}    13,628 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     5,219      4,636      7,120 {txt}{c |}{res}   161,044 


                 {txt}{c |}               year
      aborto_nos {c |}      2003       2004       2005 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       245        323        270 {txt}{c |}{res}     5,878 
{txt}       O01 Molar {c |}{res}       111         59         93 {txt}{c |}{res}     1,490 
{txt}    O02 OthrProd {c |}{res}       739        893        821 {txt}{c |}{res}    13,822 
{txt} O03 Spontaneous {c |}{res}     1,987      2,558      2,490 {txt}{c |}{res}    36,011 
{txt}     O04 Medical {c |}{res}         6         35          8 {txt}{c |}{res}       414 
{txt}   O05 OthrAbort {c |}{res}         7         20         65 {txt}{c |}{res}       596 
{txt} O06 Unspecified {c |}{res}     7,088      7,376      6,702 {txt}{c |}{res}    88,922 
{txt}   O07 FailAttem {c |}{res}         5          1          7 {txt}{c |}{res}        45 
{txt}O08 ComplEcMoAbo {c |}{res}        18          7          6 {txt}{c |}{res}       238 
{txt}    TipAtenAbort {c |}{res}       319        361        264 {txt}{c |}{res}    13,628 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}    10,525     11,633     10,726 {txt}{c |}{res}   161,044 


                 {txt}{c |}               year
      aborto_nos {c |}      2006       2007       2008 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       189        428        397 {txt}{c |}{res}     5,878 
{txt}       O01 Molar {c |}{res}        62        161        120 {txt}{c |}{res}     1,490 
{txt}    O02 OthrProd {c |}{res}       650      1,364      1,489 {txt}{c |}{res}    13,822 
{txt} O03 Spontaneous {c |}{res}     1,796      3,425      4,005 {txt}{c |}{res}    36,011 
{txt}     O04 Medical {c |}{res}        39        138         21 {txt}{c |}{res}       414 
{txt}   O05 OthrAbort {c |}{res}        49        109        202 {txt}{c |}{res}       596 
{txt} O06 Unspecified {c |}{res}     6,801      7,171      6,922 {txt}{c |}{res}    88,922 
{txt}   O07 FailAttem {c |}{res}         5          4          5 {txt}{c |}{res}        45 
{txt}O08 ComplEcMoAbo {c |}{res}        10         33         12 {txt}{c |}{res}       238 
{txt}    TipAtenAbort {c |}{res}       141      2,841      3,812 {txt}{c |}{res}    13,628 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     9,742     15,674     16,985 {txt}{c |}{res}   161,044 


                 {txt}{c |}               year
      aborto_nos {c |}      2009       2010       2011 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       590        578        649 {txt}{c |}{res}     5,878 
{txt}       O01 Molar {c |}{res}       147        120        135 {txt}{c |}{res}     1,490 
{txt}    O02 OthrProd {c |}{res}     1,356      1,156      1,029 {txt}{c |}{res}    13,822 
{txt} O03 Spontaneous {c |}{res}     3,932      3,129      2,928 {txt}{c |}{res}    36,011 
{txt}     O04 Medical {c |}{res}        20         32         43 {txt}{c |}{res}       414 
{txt}   O05 OthrAbort {c |}{res}        89          0          9 {txt}{c |}{res}       596 
{txt} O06 Unspecified {c |}{res}     5,787      6,271      6,025 {txt}{c |}{res}    88,922 
{txt}   O07 FailAttem {c |}{res}         0          5          5 {txt}{c |}{res}        45 
{txt}O08 ComplEcMoAbo {c |}{res}         6          2         61 {txt}{c |}{res}       238 
{txt}    TipAtenAbort {c |}{res}     2,485        971        832 {txt}{c |}{res}    13,628 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}    14,412     12,264     11,716 {txt}{c |}{res}   161,044 


                 {txt}{c |}               year
      aborto_nos {c |}      2012       2013       2014 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       698        706        660 {txt}{c |}{res}     5,878 
{txt}       O01 Molar {c |}{res}       106        109        115 {txt}{c |}{res}     1,490 
{txt}    O02 OthrProd {c |}{res}     1,126        980        735 {txt}{c |}{res}    13,822 
{txt} O03 Spontaneous {c |}{res}     2,457      1,813      1,887 {txt}{c |}{res}    36,011 
{txt}     O04 Medical {c |}{res}        43         16          5 {txt}{c |}{res}       414 
{txt}   O05 OthrAbort {c |}{res}        11          1          3 {txt}{c |}{res}       596 
{txt} O06 Unspecified {c |}{res}     6,253      5,743      5,640 {txt}{c |}{res}    88,922 
{txt}   O07 FailAttem {c |}{res}         3          1          0 {txt}{c |}{res}        45 
{txt}O08 ComplEcMoAbo {c |}{res}         7          4         10 {txt}{c |}{res}       238 
{txt}    TipAtenAbort {c |}{res}       481        405        374 {txt}{c |}{res}    13,628 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}    11,185      9,778      9,429 {txt}{c |}{res}   161,044 

{txt}
{com}. 
. * Eliminando duplicados para tipo de atencion aborto
. duplicates drop egreso clues folio if aborto_nos==9, force

{p 0 4}{txt}Duplicates in terms of {res} egreso clues folio{p_end}

{txt}(0 observations are duplicates)

{com}. **SOLO 1 DUPLICADO! EN TEORIA ESTA BIEN, PORQUE YA PEGAMOS SOLO CASOS UNICOS DE TIPO DE ATENCION ABORTO Y NO ABORTO NOSOTROS!!
. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      5,878        3.65        3.65
{txt}       O01 Molar {c |}{res}      1,490        0.93        4.58
{txt}    O02 OthrProd {c |}{res}     13,822        8.58       13.16
{txt} O03 Spontaneous {c |}{res}     36,011       22.36       35.52
{txt}     O04 Medical {c |}{res}        414        0.26       35.78
{txt}   O05 OthrAbort {c |}{res}        596        0.37       36.15
{txt} O06 Unspecified {c |}{res}     88,922       55.22       91.36
{txt}   O07 FailAttem {c |}{res}         45        0.03       91.39
{txt}O08 ComplEcMoAbo {c |}{res}        238        0.15       91.54
{txt}    TipAtenAbort {c |}{res}     13,628        8.46      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    161,044      100.00
{txt}
{com}. 
. 
. 
. **
. *OBSTETRICAS NOSOTROS por afeccion (sustituye a obs_nos)
. **
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" POR BLOQUE, version LARGO
. **      
. *drop obste_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obste_nos16=.
{txt}(1,256,100 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obste_nos16=1 if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(5,878 real changes made)
(1,490 real changes made)
(13,822 real changes made)
(36,011 real changes made)
(414 real changes made)
(596 real changes made)
(88,922 real changes made)
(45 real changes made)
(238 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obste_nos16=2 if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(4,091 real changes made)
(30 real changes made)
(9 real changes made)
(8,226 real changes made)
(24,511 real changes made)
(1,803 real changes made)
(2,122 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obste_nos16=3 if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(4,434 real changes made)
(439 real changes made)
(271 real changes made)
(6,227 real changes made)
(8,579 real changes made)
(38 real changes made)
(1,255 real changes made)
(0 real changes made)
(52 real changes made)
(24 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obste_nos16=4 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(4,500 real changes made)
(86 real changes made)
(8,946 real changes made)
(24,508 real changes made)
(21,167 real changes made)
(649 real changes made)
(19,683 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(791 real changes made)
(15,663 real changes made)
(39,462 real changes made)
(189 real changes made)
(2,225 real changes made)
(2,085 real changes made)
(119 real changes made)
(14,024 real changes made)
(2,435 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obste_nos16=5 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(30,771 real changes made)
(475 real changes made)
(6,042 real changes made)
(4,478 real changes made)
(8,272 real changes made)
(8,624 real changes made)
(1,979 real changes made)
(300 real changes made)
(22,325 real changes made)
(3,686 real changes made)
(1,044 real changes made)
(388 real changes made)
(1,656 real changes made)
(812 real changes made)
(130 real changes made)
(3,069 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obste_nos16=6 if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(602,825 real changes made)
(2,325 real changes made)
(144,247 real changes made)
(2,169 real changes made)
(1,871 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obste_nos16=7 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(188 real changes made)
(886 real changes made)
(93 real changes made)
(29 real changes made)
(280 real changes made)
(1,587 real changes made)
(80 real changes made)
(21 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obste_nos16=8 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(2 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(2,198 real changes made)
(17,315 real changes made)

{com}. 
.         replace obste_nos16 = 9 if (tipaten==0 & obste_nos16==.)
{txt}(6,169 real changes made)

{com}.         replace obste_nos16 = 10 if (tipaten==1 & obste_nos16==.)
{txt}(11,965 real changes made)

{com}.         
. label define obtetcnos16 1"O0-O0Abortive" 2 "O10-O16Edema" 3 "O20-O29RelPreg" 4 "O30-O48Fetus" 5 "O60-O75Labour" 6 "O80-O84Delivery" 7 "O85-O92Puerperium" 8 "O94-O99OthObst" 9 "TipAtenParto" 10 "TipAtenAborto"
{txt}
{com}. label values obste_nos16 obtetcnos16
{txt}
{com}. 
. tab obste_nos16

      {txt}obste_nos16 {c |}      Freq.     Percent        Cum.
{hline 18}{c +}{hline 35}
    O0-O0Abortive {c |}{res}    147,416       11.75       11.75
{txt}     O10-O16Edema {c |}{res}     40,792        3.25       15.00
{txt}   O20-O29RelPreg {c |}{res}     21,319        1.70       16.70
{txt}     O30-O48Fetus {c |}{res}    156,532       12.48       29.18
{txt}    O60-O75Labour {c |}{res}     94,051        7.50       36.68
{txt}  O80-O84Delivery {c |}{res}    753,437       60.07       96.75
{txt}O85-O92Puerperium {c |}{res}      3,164        0.25       97.00
{txt}   O94-O99OthObst {c |}{res}     19,516        1.56       98.55
{txt}     TipAtenParto {c |}{res}      6,169        0.49       99.05
{txt}    TipAtenAborto {c |}{res}     11,965        0.95      100.00
{txt}{hline 18}{c +}{hline 35}
            Total {c |}{res}  1,254,361      100.00
{txt}
{com}. 
. 
. **
. *PARTO NOSOTROS (sustituye a part_nos)
. **
. * CREACION DE VARIABLE "PArto SEGUN NOSOTROS"
. *
. *drop part_nos16
. gen part_nos16 =.
{txt}(1,256,100 missing values generated)

{com}. 
. ***Delivery ICD-10      
. replace part_nos16=0 if afec_nos16=="O80" 
{txt}(602,825 real changes made)

{com}. replace part_nos16=1 if afec_nos16=="O81" 
{txt}(2,325 real changes made)

{com}. replace part_nos16=2 if afec_nos16=="O82" 
{txt}(144,247 real changes made)

{com}. replace part_nos16=3 if afec_nos16=="O83" 
{txt}(2,169 real changes made)

{com}. replace part_nos16=4 if afec_nos16=="O84" 
{txt}(1,871 real changes made)

{com}. replace part_nos16 = 5 if (tipaten==0 & part_nos16==.)
{txt}(295,127 real changes made)

{com}. 
. tab part_nos if prueb==0

 {txt}part_nos16 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}    602,825       57.49       57.49
{txt}          1 {c |}{res}      2,325        0.22       57.71
{txt}          2 {c |}{res}    144,247       13.76       71.47
{txt}          3 {c |}{res}      2,169        0.21       71.68
{txt}          4 {c |}{res}      1,871        0.18       71.85
{txt}          5 {c |}{res}    295,127       28.15      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  1,048,564      100.00
{txt}
{com}. tab part_nos16

 {txt}part_nos16 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}    602,825       57.49       57.49
{txt}          1 {c |}{res}      2,325        0.22       57.71
{txt}          2 {c |}{res}    144,247       13.76       71.47
{txt}          3 {c |}{res}      2,169        0.21       71.68
{txt}          4 {c |}{res}      1,871        0.18       71.85
{txt}          5 {c |}{res}    295,127       28.15      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  1,048,564      100.00
{txt}
{com}. 
. label define partonso16 0 "O80 Un solo parto espontaneo" 1 "O81 Un solo parto con forceps y aspirad" 2 "O82 Un solo parto por cesarea" 3 "O83 Otro parto unico asistido" 4 "O84 Parto multiple" 5 "TipoAtencion Parto" 
{txt}
{com}. label values part_nos16 partonso16
{txt}
{com}. 
. 
. 
. **
. * CREACION VARIANLE "MISSING NOSOTROS16" si no tiene aborto_nos ni part_nos16 entonces es miss_nos16
. **
. *drop miss_nos16
. gen miss_nos16 = .
{txt}(1,256,100 missing values generated)

{com}. replace miss_nos16 = 1 if aborto_nos==. & part_nos16==.
{txt}(46,905 real changes made)

{com}. 
. label define missnsot16 1 "Missing nosotros" 
{txt}
{com}. label values miss_nos16 missnsot16
{txt}
{com}. 
. tab miss_nos16

      {txt}miss_nos16 {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
Missing nosotros {c |}{res}     46,905      100.00      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}     46,905      100.00
{txt}
{com}. 
. tab afec_nos16 miss_nos16

           {txt}{c |} miss_nos16
afec_nos16 {c |} Missing n {c |}     Total
{hline 11}{c +}{hline 11}{c +}{hline 10}
       A09 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       A41 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       A51 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       A63 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       B01 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       B08 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       B23 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       B24 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       B34 {c |}{res}        13 {txt}{c |}{res}        13 
{txt}       B37 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       B95 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       C50 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       C53 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       C56 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       C58 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D24 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       D25 {c |}{res}       105 {txt}{c |}{res}       105 
{txt}       D26 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       D27 {c |}{res}         8 {txt}{c |}{res}         8 
{txt}       D28 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D35 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D37 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D39 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       D44 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D48 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D50 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D58 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       D64 {c |}{res}         9 {txt}{c |}{res}         9 
{txt}       D65 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       D69 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       E03 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       E05 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E10 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E11 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       E12 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E14 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E16 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E66 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       E72 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E78 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       E87 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       F06 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F14 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F16 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F18 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F19 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F20 {c |}{res}         9 {txt}{c |}{res}         9 
{txt}       F23 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F31 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       F32 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       F33 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F34 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F43 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       F60 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       F73 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       G04 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       G08 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       G20 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       G40 {c |}{res}         7 {txt}{c |}{res}         7 
{txt}       G43 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       G45 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       G51 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       G93 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       H10 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I05 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I10 {c |}{res}         8 {txt}{c |}{res}         8 
{txt}       I12 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I15 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I23 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I41 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I42 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       I45 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I49 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I50 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       I60 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I61 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       I64 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I66 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I67 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I80 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I82 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       I83 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I87 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       I99 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       J04 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       J06 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       J09 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       J10 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       J18 {c |}{res}         7 {txt}{c |}{res}         7 
{txt}       J45 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       J46 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       J92 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       J98 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       K21 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       K31 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       K35 {c |}{res}        19 {txt}{c |}{res}        19 
{txt}       K37 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       K42 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       K46 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       K61 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       K65 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       K72 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       K80 {c |}{res}        18 {txt}{c |}{res}        18 
{txt}       K81 {c |}{res}         9 {txt}{c |}{res}         9 
{txt}       K82 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       K85 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       K86 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       L02 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       L03 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       L05 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       L52 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       L80 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       M08 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       M54 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       M72 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       M79 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N00 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N05 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N11 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       N12 {c |}{res}        14 {txt}{c |}{res}        14 
{txt}       N13 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       N17 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       N18 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       N20 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       N30 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       N34 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N39 {c |}{res}        60 {txt}{c |}{res}        60 
{txt}       N60 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N63 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       N70 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N71 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       N72 {c |}{res}        14 {txt}{c |}{res}        14 
{txt}       N73 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       N75 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       N76 {c |}{res}        21 {txt}{c |}{res}        21 
{txt}       N80 {c |}{res}        17 {txt}{c |}{res}        17 
{txt}       N81 {c |}{res}        11 {txt}{c |}{res}        11 
{txt}       N83 {c |}{res}        15 {txt}{c |}{res}        15 
{txt}       N84 {c |}{res}         7 {txt}{c |}{res}         7 
{txt}       N85 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       N86 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N87 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N89 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N90 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       N91 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       N93 {c |}{res}        41 {txt}{c |}{res}        41 
{txt}       N94 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       N95 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       N96 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       N97 {c |}{res}        62 {txt}{c |}{res}        62 
{txt}       O10 {c |}{res}       652 {txt}{c |}{res}       652 
{txt}       O11 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       O12 {c |}{res}         7 {txt}{c |}{res}         7 
{txt}       O13 {c |}{res}     1,072 {txt}{c |}{res}     1,072 
{txt}       O14 {c |}{res}     1,711 {txt}{c |}{res}     1,711 
{txt}       O15 {c |}{res}       206 {txt}{c |}{res}       206 
{txt}       O16 {c |}{res}       419 {txt}{c |}{res}       419 
{txt}       O20 {c |}{res}     4,284 {txt}{c |}{res}     4,284 
{txt}       O21 {c |}{res}       419 {txt}{c |}{res}       419 
{txt}       O22 {c |}{res}        88 {txt}{c |}{res}        88 
{txt}       O23 {c |}{res}     5,047 {txt}{c |}{res}     5,047 
{txt}       O24 {c |}{res}     3,203 {txt}{c |}{res}     3,203 
{txt}       O25 {c |}{res}         9 {txt}{c |}{res}         9 
{txt}       O26 {c |}{res}       474 {txt}{c |}{res}       474 
{txt}       O28 {c |}{res}         8 {txt}{c |}{res}         8 
{txt}       O29 {c |}{res}        11 {txt}{c |}{res}        11 
{txt}       O30 {c |}{res}       235 {txt}{c |}{res}       235 
{txt}       O31 {c |}{res}        13 {txt}{c |}{res}        13 
{txt}       O32 {c |}{res}        58 {txt}{c |}{res}        58 
{txt}       O33 {c |}{res}       123 {txt}{c |}{res}       123 
{txt}       O34 {c |}{res}       677 {txt}{c |}{res}       677 
{txt}       O35 {c |}{res}        59 {txt}{c |}{res}        59 
{txt}       O36 {c |}{res}       349 {txt}{c |}{res}       349 
{txt}       O40 {c |}{res}       100 {txt}{c |}{res}       100 
{txt}       O41 {c |}{res}       434 {txt}{c |}{res}       434 
{txt}       O42 {c |}{res}       557 {txt}{c |}{res}       557 
{txt}       O43 {c |}{res}        52 {txt}{c |}{res}        52 
{txt}       O44 {c |}{res}       337 {txt}{c |}{res}       337 
{txt}       O45 {c |}{res}        47 {txt}{c |}{res}        47 
{txt}       O46 {c |}{res}        39 {txt}{c |}{res}        39 
{txt}       O47 {c |}{res}    12,857 {txt}{c |}{res}    12,857 
{txt}       O48 {c |}{res}        41 {txt}{c |}{res}        41 
{txt}       O60 {c |}{res}     2,094 {txt}{c |}{res}     2,094 
{txt}       O61 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       O62 {c |}{res}        94 {txt}{c |}{res}        94 
{txt}       O63 {c |}{res}        52 {txt}{c |}{res}        52 
{txt}       O64 {c |}{res}        30 {txt}{c |}{res}        30 
{txt}       O65 {c |}{res}         9 {txt}{c |}{res}         9 
{txt}       O66 {c |}{res}        22 {txt}{c |}{res}        22 
{txt}       O67 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       O68 {c |}{res}       153 {txt}{c |}{res}       153 
{txt}       O69 {c |}{res}        24 {txt}{c |}{res}        24 
{txt}       O70 {c |}{res}        32 {txt}{c |}{res}        32 
{txt}       O71 {c |}{res}       111 {txt}{c |}{res}       111 
{txt}       O72 {c |}{res}       740 {txt}{c |}{res}       740 
{txt}       O73 {c |}{res}       421 {txt}{c |}{res}       421 
{txt}       O74 {c |}{res}        57 {txt}{c |}{res}        57 
{txt}       O75 {c |}{res}        94 {txt}{c |}{res}        94 
{txt}       O85 {c |}{res}        99 {txt}{c |}{res}        99 
{txt}       O86 {c |}{res}       514 {txt}{c |}{res}       514 
{txt}       O87 {c |}{res}        21 {txt}{c |}{res}        21 
{txt}       O88 {c |}{res}         5 {txt}{c |}{res}         5 
{txt}       O89 {c |}{res}        22 {txt}{c |}{res}        22 
{txt}       O90 {c |}{res}     1,292 {txt}{c |}{res}     1,292 
{txt}       O91 {c |}{res}        61 {txt}{c |}{res}        61 
{txt}       O92 {c |}{res}        12 {txt}{c |}{res}        12 
{txt}       O94 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       O98 {c |}{res}       192 {txt}{c |}{res}       192 
{txt}       O99 {c |}{res}     5,408 {txt}{c |}{res}     5,408 
{txt}       P02 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       P05 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       P07 {c |}{res}         9 {txt}{c |}{res}         9 
{txt}       P21 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       P22 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       P23 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       P36 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       P59 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       P70 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       P77 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q04 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q15 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q20 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q21 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q23 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q24 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       Q25 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q26 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q50 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q51 {c |}{res}         8 {txt}{c |}{res}         8 
{txt}       Q52 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q60 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q64 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q69 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q79 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       Q85 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Q89 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       R10 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       R17 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       R22 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       R31 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       R32 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       R50 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       R57 {c |}{res}         4 {txt}{c |}{res}         4 
{txt}       R58 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       R69 {c |}{res}        52 {txt}{c |}{res}        52 
{txt}       S05 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       S06 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       S13 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       S30 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       S35 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       S36 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       S37 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       S39 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       S70 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       S72 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       S80 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T00 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       T07 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T14 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       T19 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T29 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       T31 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T40 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T43 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       T65 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T74 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T78 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       T81 {c |}{res}        10 {txt}{c |}{res}        10 
{txt}       T83 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       T88 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       Z03 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Z10 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       Z21 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Z28 {c |}{res}         3 {txt}{c |}{res}         3 
{txt}       Z30 {c |}{res}        79 {txt}{c |}{res}        79 
{txt}       Z31 {c |}{res}         2 {txt}{c |}{res}         2 
{txt}       Z32 {c |}{res}       157 {txt}{c |}{res}       157 
{txt}       Z33 {c |}{res}        49 {txt}{c |}{res}        49 
{txt}       Z34 {c |}{res}        87 {txt}{c |}{res}        87 
{txt}       Z35 {c |}{res}       173 {txt}{c |}{res}       173 
{txt}       Z38 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Z39 {c |}{res}        28 {txt}{c |}{res}        28 
{txt}       Z40 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Z48 {c |}{res}        24 {txt}{c |}{res}        24 
{txt}       Z51 {c |}{res}        86 {txt}{c |}{res}        86 
{txt}       Z53 {c |}{res}        62 {txt}{c |}{res}        62 
{txt}       Z71 {c |}{res}        15 {txt}{c |}{res}        15 
{txt}       Z76 {c |}{res}        30 {txt}{c |}{res}        30 
{txt}       Z91 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Z94 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}       Z98 {c |}{res}         6 {txt}{c |}{res}         6 
{txt}       z32 {c |}{res}         1 {txt}{c |}{res}         1 
{txt}{hline 11}{c +}{hline 11}{c +}{hline 10}
     Total {c |}{res}    46,905 {txt}{c |}{res}    46,905 

{txt}
{com}. 
. 
. 
. 
. **
. *TIPO DE ATENCION NOSOTROS, por todas las afecciones, version largo
. **
. *Aborto nosotros, Parto nosotros, AbortParto Nosotros y Missing Nosotros
. *drop tipaten_nos16
. gen tipaten_nos16 =.
{txt}(1,256,100 missing values generated)

{com}. replace tipaten_nos16 = 0 if aborto_nos!=. & part_nos16==. & miss_nos16==. /*aborto*/
{txt}(160,631 real changes made)

{com}. replace tipaten_nos16 = 1 if part_nos16!=. & aborto_nos==. & miss_nos16==. /*parto*/
{txt}(1,048,151 real changes made)

{com}. replace tipaten_nos16 = 2 if aborto_nos!=. & part_nos16!=. & miss_nos16==. /*abortoParto*/
{txt}(413 real changes made)

{com}. replace tipaten_nos16 = 3 if aborto_nos==. & part_nos16==.
{txt}(46,905 real changes made)

{com}. 
. label define tipatenos 0 "Aborto Nosotros" 1 "Parto Nosotros" 2 "Aborto&Parto Nosotros" 3 "Missing Nosotros" 
{txt}
{com}. label values tipaten_nos16 tipatenos
{txt}
{com}. 
. tab tipaten_nos16

        {txt}tipaten_nos16 {c |}      Freq.     Percent        Cum.
{hline 22}{c +}{hline 35}
      Aborto Nosotros {c |}{res}    160,631       12.79       12.79
{txt}       Parto Nosotros {c |}{res}  1,048,151       83.44       96.23
{txt}Aborto&Parto Nosotros {c |}{res}        413        0.03       96.27
{txt}     Missing Nosotros {c |}{res}     46,905        3.73      100.00
{txt}{hline 22}{c +}{hline 35}
                Total {c |}{res}  1,256,100      100.00
{txt}
{com}. 
. 
. 
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" individual
. **      
. *drop obsteInd_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obsteInd_nos16=.
{txt}(1,256,100 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(5,878 real changes made)
(1,490 real changes made)
(13,822 real changes made)
(36,011 real changes made)
(414 real changes made)
(596 real changes made)
(88,922 real changes made)
(45 real changes made)
(238 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=10+`i'  if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(4,091 real changes made)
(30 real changes made)
(9 real changes made)
(8,226 real changes made)
(24,511 real changes made)
(1,803 real changes made)
(2,122 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=20+`i'  if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(4,434 real changes made)
(439 real changes made)
(271 real changes made)
(6,227 real changes made)
(8,579 real changes made)
(38 real changes made)
(1,255 real changes made)
(0 real changes made)
(52 real changes made)
(24 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(4,500 real changes made)
(86 real changes made)
(8,946 real changes made)
(24,508 real changes made)
(21,167 real changes made)
(649 real changes made)
(19,683 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(791 real changes made)
(15,663 real changes made)
(39,462 real changes made)
(189 real changes made)
(2,225 real changes made)
(2,085 real changes made)
(119 real changes made)
(14,024 real changes made)
(2,435 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(30,771 real changes made)
(475 real changes made)
(6,042 real changes made)
(4,478 real changes made)
(8,272 real changes made)
(8,624 real changes made)
(1,979 real changes made)
(300 real changes made)
(22,325 real changes made)
(3,686 real changes made)
(1,044 real changes made)
(388 real changes made)
(1,656 real changes made)
(812 real changes made)
(130 real changes made)
(3,069 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=80+`i' if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(602,825 real changes made)
(2,325 real changes made)
(144,247 real changes made)
(2,169 real changes made)
(1,871 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(188 real changes made)
(886 real changes made)
(93 real changes made)
(29 real changes made)
(280 real changes made)
(1,587 real changes made)
(80 real changes made)
(21 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(2 real changes made)
(1 real change made)
(0 real changes made)
(0 real changes made)
(2,198 real changes made)
(17,315 real changes made)

{com}. 
.         replace obsteInd_nos16 = 100 if (tipaten==0 & obsteInd_nos16==.)
{txt}(6,169 real changes made)

{com}.         replace obsteInd_nos16 = 101 if (tipaten==1 & obsteInd_nos16==.)
{txt}(11,965 real changes made)

{com}.         
. 
. **** A valores de categorÓ¡s ****
. label define obtetIncnos /* Primera categoria */ 0 "O00 Embarazo ectopico" 1 "O01 Mola Hidaltiforme" 2 "O02 Otros productos anormales" 3 "O03 Aborto espontaneo" 4 "O04 Aborto medico" 5 "O05 Otro aborto" 6 "O06 Aborto inespecifico" 7 "O07 Intento fallido" 8 "O08 Complicaciones despues de aborto/ect/molar" /* Segunda categoria */ 10 "O10 Hipertension pre-existente complicada con embarazo, parto y puerperio" 11 "O11 Pre-eclampsia superpuesta a hipertension cronica" 12 "O12 Edema y proteinuria gestacional sin hipertension" 13 "O13 Hipertension gestacional" 14 "O14 Pre-eclampsia" 15 "O15 Eclampsia" 16 "O16 Hipertension materna inespecificada"  /* Tercera categoria */ 20 "O20 Hemorragia temprana" 21 "O21 Vomito excesivo" 22 "O22 Complicaciones en venas y hemorroides" 23 "O23 Infecciones en tracto genitourinario" 24 "O24 Diabetes mellitus" 25 "O25 Malnutricion en embarazo" 26 "O26 Atencion para otras condiciones" 28 "O28 Hallazgos anormales en atencion pre-natal" 29 "O29 Complicaciones de anestesia durante el embarazo"/* Cuarta categoria */ 30 "O30 Gestacion multiple" 31 "O31 Complicaciones de gestacion multiple" 32 "O32 Atencion para malpresentacion del feto" 33 "O33 Atencion para desproporcion del feto" 34 "O34 Atencion para anormalidad de los organos pelvicos" 35 "O35 Atencion para anormalidad del feto" 36 "O36 Atencion para otros problemas fetales" 40 "O40 Polyhydramnios" 41 "O41 Otros desordenes de fluido amniotico y membranas" 42 "O42 Ruptura prematura de membranas" 43 "O43 Desordenes de placenta" 44 "O44 Placenta praevia" 45 "O45 Separacion prematura de placenta" 46 "O46 Hemorragia antes del parto no clasificada" 47 "O47 Falsa labor" 48 "O48 Embarazo prolongado" /* Quinta categoria */ 60 "O60 Labor y parto pretermino" 61 "O61 Induccion de labor fallida" 62 "O62 Anormalidades en las impulsoras de labor" 63 "O63 Labor extendida" 64 "O64 Labor obstruida por malposicion o malpresentacion de feto" 65 "O65 Labor obstruida por anormalidad pelvica de la madre" 66 "O66 Otra labor obstruida" 67 "O67 Labor y parto complicados por hemorragia intraparto no clasificada en otra parte" 68 "O68 Labor y parto complicados por estres fetal" 69 "O69 Labor y parto complicados por complicaciones con el cordon umbilical" 70 "O70 Laceracion perineal durante el parto" 71 "O71 Otro trauma obstetrico" 72 "O72 Hemorragia post-parto" 73 "O73 Placenta y membranas retenidos sin hemorragia" 74 "O74 Complicaciones de anestesia durante labor y parto" 75 "O75 Otras complicaciones de parto y labor no clasificadas" /* Sexta categoria */ 80 "O80 Un solo parto espontaneo" 81 "O81 Un solo parto con forceps y aspirado" 82 "O82 Un solo parto por cesarea" 83 "O83 Otro parto unico asistido" 84 "O84 Parto multiple" /* Septima categoria */ 85 "O85 Sepsis puerperal" 86 "O86 Otras infecciones puerperales" 87 "O87 Complicaciones en venas y hemorroides en el puerperio" 88 "O88 Embolia obstetrica" 89 "O89 Complicaciones de anestesia durante el puerperio" 90 "O90 Complicaciones del puerperio no clasificadas" 91 "O91 Infecciones de pecho asociadas con el nacimiento" 92 "O92 Otros desordenes de pecho y lactancia asociados al nacimiento"  /* Octava categoria */94 "O94 Secuela de complicacion en embarazo, parto y puerperio" 95 "O95 Muerte obstetrica de causa inespecifica" 96 "O96 Muerte por alguna causa obstetrica ocurrida despues de 42 dias pero antes de un despues del parto" 97 "O97 Muerte por secuela de causas obstetricas" 98 "O98 Infeccion materna y enfermedades parasitarias complicando el embarazo, parto y puerperio" 99 "O99 Otras enfermedades maternas complicando el embarazo, parto y puerperio" 100 "TipAtenPArto" 101 "TipAtenAborto"
{txt}
{com}. label values obsteInd_nos16 obtetIncnos
{txt}
{com}. 
. tab obsteInd_nos16

                         {txt}obsteInd_nos16 {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                  O00 Embarazo ectopico {c |}{res}      5,878        0.47        0.47
{txt}                  O01 Mola Hidaltiforme {c |}{res}      1,490        0.12        0.59
{txt}          O02 Otros productos anormales {c |}{res}     13,822        1.10        1.69
{txt}                  O03 Aborto espontaneo {c |}{res}     36,011        2.87        4.56
{txt}                      O04 Aborto medico {c |}{res}        414        0.03        4.59
{txt}                        O05 Otro aborto {c |}{res}        596        0.05        4.64
{txt}                O06 Aborto inespecifico {c |}{res}     88,922        7.09       11.73
{txt}                    O07 Intento fallido {c |}{res}         45        0.00       11.73
{txt}O08 Complicaciones despues de aborto/ec {c |}{res}        238        0.02       11.75
{txt}O10 Hipertension pre-existente complica {c |}{res}      4,091        0.33       12.08
{txt}O11 Pre-eclampsia superpuesta a hiperte {c |}{res}         30        0.00       12.08
{txt}O12 Edema y proteinuria gestacional sin {c |}{res}          9        0.00       12.08
{txt}           O13 Hipertension gestacional {c |}{res}      8,226        0.66       12.74
{txt}                      O14 Pre-eclampsia {c |}{res}     24,511        1.95       14.69
{txt}                          O15 Eclampsia {c |}{res}      1,803        0.14       14.84
{txt}O16 Hipertension materna inespecificada {c |}{res}      2,122        0.17       15.00
{txt}                O20 Hemorragia temprana {c |}{res}      4,434        0.35       15.36
{txt}                    O21 Vomito excesivo {c |}{res}        439        0.03       15.39
{txt}O22 Complicaciones en venas y hemorroid {c |}{res}        271        0.02       15.41
{txt}O23 Infecciones en tracto genitourinari {c |}{res}      6,227        0.50       15.91
{txt}                  O24 Diabetes mellitus {c |}{res}      8,579        0.68       16.59
{txt}           O25 Malnutricion en embarazo {c |}{res}         38        0.00       16.60
{txt}    O26 Atencion para otras condiciones {c |}{res}      1,255        0.10       16.70
{txt}O28 Hallazgos anormales en atencion pre {c |}{res}         52        0.00       16.70
{txt}O29 Complicaciones de anestesia durante {c |}{res}         24        0.00       16.70
{txt}                 O30 Gestacion multiple {c |}{res}      4,500        0.36       17.06
{txt}O31 Complicaciones de gestacion multipl {c |}{res}         86        0.01       17.07
{txt}O32 Atencion para malpresentacion del f {c |}{res}      8,946        0.71       17.78
{txt}O33 Atencion para desproporcion del fet {c |}{res}     24,508        1.95       19.74
{txt}O34 Atencion para anormalidad de los or {c |}{res}     21,167        1.69       21.42
{txt} O35 Atencion para anormalidad del feto {c |}{res}        649        0.05       21.48
{txt}O36 Atencion para otros problemas fetal {c |}{res}     19,683        1.57       23.04
{txt}                     O40 Polyhydramnios {c |}{res}        791        0.06       23.11
{txt}O41 Otros desordenes de fluido amniotic {c |}{res}     15,663        1.25       24.36
{txt}     O42 Ruptura prematura de membranas {c |}{res}     39,462        3.15       27.50
{txt}             O43 Desordenes de placenta {c |}{res}        189        0.02       27.52
{txt}                   O44 Placenta praevia {c |}{res}      2,225        0.18       27.70
{txt}   O45 Separacion prematura de placenta {c |}{res}      2,085        0.17       27.86
{txt}O46 Hemorragia antes del parto no clasi {c |}{res}        119        0.01       27.87
{txt}                        O47 Falsa labor {c |}{res}     14,024        1.12       28.99
{txt}                O48 Embarazo prolongado {c |}{res}      2,435        0.19       29.18
{txt}           O60 Labor y parto pretermino {c |}{res}     30,771        2.45       31.64
{txt}         O61 Induccion de labor fallida {c |}{res}        475        0.04       31.67
{txt}O62 Anormalidades en las impulsoras de  {c |}{res}      6,042        0.48       32.16
{txt}                    O63 Labor extendida {c |}{res}      4,478        0.36       32.51
{txt}O64 Labor obstruida por malposicion o m {c |}{res}      8,272        0.66       33.17
{txt}O65 Labor obstruida por anormalidad pel {c |}{res}      8,624        0.69       33.86
{txt}               O66 Otra labor obstruida {c |}{res}      1,979        0.16       34.02
{txt}O67 Labor y parto complicados por hemor {c |}{res}        300        0.02       34.04
{txt}O68 Labor y parto complicados por estre {c |}{res}     22,325        1.78       35.82
{txt}O69 Labor y parto complicados por compl {c |}{res}      3,686        0.29       36.11
{txt}O70 Laceracion perineal durante el part {c |}{res}      1,044        0.08       36.20
{txt}             O71 Otro trauma obstetrico {c |}{res}        388        0.03       36.23
{txt}              O72 Hemorragia post-parto {c |}{res}      1,656        0.13       36.36
{txt}O73 Placenta y membranas retenidos sin  {c |}{res}        812        0.06       36.43
{txt}O74 Complicaciones de anestesia durante {c |}{res}        130        0.01       36.44
{txt}O75 Otras complicaciones de parto y lab {c |}{res}      3,069        0.24       36.68
{txt}           O80 Un solo parto espontaneo {c |}{res}    602,825       48.06       84.74
{txt}O81 Un solo parto con forceps y aspirad {c |}{res}      2,325        0.19       84.92
{txt}          O82 Un solo parto por cesarea {c |}{res}    144,247       11.50       96.42
{txt}          O83 Otro parto unico asistido {c |}{res}      2,169        0.17       96.60
{txt}                     O84 Parto multiple {c |}{res}      1,871        0.15       96.75
{txt}                   O85 Sepsis puerperal {c |}{res}        188        0.01       96.76
{txt}      O86 Otras infecciones puerperales {c |}{res}        886        0.07       96.83
{txt}O87 Complicaciones en venas y hemorroid {c |}{res}         93        0.01       96.84
{txt}                 O88 Embolia obstetrica {c |}{res}         29        0.00       96.84
{txt}O89 Complicaciones de anestesia durante {c |}{res}        280        0.02       96.86
{txt}O90 Complicaciones del puerperio no cla {c |}{res}      1,587        0.13       96.99
{txt}O91 Infecciones de pecho asociadas con  {c |}{res}         80        0.01       97.00
{txt}O92 Otros desordenes de pecho y lactanc {c |}{res}         21        0.00       97.00
{txt}O94 Secuela de complicacion en embarazo {c |}{res}          2        0.00       97.00
{txt}O95 Muerte obstetrica de causa inespeci {c |}{res}          1        0.00       97.00
{txt}O98 Infeccion materna y enfermedades pa {c |}{res}      2,198        0.18       97.17
{txt}O99 Otras enfermedades maternas complic {c |}{res}     17,315        1.38       98.55
{txt}                           TipAtenPArto {c |}{res}      6,169        0.49       99.05
{txt}                          TipAtenAborto {c |}{res}     11,965        0.95      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}  1,254,361      100.00
{txt}
{com}. 
. 
. 
. *******************
. *PARTE 7
. ******************
. 
. *VARIABLES Y TABLAS PARA MANUSCRITO 
. 
. **CREACIÃN DE VARIABLES
. **
. 
. *generando Grandes Grupos de EDAD
. *drop edad_nos
. gen edad_nos=.
{txt}(1,256,100 missing values generated)

{com}. replace edad_nos=1 if edad <18 & edad!=.
{txt}(147,604 real changes made)

{com}. replace edad_nos=2 if edad <26 & edad_nos==.
{txt}(656,391 real changes made)

{com}. replace edad_nos=3 if edad <31 & edad_nos==.
{txt}(240,100 real changes made)

{com}. replace edad_nos=4 if edad <41 & edad_nos==.
{txt}(197,481 real changes made)

{com}. replace edad_nos=5 if edad >40 & edad_nos==.
{txt}(14,524 real changes made)

{com}. 
. label define edadnos 1  "< 18" 2  "18 - 25" 3  "26 - 30" 4  "31 - 40" 5  "> 40" 
{txt}
{com}. label values edad_nos edadnos
{txt}
{com}. 
. *generando la vairble de 2do trimestre tardio hasta semana 24 con tres categorias
. *drop trim23
. gen trim23 = .
{txt}(1,256,100 missing values generated)

{com}. replace trim23 = 1 if  gestac < 17 & gestac > 12
{txt}(6,954 real changes made)

{com}. replace trim23 = 2 if  gestac < 21 & gestac > 16
{txt}(6,773 real changes made)

{com}. replace trim23 = 3 if  gestac < 25 & gestac > 20
{txt}(4,792 real changes made)

{com}. 
. label define trimeSS23 1  "13-16" 2  "17-20" 3 "21-24"
{txt}
{com}. label values trim23 trimeSS23
{txt}
{com}. 
. **
. **TABLAS
. **
. 
. *total de EGERESOS de 2007 a 2014
. count if year!=. & year >2006
  {res}723,854
{txt}
{com}. 
. *total de abortos
. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}      9,235        9.65        9.65
{txt} O03 Spontaneous {c |}{res}     23,576       24.63       34.28
{txt}     O04 Medical {c |}{res}        318        0.33       34.61
{txt}   O05 OthrAbort {c |}{res}        424        0.44       35.05
{txt} O06 Unspecified {c |}{res}     49,812       52.04       87.09
{txt}   O07 FailAttem {c |}{res}         23        0.02       87.11
{txt}O08 ComplEcMoAbo {c |}{res}        135        0.14       87.25
{txt}    TipAtenAbort {c |}{res}     12,201       12.75      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}     95,724      100.00
{txt}
{com}. 
. *aborto que tienen edad gestacional de 2007 a 2014
. tab aborto_nos if gestac!=. & aborto_nos!=0     & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}      4,694        7.83        7.83
{txt} O03 Spontaneous {c |}{res}     12,624       21.06       28.89
{txt}     O04 Medical {c |}{res}        164        0.27       29.16
{txt}   O05 OthrAbort {c |}{res}        156        0.26       29.42
{txt} O06 Unspecified {c |}{res}     30,717       51.24       80.66
{txt}   O07 FailAttem {c |}{res}          6        0.01       80.67
{txt}O08 ComplEcMoAbo {c |}{res}         25        0.04       80.71
{txt}    TipAtenAbort {c |}{res}     11,561       19.29      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}     59,947      100.00
{txt}
{com}. 
{txt}end of do-file

{com}. count if aborto_nos!=0 & aborto_nos!=1 & year == 2014 & trim23!=.
  {res}1,465

{com}. 
. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Aborto en 2trimestre.dta", clear

. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", clear

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.         
.         
. 
. // Initial descriptive analysis of abortions
.         gen abortion=0
{txt}
{com}.         replace abortion = 1 if (substr(afecprin,1,3) =="O02" | | substr(afecprin,1,3) =="O03" | | substr(afecprin,1,3) =="O04" | | substr(afecprin,1,3) =="O05" | | substr(afecprin,1,3) =="O06" | | substr(afecprin,1,3) =="O07" | | substr(afecprin,1,3) =="O08")
{txt}(119,820 real changes made)

{com}.         
.         forvalues i=1(1)15 {c -(} 
{txt}  2{com}.                 rename afec`i' AFEC0`i'
{txt}  3{com}.         {c )-} 
{res}{txt}
{com}.         
.         forvalues i= 1(1)6{c -(}
{txt}  2{com}.                 replace abortion = 1 if (substr(AFEC0`i',1,3) =="O02" | | substr(AFEC0`i',1,3) =="O03" | | substr(AFEC0`i',1,3) =="O04" | | substr(AFEC0`i',1,3) =="O05" | | substr(AFEC0`i',1,3) =="O06" | | substr(AFEC0`i',1,3) =="O07" | | substr(AFEC0`i',1,3) =="O08") & abortion==0
{txt}  3{com}.         {c )-}
{txt}(693 real changes made)
(60 real changes made)
(12 real changes made)
(2 real changes made)
(0 real changes made)
(2 real changes made)

{com}.         
.         // Attention for abortion 
.         gen atten_abortion = 0 
{txt}
{com}.         replace atten_abortion = 1 if tipaten == 1 
{txt}(117,921 real changes made)

{com}.         
.         // Distinguish between abortion types 
.         gen type_abortion = . 
{txt}(2,959,197 missing values generated)

{com}.         replace type_abortion = 1 if abortion == 1 
{txt}(120,589 real changes made)

{com}.         replace type_abortion = 2 if abortion != 1 & atten_abortion == 1 
{txt}(7,646 real changes made)

{com}.         
.         label define type_abortion 1 "O00-O08" 2 "Tipo Att Aborto" 
{txt}
{com}.         label values type_abortion type_abortion
{txt}
{com}.         
. // Drop duplicates (only 2) 
.         duplicates drop clues edad afecprin egreso ingre year id folio, force

{p 0 4}{txt}Duplicates in terms of {res} clues edad afecprin egreso ingre year id folio{p_end}

{txt}(0 observations are duplicates)

{com}.         
.         gen afec_nos16 = substr(afecprin,1,3)
{txt}
{com}. 
. 
.         gen claswho = .
{txt}(2,959,197 missing values generated)

{com}.         
.                 *Ectopic pregnancy
.                 replace claswho = 1 if afec_nos16 == "O00" | afec_nos16 == "O01" 
{txt}(7,906 real changes made)

{com}.                 
.                 *Miscarriage 
.                 replace claswho = 2 if afec_nos16 == "O02" | afec_nos16 == "O03"
{txt}(37,192 real changes made)

{com}.                 
.                 *Abortion
.                 replace claswho = 3 if afec_nos16 == "O04" | afec_nos16 == "O05" | afec_nos16 == "O06" | afec_nos16 == "O07" | afec_nos16 == "O08" 
{txt}(82,628 real changes made)

{com}.                 replace claswho = 3 if tipaten == 1 & (afec_nos16 != "O00" & afec_nos16 != "O01" & afec_nos16 != "O02" & afec_nos16 != "O03" & afec_nos16 != "O04" & afec_nos16 != "O05" & afec_nos16 != "O06" & afec_nos16 != "O07" & afec_nos16 != "O08" )    
{txt}(2,849 real changes made)

{com}.                 
.                 *Other direct causes
.                 replace claswho = 4 if (afec_nos16 == "F53"|afec_nos16 == "O21"|afec_nos16 == "O26"|afec_nos16 == "O28"|afec_nos16 == "O30"|afec_nos16 == "O31"|afec_nos16 == "O32"|afec_nos16 == "O34"|afec_nos16 == "O35"|afec_nos16 == "O36"|afec_nos16 == "O40"|afec_nos16 == "O41"|afec_nos16 == "O410"|afec_nos16 == "O418"|afec_nos16 == "O419"|afec_nos16 == "O42"|afec_nos16 == "O43 "|afec_nos16 == "O47"|afec_nos16 == "O48"|afec_nos16 == "O60"|afec_nos16 == "O61"|afec_nos16 == "O68"|afec_nos16 == "O69"|afec_nos16 == "O73"|afec_nos16 == "O80"|afec_nos16 == "O81"|afec_nos16 == "O82"|afec_nos16 == "O83"|afec_nos16 == "O84"|afec_nos16 == "O90"|afec_nos16 == "O91"|afec_nos16 == "O92"|afec_nos16 == "Y87"|afecprin== "O717"|afecprin == "O440"|afecprin == "O244") 
{txt}(907,447 real changes made)

{com}.                 
.                 *Complicactions of anethesia
.                 replace claswho = 5 if (afec_nos16 == "O29"|afec_nos16 == "O74"|afec_nos16 == "O89")
{txt}(705 real changes made)

{com}.                 
.                 *Complications - obstetric trauma
.                 replace claswho = 6 if (afec_nos16 == "O71"|afecprin== "O715"|afecprin == "O716"|afecprin == "O718"|afecprin == "O719")
{txt}(1,006 real changes made)

{com}.                 
.                 *Complications -other-not specified
.                 replace claswho = 7 if (afec_nos16 == "O75"|afec_nos16 == "Y60"|afecprin == "O750"|afecprin == "O751"|afecprin == "O752"|afecprin== "O754"|afecprin == "O755"|afecprin == "O756"|afecprin == "O758"|afecprin == "O759")
{txt}(8,059 real changes made)

{com}.                 
.                 *Obstructed labor
.                 replace claswho = 8 if (afec_nos16 == "O33"|afec_nos16 == "O62"|afec_nos16 == "O63"|afec_nos16 == "O64"|afec_nos16 == "O65"|afec_nos16 == "O66")
{txt}(97,812 real changes made)

{com}.                 
.                 *Embolism
.                 replace claswho = 9 if (afec_nos16 == "O22"|afec_nos16 == "O87"|afec_nos16 == "O88")
{txt}(337 real changes made)

{com}.                 
.                 *Antenatal obstetric Haemorrage
.                 replace claswho = 10 if (afec_nos16 == "O44"|afec_nos16 == "O45"|afec_nos16 == "O46"|afecprin== "O710"|afecprin == "O441")
{txt}(5,509 real changes made)

{com}.                 
.                 *Intrapartum obstetric Haemorrage
.                 replace claswho = 11 if (afec_nos16 == "O67"|afec_nos16 == "O70"|afecprin == "O711"|afecprin == "O757")
{txt}(6,545 real changes made)

{com}.                 
.                 *Postpartum obstetric haemorrage
.                 replace claswho = 12 if (afec_nos16 == "O72"|afecprin == "O712")
{txt}(3,756 real changes made)

{com}.                 
.                 *Obstetric haemorrage - other
.                 replace claswho = 13 if (afec_nos16 == "O20"|afec_nos16 == "O713"|afec_nos16 == "O714")
{txt}(15,493 real changes made)

{com}.                 
.                 *Hypertensive disorders
.                 replace claswho = 14 if (afec_nos16 == "O10"|afec_nos16 == "O11"|afec_nos16 == "O12"|afec_nos16 == "O13"|afec_nos16 == "O14"|afec_nos16 == "O15"|afec_nos16 == "O16")
{txt}(56,424 real changes made)

{com}.                 
.                 *Pregnancy related sepsys
.                 replace claswho = 15 if (afec_nos16 == "A34"|afec_nos16 == "O85"|afec_nos16 == "O86"|afecprin == "O411"|afecprin == "O753")
{txt}(2,861 real changes made)

{com}.                 
.                 *Direct causes - other
.                 replace claswho = 16 if (afec_nos16 == "O95")
{txt}(0 real changes made)

{com}.                 
.                 *Indirect causes â medical disorders
.                 replace claswho = 17 if (afec_nos16 == "O99" | afec_nos16 == "O24" & afecprin!="O244") 
{txt}(19,362 real changes made)

{com}.                 
.                 *Indirect causes â HIV related
.                 replace claswho = 18 if (afecprin == "O987")
{txt}(153 real changes made)

{com}.                 
.                 *Indirect causes - other
.                 replace claswho = 19 if (afec_nos16 == "I40"|afec_nos16 == "O23"|afec_nos16 == "O25"|afec_nos16 == "O98"|afecprin == "O980"|afecprin== "O981"|afecprin== "O982"|afecprin== "O983"|afecprin== "O984"|afecprin== "O985"|afecprin== "O986"|afecprin == "O988"|afecprin== "O989")
{txt}(27,097 real changes made)

{com}. 
. 
.         *labels clas_who
.         label define claswhOOO 1 "Ectopic pregnancy" 2 "Miscarriage" 3 "Abortion" 4 "Other direct" 5 "Compl anethesia" 6 "Comp obs trauma" 7 "Comp OthNotSpec" 8 "Obstru labor" 9 "Embolism" 10 "AntenObst Haemor" 11 "IntraparObste Haemor" 12 "PostparObst Haemor" 13 "ObstHaemor Other" 14 "Hypertensive disorders" 15 "PregRelat Sepsys" 16 "DireCaus Other" 17 "IndiCau MedDisorders" 18 "IndiCaus HIV rel" 19 "IndiCaus Other"
{txt}
{com}.         label values claswho claswhOOO
{txt}
{com}.         
.         **
. * ABORTO NOSOTROS por afeccion (sustituye a abort_nos) version LARGO
. **
. *drop aborto_nos
. gen aborto_nos =.
{txt}(2,959,197 missing values generated)

{com}. replace aborto_nos = 0 if afec_nos16 =="O00" 
{txt}(6,726 real changes made)

{com}. replace aborto_nos = 1 if afec_nos16 =="O01" 
{txt}(1,180 real changes made)

{com}. replace aborto_nos = 2 if afec_nos16 =="O02" 
{txt}(23,013 real changes made)

{com}. replace aborto_nos = 3 if afec_nos16 =="O03" 
{txt}(14,179 real changes made)

{com}. replace aborto_nos = 4 if afec_nos16 =="O04" 
{txt}(260 real changes made)

{com}. replace aborto_nos = 5 if afec_nos16 =="O05" 
{txt}(4,107 real changes made)

{com}. replace aborto_nos = 6 if afec_nos16 =="O06" 
{txt}(77,923 real changes made)

{com}. replace aborto_nos = 7 if afec_nos16 =="O07" 
{txt}(22 real changes made)

{com}. replace aborto_nos = 8 if afec_nos16 =="O08"
{txt}(316 real changes made)

{com}. replace aborto_nos = 9 if tipaten ==1 & aborto_nos==.  
{txt}(2,849 real changes made)

{com}. 
. tab aborto_nos

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. label define obortonos16 0"O00 Ectopic" 1 "O01 Molar" 2 "O02 OthrProd" 3 "O03 Spontaneous" 4 "O04 Medical" 5 "O05 OthrAbort" 6 "O06 Unspecified" 7 "O07 FailAttem" 8 "O08 ComplEcMoAbo" 9 "TipAtenAbort" 
{txt}
{com}. label values aborto_nos obortonos16
{txt}
{com}. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. tab aborto_nos year

                 {txt}{c |}    year
      aborto_nos {c |}      2014 {c |}     Total
{hline 17}{c +}{hline 11}{c +}{hline 10}
     O00 Ectopic {c |}{res}     6,562 {txt}{c |}{res}     6,562 
{txt}       O01 Molar {c |}{res}     1,139 {txt}{c |}{res}     1,139 
{txt}    O02 OthrProd {c |}{res}    22,960 {txt}{c |}{res}    22,960 
{txt} O03 Spontaneous {c |}{res}    14,128 {txt}{c |}{res}    14,128 
{txt}     O04 Medical {c |}{res}       249 {txt}{c |}{res}       249 
{txt}   O05 OthrAbort {c |}{res}     4,097 {txt}{c |}{res}     4,097 
{txt} O06 Unspecified {c |}{res}    77,872 {txt}{c |}{res}    77,872 
{txt}   O07 FailAttem {c |}{res}        22 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}       313 {txt}{c |}{res}       313 
{txt}    TipAtenAbort {c |}{res}     2,849 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 11}{c +}{hline 10}
           Total {c |}{res}   130,191 {txt}{c |}{res}   130,191 

{txt}
{com}. 
. * Eliminando duplicados para tipo de atencion aborto
. duplicates drop egreso clues folio if aborto_nos==9, force

{p 0 4}{txt}Duplicates in terms of {res} egreso clues folio{p_end}

{txt}(0 observations are duplicates)

{com}. **SOLO 1 DUPLICADO! EN TEORIA ESTA BIEN, PORQUE YA PEGAMOS SOLO CASOS UNICOS DE TIPO DE ATENCION ABORTO Y NO ABORTO NOSOTROS!!
. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. 
. 
. **
. *OBSTETRICAS NOSOTROS por afeccion (sustituye a obs_nos)
. **
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" POR BLOQUE, version LARGO
. **      
. *drop obste_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obste_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obste_nos16=1 if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obste_nos16=2 if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obste_nos16=3 if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obste_nos16=4 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obste_nos16=5 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obste_nos16=6 if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obste_nos16=7 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obste_nos16=8 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obste_nos16 = 9 if (tipaten==0 & obste_nos16==.)
{txt}(0 real changes made)

{com}.         replace obste_nos16 = 10 if (tipaten==1 & obste_nos16==.)
{txt}(782 real changes made)

{com}.         
. label define obtetcnos16 1"O0-O0Abortive" 2 "O10-O16Edema" 3 "O20-O29RelPreg" 4 "O30-O48Fetus" 5 "O60-O75Labour" 6 "O80-O84Delivery" 7 "O85-O92Puerperium" 8 "O94-O99OthObst" 9 "TipAtenParto" 10 "TipAtenAborto"
{txt}
{com}. label values obste_nos16 obtetcnos16
{txt}
{com}. 
. tab obste_nos16

      {txt}obste_nos16 {c |}      Freq.     Percent        Cum.
{hline 18}{c +}{hline 35}
    O0-O0Abortive {c |}{res}    127,726       10.00       10.00
{txt}     O10-O16Edema {c |}{res}     56,424        4.42       14.42
{txt}   O20-O29RelPreg {c |}{res}     51,573        4.04       18.45
{txt}     O30-O48Fetus {c |}{res}    268,751       21.04       39.49
{txt}    O60-O75Labour {c |}{res}    123,594        9.68       49.17
{txt}  O80-O84Delivery {c |}{res}    623,339       48.80       97.96
{txt}O85-O92Puerperium {c |}{res}      5,945        0.47       98.43
{txt}   O94-O99OthObst {c |}{res}     19,308        1.51       99.94
{txt}    TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 18}{c +}{hline 35}
            Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
. **
. *PARTO NOSOTROS (sustituye a part_nos)
. **
. * CREACION DE VARIABLE "PArto SEGUN NOSOTROS"
. *
. *drop part_nos16
. gen part_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. 
. ***Delivery ICD-10      
. replace part_nos16=0 if afec_nos16=="O80" 
{txt}(562,010 real changes made)

{com}. replace part_nos16=1 if afec_nos16=="O81" 
{txt}(2,041 real changes made)

{com}. replace part_nos16=2 if afec_nos16=="O82" 
{txt}(47,672 real changes made)

{com}. replace part_nos16=3 if afec_nos16=="O83" 
{txt}(10,810 real changes made)

{com}. replace part_nos16=4 if afec_nos16=="O84" 
{txt}(806 real changes made)

{com}. replace part_nos16 = 5 if (tipaten==0 & part_nos16==.)
{txt}(0 real changes made)

{com}. 
. tab part_nos16

 {txt}part_nos16 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}    562,010       90.16       90.16
{txt}          1 {c |}{res}      2,041        0.33       90.49
{txt}          2 {c |}{res}     47,672        7.65       98.14
{txt}          3 {c |}{res}     10,810        1.73       99.87
{txt}          4 {c |}{res}        806        0.13      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    623,339      100.00
{txt}
{com}. 
. label define partonso16 0 "O80 Un solo parto espontaneo" 1 "O81 Un solo parto con forceps y aspirad" 2 "O82 Un solo parto por cesarea" 3 "O83 Otro parto unico asistido" 4 "O84 Parto multiple" 5 "TipoAtencion Parto" 
{txt}
{com}. label values part_nos16 partonso16
{txt}
{com}. 
. 
. 
. **
. * CREACION VARIANLE "MISSING NOSOTROS16" si no tiene aborto_nos ni part_nos16 entonces es miss_nos16
. **
. *drop miss_nos16
. gen miss_nos16 = .
{txt}(2,959,197 missing values generated)

{com}. replace miss_nos16 = 1 if aborto_nos==. & part_nos16==.
{txt}(2,205,283 real changes made)

{com}. 
. label define missnsot16 1 "Missing nosotros" 
{txt}
{com}. label values miss_nos16 missnsot16
{txt}
{com}. 
. tab miss_nos16

      {txt}miss_nos16 {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
Missing nosotros {c |}{res}  2,205,283      100.00      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}  2,205,283      100.00
{txt}
{com}. 
. 
. 
. **
. *TIPO DE ATENCION NOSOTROS, por todas las afecciones, version largo
. **
. *Aborto nosotros, Parto nosotros, AbortParto Nosotros y Missing Nosotros
. *drop tipaten_nos16
. gen tipaten_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. replace tipaten_nos16 = 0 if aborto_nos!=. & part_nos16==. & miss_nos16==. /*aborto*/
{txt}(130,575 real changes made)

{com}. replace tipaten_nos16 = 1 if part_nos16!=. & aborto_nos==. & miss_nos16==. /*parto*/
{txt}(623,339 real changes made)

{com}. replace tipaten_nos16 = 2 if aborto_nos!=. & part_nos16!=. & miss_nos16==. /*abortoParto*/
{txt}(0 real changes made)

{com}. replace tipaten_nos16 = 3 if aborto_nos==. & part_nos16==.
{txt}(2,205,283 real changes made)

{com}. 
. label define tipatenos 0 "Aborto Nosotros" 1 "Parto Nosotros" 2 "Aborto&Parto Nosotros" 3 "Missing Nosotros" 
{txt}
{com}. label values tipaten_nos16 tipatenos
{txt}
{com}. 
. tab tipaten_nos16

        {txt}tipaten_nos16 {c |}      Freq.     Percent        Cum.
{hline 22}{c +}{hline 35}
      Aborto Nosotros {c |}{res}    130,575        4.41        4.41
{txt}       Parto Nosotros {c |}{res}    623,339       21.06       25.48
{txt}     Missing Nosotros {c |}{res}  2,205,283       74.52      100.00
{txt}{hline 22}{c +}{hline 35}
                Total {c |}{res}  2,959,197      100.00
{txt}
{com}. 
. 
. 
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" individual
. **      
. *drop obsteInd_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obsteInd_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=10+`i'  if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=20+`i'  if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=80+`i' if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obsteInd_nos16 = 100 if (tipaten==0 & obsteInd_nos16==.)
{txt}(0 real changes made)

{com}.         replace obsteInd_nos16 = 101 if (tipaten==1 & obsteInd_nos16==.)
{txt}(782 real changes made)

{com}.         
. 
. **** A valores de categorÓ¡s ****
. label define obtetIncnos /* Primera categoria */ 0 "O00 Embarazo ectopico" 1 "O01 Mola Hidaltiforme" 2 "O02 Otros productos anormales" 3 "O03 Aborto espontaneo" 4 "O04 Aborto medico" 5 "O05 Otro aborto" 6 "O06 Aborto inespecifico" 7 "O07 Intento fallido" 8 "O08 Complicaciones despues de aborto/ect/molar" /* Segunda categoria */ 10 "O10 Hipertension pre-existente complicada con embarazo, parto y puerperio" 11 "O11 Pre-eclampsia superpuesta a hipertension cronica" 12 "O12 Edema y proteinuria gestacional sin hipertension" 13 "O13 Hipertension gestacional" 14 "O14 Pre-eclampsia" 15 "O15 Eclampsia" 16 "O16 Hipertension materna inespecificada"  /* Tercera categoria */ 20 "O20 Hemorragia temprana" 21 "O21 Vomito excesivo" 22 "O22 Complicaciones en venas y hemorroides" 23 "O23 Infecciones en tracto genitourinario" 24 "O24 Diabetes mellitus" 25 "O25 Malnutricion en embarazo" 26 "O26 Atencion para otras condiciones" 28 "O28 Hallazgos anormales en atencion pre-natal" 29 "O29 Complicaciones de anestesia durante el embarazo"/* Cuarta categoria */ 30 "O30 Gestacion multiple" 31 "O31 Complicaciones de gestacion multiple" 32 "O32 Atencion para malpresentacion del feto" 33 "O33 Atencion para desproporcion del feto" 34 "O34 Atencion para anormalidad de los organos pelvicos" 35 "O35 Atencion para anormalidad del feto" 36 "O36 Atencion para otros problemas fetales" 40 "O40 Polyhydramnios" 41 "O41 Otros desordenes de fluido amniotico y membranas" 42 "O42 Ruptura prematura de membranas" 43 "O43 Desordenes de placenta" 44 "O44 Placenta praevia" 45 "O45 Separacion prematura de placenta" 46 "O46 Hemorragia antes del parto no clasificada" 47 "O47 Falsa labor" 48 "O48 Embarazo prolongado" /* Quinta categoria */ 60 "O60 Labor y parto pretermino" 61 "O61 Induccion de labor fallida" 62 "O62 Anormalidades en las impulsoras de labor" 63 "O63 Labor extendida" 64 "O64 Labor obstruida por malposicion o malpresentacion de feto" 65 "O65 Labor obstruida por anormalidad pelvica de la madre" 66 "O66 Otra labor obstruida" 67 "O67 Labor y parto complicados por hemorragia intraparto no clasificada en otra parte" 68 "O68 Labor y parto complicados por estres fetal" 69 "O69 Labor y parto complicados por complicaciones con el cordon umbilical" 70 "O70 Laceracion perineal durante el parto" 71 "O71 Otro trauma obstetrico" 72 "O72 Hemorragia post-parto" 73 "O73 Placenta y membranas retenidos sin hemorragia" 74 "O74 Complicaciones de anestesia durante labor y parto" 75 "O75 Otras complicaciones de parto y labor no clasificadas" /* Sexta categoria */ 80 "O80 Un solo parto espontaneo" 81 "O81 Un solo parto con forceps y aspirado" 82 "O82 Un solo parto por cesarea" 83 "O83 Otro parto unico asistido" 84 "O84 Parto multiple" /* Septima categoria */ 85 "O85 Sepsis puerperal" 86 "O86 Otras infecciones puerperales" 87 "O87 Complicaciones en venas y hemorroides en el puerperio" 88 "O88 Embolia obstetrica" 89 "O89 Complicaciones de anestesia durante el puerperio" 90 "O90 Complicaciones del puerperio no clasificadas" 91 "O91 Infecciones de pecho asociadas con el nacimiento" 92 "O92 Otros desordenes de pecho y lactancia asociados al nacimiento"  /* Octava categoria */94 "O94 Secuela de complicacion en embarazo, parto y puerperio" 95 "O95 Muerte obstetrica de causa inespecifica" 96 "O96 Muerte por alguna causa obstetrica ocurrida despues de 42 dias pero antes de un despues del parto" 97 "O97 Muerte por secuela de causas obstetricas" 98 "O98 Infeccion materna y enfermedades parasitarias complicando el embarazo, parto y puerperio" 99 "O99 Otras enfermedades maternas complicando el embarazo, parto y puerperio" 100 "TipAtenPArto" 101 "TipAtenAborto"
{txt}
{com}. label values obsteInd_nos16 obtetIncnos
{txt}
{com}. 
. tab obsteInd_nos16

                         {txt}obsteInd_nos16 {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                  O00 Embarazo ectopico {c |}{res}      6,726        0.53        0.53
{txt}                  O01 Mola Hidaltiforme {c |}{res}      1,180        0.09        0.62
{txt}          O02 Otros productos anormales {c |}{res}     23,013        1.80        2.42
{txt}                  O03 Aborto espontaneo {c |}{res}     14,179        1.11        3.53
{txt}                      O04 Aborto medico {c |}{res}        260        0.02        3.55
{txt}                        O05 Otro aborto {c |}{res}      4,107        0.32        3.87
{txt}                O06 Aborto inespecifico {c |}{res}     77,923        6.10        9.97
{txt}                    O07 Intento fallido {c |}{res}         22        0.00        9.97
{txt}O08 Complicaciones despues de aborto/ec {c |}{res}        316        0.02       10.00
{txt}O10 Hipertension pre-existente complica {c |}{res}      2,349        0.18       10.18
{txt}O11 Pre-eclampsia superpuesta a hiperte {c |}{res}        156        0.01       10.19
{txt}O12 Edema y proteinuria gestacional sin {c |}{res}         29        0.00       10.20
{txt}           O13 Hipertension gestacional {c |}{res}     21,374        1.67       11.87
{txt}                      O14 Pre-eclampsia {c |}{res}     25,703        2.01       13.88
{txt}                          O15 Eclampsia {c |}{res}      1,988        0.16       14.04
{txt}O16 Hipertension materna inespecificada {c |}{res}      4,825        0.38       14.42
{txt}                O20 Hemorragia temprana {c |}{res}     15,493        1.21       15.63
{txt}                    O21 Vomito excesivo {c |}{res}      1,249        0.10       15.73
{txt}O22 Complicaciones en venas y hemorroid {c |}{res}        196        0.02       15.74
{txt}O23 Infecciones en tracto genitourinari {c |}{res}     23,557        1.84       17.59
{txt}                  O24 Diabetes mellitus {c |}{res}      9,035        0.71       18.29
{txt}           O25 Malnutricion en embarazo {c |}{res}         32        0.00       18.30
{txt}    O26 Atencion para otras condiciones {c |}{res}      1,928        0.15       18.45
{txt}O28 Hallazgos anormales en atencion pre {c |}{res}         34        0.00       18.45
{txt}O29 Complicaciones de anestesia durante {c |}{res}         49        0.00       18.45
{txt}                 O30 Gestacion multiple {c |}{res}      3,891        0.30       18.76
{txt}O31 Complicaciones de gestacion multipl {c |}{res}        208        0.02       18.77
{txt}O32 Atencion para malpresentacion del f {c |}{res}     14,087        1.10       19.88
{txt}O33 Atencion para desproporcion del fet {c |}{res}     51,451        4.03       23.90
{txt}O34 Atencion para anormalidad de los or {c |}{res}     56,666        4.44       28.34
{txt} O35 Atencion para anormalidad del feto {c |}{res}        599        0.05       28.39
{txt}O36 Atencion para otros problemas fetal {c |}{res}     27,324        2.14       30.53
{txt}                     O40 Polyhydramnios {c |}{res}      1,322        0.10       30.63
{txt}O41 Otros desordenes de fluido amniotic {c |}{res}     29,890        2.34       32.97
{txt}     O42 Ruptura prematura de membranas {c |}{res}     41,819        3.27       36.24
{txt}             O43 Desordenes de placenta {c |}{res}        400        0.03       36.27
{txt}                   O44 Placenta praevia {c |}{res}      2,888        0.23       36.50
{txt}   O45 Separacion prematura de placenta {c |}{res}      2,145        0.17       36.67
{txt}O46 Hemorragia antes del parto no clasi {c |}{res}        410        0.03       36.70
{txt}                        O47 Falsa labor {c |}{res}     33,600        2.63       39.33
{txt}                O48 Embarazo prolongado {c |}{res}      2,051        0.16       39.49
{txt}           O60 Labor y parto pretermino {c |}{res}     20,044        1.57       41.06
{txt}         O61 Induccion de labor fallida {c |}{res}      4,366        0.34       41.40
{txt}O62 Anormalidades en las impulsoras de  {c |}{res}     11,553        0.90       42.31
{txt}                    O63 Labor extendida {c |}{res}      9,937        0.78       43.08
{txt}O64 Labor obstruida por malposicion o m {c |}{res}      8,975        0.70       43.79
{txt}O65 Labor obstruida por anormalidad pel {c |}{res}     10,923        0.86       44.64
{txt}               O66 Otra labor obstruida {c |}{res}      4,973        0.39       45.03
{txt}O67 Labor y parto complicados por hemor {c |}{res}        977        0.08       45.11
{txt}O68 Labor y parto complicados por estre {c |}{res}     27,968        2.19       47.30
{txt}O69 Labor y parto complicados por compl {c |}{res}      5,092        0.40       47.70
{txt}O70 Laceracion perineal durante el part {c |}{res}      3,897        0.31       48.00
{txt}             O71 Otro trauma obstetrico {c |}{res}      1,006        0.08       48.08
{txt}              O72 Hemorragia post-parto {c |}{res}      3,700        0.29       48.37
{txt}O73 Placenta y membranas retenidos sin  {c |}{res}      1,875        0.15       48.52
{txt}O74 Complicaciones de anestesia durante {c |}{res}        249        0.02       48.54
{txt}O75 Otras complicaciones de parto y lab {c |}{res}      8,059        0.63       49.17
{txt}           O80 Un solo parto espontaneo {c |}{res}    562,010       43.99       93.16
{txt}O81 Un solo parto con forceps y aspirad {c |}{res}      2,041        0.16       93.32
{txt}          O82 Un solo parto por cesarea {c |}{res}     47,672        3.73       97.05
{txt}          O83 Otro parto unico asistido {c |}{res}     10,810        0.85       97.90
{txt}                     O84 Parto multiple {c |}{res}        806        0.06       97.96
{txt}                   O85 Sepsis puerperal {c |}{res}        751        0.06       98.02
{txt}      O86 Otras infecciones puerperales {c |}{res}      1,354        0.11       98.13
{txt}O87 Complicaciones en venas y hemorroid {c |}{res}         97        0.01       98.13
{txt}                 O88 Embolia obstetrica {c |}{res}         44        0.00       98.14
{txt}O89 Complicaciones de anestesia durante {c |}{res}        407        0.03       98.17
{txt}O90 Complicaciones del puerperio no cla {c |}{res}      2,935        0.23       98.40
{txt}O91 Infecciones de pecho asociadas con  {c |}{res}        337        0.03       98.43
{txt}O92 Otros desordenes de pecho y lactanc {c |}{res}         20        0.00       98.43
{txt}O94 Secuela de complicacion en embarazo {c |}{res}         34        0.00       98.43
{txt}O98 Infeccion materna y enfermedades pa {c |}{res}      3,455        0.27       98.70
{txt}O99 Otras enfermedades maternas complic {c |}{res}     15,819        1.24       99.94
{txt}                          TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
. 
. 
. *******************
. *PARTE 7
. ******************
. 
. *VARIABLES Y TABLAS PARA MANUSCRITO 
. 
. label define entidad 1 "Aguascalientes" 2 "Baja California" 3 "Baja California Sur" 4 "Campeche" 5 "Coahuila de Zaragoza" 6 "Colima" 7 "Chiapas" 8 "Chihuahua" 9 "Distrito Federal" 10 "Durango" 11 "Guanajuato" 12 "Guerrero" 13 "Hidalgo" 14 "Jalisco" 15 "Mexico" 16 "Michoacan de Ocampo" 17 "Morelos" 18 "Nayarit" 19 "Nuevo Leon" 20 "Oaxaca" 21 "Puebla" 22 "Queretaro" 23 "Quintana Roo" 24 "San Luis Potosi" 25 "Sinaloa" 26 "Sonora" 27 "Tabasco" 28 "Tamaulipas" 29 "Tlaxcala" 30 "Veracruz de Ignacio de la Llave" 31 "Yucatan" 32 "Zacatecas"
{txt}
{com}. 
. label values entidad entidad
{txt}
{com}. 
. **CREACIÃN DE VARIABLES
. **
. 
. *generando Grandes Grupos de EDAD
. *drop edad_nos
. gen edad_nos=.
{txt}(2,959,197 missing values generated)

{com}. replace edad_nos=1 if edad <18 & edad!=.
{txt}(644,872 real changes made)

{com}. replace edad_nos=2 if edad <26 & edad_nos==.
{txt}(828,955 real changes made)

{com}. replace edad_nos=3 if edad <31 & edad_nos==.
{txt}(341,467 real changes made)

{com}. replace edad_nos=4 if edad <41 & edad_nos==.
{txt}(405,141 real changes made)

{com}. replace edad_nos=5 if edad >40 & edad_nos==.
{txt}(738,762 real changes made)

{com}. 
. label define edadnos 1  "< 18" 2  "18 - 25" 3  "26 - 30" 4  "31 - 40" 5  "> 40" 
{txt}
{com}. label values edad_nos edadnos
{txt}
{com}. 
. *generando la vairble de 2do trimestre tardio hasta semana 24 con tres categorias
. *drop trim23
. gen trim23 = .
{txt}(2,959,197 missing values generated)

{com}. replace trim23 = 1 if  gestac < 17 & gestac > 12
{txt}(10,345 real changes made)

{com}. replace trim23 = 2 if  gestac < 21 & gestac > 16
{txt}(6,055 real changes made)

{com}. replace trim23 = 3 if  gestac < 25 & gestac > 20
{txt}(3,059 real changes made)

{com}. 
. label define trimeSS23 1  "13-16" 2  "17-20" 3 "21-24"
{txt}
{com}. label values trim23 trimeSS23
{txt}
{com}. 
. **
. **TABLAS
. **
. 
. *total de EGERESOS de 2007 a 2014
. count if year!=. & year >2006
  {res}1,282,693
{txt}
{com}. 
. *total de abortos
. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}     23,013       18.76       18.76
{txt} O03 Spontaneous {c |}{res}     14,179       11.56       30.32
{txt}     O04 Medical {c |}{res}        260        0.21       30.53
{txt}   O05 OthrAbort {c |}{res}      4,107        3.35       33.88
{txt} O06 Unspecified {c |}{res}     77,923       63.52       97.40
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.42
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.26       97.68
{txt}    TipAtenAbort {c |}{res}      2,849        2.32      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    122,669      100.00
{txt}
{com}. 
. *aborto que tienen edad gestacional de 2007 a 2014
. tab aborto_nos if gestac!=. & aborto_nos!=0     & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}     20,744       18.39       18.39
{txt} O03 Spontaneous {c |}{res}     12,342       10.94       29.33
{txt}     O04 Medical {c |}{res}        186        0.16       29.50
{txt}   O05 OthrAbort {c |}{res}      3,413        3.03       32.52
{txt} O06 Unspecified {c |}{res}     73,046       64.76       97.29
{txt}   O07 FailAttem {c |}{res}          1        0.00       97.29
{txt}O08 ComplEcMoAbo {c |}{res}        212        0.19       97.47
{txt}    TipAtenAbort {c |}{res}      2,849        2.53      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    112,793      100.00
{txt}
{com}. 
{txt}end of do-file

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=.

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}      2,154       13.33       13.33
{txt} O03 Spontaneous {c |}{res}      1,949       12.06       25.39
{txt}     O04 Medical {c |}{res}         28        0.17       25.56
{txt}   O05 OthrAbort {c |}{res}        469        2.90       28.47
{txt} O06 Unspecified {c |}{res}     11,007       68.12       96.58
{txt}O08 ComplEcMoAbo {c |}{res}         21        0.13       96.71
{txt}    TipAtenAbort {c |}{res}        531        3.29      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}     16,159      100.00
{txt}
{com}. 
{txt}end of do-file

{com}. tab aborto_nos if entidad == 9 & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=.

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}         29        3.05        3.05
{txt} O03 Spontaneous {c |}{res}        252       26.50       29.55
{txt} O06 Unspecified {c |}{res}        667       70.14       99.68
{txt}    TipAtenAbort {c |}{res}          3        0.32      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}        951      100.00

{com}. 
. tab entidad

                        {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 32}{c +}{hline 35}
                 Aguascalientes {c |}{res}     43,187        1.46        1.46
{txt}                Baja California {c |}{res}     52,122        1.76        3.22
{txt}            Baja California Sur {c |}{res}     18,131        0.61        3.83
{txt}                       Campeche {c |}{res}     30,082        1.02        4.85
{txt}           Coahuila de Zaragoza {c |}{res}     49,492        1.67        6.52
{txt}                         Colima {c |}{res}     20,371        0.69        7.21
{txt}                        Chiapas {c |}{res}    139,371        4.71       11.92
{txt}                      Chihuahua {c |}{res}     77,235        2.61       14.53
{txt}               Distrito Federal {c |}{res}    205,745        6.95       21.48
{txt}                        Durango {c |}{res}     50,341        1.70       23.18
{txt}                     Guanajuato {c |}{res}    162,737        5.50       28.68
{txt}                       Guerrero {c |}{res}     94,962        3.21       31.89
{txt}                        Hidalgo {c |}{res}     64,633        2.18       34.08
{txt}                        Jalisco {c |}{res}    215,566        7.28       41.36
{txt}                         Mexico {c |}{res}    397,698       13.44       54.80
{txt}            Michoacan de Ocampo {c |}{res}    137,206        4.64       59.44
{txt}                        Morelos {c |}{res}     51,739        1.75       61.19
{txt}                        Nayarit {c |}{res}     28,236        0.95       62.14
{txt}                     Nuevo Leon {c |}{res}     57,795        1.95       64.09
{txt}                         Oaxaca {c |}{res}     94,853        3.21       67.30
{txt}                         Puebla {c |}{res}    124,250        4.20       71.50
{txt}                      Queretaro {c |}{res}     55,048        1.86       73.36
{txt}                   Quintana Roo {c |}{res}     39,978        1.35       74.71
{txt}                San Luis Potosi {c |}{res}     67,229        2.27       76.98
{txt}                        Sinaloa {c |}{res}     75,875        2.56       79.54
{txt}                         Sonora {c |}{res}     77,296        2.61       82.16
{txt}                        Tabasco {c |}{res}    109,024        3.68       85.84
{txt}                     Tamaulipas {c |}{res}     86,244        2.91       88.76
{txt}                       Tlaxcala {c |}{res}     46,400        1.57       90.32
{txt}Veracruz de Ignacio de la Llave {c |}{res}    176,466        5.96       96.29
{txt}                        Yucatan {c |}{res}     53,680        1.81       98.10
{txt}                      Zacatecas {c |}{res}     44,871        1.52       99.62
{txt}                             33 {c |}{res}         78        0.00       99.62
{txt}                             34 {c |}{res}        842        0.03       99.65
{txt}                             35 {c |}{res}         44        0.00       99.65
{txt}                             99 {c |}{res}     10,370        0.35      100.00
{txt}{hline 32}{c +}{hline 35}
                          Total {c |}{res}  2,959,197      100.00

{com}. count if if entidad == 9 & aborto_nos!=0 & aborto_nos!=1 & trim23!=.
{err}if not found
{txt}{search r(111), local:r(111);}

{com}. count if entidad == 9 & aborto_nos!=0 & aborto_nos!=1 & trim23!=.
  {res}1,203

{com}. count
  {res}2,959,197

{com}. count if aborto_nos != 0 & aborto_nos != 1 
  {res}2,951,291

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . 
  {res}122,669

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . & entidad == 9 
  {res}7,405

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . & entidad == 9 & (trim23 == 2 | trim23 == 3) 
  {res}410

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . & entidad == 9 & trim23 1= . 
{err}invalid '1' 
{txt}{search r(198), local:r(198);}

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . & entidad == 9 & trim23 != . 
  {res}951

{com}. tab entidad

                        {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 32}{c +}{hline 35}
                 Aguascalientes {c |}{res}     43,187        1.46        1.46
{txt}                Baja California {c |}{res}     52,122        1.76        3.22
{txt}            Baja California Sur {c |}{res}     18,131        0.61        3.83
{txt}                       Campeche {c |}{res}     30,082        1.02        4.85
{txt}           Coahuila de Zaragoza {c |}{res}     49,492        1.67        6.52
{txt}                         Colima {c |}{res}     20,371        0.69        7.21
{txt}                        Chiapas {c |}{res}    139,371        4.71       11.92
{txt}                      Chihuahua {c |}{res}     77,235        2.61       14.53
{txt}               Distrito Federal {c |}{res}    205,745        6.95       21.48
{txt}                        Durango {c |}{res}     50,341        1.70       23.18
{txt}                     Guanajuato {c |}{res}    162,737        5.50       28.68
{txt}                       Guerrero {c |}{res}     94,962        3.21       31.89
{txt}                        Hidalgo {c |}{res}     64,633        2.18       34.08
{txt}                        Jalisco {c |}{res}    215,566        7.28       41.36
{txt}                         Mexico {c |}{res}    397,698       13.44       54.80
{txt}            Michoacan de Ocampo {c |}{res}    137,206        4.64       59.44
{txt}                        Morelos {c |}{res}     51,739        1.75       61.19
{txt}                        Nayarit {c |}{res}     28,236        0.95       62.14
{txt}                     Nuevo Leon {c |}{res}     57,795        1.95       64.09
{txt}                         Oaxaca {c |}{res}     94,853        3.21       67.30
{txt}                         Puebla {c |}{res}    124,250        4.20       71.50
{txt}                      Queretaro {c |}{res}     55,048        1.86       73.36
{txt}                   Quintana Roo {c |}{res}     39,978        1.35       74.71
{txt}                San Luis Potosi {c |}{res}     67,229        2.27       76.98
{txt}                        Sinaloa {c |}{res}     75,875        2.56       79.54
{txt}                         Sonora {c |}{res}     77,296        2.61       82.16
{txt}                        Tabasco {c |}{res}    109,024        3.68       85.84
{txt}                     Tamaulipas {c |}{res}     86,244        2.91       88.76
{txt}                       Tlaxcala {c |}{res}     46,400        1.57       90.32
{txt}Veracruz de Ignacio de la Llave {c |}{res}    176,466        5.96       96.29
{txt}                        Yucatan {c |}{res}     53,680        1.81       98.10
{txt}                      Zacatecas {c |}{res}     44,871        1.52       99.62
{txt}                             33 {c |}{res}         78        0.00       99.62
{txt}                             34 {c |}{res}        842        0.03       99.65
{txt}                             35 {c |}{res}         44        0.00       99.65
{txt}                             99 {c |}{res}     10,370        0.35      100.00
{txt}{hline 32}{c +}{hline 35}
                          Total {c |}{res}  2,959,197      100.00

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . & entidad == 9 & trim23 1= . 
{err}invalid '1' 
{txt}{search r(198), local:r(198);}

{com}. count if aborto_nos != 0 & aborto_nos != 1 & aborto_nos != . & entidad == 9 & trim23 != . 
  {res}951

{com}. count if entidad == 9
  {res}205,745

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", clear

. count if entidad == 9
  {res}205,745

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Aborto en 2trimestre.dta", clear

. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Aborto en 2trimestre dataset.dta", clear

. count if year == 2014
  {res}84,508

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/OBSTET14/OBSTET14.DTA"

. count if year == 2014
{err}year not found
{txt}{search r(111), local:r(111);}

{com}. count
  {res}84,508

{com}. import delimited using "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}. count
  {res}1,282,693

{com}. br

. import delimited using "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/EGRESO.csv", clear
{res}{text}(45 vars, 2,959,197 obs)

{com}. br

. lookfor entidad

              {txt}storage   display    value
variable name   type    format     label      variable label
{hline}
{p 0 48}{res}{bind:entidad        }{txt}{bind: byte    }{bind:{txt}%8.0g     }{space 1}{bind:         }{bind:  }{res}{res}ENTIDAD{p_end}

{com}. br entidad 

. count if entidad == 9 
  {res}205,745

{com}. tempfile egreso 

. save `egreso', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000001 saved

{com}. duplicates tag id 
{err}option {bf}generate(){sf} required
{txt}{search r(198), local:r(198);}

{com}. duplicates tag id, gen(dup) 

{p 0 4}{txt}Duplicates in terms of {res} id{p_end}

{com}. count if dup != 0 
  {res}0

{com}. import delimited using "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}. merge 1:1 id using `egreso' 
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,676,504
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}       1,676,504{txt}  (_merge==2)

{col 5}matched{col 30}{res}       1,282,693{txt}  (_merge==3)
{col 5}{hline 41}

{com}. br if _m == 2 

. count if entidad == 9
  {res}205,745

{com}. br if entidad == 9 & _m == 3 

. count if entidad == 9 & _m == 3 
  {res}73,736

{com}. use `egreso', clear

. count if entidad == 9 
  {res}205,745

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/SAEH2014/SAEH2014.DTA"

. br

. count
  {res}304,762

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. // Lily Alexander 
. // MPH Student, University of Washington 
. // March 7, 2018
. 
. // Purpose: Exploring second-trimester abortion in SAEH national-level data 
. 
. 
. *****************************************************
. * Set Stata preferences and local directories
. *****************************************************
. 
.         clear all
{res}{txt}
{com}.         set more off
{txt}
{com}.         set mem 2g
{txt}{bf:set memory} ignored.
{p 4 4 2}
Memory no longer
needs to be set in modern Statas;
memory adjustments are performed on the fly
automatically.
{p_end}

{com}.         
.         local data "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos"
{txt}
{com}.         
. 
. *****************************************************
. * First, merge different parts of SAEH sheet
. *****************************************************
.         
.         // Bring in obstetric section
.         import delimited using "`data'/OBSTET.csv", clear
{res}{text}(10 vars, 1,282,693 obs)

{com}.         gen year = 2014
{txt}
{com}.         tempfile obstet 
{txt}
{com}.         save `obstet', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000002 saved

{com}.         
.         // Bring in productos section 
.         import delimited using "`data'/PRODUCTOS.csv", clear 
{res}{text}(9 vars, 1,148,240 obs)

{com}.         
.                 // Reshape so that we have 1 observation per woman, with number of babies and their respective variables wide. 
.                 reshape wide pesoprod sexprod condnac condegre naviapag navirean navicune, i(id) j(numproducto)
{txt}(note: j = 1 2 3 4)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 1.1e+06   {txt}->{res} 1.1e+06
{txt}Number of variables            {res}       9   {txt}->{res}      29
{txt}j variable (4 values)       {res}numproducto   {txt}->   (dropped)
xij variables:
                               {res}pesoprod   {txt}->   {res}pesoprod1 pesoprod2 ... pesoprod4
                                sexprod   {txt}->   {res}sexprod1 sexprod2 ... sexprod4
                                condnac   {txt}->   {res}condnac1 condnac2 ... condnac4
                               condegre   {txt}->   {res}condegre1 condegre2 ... condegre4
                               naviapag   {txt}->   {res}naviapag1 naviapag2 ... naviapag4
                               navirean   {txt}->   {res}navirean1 navirean2 ... navirean4
                               navicune   {txt}->   {res}navicune1 navicune2 ... navicune4
{txt}{hline 77}

{com}. 
.         tempfile productos 
{txt}
{com}.         save `productos', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000003 saved

{com}.         
.         // Bring in defunc section 
.         import delimited using "`data'/DEFUNC.csv", clear 
{res}{text}(21 vars, 64,923 obs)

{com}.         tempfile defunc 
{txt}
{com}.         save `defunc', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000004 saved

{com}.         
.         // Bring in procedimientos section 
.         import delimited using "`data'/PROCEDIMIENTOS.csv", clear 
{res}{text}(8 vars, 6,448,949 obs)

{com}.                 sort id promed
{txt}
{com}.                 drop if numpromed > 11 // keep just the first 10 procedures. 
{txt}(44,759 observations deleted)

{com}.                 // Reshape so that we have 1 observation per woman
.                 reshape wide tipo promed anest quirof qh qm, i(id) j(numpromed)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 6.4e+06   {txt}->{res} 2.6e+06
{txt}Number of variables            {res}       8   {txt}->{res}      67
{txt}j variable (11 values)        {res}numpromed   {txt}->   (dropped)
xij variables:
                                   {res}tipo   {txt}->   {res}tipo1 tipo2 ... tipo11
                                 promed   {txt}->   {res}promed1 promed2 ... promed11
                                  anest   {txt}->   {res}anest1 anest2 ... anest11
                                 quirof   {txt}->   {res}quirof1 quirof2 ... quirof11
                                     qh   {txt}->   {res}qh1 qh2 ... qh11
                                     qm   {txt}->   {res}qm1 qm2 ... qm11
{txt}{hline 77}

{com}.         tempfile proced
{txt}
{com}.         save `proced', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000005 saved

{com}.         
.         
.         // Bring in afecciones section 
.         import delimited using "`data'/AFECCIONES.csv", clear 
{res}{text}(3 vars, 2,767,444 obs)

{com}.         
.         duplicates drop id numafec afec, force

{p 0 4}{txt}Duplicates in terms of {res} id numafec afec{p_end}

{txt}(620 observations deleted)

{com}.         reshape wide afec, i(id) j(numafec)
{txt}(note: j = 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15)

Data{col 36}long{col 43}->{col 48}wide
{hline 77}
Number of obs.                 {res} 2.8e+06   {txt}->{res} 1.9e+06
{txt}Number of variables            {res}       3   {txt}->{res}      16
{txt}j variable (15 values)          {res}numafec   {txt}->   (dropped)
xij variables:
                                   {res}afec   {txt}->   {res}afec1 afec2 ... afec15
{txt}{hline 77}

{com}.         
.         tempfile afec
{txt}
{com}.         save `afec', replace
{txt}(note: file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000006 not found)
file /var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//S_00246.000006 saved

{com}.         
.         // Bring in egresos section 
.         import delimited using "`data'/EGRESO.csv", clear 
{res}{text}(45 vars, 2,959,197 obs)

{com}.                 
.                 split egreso, p(" ")
{res}variables created as string: 
{txt}{col 1}egreso1{col 10}egreso2

{com}.                 drop egreso egreso2 
{txt}
{com}.                 rename egreso1 egreso 
{res}{txt}
{com}.                 
.         
.         // Merge iwth other datasets 
.         merge 1:1 id using `obstet', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,676,504
{txt}{col 9}from master{col 30}{res}       1,676,504{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,282,693{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `productos', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,819,777
{txt}{col 9}from master{col 30}{res}       1,819,777{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,139,420{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `defunc', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       2,894,274
{txt}{col 9}from master{col 30}{res}       2,894,274{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}          64,923{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `proced', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}         358,224
{txt}{col 9}from master{col 30}{res}         358,224{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       2,600,973{txt}  
{col 5}{hline 41}

{com}.         merge 1:1 id using `afec', nogen
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}       1,077,091
{txt}{col 9}from master{col 30}{res}       1,077,091{txt}  
{col 9}from using{col 30}{res}               0{txt}  

{col 5}matched{col 30}{res}       1,882,106{txt}  
{col 5}{hline 41}

{com}.         
.         
. // Save compiled dataset 
.         save "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", replace
{txt}file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta saved

{com}.         
. 
.         
.         
. 
. // Initial descriptive analysis of abortions
.         gen abortion=0
{txt}
{com}.         replace abortion = 1 if (substr(afecprin,1,3) =="O02" | | substr(afecprin,1,3) =="O03" | | substr(afecprin,1,3) =="O04" | | substr(afecprin,1,3) =="O05" | | substr(afecprin,1,3) =="O06" | | substr(afecprin,1,3) =="O07" | | substr(afecprin,1,3) =="O08")
{txt}(119,820 real changes made)

{com}.         
.         forvalues i=1(1)15 {c -(} 
{txt}  2{com}.                 rename afec`i' AFEC0`i'
{txt}  3{com}.         {c )-} 
{res}{txt}
{com}.         
.         forvalues i= 1(1)6{c -(}
{txt}  2{com}.                 replace abortion = 1 if (substr(AFEC0`i',1,3) =="O02" | | substr(AFEC0`i',1,3) =="O03" | | substr(AFEC0`i',1,3) =="O04" | | substr(AFEC0`i',1,3) =="O05" | | substr(AFEC0`i',1,3) =="O06" | | substr(AFEC0`i',1,3) =="O07" | | substr(AFEC0`i',1,3) =="O08") & abortion==0
{txt}  3{com}.         {c )-}
{txt}(693 real changes made)
(60 real changes made)
(12 real changes made)
(2 real changes made)
(0 real changes made)
(2 real changes made)

{com}.         
.         // Attention for abortion 
.         gen atten_abortion = 0 
{txt}
{com}.         replace atten_abortion = 1 if tipaten == 1 
{txt}(117,921 real changes made)

{com}.         
.         // Distinguish between abortion types 
.         gen type_abortion = . 
{txt}(2,959,197 missing values generated)

{com}.         replace type_abortion = 1 if abortion == 1 
{txt}(120,589 real changes made)

{com}.         replace type_abortion = 2 if abortion != 1 & atten_abortion == 1 
{txt}(7,646 real changes made)

{com}.         
.         label define type_abortion 1 "O00-O08" 2 "Tipo Att Aborto" 
{txt}
{com}.         label values type_abortion type_abortion
{txt}
{com}.         
. // Drop duplicates (only 2) 
.         duplicates drop clues edad afecprin egreso ingre year id folio, force

{p 0 4}{txt}Duplicates in terms of {res} clues edad afecprin egreso ingre year id folio{p_end}

{txt}(0 observations are duplicates)

{com}.         
.         gen afec_nos16 = substr(afecprin,1,3)
{txt}
{com}. 
. 
.         gen claswho = .
{txt}(2,959,197 missing values generated)

{com}.         
.                 *Ectopic pregnancy
.                 replace claswho = 1 if afec_nos16 == "O00" | afec_nos16 == "O01" 
{txt}(7,906 real changes made)

{com}.                 
.                 *Miscarriage 
.                 replace claswho = 2 if afec_nos16 == "O02" | afec_nos16 == "O03"
{txt}(37,192 real changes made)

{com}.                 
.                 *Abortion
.                 replace claswho = 3 if afec_nos16 == "O04" | afec_nos16 == "O05" | afec_nos16 == "O06" | afec_nos16 == "O07" | afec_nos16 == "O08" 
{txt}(82,628 real changes made)

{com}.                 replace claswho = 3 if tipaten == 1 & (afec_nos16 != "O00" & afec_nos16 != "O01" & afec_nos16 != "O02" & afec_nos16 != "O03" & afec_nos16 != "O04" & afec_nos16 != "O05" & afec_nos16 != "O06" & afec_nos16 != "O07" & afec_nos16 != "O08" )    
{txt}(2,849 real changes made)

{com}.                 
.                 *Other direct causes
.                 replace claswho = 4 if (afec_nos16 == "F53"|afec_nos16 == "O21"|afec_nos16 == "O26"|afec_nos16 == "O28"|afec_nos16 == "O30"|afec_nos16 == "O31"|afec_nos16 == "O32"|afec_nos16 == "O34"|afec_nos16 == "O35"|afec_nos16 == "O36"|afec_nos16 == "O40"|afec_nos16 == "O41"|afec_nos16 == "O410"|afec_nos16 == "O418"|afec_nos16 == "O419"|afec_nos16 == "O42"|afec_nos16 == "O43 "|afec_nos16 == "O47"|afec_nos16 == "O48"|afec_nos16 == "O60"|afec_nos16 == "O61"|afec_nos16 == "O68"|afec_nos16 == "O69"|afec_nos16 == "O73"|afec_nos16 == "O80"|afec_nos16 == "O81"|afec_nos16 == "O82"|afec_nos16 == "O83"|afec_nos16 == "O84"|afec_nos16 == "O90"|afec_nos16 == "O91"|afec_nos16 == "O92"|afec_nos16 == "Y87"|afecprin== "O717"|afecprin == "O440"|afecprin == "O244") 
{txt}(907,447 real changes made)

{com}.                 
.                 *Complicactions of anethesia
.                 replace claswho = 5 if (afec_nos16 == "O29"|afec_nos16 == "O74"|afec_nos16 == "O89")
{txt}(705 real changes made)

{com}.                 
.                 *Complications - obstetric trauma
.                 replace claswho = 6 if (afec_nos16 == "O71"|afecprin== "O715"|afecprin == "O716"|afecprin == "O718"|afecprin == "O719")
{txt}(1,006 real changes made)

{com}.                 
.                 *Complications -other-not specified
.                 replace claswho = 7 if (afec_nos16 == "O75"|afec_nos16 == "Y60"|afecprin == "O750"|afecprin == "O751"|afecprin == "O752"|afecprin== "O754"|afecprin == "O755"|afecprin == "O756"|afecprin == "O758"|afecprin == "O759")
{txt}(8,059 real changes made)

{com}.                 
.                 *Obstructed labor
.                 replace claswho = 8 if (afec_nos16 == "O33"|afec_nos16 == "O62"|afec_nos16 == "O63"|afec_nos16 == "O64"|afec_nos16 == "O65"|afec_nos16 == "O66")
{txt}(97,812 real changes made)

{com}.                 
.                 *Embolism
.                 replace claswho = 9 if (afec_nos16 == "O22"|afec_nos16 == "O87"|afec_nos16 == "O88")
{txt}(337 real changes made)

{com}.                 
.                 *Antenatal obstetric Haemorrage
.                 replace claswho = 10 if (afec_nos16 == "O44"|afec_nos16 == "O45"|afec_nos16 == "O46"|afecprin== "O710"|afecprin == "O441")
{txt}(5,509 real changes made)

{com}.                 
.                 *Intrapartum obstetric Haemorrage
.                 replace claswho = 11 if (afec_nos16 == "O67"|afec_nos16 == "O70"|afecprin == "O711"|afecprin == "O757")
{txt}(6,545 real changes made)

{com}.                 
.                 *Postpartum obstetric haemorrage
.                 replace claswho = 12 if (afec_nos16 == "O72"|afecprin == "O712")
{txt}(3,756 real changes made)

{com}.                 
.                 *Obstetric haemorrage - other
.                 replace claswho = 13 if (afec_nos16 == "O20"|afec_nos16 == "O713"|afec_nos16 == "O714")
{txt}(15,493 real changes made)

{com}.                 
.                 *Hypertensive disorders
.                 replace claswho = 14 if (afec_nos16 == "O10"|afec_nos16 == "O11"|afec_nos16 == "O12"|afec_nos16 == "O13"|afec_nos16 == "O14"|afec_nos16 == "O15"|afec_nos16 == "O16")
{txt}(56,424 real changes made)

{com}.                 
.                 *Pregnancy related sepsys
.                 replace claswho = 15 if (afec_nos16 == "A34"|afec_nos16 == "O85"|afec_nos16 == "O86"|afecprin == "O411"|afecprin == "O753")
{txt}(2,861 real changes made)

{com}.                 
.                 *Direct causes - other
.                 replace claswho = 16 if (afec_nos16 == "O95")
{txt}(0 real changes made)

{com}.                 
.                 *Indirect causes â medical disorders
.                 replace claswho = 17 if (afec_nos16 == "O99" | afec_nos16 == "O24" & afecprin!="O244") 
{txt}(19,362 real changes made)

{com}.                 
.                 *Indirect causes â HIV related
.                 replace claswho = 18 if (afecprin == "O987")
{txt}(153 real changes made)

{com}.                 
.                 *Indirect causes - other
.                 replace claswho = 19 if (afec_nos16 == "I40"|afec_nos16 == "O23"|afec_nos16 == "O25"|afec_nos16 == "O98"|afecprin == "O980"|afecprin== "O981"|afecprin== "O982"|afecprin== "O983"|afecprin== "O984"|afecprin== "O985"|afecprin== "O986"|afecprin == "O988"|afecprin== "O989")
{txt}(27,097 real changes made)

{com}. 
. 
.         *labels clas_who
.         label define claswhOOO 1 "Ectopic pregnancy" 2 "Miscarriage" 3 "Abortion" 4 "Other direct" 5 "Compl anethesia" 6 "Comp obs trauma" 7 "Comp OthNotSpec" 8 "Obstru labor" 9 "Embolism" 10 "AntenObst Haemor" 11 "IntraparObste Haemor" 12 "PostparObst Haemor" 13 "ObstHaemor Other" 14 "Hypertensive disorders" 15 "PregRelat Sepsys" 16 "DireCaus Other" 17 "IndiCau MedDisorders" 18 "IndiCaus HIV rel" 19 "IndiCaus Other"
{txt}
{com}.         label values claswho claswhOOO
{txt}
{com}.         
.         **
. * ABORTO NOSOTROS por afeccion (sustituye a abort_nos) version LARGO
. **
. *drop aborto_nos
. gen aborto_nos =.
{txt}(2,959,197 missing values generated)

{com}. replace aborto_nos = 0 if afec_nos16 =="O00" 
{txt}(6,726 real changes made)

{com}. replace aborto_nos = 1 if afec_nos16 =="O01" 
{txt}(1,180 real changes made)

{com}. replace aborto_nos = 2 if afec_nos16 =="O02" 
{txt}(23,013 real changes made)

{com}. replace aborto_nos = 3 if afec_nos16 =="O03" 
{txt}(14,179 real changes made)

{com}. replace aborto_nos = 4 if afec_nos16 =="O04" 
{txt}(260 real changes made)

{com}. replace aborto_nos = 5 if afec_nos16 =="O05" 
{txt}(4,107 real changes made)

{com}. replace aborto_nos = 6 if afec_nos16 =="O06" 
{txt}(77,923 real changes made)

{com}. replace aborto_nos = 7 if afec_nos16 =="O07" 
{txt}(22 real changes made)

{com}. replace aborto_nos = 8 if afec_nos16 =="O08"
{txt}(316 real changes made)

{com}. replace aborto_nos = 9 if tipaten ==1 & aborto_nos==.  
{txt}(2,849 real changes made)

{com}. 
. tab aborto_nos

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. label define obortonos16 0"O00 Ectopic" 1 "O01 Molar" 2 "O02 OthrProd" 3 "O03 Spontaneous" 4 "O04 Medical" 5 "O05 OthrAbort" 6 "O06 Unspecified" 7 "O07 FailAttem" 8 "O08 ComplEcMoAbo" 9 "TipAtenAbort" 
{txt}
{com}. label values aborto_nos obortonos16
{txt}
{com}. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. tab aborto_nos year

                 {txt}{c |}    year
      aborto_nos {c |}      2014 {c |}     Total
{hline 17}{c +}{hline 11}{c +}{hline 10}
     O00 Ectopic {c |}{res}     6,562 {txt}{c |}{res}     6,562 
{txt}       O01 Molar {c |}{res}     1,139 {txt}{c |}{res}     1,139 
{txt}    O02 OthrProd {c |}{res}    22,960 {txt}{c |}{res}    22,960 
{txt} O03 Spontaneous {c |}{res}    14,128 {txt}{c |}{res}    14,128 
{txt}     O04 Medical {c |}{res}       249 {txt}{c |}{res}       249 
{txt}   O05 OthrAbort {c |}{res}     4,097 {txt}{c |}{res}     4,097 
{txt} O06 Unspecified {c |}{res}    77,872 {txt}{c |}{res}    77,872 
{txt}   O07 FailAttem {c |}{res}        22 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}       313 {txt}{c |}{res}       313 
{txt}    TipAtenAbort {c |}{res}     2,849 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 11}{c +}{hline 10}
           Total {c |}{res}   130,191 {txt}{c |}{res}   130,191 

{txt}
{com}. 
. * Eliminando duplicados para tipo de atencion aborto
. duplicates drop egreso clues folio if aborto_nos==9, force

{p 0 4}{txt}Duplicates in terms of {res} egreso clues folio{p_end}

{txt}(0 observations are duplicates)

{com}. **SOLO 1 DUPLICADO! EN TEORIA ESTA BIEN, PORQUE YA PEGAMOS SOLO CASOS UNICOS DE TIPO DE ATENCION ABORTO Y NO ABORTO NOSOTROS!!
. 
. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00
{txt}
{com}. 
. 
. 
. **
. *OBSTETRICAS NOSOTROS por afeccion (sustituye a obs_nos)
. **
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" POR BLOQUE, version LARGO
. **      
. *drop obste_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obste_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obste_nos16=1 if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obste_nos16=2 if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obste_nos16=3 if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obste_nos16=4 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obste_nos16=5 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obste_nos16=6 if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obste_nos16=7 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obste_nos16=8 if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obste_nos16 = 9 if (tipaten==0 & obste_nos16==.)
{txt}(0 real changes made)

{com}.         replace obste_nos16 = 10 if (tipaten==1 & obste_nos16==.)
{txt}(782 real changes made)

{com}.         
. label define obtetcnos16 1"O0-O0Abortive" 2 "O10-O16Edema" 3 "O20-O29RelPreg" 4 "O30-O48Fetus" 5 "O60-O75Labour" 6 "O80-O84Delivery" 7 "O85-O92Puerperium" 8 "O94-O99OthObst" 9 "TipAtenParto" 10 "TipAtenAborto"
{txt}
{com}. label values obste_nos16 obtetcnos16
{txt}
{com}. 
. tab obste_nos16

      {txt}obste_nos16 {c |}      Freq.     Percent        Cum.
{hline 18}{c +}{hline 35}
    O0-O0Abortive {c |}{res}    127,726       10.00       10.00
{txt}     O10-O16Edema {c |}{res}     56,424        4.42       14.42
{txt}   O20-O29RelPreg {c |}{res}     51,573        4.04       18.45
{txt}     O30-O48Fetus {c |}{res}    268,751       21.04       39.49
{txt}    O60-O75Labour {c |}{res}    123,594        9.68       49.17
{txt}  O80-O84Delivery {c |}{res}    623,339       48.80       97.96
{txt}O85-O92Puerperium {c |}{res}      5,945        0.47       98.43
{txt}   O94-O99OthObst {c |}{res}     19,308        1.51       99.94
{txt}    TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 18}{c +}{hline 35}
            Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
. **
. *PARTO NOSOTROS (sustituye a part_nos)
. **
. * CREACION DE VARIABLE "PArto SEGUN NOSOTROS"
. *
. *drop part_nos16
. gen part_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. 
. ***Delivery ICD-10      
. replace part_nos16=0 if afec_nos16=="O80" 
{txt}(562,010 real changes made)

{com}. replace part_nos16=1 if afec_nos16=="O81" 
{txt}(2,041 real changes made)

{com}. replace part_nos16=2 if afec_nos16=="O82" 
{txt}(47,672 real changes made)

{com}. replace part_nos16=3 if afec_nos16=="O83" 
{txt}(10,810 real changes made)

{com}. replace part_nos16=4 if afec_nos16=="O84" 
{txt}(806 real changes made)

{com}. replace part_nos16 = 5 if (tipaten==0 & part_nos16==.)
{txt}(0 real changes made)

{com}. 
. tab part_nos16

 {txt}part_nos16 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}    562,010       90.16       90.16
{txt}          1 {c |}{res}      2,041        0.33       90.49
{txt}          2 {c |}{res}     47,672        7.65       98.14
{txt}          3 {c |}{res}     10,810        1.73       99.87
{txt}          4 {c |}{res}        806        0.13      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    623,339      100.00
{txt}
{com}. 
. label define partonso16 0 "O80 Un solo parto espontaneo" 1 "O81 Un solo parto con forceps y aspirad" 2 "O82 Un solo parto por cesarea" 3 "O83 Otro parto unico asistido" 4 "O84 Parto multiple" 5 "TipoAtencion Parto" 
{txt}
{com}. label values part_nos16 partonso16
{txt}
{com}. 
. 
. 
. **
. * CREACION VARIANLE "MISSING NOSOTROS16" si no tiene aborto_nos ni part_nos16 entonces es miss_nos16
. **
. *drop miss_nos16
. gen miss_nos16 = .
{txt}(2,959,197 missing values generated)

{com}. replace miss_nos16 = 1 if aborto_nos==. & part_nos16==.
{txt}(2,205,283 real changes made)

{com}. 
. label define missnsot16 1 "Missing nosotros" 
{txt}
{com}. label values miss_nos16 missnsot16
{txt}
{com}. 
. tab miss_nos16

      {txt}miss_nos16 {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
Missing nosotros {c |}{res}  2,205,283      100.00      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}  2,205,283      100.00
{txt}
{com}. 
. 
. 
. **
. *TIPO DE ATENCION NOSOTROS, por todas las afecciones, version largo
. **
. *Aborto nosotros, Parto nosotros, AbortParto Nosotros y Missing Nosotros
. *drop tipaten_nos16
. gen tipaten_nos16 =.
{txt}(2,959,197 missing values generated)

{com}. replace tipaten_nos16 = 0 if aborto_nos!=. & part_nos16==. & miss_nos16==. /*aborto*/
{txt}(130,575 real changes made)

{com}. replace tipaten_nos16 = 1 if part_nos16!=. & aborto_nos==. & miss_nos16==. /*parto*/
{txt}(623,339 real changes made)

{com}. replace tipaten_nos16 = 2 if aborto_nos!=. & part_nos16!=. & miss_nos16==. /*abortoParto*/
{txt}(0 real changes made)

{com}. replace tipaten_nos16 = 3 if aborto_nos==. & part_nos16==.
{txt}(2,205,283 real changes made)

{com}. 
. label define tipatenos 0 "Aborto Nosotros" 1 "Parto Nosotros" 2 "Aborto&Parto Nosotros" 3 "Missing Nosotros" 
{txt}
{com}. label values tipaten_nos16 tipatenos
{txt}
{com}. 
. tab tipaten_nos16

        {txt}tipaten_nos16 {c |}      Freq.     Percent        Cum.
{hline 22}{c +}{hline 35}
      Aborto Nosotros {c |}{res}    130,575        4.41        4.41
{txt}       Parto Nosotros {c |}{res}    623,339       21.06       25.48
{txt}     Missing Nosotros {c |}{res}  2,205,283       74.52      100.00
{txt}{hline 22}{c +}{hline 35}
                Total {c |}{res}  2,959,197      100.00
{txt}
{com}. 
. 
. 
. **
. * CREACION DE VARIABLE "OBSTÃTRICAS SEGUN NOSOTROS" individual
. **      
. *drop obsteInd_nos16
.         ***CAPiLO 1: Pregnancy with abortive outcome
.         gen obsteInd_nos16=.
{txt}(2,959,197 missing values generated)

{com}.         forvalues i = 0(1)8 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O0`i'"
{txt}  3{com}.         {c )-}
{txt}(6,726 real changes made)
(1,180 real changes made)
(23,013 real changes made)
(14,179 real changes made)
(260 real changes made)
(4,107 real changes made)
(77,923 real changes made)
(22 real changes made)
(316 real changes made)

{com}.         
.         ***CAPiLO 2: Oedema, proteinuria and hypertensive disorders in pregnancy, childbirth and the puerperium
.         forvalues i = 0(1)6 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=10+`i'  if afec_nos16=="O1`i'"
{txt}  3{com}.         {c )-}
{txt}(2,349 real changes made)
(156 real changes made)
(29 real changes made)
(21,374 real changes made)
(25,703 real changes made)
(1,988 real changes made)
(4,825 real changes made)

{com}.         
.         ***CAPiLO 3: Other maternal disorders predominantly related to pregnancy
.         forvalues i = 0(1)9 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=20+`i'  if afec_nos16=="O2`i'"
{txt}  3{com}.         {c )-}
{txt}(15,493 real changes made)
(1,249 real changes made)
(196 real changes made)
(23,557 real changes made)
(9,035 real changes made)
(32 real changes made)
(1,928 real changes made)
(0 real changes made)
(34 real changes made)
(49 real changes made)

{com}.         
.         ***CAPiLO 4: Maternal care related to the fetus and amniotic cavity and possible delivery problems
.         forvalues i = 30(1)48 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(3,891 real changes made)
(208 real changes made)
(14,087 real changes made)
(51,451 real changes made)
(56,666 real changes made)
(599 real changes made)
(27,324 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(1,322 real changes made)
(29,890 real changes made)
(41,819 real changes made)
(400 real changes made)
(2,888 real changes made)
(2,145 real changes made)
(410 real changes made)
(33,600 real changes made)
(2,051 real changes made)

{com}.         
.         ***CAPiLO 5: Complications of labour and delivery
.         forvalues i = 60(1)75 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(20,044 real changes made)
(4,366 real changes made)
(11,553 real changes made)
(9,937 real changes made)
(8,975 real changes made)
(10,923 real changes made)
(4,973 real changes made)
(977 real changes made)
(27,968 real changes made)
(5,092 real changes made)
(3,897 real changes made)
(1,006 real changes made)
(3,700 real changes made)
(1,875 real changes made)
(249 real changes made)
(8,059 real changes made)

{com}.         
.         ***CAPiLO 6: Delivery
.         forvalues i = 0(1)4 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=80+`i' if afec_nos16=="O8`i'"
{txt}  3{com}.         {c )-}
{txt}(562,010 real changes made)
(2,041 real changes made)
(47,672 real changes made)
(10,810 real changes made)
(806 real changes made)

{com}.         
.         ***CAPiLO 7: Complications predominantly related to the puerperium
.         forvalues i = 85(1)92 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(751 real changes made)
(1,354 real changes made)
(97 real changes made)
(44 real changes made)
(407 real changes made)
(2,935 real changes made)
(337 real changes made)
(20 real changes made)

{com}.         
.         ***CAPiLO 8: Other obstetric conditions, not elsewhere classified
.         forvalues i = 94(1)99 {c -(}
{txt}  2{com}.         replace obsteInd_nos16=`i' if afec_nos16=="O`i'"
{txt}  3{com}.         {c )-}
{txt}(34 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(3,455 real changes made)
(15,819 real changes made)

{com}. 
.         replace obsteInd_nos16 = 100 if (tipaten==0 & obsteInd_nos16==.)
{txt}(0 real changes made)

{com}.         replace obsteInd_nos16 = 101 if (tipaten==1 & obsteInd_nos16==.)
{txt}(782 real changes made)

{com}.         
. 
. **** A valores de categorÓ¡s ****
. label define obtetIncnos /* Primera categoria */ 0 "O00 Embarazo ectopico" 1 "O01 Mola Hidaltiforme" 2 "O02 Otros productos anormales" 3 "O03 Aborto espontaneo" 4 "O04 Aborto medico" 5 "O05 Otro aborto" 6 "O06 Aborto inespecifico" 7 "O07 Intento fallido" 8 "O08 Complicaciones despues de aborto/ect/molar" /* Segunda categoria */ 10 "O10 Hipertension pre-existente complicada con embarazo, parto y puerperio" 11 "O11 Pre-eclampsia superpuesta a hipertension cronica" 12 "O12 Edema y proteinuria gestacional sin hipertension" 13 "O13 Hipertension gestacional" 14 "O14 Pre-eclampsia" 15 "O15 Eclampsia" 16 "O16 Hipertension materna inespecificada"  /* Tercera categoria */ 20 "O20 Hemorragia temprana" 21 "O21 Vomito excesivo" 22 "O22 Complicaciones en venas y hemorroides" 23 "O23 Infecciones en tracto genitourinario" 24 "O24 Diabetes mellitus" 25 "O25 Malnutricion en embarazo" 26 "O26 Atencion para otras condiciones" 28 "O28 Hallazgos anormales en atencion pre-natal" 29 "O29 Complicaciones de anestesia durante el embarazo"/* Cuarta categoria */ 30 "O30 Gestacion multiple" 31 "O31 Complicaciones de gestacion multiple" 32 "O32 Atencion para malpresentacion del feto" 33 "O33 Atencion para desproporcion del feto" 34 "O34 Atencion para anormalidad de los organos pelvicos" 35 "O35 Atencion para anormalidad del feto" 36 "O36 Atencion para otros problemas fetales" 40 "O40 Polyhydramnios" 41 "O41 Otros desordenes de fluido amniotico y membranas" 42 "O42 Ruptura prematura de membranas" 43 "O43 Desordenes de placenta" 44 "O44 Placenta praevia" 45 "O45 Separacion prematura de placenta" 46 "O46 Hemorragia antes del parto no clasificada" 47 "O47 Falsa labor" 48 "O48 Embarazo prolongado" /* Quinta categoria */ 60 "O60 Labor y parto pretermino" 61 "O61 Induccion de labor fallida" 62 "O62 Anormalidades en las impulsoras de labor" 63 "O63 Labor extendida" 64 "O64 Labor obstruida por malposicion o malpresentacion de feto" 65 "O65 Labor obstruida por anormalidad pelvica de la madre" 66 "O66 Otra labor obstruida" 67 "O67 Labor y parto complicados por hemorragia intraparto no clasificada en otra parte" 68 "O68 Labor y parto complicados por estres fetal" 69 "O69 Labor y parto complicados por complicaciones con el cordon umbilical" 70 "O70 Laceracion perineal durante el parto" 71 "O71 Otro trauma obstetrico" 72 "O72 Hemorragia post-parto" 73 "O73 Placenta y membranas retenidos sin hemorragia" 74 "O74 Complicaciones de anestesia durante labor y parto" 75 "O75 Otras complicaciones de parto y labor no clasificadas" /* Sexta categoria */ 80 "O80 Un solo parto espontaneo" 81 "O81 Un solo parto con forceps y aspirado" 82 "O82 Un solo parto por cesarea" 83 "O83 Otro parto unico asistido" 84 "O84 Parto multiple" /* Septima categoria */ 85 "O85 Sepsis puerperal" 86 "O86 Otras infecciones puerperales" 87 "O87 Complicaciones en venas y hemorroides en el puerperio" 88 "O88 Embolia obstetrica" 89 "O89 Complicaciones de anestesia durante el puerperio" 90 "O90 Complicaciones del puerperio no clasificadas" 91 "O91 Infecciones de pecho asociadas con el nacimiento" 92 "O92 Otros desordenes de pecho y lactancia asociados al nacimiento"  /* Octava categoria */94 "O94 Secuela de complicacion en embarazo, parto y puerperio" 95 "O95 Muerte obstetrica de causa inespecifica" 96 "O96 Muerte por alguna causa obstetrica ocurrida despues de 42 dias pero antes de un despues del parto" 97 "O97 Muerte por secuela de causas obstetricas" 98 "O98 Infeccion materna y enfermedades parasitarias complicando el embarazo, parto y puerperio" 99 "O99 Otras enfermedades maternas complicando el embarazo, parto y puerperio" 100 "TipAtenPArto" 101 "TipAtenAborto"
{txt}
{com}. label values obsteInd_nos16 obtetIncnos
{txt}
{com}. 
. tab obsteInd_nos16

                         {txt}obsteInd_nos16 {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                  O00 Embarazo ectopico {c |}{res}      6,726        0.53        0.53
{txt}                  O01 Mola Hidaltiforme {c |}{res}      1,180        0.09        0.62
{txt}          O02 Otros productos anormales {c |}{res}     23,013        1.80        2.42
{txt}                  O03 Aborto espontaneo {c |}{res}     14,179        1.11        3.53
{txt}                      O04 Aborto medico {c |}{res}        260        0.02        3.55
{txt}                        O05 Otro aborto {c |}{res}      4,107        0.32        3.87
{txt}                O06 Aborto inespecifico {c |}{res}     77,923        6.10        9.97
{txt}                    O07 Intento fallido {c |}{res}         22        0.00        9.97
{txt}O08 Complicaciones despues de aborto/ec {c |}{res}        316        0.02       10.00
{txt}O10 Hipertension pre-existente complica {c |}{res}      2,349        0.18       10.18
{txt}O11 Pre-eclampsia superpuesta a hiperte {c |}{res}        156        0.01       10.19
{txt}O12 Edema y proteinuria gestacional sin {c |}{res}         29        0.00       10.20
{txt}           O13 Hipertension gestacional {c |}{res}     21,374        1.67       11.87
{txt}                      O14 Pre-eclampsia {c |}{res}     25,703        2.01       13.88
{txt}                          O15 Eclampsia {c |}{res}      1,988        0.16       14.04
{txt}O16 Hipertension materna inespecificada {c |}{res}      4,825        0.38       14.42
{txt}                O20 Hemorragia temprana {c |}{res}     15,493        1.21       15.63
{txt}                    O21 Vomito excesivo {c |}{res}      1,249        0.10       15.73
{txt}O22 Complicaciones en venas y hemorroid {c |}{res}        196        0.02       15.74
{txt}O23 Infecciones en tracto genitourinari {c |}{res}     23,557        1.84       17.59
{txt}                  O24 Diabetes mellitus {c |}{res}      9,035        0.71       18.29
{txt}           O25 Malnutricion en embarazo {c |}{res}         32        0.00       18.30
{txt}    O26 Atencion para otras condiciones {c |}{res}      1,928        0.15       18.45
{txt}O28 Hallazgos anormales en atencion pre {c |}{res}         34        0.00       18.45
{txt}O29 Complicaciones de anestesia durante {c |}{res}         49        0.00       18.45
{txt}                 O30 Gestacion multiple {c |}{res}      3,891        0.30       18.76
{txt}O31 Complicaciones de gestacion multipl {c |}{res}        208        0.02       18.77
{txt}O32 Atencion para malpresentacion del f {c |}{res}     14,087        1.10       19.88
{txt}O33 Atencion para desproporcion del fet {c |}{res}     51,451        4.03       23.90
{txt}O34 Atencion para anormalidad de los or {c |}{res}     56,666        4.44       28.34
{txt} O35 Atencion para anormalidad del feto {c |}{res}        599        0.05       28.39
{txt}O36 Atencion para otros problemas fetal {c |}{res}     27,324        2.14       30.53
{txt}                     O40 Polyhydramnios {c |}{res}      1,322        0.10       30.63
{txt}O41 Otros desordenes de fluido amniotic {c |}{res}     29,890        2.34       32.97
{txt}     O42 Ruptura prematura de membranas {c |}{res}     41,819        3.27       36.24
{txt}             O43 Desordenes de placenta {c |}{res}        400        0.03       36.27
{txt}                   O44 Placenta praevia {c |}{res}      2,888        0.23       36.50
{txt}   O45 Separacion prematura de placenta {c |}{res}      2,145        0.17       36.67
{txt}O46 Hemorragia antes del parto no clasi {c |}{res}        410        0.03       36.70
{txt}                        O47 Falsa labor {c |}{res}     33,600        2.63       39.33
{txt}                O48 Embarazo prolongado {c |}{res}      2,051        0.16       39.49
{txt}           O60 Labor y parto pretermino {c |}{res}     20,044        1.57       41.06
{txt}         O61 Induccion de labor fallida {c |}{res}      4,366        0.34       41.40
{txt}O62 Anormalidades en las impulsoras de  {c |}{res}     11,553        0.90       42.31
{txt}                    O63 Labor extendida {c |}{res}      9,937        0.78       43.08
{txt}O64 Labor obstruida por malposicion o m {c |}{res}      8,975        0.70       43.79
{txt}O65 Labor obstruida por anormalidad pel {c |}{res}     10,923        0.86       44.64
{txt}               O66 Otra labor obstruida {c |}{res}      4,973        0.39       45.03
{txt}O67 Labor y parto complicados por hemor {c |}{res}        977        0.08       45.11
{txt}O68 Labor y parto complicados por estre {c |}{res}     27,968        2.19       47.30
{txt}O69 Labor y parto complicados por compl {c |}{res}      5,092        0.40       47.70
{txt}O70 Laceracion perineal durante el part {c |}{res}      3,897        0.31       48.00
{txt}             O71 Otro trauma obstetrico {c |}{res}      1,006        0.08       48.08
{txt}              O72 Hemorragia post-parto {c |}{res}      3,700        0.29       48.37
{txt}O73 Placenta y membranas retenidos sin  {c |}{res}      1,875        0.15       48.52
{txt}O74 Complicaciones de anestesia durante {c |}{res}        249        0.02       48.54
{txt}O75 Otras complicaciones de parto y lab {c |}{res}      8,059        0.63       49.17
{txt}           O80 Un solo parto espontaneo {c |}{res}    562,010       43.99       93.16
{txt}O81 Un solo parto con forceps y aspirad {c |}{res}      2,041        0.16       93.32
{txt}          O82 Un solo parto por cesarea {c |}{res}     47,672        3.73       97.05
{txt}          O83 Otro parto unico asistido {c |}{res}     10,810        0.85       97.90
{txt}                     O84 Parto multiple {c |}{res}        806        0.06       97.96
{txt}                   O85 Sepsis puerperal {c |}{res}        751        0.06       98.02
{txt}      O86 Otras infecciones puerperales {c |}{res}      1,354        0.11       98.13
{txt}O87 Complicaciones en venas y hemorroid {c |}{res}         97        0.01       98.13
{txt}                 O88 Embolia obstetrica {c |}{res}         44        0.00       98.14
{txt}O89 Complicaciones de anestesia durante {c |}{res}        407        0.03       98.17
{txt}O90 Complicaciones del puerperio no cla {c |}{res}      2,935        0.23       98.40
{txt}O91 Infecciones de pecho asociadas con  {c |}{res}        337        0.03       98.43
{txt}O92 Otros desordenes de pecho y lactanc {c |}{res}         20        0.00       98.43
{txt}O94 Secuela de complicacion en embarazo {c |}{res}         34        0.00       98.43
{txt}O98 Infeccion materna y enfermedades pa {c |}{res}      3,455        0.27       98.70
{txt}O99 Otras enfermedades maternas complic {c |}{res}     15,819        1.24       99.94
{txt}                          TipAtenAborto {c |}{res}        782        0.06      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}  1,277,442      100.00
{txt}
{com}. 
. 
. 
. 
. *******************
. *PARTE 7
. ******************
. 
. *VARIABLES Y TABLAS PARA MANUSCRITO 
. 
. label define entidad 1 "Aguascalientes" 2 "Baja California" 3 "Baja California Sur" 4 "Campeche" 5 "Coahuila de Zaragoza" 6 "Colima" 7 "Chiapas" 8 "Chihuahua" 9 "Distrito Federal" 10 "Durango" 11 "Guanajuato" 12 "Guerrero" 13 "Hidalgo" 14 "Jalisco" 15 "Mexico" 16 "Michoacan de Ocampo" 17 "Morelos" 18 "Nayarit" 19 "Nuevo Leon" 20 "Oaxaca" 21 "Puebla" 22 "Queretaro" 23 "Quintana Roo" 24 "San Luis Potosi" 25 "Sinaloa" 26 "Sonora" 27 "Tabasco" 28 "Tamaulipas" 29 "Tlaxcala" 30 "Veracruz de Ignacio de la Llave" 31 "Yucatan" 32 "Zacatecas" 33 "Estaduos Unidos de Norteamerica" 34 "Otros paises latinoamericanos" 35 "Otros paises" 99 "No Especificado"
{txt}
{com}. 
. label values entidad entidad
{txt}
{com}. 
. **CREACIÃN DE VARIABLES
. **
. 
. *generando Grandes Grupos de EDAD
. *drop edad_nos
. gen edad_nos=.
{txt}(2,959,197 missing values generated)

{com}. replace edad_nos=1 if edad <18 & edad!=.
{txt}(644,872 real changes made)

{com}. replace edad_nos=2 if edad <26 & edad_nos==.
{txt}(828,955 real changes made)

{com}. replace edad_nos=3 if edad <31 & edad_nos==.
{txt}(341,467 real changes made)

{com}. replace edad_nos=4 if edad <41 & edad_nos==.
{txt}(405,141 real changes made)

{com}. replace edad_nos=5 if edad >40 & edad_nos==.
{txt}(738,762 real changes made)

{com}. 
. label define edadnos 1  "< 18" 2  "18 - 25" 3  "26 - 30" 4  "31 - 40" 5  "> 40" 
{txt}
{com}. label values edad_nos edadnos
{txt}
{com}. 
. *generando la vairble de 2do trimestre tardio hasta semana 24 con tres categorias
. *drop trim23
. gen trim23 = .
{txt}(2,959,197 missing values generated)

{com}. replace trim23 = 1 if  gestac < 17 & gestac > 12
{txt}(10,345 real changes made)

{com}. replace trim23 = 2 if  gestac < 21 & gestac > 16
{txt}(6,055 real changes made)

{com}. replace trim23 = 3 if  gestac < 25 & gestac > 20
{txt}(3,059 real changes made)

{com}. 
. label define trimeSS23 1  "13-16" 2  "17-20" 3 "21-24"
{txt}
{com}. label values trim23 trimeSS23
{txt}
{com}. 
. **
. **TABLAS
. **
. 
. *total de EGERESOS de 2007 a 2014
. count if year!=. & year >2006
  {res}1,282,693
{txt}
{com}. 
. *total de abortos
. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}     23,013       18.76       18.76
{txt} O03 Spontaneous {c |}{res}     14,179       11.56       30.32
{txt}     O04 Medical {c |}{res}        260        0.21       30.53
{txt}   O05 OthrAbort {c |}{res}      4,107        3.35       33.88
{txt} O06 Unspecified {c |}{res}     77,923       63.52       97.40
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.42
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.26       97.68
{txt}    TipAtenAbort {c |}{res}      2,849        2.32      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    122,669      100.00
{txt}
{com}. 
. *aborto que tienen edad gestacional de 2007 a 2014
. tab aborto_nos if gestac!=. & aborto_nos!=0     & aborto_nos!=1 & year >2006

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}     20,744       18.39       18.39
{txt} O03 Spontaneous {c |}{res}     12,342       10.94       29.33
{txt}     O04 Medical {c |}{res}        186        0.16       29.50
{txt}   O05 OthrAbort {c |}{res}      3,413        3.03       32.52
{txt} O06 Unspecified {c |}{res}     73,046       64.76       97.29
{txt}   O07 FailAttem {c |}{res}          1        0.00       97.29
{txt}O08 ComplEcMoAbo {c |}{res}        212        0.19       97.47
{txt}    TipAtenAbort {c |}{res}      2,849        2.53      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    112,793      100.00
{txt}
{com}. 
. 
. *aborto que tienen edad gestacional de 2007 a 2014 en SEGUNDO TRIMESTRE
. tab aborto_nos if aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=.

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
    O02 OthrProd {c |}{res}      2,154       13.33       13.33
{txt} O03 Spontaneous {c |}{res}      1,949       12.06       25.39
{txt}     O04 Medical {c |}{res}         28        0.17       25.56
{txt}   O05 OthrAbort {c |}{res}        469        2.90       28.47
{txt} O06 Unspecified {c |}{res}     11,007       68.12       96.58
{txt}O08 ComplEcMoAbo {c |}{res}         21        0.13       96.71
{txt}    TipAtenAbort {c |}{res}        531        3.29      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}     16,159      100.00
{txt}
{com}. tab trim23     if aborto_nos!=0 & aborto_nos!=1 & year >2006 & aborto_nos!=.

     {txt}trim23 {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      13-16 {c |}{res}     10,182       63.01       63.01
{txt}      17-20 {c |}{res}      5,976       36.98       99.99
{txt}      21-24 {c |}{res}          1        0.01      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     16,159      100.00
{txt}
{com}. 
. *tabla por semanas de gestacion
. *(tab aborto_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1)
. tab aborto_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006

                 {txt}{c |}              trim23
      aborto_nos {c |}     13-16      17-20      21-24 {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
    O02 OthrProd {c |}{res}     1,617        537          0 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}     1,155        794          0 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}        12         16          0 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}       277        192          0 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}     6,896      4,111          0 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}        12          8          1 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}       213        318          0 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}    10,182      5,976          1 {txt}{c |}{res}    16,159 

{txt}
{com}. 
. 
. * tablas por edad, aborto en senguno trimestre
. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23!=. 

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}      2,022       12.51       12.51
{txt}    18 - 25 {c |}{res}      7,395       45.76       58.28
{txt}    26 - 30 {c |}{res}      3,054       18.90       77.18
{txt}    31 - 40 {c |}{res}      3,279       20.29       97.47
{txt}       > 40 {c |}{res}        409        2.53      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     16,159      100.00
{txt}
{com}. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23==1

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}      1,263       12.40       12.40
{txt}    18 - 25 {c |}{res}      4,610       45.28       57.68
{txt}    26 - 30 {c |}{res}      1,935       19.00       76.68
{txt}    31 - 40 {c |}{res}      2,096       20.59       97.27
{txt}       > 40 {c |}{res}        278        2.73      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}     10,182      100.00
{txt}
{com}. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23==2

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}        758       12.68       12.68
{txt}    18 - 25 {c |}{res}      2,785       46.60       59.29
{txt}    26 - 30 {c |}{res}      1,119       18.72       78.01
{txt}    31 - 40 {c |}{res}      1,183       19.80       97.81
{txt}       > 40 {c |}{res}        131        2.19      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}      5,976      100.00
{txt}
{com}. tab edad_nos if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim23==3

   {txt}edad_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
       < 18 {c |}{res}          1      100.00      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}          1      100.00
{txt}
{com}. 
. tab edad_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006

           {txt}{c |}              trim23
  edad_nos {c |}     13-16      17-20      21-24 {c |}     Total
{hline 11}{c +}{hline 33}{c +}{hline 10}
      < 18 {c |}{res}     1,263        758          1 {txt}{c |}{res}     2,022 
{txt}   18 - 25 {c |}{res}     4,610      2,785          0 {txt}{c |}{res}     7,395 
{txt}   26 - 30 {c |}{res}     1,935      1,119          0 {txt}{c |}{res}     3,054 
{txt}   31 - 40 {c |}{res}     2,096      1,183          0 {txt}{c |}{res}     3,279 
{txt}      > 40 {c |}{res}       278        131          0 {txt}{c |}{res}       409 
{txt}{hline 11}{c +}{hline 33}{c +}{hline 10}
     Total {c |}{res}    10,182      5,976          1 {txt}{c |}{res}    16,159 

{txt}
{com}. tab edad_nos trim23 if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006, chi2

           {txt}{c |}              trim23
  edad_nos {c |}     13-16      17-20      21-24 {c |}     Total
{hline 11}{c +}{hline 33}{c +}{hline 10}
      < 18 {c |}{res}     1,263        758          1 {txt}{c |}{res}     2,022 
{txt}   18 - 25 {c |}{res}     4,610      2,785          0 {txt}{c |}{res}     7,395 
{txt}   26 - 30 {c |}{res}     1,935      1,119          0 {txt}{c |}{res}     3,054 
{txt}   31 - 40 {c |}{res}     2,096      1,183          0 {txt}{c |}{res}     3,279 
{txt}      > 40 {c |}{res}       278        131          0 {txt}{c |}{res}       409 
{txt}{hline 11}{c +}{hline 33}{c +}{hline 10}
     Total {c |}{res}    10,182      5,976          1 {txt}{c |}{res}    16,159 

{txt}          Pearson chi2({res}8{txt}) = {res} 14.2987  {txt} Pr = {res}0.074
{txt}
{com}. 
. *tablas por indice de marginacion
. tab quint if aborto_nos!=. & aborto_nos!=0 & aborto_nos!=1 & year >2006 & trim2!=.
{err}variable {bf}quint{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. tab aborto_nos entidad

                 {txt}{c |}             ENTIDAD
      aborto_nos {c |} Aguascali  Baja Cali  Baja Cali {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}        96        163         37 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        19         43          7 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       744        538        208 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}        13      1,300         80 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         1          0          4 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}         1         20        114 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}       922        906        310 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         1          3          1 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        35        242         13 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     1,832      3,215        774 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |}  Campeche  Coahuila      Colima {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}        60        125         41 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}         4         14          0 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       238        432        227 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}        39         92         46 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         1          2          0 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}        15          1          1 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}       801      1,889        522 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         5          1          2 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        15         68         34 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     1,178      2,624        873 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |}   Chiapas  Chihuahua  Distrito  {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       335        193        613 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}       125         20         95 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       710        538        587 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}       407        486      1,707 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}        64          1          9 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}       411        183          3 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     5,166      1,036      4,772 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          1          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}        19         21         10 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}       138         29        317 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     7,375      2,508      8,113 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |}   Durango  Guanajuat   Guerrero {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       136        308        256 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        10         37         23 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       614      2,669        995 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}       293         92        772 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         0          2          6 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}        92          4         12 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     1,212      4,494      2,682 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          1 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         3          8         15 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        42         13        132 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     2,402      7,627      4,894 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |}   Hidalgo    Jalisco     Mexico {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       206        394        975 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        20         39        121 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       566      1,779      2,543 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}        52        718      4,214 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         0         19         83 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}         7        393        779 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     1,989      5,595      8,466 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          1         16 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}        25         21         27 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        36        133        499 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     2,901      9,092     17,723 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |} Michoacan    Morelos    Nayarit {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       208        120         75 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        49         23         17 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       885        508        140 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}       229         45         40 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         5          1          0 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}       887        253          2 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     2,674      1,699      1,012 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          1 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}        12         14          6 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}       199         99         35 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     5,148      2,762      1,328 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |} Nuevo Leo     Oaxaca     Puebla {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       193        234        270 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        20         57         56 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       155        570        980 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}       156         93         25 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         0          6          0 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}         0         77         48 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     2,115      3,466      4,987 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          1          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         3          9         10 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        38         63         39 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     2,680      4,576      6,415 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |} Queretaro  Quintana   San Luis  {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       159         94        136 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        60         10         34 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       387        464        449 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}        14        141        922 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         7          3          5 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}        14          5         12 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     2,023      1,125      1,320 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         9          1          4 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        51         33         31 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     2,724      1,876      2,913 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |}   Sinaloa     Sonora    Tabasco {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       120        187        154 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        26         13         32 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       545        579      1,086 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}       721        343         18 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}        12          2          4 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}       260        122          4 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     1,493      1,908      2,531 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         3          6         11 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        78         70         38 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     3,258      3,230      3,878 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |} Tamaulipa   Tlaxcala  Veracruz  {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}       167         97        368 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        20         10        132 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       594        488        879 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}       114         18        382 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         6          0          6 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}         7          1        313 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     2,799      1,362      4,511 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          1 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}        19          2         19 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        72         27        147 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     3,798      2,005      6,758 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |}   Yucatan  Zacatecas  Estaduos  {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}        96        102          1 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}        25         13          0 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}       288        616          0 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}         5        592          1 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         0         11          0 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}         1         62          0 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}     1,288        807          0 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         3         23          0 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}        35         44          0 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}     1,741      2,270          2 {txt}{c |}{res}   130,575 


                 {txt}{c |}             ENTIDAD
      aborto_nos {c |} Otros pai  Otros pai  No Especi {c |}     Total
{hline 17}{c +}{hline 33}{c +}{hline 10}
     O00 Ectopic {c |}{res}         5          0          2 {txt}{c |}{res}     6,726 
{txt}       O01 Molar {c |}{res}         0          0          6 {txt}{c |}{res}     1,180 
{txt}    O02 OthrProd {c |}{res}         8          0          4 {txt}{c |}{res}    23,013 
{txt} O03 Spontaneous {c |}{res}         1          0          8 {txt}{c |}{res}    14,179 
{txt}     O04 Medical {c |}{res}         0          0          0 {txt}{c |}{res}       260 
{txt}   O05 OthrAbort {c |}{res}         0          0          3 {txt}{c |}{res}     4,107 
{txt} O06 Unspecified {c |}{res}        27          1         13 {txt}{c |}{res}    77,923 
{txt}   O07 FailAttem {c |}{res}         0          0          0 {txt}{c |}{res}        22 
{txt}O08 ComplEcMoAbo {c |}{res}         0          0          0 {txt}{c |}{res}       316 
{txt}    TipAtenAbort {c |}{res}         1          0          3 {txt}{c |}{res}     2,849 
{txt}{hline 17}{c +}{hline 33}{c +}{hline 10}
           Total {c |}{res}        42          1         39 {txt}{c |}{res}   130,575 


{com}. tab entidad aborto_nos

                      {txt}{c |}            aborto_nos
              ENTIDAD {c |} O00 Ectop  O01 Molar  O02 OthrP {c |}     Total
{hline 22}{c +}{hline 33}{c +}{hline 10}
       Aguascalientes {c |}{res}        96         19        744 {txt}{c |}{res}     1,832 
{txt}      Baja California {c |}{res}       163         43        538 {txt}{c |}{res}     3,215 
{txt}  Baja California Sur {c |}{res}        37          7        208 {txt}{c |}{res}       774 
{txt}             Campeche {c |}{res}        60          4        238 {txt}{c |}{res}     1,178 
{txt} Coahuila de Zaragoza {c |}{res}       125         14        432 {txt}{c |}{res}     2,624 
{txt}               Colima {c |}{res}        41          0        227 {txt}{c |}{res}       873 
{txt}              Chiapas {c |}{res}       335        125        710 {txt}{c |}{res}     7,375 
{txt}            Chihuahua {c |}{res}       193         20        538 {txt}{c |}{res}     2,508 
{txt}     Distrito Federal {c |}{res}       613         95        587 {txt}{c |}{res}     8,113 
{txt}              Durango {c |}{res}       136         10        614 {txt}{c |}{res}     2,402 
{txt}           Guanajuato {c |}{res}       308         37      2,669 {txt}{c |}{res}     7,627 
{txt}             Guerrero {c |}{res}       256         23        995 {txt}{c |}{res}     4,894 
{txt}              Hidalgo {c |}{res}       206         20        566 {txt}{c |}{res}     2,901 
{txt}              Jalisco {c |}{res}       394         39      1,779 {txt}{c |}{res}     9,092 
{txt}               Mexico {c |}{res}       975        121      2,543 {txt}{c |}{res}    17,723 
{txt}  Michoacan de Ocampo {c |}{res}       208         49        885 {txt}{c |}{res}     5,148 
{txt}              Morelos {c |}{res}       120         23        508 {txt}{c |}{res}     2,762 
{txt}              Nayarit {c |}{res}        75         17        140 {txt}{c |}{res}     1,328 
{txt}           Nuevo Leon {c |}{res}       193         20        155 {txt}{c |}{res}     2,680 
{txt}               Oaxaca {c |}{res}       234         57        570 {txt}{c |}{res}     4,576 
{txt}               Puebla {c |}{res}       270         56        980 {txt}{c |}{res}     6,415 
{txt}            Queretaro {c |}{res}       159         60        387 {txt}{c |}{res}     2,724 
{txt}         Quintana Roo {c |}{res}        94         10        464 {txt}{c |}{res}     1,876 
{txt}      San Luis Potosi {c |}{res}       136         34        449 {txt}{c |}{res}     2,913 
{txt}              Sinaloa {c |}{res}       120         26        545 {txt}{c |}{res}     3,258 
{txt}               Sonora {c |}{res}       187         13        579 {txt}{c |}{res}     3,230 
{txt}              Tabasco {c |}{res}       154         32      1,086 {txt}{c |}{res}     3,878 
{txt}           Tamaulipas {c |}{res}       167         20        594 {txt}{c |}{res}     3,798 
{txt}             Tlaxcala {c |}{res}        97         10        488 {txt}{c |}{res}     2,005 
{txt}Veracruz de Ignacio d {c |}{res}       368        132        879 {txt}{c |}{res}     6,758 
{txt}              Yucatan {c |}{res}        96         25        288 {txt}{c |}{res}     1,741 
{txt}            Zacatecas {c |}{res}       102         13        616 {txt}{c |}{res}     2,270 
{txt}Estaduos Unidos de No {c |}{res}         1          0          0 {txt}{c |}{res}         2 
{txt}Otros paises latinoam {c |}{res}         5          0          8 {txt}{c |}{res}        42 
{txt}         Otros paises {c |}{res}         0          0          0 {txt}{c |}{res}         1 
{txt}      No Especificado {c |}{res}         2          6          4 {txt}{c |}{res}        39 
{txt}{hline 22}{c +}{hline 33}{c +}{hline 10}
                Total {c |}{res}     6,726      1,180     23,013 {txt}{c |}{res}   130,575 


                      {txt}{c |}            aborto_nos
              ENTIDAD {c |} O03 Spont  O04 Medic  O05 OthrA {c |}     Total
{hline 22}{c +}{hline 33}{c +}{hline 10}
       Aguascalientes {c |}{res}        13          1          1 {txt}{c |}{res}     1,832 
{txt}      Baja California {c |}{res}     1,300          0         20 {txt}{c |}{res}     3,215 
{txt}  Baja California Sur {c |}{res}        80          4        114 {txt}{c |}{res}       774 
{txt}             Campeche {c |}{res}        39          1         15 {txt}{c |}{res}     1,178 
{txt} Coahuila de Zaragoza {c |}{res}        92          2          1 {txt}{c |}{res}     2,624 
{txt}               Colima {c |}{res}        46          0          1 {txt}{c |}{res}       873 
{txt}              Chiapas {c |}{res}       407         64        411 {txt}{c |}{res}     7,375 
{txt}            Chihuahua {c |}{res}       486          1        183 {txt}{c |}{res}     2,508 
{txt}     Distrito Federal {c |}{res}     1,707          9          3 {txt}{c |}{res}     8,113 
{txt}              Durango {c |}{res}       293          0         92 {txt}{c |}{res}     2,402 
{txt}           Guanajuato {c |}{res}        92          2          4 {txt}{c |}{res}     7,627 
{txt}             Guerrero {c |}{res}       772          6         12 {txt}{c |}{res}     4,894 
{txt}              Hidalgo {c |}{res}        52          0          7 {txt}{c |}{res}     2,901 
{txt}              Jalisco {c |}{res}       718         19        393 {txt}{c |}{res}     9,092 
{txt}               Mexico {c |}{res}     4,214         83        779 {txt}{c |}{res}    17,723 
{txt}  Michoacan de Ocampo {c |}{res}       229          5        887 {txt}{c |}{res}     5,148 
{txt}              Morelos {c |}{res}        45          1        253 {txt}{c |}{res}     2,762 
{txt}              Nayarit {c |}{res}        40          0          2 {txt}{c |}{res}     1,328 
{txt}           Nuevo Leon {c |}{res}       156          0          0 {txt}{c |}{res}     2,680 
{txt}               Oaxaca {c |}{res}        93          6         77 {txt}{c |}{res}     4,576 
{txt}               Puebla {c |}{res}        25          0         48 {txt}{c |}{res}     6,415 
{txt}            Queretaro {c |}{res}        14          7         14 {txt}{c |}{res}     2,724 
{txt}         Quintana Roo {c |}{res}       141          3          5 {txt}{c |}{res}     1,876 
{txt}      San Luis Potosi {c |}{res}       922          5         12 {txt}{c |}{res}     2,913 
{txt}              Sinaloa {c |}{res}       721         12        260 {txt}{c |}{res}     3,258 
{txt}               Sonora {c |}{res}       343          2        122 {txt}{c |}{res}     3,230 
{txt}              Tabasco {c |}{res}        18          4          4 {txt}{c |}{res}     3,878 
{txt}           Tamaulipas {c |}{res}       114          6          7 {txt}{c |}{res}     3,798 
{txt}             Tlaxcala {c |}{res}        18          0          1 {txt}{c |}{res}     2,005 
{txt}Veracruz de Ignacio d {c |}{res}       382          6        313 {txt}{c |}{res}     6,758 
{txt}              Yucatan {c |}{res}         5          0          1 {txt}{c |}{res}     1,741 
{txt}            Zacatecas {c |}{res}       592         11         62 {txt}{c |}{res}     2,270 
{txt}Estaduos Unidos de No {c |}{res}         1          0          0 {txt}{c |}{res}         2 
{txt}Otros paises latinoam {c |}{res}         1          0          0 {txt}{c |}{res}        42 
{txt}         Otros paises {c |}{res}         0          0          0 {txt}{c |}{res}         1 
{txt}      No Especificado {c |}{res}         8          0          3 {txt}{c |}{res}        39 
{txt}{hline 22}{c +}{hline 33}{c +}{hline 10}
                Total {c |}{res}    14,179        260      4,107 {txt}{c |}{res}   130,575 


                      {txt}{c |}            aborto_nos
              ENTIDAD {c |} O06 Unspe  O07 FailA  O08 Compl {c |}     Total
{hline 22}{c +}{hline 33}{c +}{hline 10}
       Aguascalientes {c |}{res}       922          0          1 {txt}{c |}{res}     1,832 
{txt}      Baja California {c |}{res}       906          0          3 {txt}{c |}{res}     3,215 
{txt}  Baja California Sur {c |}{res}       310          0          1 {txt}{c |}{res}       774 
{txt}             Campeche {c |}{res}       801          0          5 {txt}{c |}{res}     1,178 
{txt} Coahuila de Zaragoza {c |}{res}     1,889          0          1 {txt}{c |}{res}     2,624 
{txt}               Colima {c |}{res}       522          0          2 {txt}{c |}{res}       873 
{txt}              Chiapas {c |}{res}     5,166          0         19 {txt}{c |}{res}     7,375 
{txt}            Chihuahua {c |}{res}     1,036          1         21 {txt}{c |}{res}     2,508 
{txt}     Distrito Federal {c |}{res}     4,772          0         10 {txt}{c |}{res}     8,113 
{txt}              Durango {c |}{res}     1,212          0          3 {txt}{c |}{res}     2,402 
{txt}           Guanajuato {c |}{res}     4,494          0          8 {txt}{c |}{res}     7,627 
{txt}             Guerrero {c |}{res}     2,682          1         15 {txt}{c |}{res}     4,894 
{txt}              Hidalgo {c |}{res}     1,989          0         25 {txt}{c |}{res}     2,901 
{txt}              Jalisco {c |}{res}     5,595          1         21 {txt}{c |}{res}     9,092 
{txt}               Mexico {c |}{res}     8,466         16         27 {txt}{c |}{res}    17,723 
{txt}  Michoacan de Ocampo {c |}{res}     2,674          0         12 {txt}{c |}{res}     5,148 
{txt}              Morelos {c |}{res}     1,699          0         14 {txt}{c |}{res}     2,762 
{txt}              Nayarit {c |}{res}     1,012          1          6 {txt}{c |}{res}     1,328 
{txt}           Nuevo Leon {c |}{res}     2,115          0          3 {txt}{c |}{res}     2,680 
{txt}               Oaxaca {c |}{res}     3,466          1          9 {txt}{c |}{res}     4,576 
{txt}               Puebla {c |}{res}     4,987          0         10 {txt}{c |}{res}     6,415 
{txt}            Queretaro {c |}{res}     2,023          0          9 {txt}{c |}{res}     2,724 
{txt}         Quintana Roo {c |}{res}     1,125          0          1 {txt}{c |}{res}     1,876 
{txt}      San Luis Potosi {c |}{res}     1,320          0          4 {txt}{c |}{res}     2,913 
{txt}              Sinaloa {c |}{res}     1,493          0          3 {txt}{c |}{res}     3,258 
{txt}               Sonora {c |}{res}     1,908          0          6 {txt}{c |}{res}     3,230 
{txt}              Tabasco {c |}{res}     2,531          0         11 {txt}{c |}{res}     3,878 
{txt}           Tamaulipas {c |}{res}     2,799          0         19 {txt}{c |}{res}     3,798 
{txt}             Tlaxcala {c |}{res}     1,362          0          2 {txt}{c |}{res}     2,005 
{txt}Veracruz de Ignacio d {c |}{res}     4,511          1         19 {txt}{c |}{res}     6,758 
{txt}              Yucatan {c |}{res}     1,288          0          3 {txt}{c |}{res}     1,741 
{txt}            Zacatecas {c |}{res}       807          0         23 {txt}{c |}{res}     2,270 
{txt}Estaduos Unidos de No {c |}{res}         0          0          0 {txt}{c |}{res}         2 
{txt}Otros paises latinoam {c |}{res}        27          0          0 {txt}{c |}{res}        42 
{txt}         Otros paises {c |}{res}         1          0          0 {txt}{c |}{res}         1 
{txt}      No Especificado {c |}{res}        13          0          0 {txt}{c |}{res}        39 
{txt}{hline 22}{c +}{hline 33}{c +}{hline 10}
                Total {c |}{res}    77,923         22        316 {txt}{c |}{res}   130,575 


                      {txt}{c |} aborto_nos
              ENTIDAD {c |} TipAtenAb {c |}     Total
{hline 22}{c +}{hline 11}{c +}{hline 10}
       Aguascalientes {c |}{res}        35 {txt}{c |}{res}     1,832 
{txt}      Baja California {c |}{res}       242 {txt}{c |}{res}     3,215 
{txt}  Baja California Sur {c |}{res}        13 {txt}{c |}{res}       774 
{txt}             Campeche {c |}{res}        15 {txt}{c |}{res}     1,178 
{txt} Coahuila de Zaragoza {c |}{res}        68 {txt}{c |}{res}     2,624 
{txt}               Colima {c |}{res}        34 {txt}{c |}{res}       873 
{txt}              Chiapas {c |}{res}       138 {txt}{c |}{res}     7,375 
{txt}            Chihuahua {c |}{res}        29 {txt}{c |}{res}     2,508 
{txt}     Distrito Federal {c |}{res}       317 {txt}{c |}{res}     8,113 
{txt}              Durango {c |}{res}        42 {txt}{c |}{res}     2,402 
{txt}           Guanajuato {c |}{res}        13 {txt}{c |}{res}     7,627 
{txt}             Guerrero {c |}{res}       132 {txt}{c |}{res}     4,894 
{txt}              Hidalgo {c |}{res}        36 {txt}{c |}{res}     2,901 
{txt}              Jalisco {c |}{res}       133 {txt}{c |}{res}     9,092 
{txt}               Mexico {c |}{res}       499 {txt}{c |}{res}    17,723 
{txt}  Michoacan de Ocampo {c |}{res}       199 {txt}{c |}{res}     5,148 
{txt}              Morelos {c |}{res}        99 {txt}{c |}{res}     2,762 
{txt}              Nayarit {c |}{res}        35 {txt}{c |}{res}     1,328 
{txt}           Nuevo Leon {c |}{res}        38 {txt}{c |}{res}     2,680 
{txt}               Oaxaca {c |}{res}        63 {txt}{c |}{res}     4,576 
{txt}               Puebla {c |}{res}        39 {txt}{c |}{res}     6,415 
{txt}            Queretaro {c |}{res}        51 {txt}{c |}{res}     2,724 
{txt}         Quintana Roo {c |}{res}        33 {txt}{c |}{res}     1,876 
{txt}      San Luis Potosi {c |}{res}        31 {txt}{c |}{res}     2,913 
{txt}              Sinaloa {c |}{res}        78 {txt}{c |}{res}     3,258 
{txt}               Sonora {c |}{res}        70 {txt}{c |}{res}     3,230 
{txt}              Tabasco {c |}{res}        38 {txt}{c |}{res}     3,878 
{txt}           Tamaulipas {c |}{res}        72 {txt}{c |}{res}     3,798 
{txt}             Tlaxcala {c |}{res}        27 {txt}{c |}{res}     2,005 
{txt}Veracruz de Ignacio d {c |}{res}       147 {txt}{c |}{res}     6,758 
{txt}              Yucatan {c |}{res}        35 {txt}{c |}{res}     1,741 
{txt}            Zacatecas {c |}{res}        44 {txt}{c |}{res}     2,270 
{txt}Estaduos Unidos de No {c |}{res}         0 {txt}{c |}{res}         2 
{txt}Otros paises latinoam {c |}{res}         1 {txt}{c |}{res}        42 
{txt}         Otros paises {c |}{res}         0 {txt}{c |}{res}         1 
{txt}      No Especificado {c |}{res}         3 {txt}{c |}{res}        39 
{txt}{hline 22}{c +}{hline 11}{c +}{hline 10}
                Total {c |}{res}     2,849 {txt}{c |}{res}   130,575 


{com}. preserve 

. collapse (sum) aborto_nos, by(entidad) 

. br

. br

. sort aborto_nos

. restore

. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00

{com}. tab aborto_nos, nola

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00

{com}. tab aborto_nos if entidad == 9 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}        613        7.56        7.56
{txt}       O01 Molar {c |}{res}         95        1.17        8.73
{txt}    O02 OthrProd {c |}{res}        587        7.24       15.96
{txt} O03 Spontaneous {c |}{res}      1,707       21.04       37.00
{txt}     O04 Medical {c |}{res}          9        0.11       37.11
{txt}   O05 OthrAbort {c |}{res}          3        0.04       37.15
{txt} O06 Unspecified {c |}{res}      4,772       58.82       95.97
{txt}O08 ComplEcMoAbo {c |}{res}         10        0.12       96.09
{txt}    TipAtenAbort {c |}{res}        317        3.91      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}      8,113      100.00

{com}. tab aborto_nos if entidad == 9 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}          3        0.31        0.31
{txt}       O01 Molar {c |}{res}          4        0.42        0.73
{txt}    O02 OthrProd {c |}{res}         29        3.03        3.76
{txt} O03 Spontaneous {c |}{res}        252       26.30       30.06
{txt} O06 Unspecified {c |}{res}        667       69.62       99.69
{txt}    TipAtenAbort {c |}{res}          3        0.31      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}        958      100.00

{com}. tab aborto_nos if entidad == 1 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}         96        5.24        5.24
{txt}       O01 Molar {c |}{res}         19        1.04        6.28
{txt}    O02 OthrProd {c |}{res}        744       40.61       46.89
{txt} O03 Spontaneous {c |}{res}         13        0.71       47.60
{txt}     O04 Medical {c |}{res}          1        0.05       47.65
{txt}   O05 OthrAbort {c |}{res}          1        0.05       47.71
{txt} O06 Unspecified {c |}{res}        922       50.33       98.03
{txt}O08 ComplEcMoAbo {c |}{res}          1        0.05       98.09
{txt}    TipAtenAbort {c |}{res}         35        1.91      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}      1,832      100.00

{com}. tab aborto_nos if entidad == 1 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}         96        5.24        5.24
{txt}       O01 Molar {c |}{res}         19        1.04        6.28
{txt}    O02 OthrProd {c |}{res}        744       40.61       46.89
{txt} O03 Spontaneous {c |}{res}         13        0.71       47.60
{txt}     O04 Medical {c |}{res}          1        0.05       47.65
{txt}   O05 OthrAbort {c |}{res}          1        0.05       47.71
{txt} O06 Unspecified {c |}{res}        922       50.33       98.03
{txt}O08 ComplEcMoAbo {c |}{res}          1        0.05       98.09
{txt}    TipAtenAbort {c |}{res}         35        1.91      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}      1,832      100.00

{com}. tab aborto_nos if entidad == 1 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
       O01 Molar {c |}{res}          4        2.88        2.88
{txt}    O02 OthrProd {c |}{res}         51       36.69       39.57
{txt} O03 Spontaneous {c |}{res}          3        2.16       41.73
{txt} O06 Unspecified {c |}{res}         78       56.12       97.84
{txt}    TipAtenAbort {c |}{res}          3        2.16      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}        139      100.00

{com}. tab aborto_nos if entidad == 2 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}          5        2.29        2.29
{txt}       O01 Molar {c |}{res}          2        0.92        3.21
{txt}    O02 OthrProd {c |}{res}         17        7.80       11.01
{txt} O03 Spontaneous {c |}{res}        109       50.00       61.01
{txt}   O05 OthrAbort {c |}{res}          2        0.92       61.93
{txt} O06 Unspecified {c |}{res}         56       25.69       87.61
{txt}    TipAtenAbort {c |}{res}         27       12.39      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}        218      100.00

{com}. tab aborto_nos if entidad == 3 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
       O01 Molar {c |}{res}          1        0.75        0.75
{txt}    O02 OthrProd {c |}{res}         32       24.06       24.81
{txt} O03 Spontaneous {c |}{res}         17       12.78       37.59
{txt}   O05 OthrAbort {c |}{res}         21       15.79       53.38
{txt} O06 Unspecified {c |}{res}         61       45.86       99.25
{txt}    TipAtenAbort {c |}{res}          1        0.75      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}        133      100.00

{com}. tab aborto_nos if entidad == 4 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
       O01 Molar {c |}{res}          1        1.45        1.45
{txt}    O02 OthrProd {c |}{res}         10       14.49       15.94
{txt} O03 Spontaneous {c |}{res}          5        7.25       23.19
{txt}   O05 OthrAbort {c |}{res}          2        2.90       26.09
{txt} O06 Unspecified {c |}{res}         49       71.01       97.10
{txt}    TipAtenAbort {c |}{res}          2        2.90      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}         69      100.00

{com}. tab aborto_nos if entidad == 4 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
       O01 Molar {c |}{res}          1        1.45        1.45
{txt}    O02 OthrProd {c |}{res}         10       14.49       15.94
{txt} O03 Spontaneous {c |}{res}          5        7.25       23.19
{txt}   O05 OthrAbort {c |}{res}          2        2.90       26.09
{txt} O06 Unspecified {c |}{res}         49       71.01       97.10
{txt}    TipAtenAbort {c |}{res}          2        2.90      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}         69      100.00

{com}. tab entidad

                        {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 32}{c +}{hline 35}
                 Aguascalientes {c |}{res}     43,187        1.46        1.46
{txt}                Baja California {c |}{res}     52,122        1.76        3.22
{txt}            Baja California Sur {c |}{res}     18,131        0.61        3.83
{txt}                       Campeche {c |}{res}     30,082        1.02        4.85
{txt}           Coahuila de Zaragoza {c |}{res}     49,492        1.67        6.52
{txt}                         Colima {c |}{res}     20,371        0.69        7.21
{txt}                        Chiapas {c |}{res}    139,371        4.71       11.92
{txt}                      Chihuahua {c |}{res}     77,235        2.61       14.53
{txt}               Distrito Federal {c |}{res}    205,745        6.95       21.48
{txt}                        Durango {c |}{res}     50,341        1.70       23.18
{txt}                     Guanajuato {c |}{res}    162,737        5.50       28.68
{txt}                       Guerrero {c |}{res}     94,962        3.21       31.89
{txt}                        Hidalgo {c |}{res}     64,633        2.18       34.08
{txt}                        Jalisco {c |}{res}    215,566        7.28       41.36
{txt}                         Mexico {c |}{res}    397,698       13.44       54.80
{txt}            Michoacan de Ocampo {c |}{res}    137,206        4.64       59.44
{txt}                        Morelos {c |}{res}     51,739        1.75       61.19
{txt}                        Nayarit {c |}{res}     28,236        0.95       62.14
{txt}                     Nuevo Leon {c |}{res}     57,795        1.95       64.09
{txt}                         Oaxaca {c |}{res}     94,853        3.21       67.30
{txt}                         Puebla {c |}{res}    124,250        4.20       71.50
{txt}                      Queretaro {c |}{res}     55,048        1.86       73.36
{txt}                   Quintana Roo {c |}{res}     39,978        1.35       74.71
{txt}                San Luis Potosi {c |}{res}     67,229        2.27       76.98
{txt}                        Sinaloa {c |}{res}     75,875        2.56       79.54
{txt}                         Sonora {c |}{res}     77,296        2.61       82.16
{txt}                        Tabasco {c |}{res}    109,024        3.68       85.84
{txt}                     Tamaulipas {c |}{res}     86,244        2.91       88.76
{txt}                       Tlaxcala {c |}{res}     46,400        1.57       90.32
{txt}Veracruz de Ignacio de la Llave {c |}{res}    176,466        5.96       96.29
{txt}                        Yucatan {c |}{res}     53,680        1.81       98.10
{txt}                      Zacatecas {c |}{res}     44,871        1.52       99.62
{txt}Estaduos Unidos de Norteamerica {c |}{res}         78        0.00       99.62
{txt}  Otros paises latinoamericanos {c |}{res}        842        0.03       99.65
{txt}                   Otros paises {c |}{res}         44        0.00       99.65
{txt}                No Especificado {c |}{res}     10,370        0.35      100.00
{txt}{hline 32}{c +}{hline 35}
                          Total {c |}{res}  2,959,197      100.00

{com}. tab aborto_nos if entidad == 15 & trim23 != . 

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}          7        0.38        0.38
{txt}       O01 Molar {c |}{res}          5        0.27        0.64
{txt}    O02 OthrProd {c |}{res}        171        9.18        9.82
{txt} O03 Spontaneous {c |}{res}        441       23.67       33.49
{txt}     O04 Medical {c |}{res}          5        0.27       33.76
{txt}   O05 OthrAbort {c |}{res}         97        5.21       38.97
{txt} O06 Unspecified {c |}{res}      1,072       57.54       96.51
{txt}O08 ComplEcMoAbo {c |}{res}          3        0.16       96.67
{txt}    TipAtenAbort {c |}{res}         62        3.33      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}      1,863      100.00

{com}. br afec
{bf}{err}afec{sf} ambiguous abbreviation
{txt}{search r(111), local:r(111);}

{com}. br AFEC*

. br if regexm(AFEC01, "Z301") 

. br AFEC01 if regexm(AFEC01, "Z301") 

. br AFEC01 if regexm(AFEC01, "Z303") 

. tab aborto_nos entidad if trim23 != . 

                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |} Aguascali  Baja Cali  Baja Cali   Campeche  Coahuila      Colima    Chiapas {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
     O00 Ectopic {c |}{res}         0          5          0          0          0          0          4 {txt}{c |}{res}       107 
{txt}       O01 Molar {c |}{res}         4          2          1          1          1          0         16 {txt}{c |}{res}       135 
{txt}    O02 OthrProd {c |}{res}        51         17         32         10         20          8         46 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}         3        109         17          5          0         10         32 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}         0          0          0          0          1          0          9 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}         0          2         21          2          0          0         32 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}        78         56         61         49        251         23        687 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}         0          0          0          0          0          1          1 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}         3         27          1          2         18          7         33 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}       139        218        133         69        291         49        860 {txt}{c |}{res}    16,401 


                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |} Chihuahua  Distrito     Durango  Guanajuat   Guerrero    Hidalgo    Jalisco {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
     O00 Ectopic {c |}{res}         2          3          4          6          5          3          8 {txt}{c |}{res}       107 
{txt}       O01 Molar {c |}{res}         2          4          2          5          2          4          5 {txt}{c |}{res}       135 
{txt}    O02 OthrProd {c |}{res}        66         29         95        294        106        112        170 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}        88        252         40         30        155         11        104 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}         0          0          0          1          1          0          2 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}         9          0         18          1          0          0         18 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}       165        667        245        718        421        486        566 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}         0          0          0          0          0          1          4 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}         9          3         11          8         28         12         32 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}       341        958        415      1,063        718        629        909 {txt}{c |}{res}    16,401 


                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |}    Mexico  Michoacan    Morelos    Nayarit  Nuevo Leo     Oaxaca     Puebla {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
     O00 Ectopic {c |}{res}         7          3          3          0          6          7          9 {txt}{c |}{res}       107 
{txt}       O01 Molar {c |}{res}         5          4          3          8          5         13          5 {txt}{c |}{res}       135 
{txt}    O02 OthrProd {c |}{res}       171         85         35         19         22         42         96 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}       441         42         20          7         18          8          7 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}         5          0          0          0          0          1          0 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}        97        145         15          0          0          7         10 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}     1,072        406        145        192        401        562        801 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}         3          0          1          0          0          0          0 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}        62         39         36          8         10         11         13 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}     1,863        724        258        234        462        651        941 {txt}{c |}{res}    16,401 


                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |} Queretaro  Quintana   San Luis     Sinaloa     Sonora    Tabasco  Tamaulipa {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
     O00 Ectopic {c |}{res}         3          0          5          3          4          0          5 {txt}{c |}{res}       107 
{txt}       O01 Molar {c |}{res}         2          0          8          5          0          5          1 {txt}{c |}{res}       135 
{txt}    O02 OthrProd {c |}{res}        25         34         60         77         53         67         55 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}         3          8        184         69         50          6         29 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}         0          0          0          1          0          2          0 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}         5          0          3         30          5          2          4 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}       263        135        282        220        282        244        360 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}         1          0          0          1          0          0          2 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}         7         11          4         25         26          9         17 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}       309        188        546        431        420        335        473 {txt}{c |}{res}    16,401 


                 {txt}{c |}                              ENTIDAD
      aborto_nos {c |}  Tlaxcala  Veracruz     Yucatan  Zacatecas  Otros pai  No Especi {c |}     Total
{hline 17}{c +}{hline 66}{c +}{hline 10}
     O00 Ectopic {c |}{res}         0          7          2          3          0          0 {txt}{c |}{res}       107 
{txt}       O01 Molar {c |}{res}         3         11          4          4          0          0 {txt}{c |}{res}       135 
{txt}    O02 OthrProd {c |}{res}        28        107         12        108          1          1 {txt}{c |}{res}     2,154 
{txt} O03 Spontaneous {c |}{res}         3         68          0        130          0          0 {txt}{c |}{res}     1,949 
{txt}     O04 Medical {c |}{res}         0          3          0          2          0          0 {txt}{c |}{res}        28 
{txt}   O05 OthrAbort {c |}{res}         0         28          0         14          0          1 {txt}{c |}{res}       469 
{txt} O06 Unspecified {c |}{res}       199        661        133        170          4          2 {txt}{c |}{res}    11,007 
{txt}O08 ComplEcMoAbo {c |}{res}         0          3          0          3          0          0 {txt}{c |}{res}        21 
{txt}    TipAtenAbort {c |}{res}         9         29         11          9          0          1 {txt}{c |}{res}       531 
{txt}{hline 17}{c +}{hline 66}{c +}{hline 10}
           Total {c |}{res}       242        917        162        443          5          5 {txt}{c |}{res}    16,401 


{com}. tab entidad aborto_nos if trim23 != . 

                      {txt}{c |}                            aborto_nos
              ENTIDAD {c |} O00 Ectop  O01 Molar  O02 OthrP  O03 Spont  O04 Medic  O05 OthrA {c |}     Total
{hline 22}{c +}{hline 66}{c +}{hline 10}
       Aguascalientes {c |}{res}         0          4         51          3          0          0 {txt}{c |}{res}       139 
{txt}      Baja California {c |}{res}         5          2         17        109          0          2 {txt}{c |}{res}       218 
{txt}  Baja California Sur {c |}{res}         0          1         32         17          0         21 {txt}{c |}{res}       133 
{txt}             Campeche {c |}{res}         0          1         10          5          0          2 {txt}{c |}{res}        69 
{txt} Coahuila de Zaragoza {c |}{res}         0          1         20          0          1          0 {txt}{c |}{res}       291 
{txt}               Colima {c |}{res}         0          0          8         10          0          0 {txt}{c |}{res}        49 
{txt}              Chiapas {c |}{res}         4         16         46         32          9         32 {txt}{c |}{res}       860 
{txt}            Chihuahua {c |}{res}         2          2         66         88          0          9 {txt}{c |}{res}       341 
{txt}     Distrito Federal {c |}{res}         3          4         29        252          0          0 {txt}{c |}{res}       958 
{txt}              Durango {c |}{res}         4          2         95         40          0         18 {txt}{c |}{res}       415 
{txt}           Guanajuato {c |}{res}         6          5        294         30          1          1 {txt}{c |}{res}     1,063 
{txt}             Guerrero {c |}{res}         5          2        106        155          1          0 {txt}{c |}{res}       718 
{txt}              Hidalgo {c |}{res}         3          4        112         11          0          0 {txt}{c |}{res}       629 
{txt}              Jalisco {c |}{res}         8          5        170        104          2         18 {txt}{c |}{res}       909 
{txt}               Mexico {c |}{res}         7          5        171        441          5         97 {txt}{c |}{res}     1,863 
{txt}  Michoacan de Ocampo {c |}{res}         3          4         85         42          0        145 {txt}{c |}{res}       724 
{txt}              Morelos {c |}{res}         3          3         35         20          0         15 {txt}{c |}{res}       258 
{txt}              Nayarit {c |}{res}         0          8         19          7          0          0 {txt}{c |}{res}       234 
{txt}           Nuevo Leon {c |}{res}         6          5         22         18          0          0 {txt}{c |}{res}       462 
{txt}               Oaxaca {c |}{res}         7         13         42          8          1          7 {txt}{c |}{res}       651 
{txt}               Puebla {c |}{res}         9          5         96          7          0         10 {txt}{c |}{res}       941 
{txt}            Queretaro {c |}{res}         3          2         25          3          0          5 {txt}{c |}{res}       309 
{txt}         Quintana Roo {c |}{res}         0          0         34          8          0          0 {txt}{c |}{res}       188 
{txt}      San Luis Potosi {c |}{res}         5          8         60        184          0          3 {txt}{c |}{res}       546 
{txt}              Sinaloa {c |}{res}         3          5         77         69          1         30 {txt}{c |}{res}       431 
{txt}               Sonora {c |}{res}         4          0         53         50          0          5 {txt}{c |}{res}       420 
{txt}              Tabasco {c |}{res}         0          5         67          6          2          2 {txt}{c |}{res}       335 
{txt}           Tamaulipas {c |}{res}         5          1         55         29          0          4 {txt}{c |}{res}       473 
{txt}             Tlaxcala {c |}{res}         0          3         28          3          0          0 {txt}{c |}{res}       242 
{txt}Veracruz de Ignacio d {c |}{res}         7         11        107         68          3         28 {txt}{c |}{res}       917 
{txt}              Yucatan {c |}{res}         2          4         12          0          0          0 {txt}{c |}{res}       162 
{txt}            Zacatecas {c |}{res}         3          4        108        130          2         14 {txt}{c |}{res}       443 
{txt}Otros paises latinoam {c |}{res}         0          0          1          0          0          0 {txt}{c |}{res}         5 
{txt}      No Especificado {c |}{res}         0          0          1          0          0          1 {txt}{c |}{res}         5 
{txt}{hline 22}{c +}{hline 66}{c +}{hline 10}
                Total {c |}{res}       107        135      2,154      1,949         28        469 {txt}{c |}{res}    16,401 


                      {txt}{c |}            aborto_nos
              ENTIDAD {c |} O06 Unspe  O08 Compl  TipAtenAb {c |}     Total
{hline 22}{c +}{hline 33}{c +}{hline 10}
       Aguascalientes {c |}{res}        78          0          3 {txt}{c |}{res}       139 
{txt}      Baja California {c |}{res}        56          0         27 {txt}{c |}{res}       218 
{txt}  Baja California Sur {c |}{res}        61          0          1 {txt}{c |}{res}       133 
{txt}             Campeche {c |}{res}        49          0          2 {txt}{c |}{res}        69 
{txt} Coahuila de Zaragoza {c |}{res}       251          0         18 {txt}{c |}{res}       291 
{txt}               Colima {c |}{res}        23          1          7 {txt}{c |}{res}        49 
{txt}              Chiapas {c |}{res}       687          1         33 {txt}{c |}{res}       860 
{txt}            Chihuahua {c |}{res}       165          0          9 {txt}{c |}{res}       341 
{txt}     Distrito Federal {c |}{res}       667          0          3 {txt}{c |}{res}       958 
{txt}              Durango {c |}{res}       245          0         11 {txt}{c |}{res}       415 
{txt}           Guanajuato {c |}{res}       718          0          8 {txt}{c |}{res}     1,063 
{txt}             Guerrero {c |}{res}       421          0         28 {txt}{c |}{res}       718 
{txt}              Hidalgo {c |}{res}       486          1         12 {txt}{c |}{res}       629 
{txt}              Jalisco {c |}{res}       566          4         32 {txt}{c |}{res}       909 
{txt}               Mexico {c |}{res}     1,072          3         62 {txt}{c |}{res}     1,863 
{txt}  Michoacan de Ocampo {c |}{res}       406          0         39 {txt}{c |}{res}       724 
{txt}              Morelos {c |}{res}       145          1         36 {txt}{c |}{res}       258 
{txt}              Nayarit {c |}{res}       192          0          8 {txt}{c |}{res}       234 
{txt}           Nuevo Leon {c |}{res}       401          0         10 {txt}{c |}{res}       462 
{txt}               Oaxaca {c |}{res}       562          0         11 {txt}{c |}{res}       651 
{txt}               Puebla {c |}{res}       801          0         13 {txt}{c |}{res}       941 
{txt}            Queretaro {c |}{res}       263          1          7 {txt}{c |}{res}       309 
{txt}         Quintana Roo {c |}{res}       135          0         11 {txt}{c |}{res}       188 
{txt}      San Luis Potosi {c |}{res}       282          0          4 {txt}{c |}{res}       546 
{txt}              Sinaloa {c |}{res}       220          1         25 {txt}{c |}{res}       431 
{txt}               Sonora {c |}{res}       282          0         26 {txt}{c |}{res}       420 
{txt}              Tabasco {c |}{res}       244          0          9 {txt}{c |}{res}       335 
{txt}           Tamaulipas {c |}{res}       360          2         17 {txt}{c |}{res}       473 
{txt}             Tlaxcala {c |}{res}       199          0          9 {txt}{c |}{res}       242 
{txt}Veracruz de Ignacio d {c |}{res}       661          3         29 {txt}{c |}{res}       917 
{txt}              Yucatan {c |}{res}       133          0         11 {txt}{c |}{res}       162 
{txt}            Zacatecas {c |}{res}       170          3          9 {txt}{c |}{res}       443 
{txt}Otros paises latinoam {c |}{res}         4          0          0 {txt}{c |}{res}         5 
{txt}      No Especificado {c |}{res}         2          0          1 {txt}{c |}{res}         5 
{txt}{hline 22}{c +}{hline 33}{c +}{hline 10}
                Total {c |}{res}    11,007         21        531 {txt}{c |}{res}    16,401 


{com}. br gestac

. tab gestac

     {txt}GESTAC {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}        347        0.03        0.03
{txt}          2 {c |}{res}        193        0.02        0.05
{txt}          3 {c |}{res}        271        0.02        0.07
{txt}          4 {c |}{res}      1,139        0.10        0.17
{txt}          5 {c |}{res}      3,109        0.27        0.44
{txt}          6 {c |}{res}      7,854        0.69        1.13
{txt}          7 {c |}{res}      8,672        0.76        1.89
{txt}          8 {c |}{res}     14,324        1.26        3.15
{txt}          9 {c |}{res}     15,068        1.32        4.47
{txt}         10 {c |}{res}     19,948        1.75        6.22
{txt}         11 {c |}{res}      6,646        0.58        6.81
{txt}         12 {c |}{res}     10,309        0.90        7.71
{txt}         13 {c |}{res}      3,650        0.32        8.03
{txt}         14 {c |}{res}      2,760        0.24        8.28
{txt}         15 {c |}{res}      2,056        0.18        8.46
{txt}         16 {c |}{res}      1,879        0.16        8.62
{txt}         17 {c |}{res}      1,310        0.11        8.74
{txt}         18 {c |}{res}      1,605        0.14        8.88
{txt}         19 {c |}{res}      1,310        0.11        8.99
{txt}         20 {c |}{res}      1,830        0.16        9.15
{txt}         21 {c |}{res}          9        0.00        9.15
{txt}         22 {c |}{res}      1,174        0.10        9.26
{txt}         23 {c |}{res}        894        0.08        9.33
{txt}         24 {c |}{res}        982        0.09        9.42
{txt}         25 {c |}{res}      1,030        0.09        9.51
{txt}         26 {c |}{res}      1,106        0.10        9.61
{txt}         27 {c |}{res}      1,230        0.11        9.72
{txt}         28 {c |}{res}      1,564        0.14        9.85
{txt}         29 {c |}{res}      1,511        0.13        9.99
{txt}         30 {c |}{res}      2,957        0.26       10.25
{txt}         31 {c |}{res}      2,538        0.22       10.47
{txt}         32 {c |}{res}      4,479        0.39       10.86
{txt}         33 {c |}{res}      5,226        0.46       11.32
{txt}         34 {c |}{res}      8,265        0.73       12.05
{txt}         35 {c |}{res}     13,428        1.18       13.22
{txt}         36 {c |}{res}     29,431        2.58       15.81
{txt}         37 {c |}{res}     72,297        6.35       22.15
{txt}         38 {c |}{res}    175,388       15.39       37.54
{txt}         39 {c |}{res}    283,517       24.88       62.43
{txt}         40 {c |}{res}    328,815       28.86       91.29
{txt}         41 {c |}{res}     72,338        6.35       97.63
{txt}         42 {c |}{res}     12,004        1.05       98.69
{txt}         43 {c |}{res}        456        0.04       98.73
{txt}         44 {c |}{res}        126        0.01       98.74
{txt}         45 {c |}{res}         88        0.01       98.75
{txt}         99 {c |}{res}     14,287        1.25      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  1,139,420      100.00

{com}. count if aborto_nos != 0 & aborto_nos !=1 & gestac == . 
  {res}1,817,083

{com}. count if aborto_nos != 0 & aborto_nos !=1 & aborto_nos!=. & gestac == . 
  {res}9,876

{com}. tab aborto_nos entidad if aborto_nos !=. & aborto_nos != 0 & aborto_nos !=1 & gestac == . 

                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |} Aguascali  Baja Cali  Baja Cali   Campeche  Coahuila      Colima    Chiapas {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
    O02 OthrProd {c |}{res}         6        170          6         33         67         12        270 {txt}{c |}{res}     2,269 
{txt} O03 Spontaneous {c |}{res}         0        531          7         31          8          4        271 {txt}{c |}{res}     1,837 
{txt}     O04 Medical {c |}{res}         0          0          1          1          0          0         24 {txt}{c |}{res}        74 
{txt}   O05 OthrAbort {c |}{res}         0          3          1          4          1          1        289 {txt}{c |}{res}       694 
{txt} O06 Unspecified {c |}{res}         3        603          3         43         99         19        314 {txt}{c |}{res}     4,877 
{txt}   O07 FailAttem {c |}{res}         0          0          0          0          0          0          0 {txt}{c |}{res}        21 
{txt}O08 ComplEcMoAbo {c |}{res}         1          0          0          1          0          0          4 {txt}{c |}{res}       104 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}        10      1,307         18        113        175         36      1,172 {txt}{c |}{res}     9,876 


                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |} Chihuahua  Distrito     Durango  Guanajuat   Guerrero    Hidalgo    Jalisco {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
    O02 OthrProd {c |}{res}        53         21          8         11         69         48        457 {txt}{c |}{res}     2,269 
{txt} O03 Spontaneous {c |}{res}        52         40          6          3         18          6        169 {txt}{c |}{res}     1,837 
{txt}     O04 Medical {c |}{res}         0          9          0          0          3          0          7 {txt}{c |}{res}        74 
{txt}   O05 OthrAbort {c |}{res}       119          1          0          0          4          0        157 {txt}{c |}{res}       694 
{txt} O06 Unspecified {c |}{res}       102         16         11          7        277        102      1,083 {txt}{c |}{res}     4,877 
{txt}   O07 FailAttem {c |}{res}         0          0          0          0          1          0          1 {txt}{c |}{res}        21 
{txt}O08 ComplEcMoAbo {c |}{res}        19          9          0          1          2         15          6 {txt}{c |}{res}       104 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}       345         96         25         22        374        171      1,880 {txt}{c |}{res}     9,876 


                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |}    Mexico  Michoacan    Morelos    Nayarit  Nuevo Leo     Oaxaca     Puebla {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
    O02 OthrProd {c |}{res}       382         25         14         10         18         61         45 {txt}{c |}{res}     2,269 
{txt} O03 Spontaneous {c |}{res}       433          3          5         14         10         10          2 {txt}{c |}{res}     1,837 
{txt}     O04 Medical {c |}{res}        13          1          1          0          0          1          0 {txt}{c |}{res}        74 
{txt}   O05 OthrAbort {c |}{res}        68          9          4          0          0          3          4 {txt}{c |}{res}       694 
{txt} O06 Unspecified {c |}{res}       769         45         34         26        175        165         34 {txt}{c |}{res}     4,877 
{txt}   O07 FailAttem {c |}{res}        16          0          0          1          0          1          0 {txt}{c |}{res}        21 
{txt}O08 ComplEcMoAbo {c |}{res}        10          0         10          0          1          0          3 {txt}{c |}{res}       104 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}     1,691         83         68         51        204        241         88 {txt}{c |}{res}     9,876 


                 {txt}{c |}                                   ENTIDAD
      aborto_nos {c |} Queretaro  Quintana   San Luis     Sinaloa     Sonora    Tabasco  Tamaulipa {c |}     Total
{hline 17}{c +}{hline 77}{c +}{hline 10}
    O02 OthrProd {c |}{res}        46         31         15         46         19        111         20 {txt}{c |}{res}     2,269 
{txt} O03 Spontaneous {c |}{res}         2         37         27         61          8          4         12 {txt}{c |}{res}     1,837 
{txt}     O04 Medical {c |}{res}         3          1          1          0          0          1          6 {txt}{c |}{res}        74 
{txt}   O05 OthrAbort {c |}{res}         0          2          0         16          3          0          1 {txt}{c |}{res}       694 
{txt} O06 Unspecified {c |}{res}       119         71         56         77         11        171         67 {txt}{c |}{res}     4,877 
{txt}   O07 FailAttem {c |}{res}         0          0          0          0          0          0          0 {txt}{c |}{res}        21 
{txt}O08 ComplEcMoAbo {c |}{res}         2          0          0          0          3          4          3 {txt}{c |}{res}       104 
{txt}{hline 17}{c +}{hline 77}{c +}{hline 10}
           Total {c |}{res}       172        142         99        200         44        291        109 {txt}{c |}{res}     9,876 


                 {txt}{c |}                              ENTIDAD
      aborto_nos {c |}  Tlaxcala  Veracruz     Yucatan  Zacatecas  Otros pai  No Especi {c |}     Total
{hline 17}{c +}{hline 66}{c +}{hline 10}
    O02 OthrProd {c |}{res}        30        122         23         16          4          0 {txt}{c |}{res}     2,269 
{txt} O03 Spontaneous {c |}{res}         0         26          2         33          1          1 {txt}{c |}{res}     1,837 
{txt}     O04 Medical {c |}{res}         0          0          0          1          0          0 {txt}{c |}{res}        74 
{txt}   O05 OthrAbort {c |}{res}         0          2          1          0          0          1 {txt}{c |}{res}       694 
{txt} O06 Unspecified {c |}{res}        15        296         47         15          1          1 {txt}{c |}{res}     4,877 
{txt}   O07 FailAttem {c |}{res}         0          1          0          0          0          0 {txt}{c |}{res}        21 
{txt}O08 ComplEcMoAbo {c |}{res}         2          5          1          2          0          0 {txt}{c |}{res}       104 
{txt}{hline 17}{c +}{hline 66}{c +}{hline 10}
           Total {c |}{res}        47        452         74         67          6          3 {txt}{c |}{res}     9,876 


{com}. tab entidad aborto_nos if aborto_nos !=. & aborto_nos != 0 & aborto_nos !=1 & gestac == . 

                      {txt}{c |}                            aborto_nos
              ENTIDAD {c |} O02 OthrP  O03 Spont  O04 Medic  O05 OthrA  O06 Unspe  O07 FailA {c |}     Total
{hline 22}{c +}{hline 66}{c +}{hline 10}
       Aguascalientes {c |}{res}         6          0          0          0          3          0 {txt}{c |}{res}        10 
{txt}      Baja California {c |}{res}       170        531          0          3        603          0 {txt}{c |}{res}     1,307 
{txt}  Baja California Sur {c |}{res}         6          7          1          1          3          0 {txt}{c |}{res}        18 
{txt}             Campeche {c |}{res}        33         31          1          4         43          0 {txt}{c |}{res}       113 
{txt} Coahuila de Zaragoza {c |}{res}        67          8          0          1         99          0 {txt}{c |}{res}       175 
{txt}               Colima {c |}{res}        12          4          0          1         19          0 {txt}{c |}{res}        36 
{txt}              Chiapas {c |}{res}       270        271         24        289        314          0 {txt}{c |}{res}     1,172 
{txt}            Chihuahua {c |}{res}        53         52          0        119        102          0 {txt}{c |}{res}       345 
{txt}     Distrito Federal {c |}{res}        21         40          9          1         16          0 {txt}{c |}{res}        96 
{txt}              Durango {c |}{res}         8          6          0          0         11          0 {txt}{c |}{res}        25 
{txt}           Guanajuato {c |}{res}        11          3          0          0          7          0 {txt}{c |}{res}        22 
{txt}             Guerrero {c |}{res}        69         18          3          4        277          1 {txt}{c |}{res}       374 
{txt}              Hidalgo {c |}{res}        48          6          0          0        102          0 {txt}{c |}{res}       171 
{txt}              Jalisco {c |}{res}       457        169          7        157      1,083          1 {txt}{c |}{res}     1,880 
{txt}               Mexico {c |}{res}       382        433         13         68        769         16 {txt}{c |}{res}     1,691 
{txt}  Michoacan de Ocampo {c |}{res}        25          3          1          9         45          0 {txt}{c |}{res}        83 
{txt}              Morelos {c |}{res}        14          5          1          4         34          0 {txt}{c |}{res}        68 
{txt}              Nayarit {c |}{res}        10         14          0          0         26          1 {txt}{c |}{res}        51 
{txt}           Nuevo Leon {c |}{res}        18         10          0          0        175          0 {txt}{c |}{res}       204 
{txt}               Oaxaca {c |}{res}        61         10          1          3        165          1 {txt}{c |}{res}       241 
{txt}               Puebla {c |}{res}        45          2          0          4         34          0 {txt}{c |}{res}        88 
{txt}            Queretaro {c |}{res}        46          2          3          0        119          0 {txt}{c |}{res}       172 
{txt}         Quintana Roo {c |}{res}        31         37          1          2         71          0 {txt}{c |}{res}       142 
{txt}      San Luis Potosi {c |}{res}        15         27          1          0         56          0 {txt}{c |}{res}        99 
{txt}              Sinaloa {c |}{res}        46         61          0         16         77          0 {txt}{c |}{res}       200 
{txt}               Sonora {c |}{res}        19          8          0          3         11          0 {txt}{c |}{res}        44 
{txt}              Tabasco {c |}{res}       111          4          1          0        171          0 {txt}{c |}{res}       291 
{txt}           Tamaulipas {c |}{res}        20         12          6          1         67          0 {txt}{c |}{res}       109 
{txt}             Tlaxcala {c |}{res}        30          0          0          0         15          0 {txt}{c |}{res}        47 
{txt}Veracruz de Ignacio d {c |}{res}       122         26          0          2        296          1 {txt}{c |}{res}       452 
{txt}              Yucatan {c |}{res}        23          2          0          1         47          0 {txt}{c |}{res}        74 
{txt}            Zacatecas {c |}{res}        16         33          1          0         15          0 {txt}{c |}{res}        67 
{txt}Otros paises latinoam {c |}{res}         4          1          0          0          1          0 {txt}{c |}{res}         6 
{txt}      No Especificado {c |}{res}         0          1          0          1          1          0 {txt}{c |}{res}         3 
{txt}{hline 22}{c +}{hline 66}{c +}{hline 10}
                Total {c |}{res}     2,269      1,837         74        694      4,877         21 {txt}{c |}{res}     9,876 


                      {txt}{c |} aborto_nos
              ENTIDAD {c |} O08 Compl {c |}     Total
{hline 22}{c +}{hline 11}{c +}{hline 10}
       Aguascalientes {c |}{res}         1 {txt}{c |}{res}        10 
{txt}      Baja California {c |}{res}         0 {txt}{c |}{res}     1,307 
{txt}  Baja California Sur {c |}{res}         0 {txt}{c |}{res}        18 
{txt}             Campeche {c |}{res}         1 {txt}{c |}{res}       113 
{txt} Coahuila de Zaragoza {c |}{res}         0 {txt}{c |}{res}       175 
{txt}               Colima {c |}{res}         0 {txt}{c |}{res}        36 
{txt}              Chiapas {c |}{res}         4 {txt}{c |}{res}     1,172 
{txt}            Chihuahua {c |}{res}        19 {txt}{c |}{res}       345 
{txt}     Distrito Federal {c |}{res}         9 {txt}{c |}{res}        96 
{txt}              Durango {c |}{res}         0 {txt}{c |}{res}        25 
{txt}           Guanajuato {c |}{res}         1 {txt}{c |}{res}        22 
{txt}             Guerrero {c |}{res}         2 {txt}{c |}{res}       374 
{txt}              Hidalgo {c |}{res}        15 {txt}{c |}{res}       171 
{txt}              Jalisco {c |}{res}         6 {txt}{c |}{res}     1,880 
{txt}               Mexico {c |}{res}        10 {txt}{c |}{res}     1,691 
{txt}  Michoacan de Ocampo {c |}{res}         0 {txt}{c |}{res}        83 
{txt}              Morelos {c |}{res}        10 {txt}{c |}{res}        68 
{txt}              Nayarit {c |}{res}         0 {txt}{c |}{res}        51 
{txt}           Nuevo Leon {c |}{res}         1 {txt}{c |}{res}       204 
{txt}               Oaxaca {c |}{res}         0 {txt}{c |}{res}       241 
{txt}               Puebla {c |}{res}         3 {txt}{c |}{res}        88 
{txt}            Queretaro {c |}{res}         2 {txt}{c |}{res}       172 
{txt}         Quintana Roo {c |}{res}         0 {txt}{c |}{res}       142 
{txt}      San Luis Potosi {c |}{res}         0 {txt}{c |}{res}        99 
{txt}              Sinaloa {c |}{res}         0 {txt}{c |}{res}       200 
{txt}               Sonora {c |}{res}         3 {txt}{c |}{res}        44 
{txt}              Tabasco {c |}{res}         4 {txt}{c |}{res}       291 
{txt}           Tamaulipas {c |}{res}         3 {txt}{c |}{res}       109 
{txt}             Tlaxcala {c |}{res}         2 {txt}{c |}{res}        47 
{txt}Veracruz de Ignacio d {c |}{res}         5 {txt}{c |}{res}       452 
{txt}              Yucatan {c |}{res}         1 {txt}{c |}{res}        74 
{txt}            Zacatecas {c |}{res}         2 {txt}{c |}{res}        67 
{txt}Otros paises latinoam {c |}{res}         0 {txt}{c |}{res}         6 
{txt}      No Especificado {c |}{res}         0 {txt}{c |}{res}         3 
{txt}{hline 22}{c +}{hline 11}{c +}{hline 10}
                Total {c |}{res}       104 {txt}{c |}{res}     9,876 


{com}. tab entidad aborto_nos if trim23 != . 

                      {txt}{c |}                            aborto_nos
              ENTIDAD {c |} O00 Ectop  O01 Molar  O02 OthrP  O03 Spont  O04 Medic  O05 OthrA {c |}     Total
{hline 22}{c +}{hline 66}{c +}{hline 10}
       Aguascalientes {c |}{res}         0          4         51          3          0          0 {txt}{c |}{res}       139 
{txt}      Baja California {c |}{res}         5          2         17        109          0          2 {txt}{c |}{res}       218 
{txt}  Baja California Sur {c |}{res}         0          1         32         17          0         21 {txt}{c |}{res}       133 
{txt}             Campeche {c |}{res}         0          1         10          5          0          2 {txt}{c |}{res}        69 
{txt} Coahuila de Zaragoza {c |}{res}         0          1         20          0          1          0 {txt}{c |}{res}       291 
{txt}               Colima {c |}{res}         0          0          8         10          0          0 {txt}{c |}{res}        49 
{txt}              Chiapas {c |}{res}         4         16         46         32          9         32 {txt}{c |}{res}       860 
{txt}            Chihuahua {c |}{res}         2          2         66         88          0          9 {txt}{c |}{res}       341 
{txt}     Distrito Federal {c |}{res}         3          4         29        252          0          0 {txt}{c |}{res}       958 
{txt}              Durango {c |}{res}         4          2         95         40          0         18 {txt}{c |}{res}       415 
{txt}           Guanajuato {c |}{res}         6          5        294         30          1          1 {txt}{c |}{res}     1,063 
{txt}             Guerrero {c |}{res}         5          2        106        155          1          0 {txt}{c |}{res}       718 
{txt}              Hidalgo {c |}{res}         3          4        112         11          0          0 {txt}{c |}{res}       629 
{txt}              Jalisco {c |}{res}         8          5        170        104          2         18 {txt}{c |}{res}       909 
{txt}               Mexico {c |}{res}         7          5        171        441          5         97 {txt}{c |}{res}     1,863 
{txt}  Michoacan de Ocampo {c |}{res}         3          4         85         42          0        145 {txt}{c |}{res}       724 
{txt}              Morelos {c |}{res}         3          3         35         20          0         15 {txt}{c |}{res}       258 
{txt}              Nayarit {c |}{res}         0          8         19          7          0          0 {txt}{c |}{res}       234 
{txt}           Nuevo Leon {c |}{res}         6          5         22         18          0          0 {txt}{c |}{res}       462 
{txt}               Oaxaca {c |}{res}         7         13         42          8          1          7 {txt}{c |}{res}       651 
{txt}               Puebla {c |}{res}         9          5         96          7          0         10 {txt}{c |}{res}       941 
{txt}            Queretaro {c |}{res}         3          2         25          3          0          5 {txt}{c |}{res}       309 
{txt}         Quintana Roo {c |}{res}         0          0         34          8          0          0 {txt}{c |}{res}       188 
{txt}      San Luis Potosi {c |}{res}         5          8         60        184          0          3 {txt}{c |}{res}       546 
{txt}              Sinaloa {c |}{res}         3          5         77         69          1         30 {txt}{c |}{res}       431 
{txt}               Sonora {c |}{res}         4          0         53         50          0          5 {txt}{c |}{res}       420 
{txt}              Tabasco {c |}{res}         0          5         67          6          2          2 {txt}{c |}{res}       335 
{txt}           Tamaulipas {c |}{res}         5          1         55         29          0          4 {txt}{c |}{res}       473 
{txt}             Tlaxcala {c |}{res}         0          3         28          3          0          0 {txt}{c |}{res}       242 
{txt}Veracruz de Ignacio d {c |}{res}         7         11        107         68          3         28 {txt}{c |}{res}       917 
{txt}              Yucatan {c |}{res}         2          4         12          0          0          0 {txt}{c |}{res}       162 
{txt}            Zacatecas {c |}{res}         3          4        108        130          2         14 {txt}{c |}{res}       443 
{txt}Otros paises latinoam {c |}{res}         0          0          1          0          0          0 {txt}{c |}{res}         5 
{txt}      No Especificado {c |}{res}         0          0          1          0          0          1 {txt}{c |}{res}         5 
{txt}{hline 22}{c +}{hline 66}{c +}{hline 10}
                Total {c |}{res}       107        135      2,154      1,949         28        469 {txt}{c |}{res}    16,401 


                      {txt}{c |}            aborto_nos
              ENTIDAD {c |} O06 Unspe  O08 Compl  TipAtenAb {c |}     Total
{hline 22}{c +}{hline 33}{c +}{hline 10}
       Aguascalientes {c |}{res}        78          0          3 {txt}{c |}{res}       139 
{txt}      Baja California {c |}{res}        56          0         27 {txt}{c |}{res}       218 
{txt}  Baja California Sur {c |}{res}        61          0          1 {txt}{c |}{res}       133 
{txt}             Campeche {c |}{res}        49          0          2 {txt}{c |}{res}        69 
{txt} Coahuila de Zaragoza {c |}{res}       251          0         18 {txt}{c |}{res}       291 
{txt}               Colima {c |}{res}        23          1          7 {txt}{c |}{res}        49 
{txt}              Chiapas {c |}{res}       687          1         33 {txt}{c |}{res}       860 
{txt}            Chihuahua {c |}{res}       165          0          9 {txt}{c |}{res}       341 
{txt}     Distrito Federal {c |}{res}       667          0          3 {txt}{c |}{res}       958 
{txt}              Durango {c |}{res}       245          0         11 {txt}{c |}{res}       415 
{txt}           Guanajuato {c |}{res}       718          0          8 {txt}{c |}{res}     1,063 
{txt}             Guerrero {c |}{res}       421          0         28 {txt}{c |}{res}       718 
{txt}              Hidalgo {c |}{res}       486          1         12 {txt}{c |}{res}       629 
{txt}              Jalisco {c |}{res}       566          4         32 {txt}{c |}{res}       909 
{txt}               Mexico {c |}{res}     1,072          3         62 {txt}{c |}{res}     1,863 
{txt}  Michoacan de Ocampo {c |}{res}       406          0         39 {txt}{c |}{res}       724 
{txt}              Morelos {c |}{res}       145          1         36 {txt}{c |}{res}       258 
{txt}              Nayarit {c |}{res}       192          0          8 {txt}{c |}{res}       234 
{txt}           Nuevo Leon {c |}{res}       401          0         10 {txt}{c |}{res}       462 
{txt}               Oaxaca {c |}{res}       562          0         11 {txt}{c |}{res}       651 
{txt}               Puebla {c |}{res}       801          0         13 {txt}{c |}{res}       941 
{txt}            Queretaro {c |}{res}       263          1          7 {txt}{c |}{res}       309 
{txt}         Quintana Roo {c |}{res}       135          0         11 {txt}{c |}{res}       188 
{txt}      San Luis Potosi {c |}{res}       282          0          4 {txt}{c |}{res}       546 
{txt}              Sinaloa {c |}{res}       220          1         25 {txt}{c |}{res}       431 
{txt}               Sonora {c |}{res}       282          0         26 {txt}{c |}{res}       420 
{txt}              Tabasco {c |}{res}       244          0          9 {txt}{c |}{res}       335 
{txt}           Tamaulipas {c |}{res}       360          2         17 {txt}{c |}{res}       473 
{txt}             Tlaxcala {c |}{res}       199          0          9 {txt}{c |}{res}       242 
{txt}Veracruz de Ignacio d {c |}{res}       661          3         29 {txt}{c |}{res}       917 
{txt}              Yucatan {c |}{res}       133          0         11 {txt}{c |}{res}       162 
{txt}            Zacatecas {c |}{res}       170          3          9 {txt}{c |}{res}       443 
{txt}Otros paises latinoam {c |}{res}         4          0          0 {txt}{c |}{res}         5 
{txt}      No Especificado {c |}{res}         2          0          1 {txt}{c |}{res}         5 
{txt}{hline 22}{c +}{hline 33}{c +}{hline 10}
                Total {c |}{res}    11,007         21        531 {txt}{c |}{res}    16,401 


{com}. br aborto_nos if trim23 != . 

. br aborto_nos gestac if trim23 == . & aborto_nos != . 

. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00

{com}. br aborto_nos gestac if trim23 == . & aborto_nos != . 

. corr aborto_nos gestac
{txt}(obs=118,005)

             {c |} abor~nos   gestac
{hline 13}{c +}{hline 18}
  aborto_nos {c |}{res}   1.0000
      {txt}gestac {c |}{res}   0.0253   1.0000


{com}. reg i.aborto_nos gestac
{err}depvar may not be a factor variable
{txt}{search r(198), local:r(198);}

{com}. reg aborto_nos gestac

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res}   118,005
{txt}{hline 13}{c +}{hline 34}   F(1, 118003)    = {res}    75.60
{txt}       Model {c |} {res} 302.907975         1  302.907975   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res} 472812.074   118,003  4.00678012   {txt}R-squared       ={res}    0.0006
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0006
{txt}       Total {c |} {res} 473114.982   118,004  4.00931309   {txt}Root MSE        =   {res} 2.0017

{txt}{hline 13}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}  aborto_nos{col 14}{c |}      Coef.{col 26}   Std. Err.{col 38}      t{col 46}   P>|t|{col 54}     [95% Con{col 67}f. Interval]
{hline 13}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 6}gestac {c |}{col 14}{res}{space 2} .0017683{col 26}{space 2} .0002034{col 37}{space 1}    8.69{col 46}{space 3}0.000{col 54}{space 4} .0013697{col 67}{space 3} .0021669
{txt}{space 7}_cons {c |}{col 14}{res}{space 2} 4.733469{col 26}{space 2} .0071352{col 37}{space 1}  663.40{col 46}{space 3}0.000{col 54}{space 4} 4.719485{col 67}{space 3} 4.747454
{txt}{hline 13}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. reg gestac aborto_nos

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res}   118,005
{txt}{hline 13}{c +}{hline 34}   F(1, 118003)    = {res}    75.60
{txt}       Model {c |} {res}  62024.225         1   62024.225   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res} 96814229.9   118,003  820.438717   {txt}R-squared       ={res}    0.0006
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0006
{txt}       Total {c |} {res} 96876254.1   118,004  820.957375   {txt}Root MSE        =   {res} 28.643

{txt}{hline 13}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}      gestac{col 14}{c |}      Coef.{col 26}   Std. Err.{col 38}      t{col 46}   P>|t|{col 54}     [95% Con{col 67}f. Interval]
{hline 13}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 2}aborto_nos {c |}{col 14}{res}{space 2}  .362074{col 26}{space 2} .0416428{col 37}{space 1}    8.69{col 46}{space 3}0.000{col 54}{space 4} .2804548{col 67}{space 3} .4436932
{txt}{space 7}_cons {c |}{col 14}{res}{space 2} 18.52078{col 26}{space 2} .2153992{col 37}{space 1}   85.98{col 46}{space 3}0.000{col 54}{space 4}  18.0986{col 67}{space 3} 18.94296
{txt}{hline 13}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. reg gestac i.aborto_nos

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res}   118,005
{txt}{hline 13}{c +}{hline 34}   F(9, 117995)    = {res}    48.88
{txt}       Model {c |} {res} 359814.824         9  39979.4249   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res} 96516439.3   117,995  817.970586   {txt}R-squared       ={res}    0.0037
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0036
{txt}       Total {c |} {res} 96876254.1   118,004  820.957375   {txt}Root MSE        =   {res}   28.6

{txt}{hline 18}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}           gestac{col 19}{c |}      Coef.{col 31}   Std. Err.{col 43}      t{col 51}   P>|t|{col 59}     [95% Con{col 72}f. Interval]
{hline 18}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 7}aborto_nos {c |}
{space 7}O01 Molar  {c |}{col 19}{res}{space 2} 3.338408{col 31}{space 2} 1.069779{col 42}{space 1}    3.12{col 51}{space 3}0.002{col 59}{space 4} 1.241657{col 72}{space 3} 5.435158
{txt}{space 4}O02 OthrProd  {c |}{col 19}{res}{space 2} -5.04138{col 31}{space 2} .4766223{col 42}{space 1}  -10.58{col 51}{space 3}0.000{col 59}{space 4}-5.975552{col 72}{space 3}-4.107207
{txt}{space 1}O03 Spontaneous  {c |}{col 19}{res}{space 2} -4.23774{col 31}{space 2} .5039965{col 42}{space 1}   -8.41{col 51}{space 3}0.000{col 59}{space 4}-5.225565{col 72}{space 3}-3.249915
{txt}{space 5}O04 Medical  {c |}{col 19}{res}{space 2} 18.91419{col 31}{space 2} 2.141361{col 42}{space 1}    8.83{col 51}{space 3}0.000{col 59}{space 4} 14.71715{col 72}{space 3} 23.11122
{txt}{space 3}O05 OthrAbort  {c |}{col 19}{res}{space 2}-.8673012{col 31}{space 2} .6537586{col 42}{space 1}   -1.33{col 51}{space 3}0.185{col 59}{space 4}-2.148658{col 72}{space 3} .4140553
{txt}{space 1}O06 Unspecified  {c |}{col 19}{res}{space 2}-2.268683{col 31}{space 2} .4460214{col 42}{space 1}   -5.09{col 51}{space 3}0.000{col 59}{space 4}-3.142878{col 72}{space 3}-1.394488
{txt}{space 3}O07 FailAttem  {c |}{col 19}{res}{space 2}-10.93528{col 31}{space 2} 28.60347{col 42}{space 1}   -0.38{col 51}{space 3}0.702{col 59}{space 4}-66.99762{col 72}{space 3} 45.12706
{txt}O08 ComplEcMoAbo  {c |}{col 19}{res}{space 2} 6.324157{col 31}{space 2} 2.011489{col 42}{space 1}    3.14{col 51}{space 3}0.002{col 59}{space 4} 2.381671{col 72}{space 3} 10.26664
{txt}{space 4}TipAtenAbort  {c |}{col 19}{res}{space 2} .2451376{col 31}{space 2}   .68909{col 42}{space 1}    0.36{col 51}{space 3}0.722{col 59}{space 4}-1.105468{col 72}{space 3} 1.595743
{txt}{space 17} {c |}
{space 12}_cons {c |}{col 19}{res}{space 2} 22.93528{col 31}{space 2} .4332864{col 42}{space 1}   52.93{col 51}{space 3}0.000{col 59}{space 4} 22.08604{col 72}{space 3} 23.78451
{txt}{hline 18}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. reg aborto_nos gestac

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res}   118,005
{txt}{hline 13}{c +}{hline 34}   F(1, 118003)    = {res}    75.60
{txt}       Model {c |} {res} 302.907975         1  302.907975   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res} 472812.074   118,003  4.00678012   {txt}R-squared       ={res}    0.0006
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0006
{txt}       Total {c |} {res} 473114.982   118,004  4.00931309   {txt}Root MSE        =   {res} 2.0017

{txt}{hline 13}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}  aborto_nos{col 14}{c |}      Coef.{col 26}   Std. Err.{col 38}      t{col 46}   P>|t|{col 54}     [95% Con{col 67}f. Interval]
{hline 13}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 6}gestac {c |}{col 14}{res}{space 2} .0017683{col 26}{space 2} .0002034{col 37}{space 1}    8.69{col 46}{space 3}0.000{col 54}{space 4} .0013697{col 67}{space 3} .0021669
{txt}{space 7}_cons {c |}{col 14}{res}{space 2} 4.733469{col 26}{space 2} .0071352{col 37}{space 1}  663.40{col 46}{space 3}0.000{col 54}{space 4} 4.719485{col 67}{space 3} 4.747454
{txt}{hline 13}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. reg gestac i.entidad

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res} 1,139,420
{txt}{hline 13}{c +}{hline 34}   F(35, 1139384)  = {res}   283.49
{txt}       Model {c |} {res} 1209033.54        35  34543.8155   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res}  138833976 1,139,384  121.850031   {txt}R-squared       ={res}    0.0086
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0086
{txt}       Total {c |} {res}  140043009 1,139,419  122.907385   {txt}Root MSE        =   {res} 11.039

{txt}{hline 33}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}                          gestac{col 34}{c |}      Coef.{col 46}   Std. Err.{col 58}      t{col 66}   P>|t|{col 74}     [95% Con{col 87}f. Interval]
{hline 33}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 25}entidad {c |}
{space 16}Baja California  {c |}{col 34}{res}{space 2}-3.560389{col 46}{space 2}  .112312{col 57}{space 1}  -31.70{col 66}{space 3}0.000{col 74}{space 4}-3.780517{col 87}{space 3}-3.340261
{txt}{space 12}Baja California Sur  {c |}{col 34}{res}{space 2}-4.631446{col 46}{space 2} .1617127{col 57}{space 1}  -28.64{col 66}{space 3}0.000{col 74}{space 4}-4.948398{col 87}{space 3}-4.314495
{txt}{space 23}Campeche  {c |}{col 34}{res}{space 2}-2.446498{col 46}{space 2} .1340302{col 57}{space 1}  -18.25{col 66}{space 3}0.000{col 74}{space 4}-2.709192{col 87}{space 3}-2.183803
{txt}{space 11}Coahuila de Zaragoza  {c |}{col 34}{res}{space 2}-4.358859{col 46}{space 2} .1152333{col 57}{space 1}  -37.83{col 66}{space 3}0.000{col 74}{space 4}-4.584713{col 87}{space 3}-4.133006
{txt}{space 25}Colima  {c |}{col 34}{res}{space 2}-2.353105{col 46}{space 2} .1500564{col 57}{space 1}  -15.68{col 66}{space 3}0.000{col 74}{space 4} -2.64721{col 87}{space 3}-2.058999
{txt}{space 24}Chiapas  {c |}{col 34}{res}{space 2}-1.824157{col 46}{space 2} .0987652{col 57}{space 1}  -18.47{col 66}{space 3}0.000{col 74}{space 4}-2.017734{col 87}{space 3}-1.630581
{txt}{space 22}Chihuahua  {c |}{col 34}{res}{space 2}-4.234728{col 46}{space 2} .1147698{col 57}{space 1}  -36.90{col 66}{space 3}0.000{col 74}{space 4}-4.459673{col 87}{space 3}-4.009784
{txt}{space 15}Distrito Federal  {c |}{col 34}{res}{space 2}-2.178103{col 46}{space 2} .0973589{col 57}{space 1}  -22.37{col 66}{space 3}0.000{col 74}{space 4}-2.368923{col 87}{space 3}-1.987283
{txt}{space 24}Durango  {c |}{col 34}{res}{space 2}-4.756415{col 46}{space 2} .1177466{col 57}{space 1}  -40.40{col 66}{space 3}0.000{col 74}{space 4}-4.987195{col 87}{space 3}-4.525636
{txt}{space 21}Guanajuato  {c |}{col 34}{res}{space 2}-4.815367{col 46}{space 2} .0968782{col 57}{space 1}  -49.71{col 66}{space 3}0.000{col 74}{space 4}-5.005245{col 87}{space 3}-4.625489
{txt}{space 23}Guerrero  {c |}{col 34}{res}{space 2} -3.31324{col 46}{space 2} .1013224{col 57}{space 1}  -32.70{col 66}{space 3}0.000{col 74}{space 4}-3.511828{col 87}{space 3}-3.114651
{txt}{space 24}Hidalgo  {c |}{col 34}{res}{space 2}-4.576797{col 46}{space 2}  .111017{col 57}{space 1}  -41.23{col 66}{space 3}0.000{col 74}{space 4}-4.794386{col 87}{space 3}-4.359207
{txt}{space 24}Jalisco  {c |}{col 34}{res}{space 2}-2.839904{col 46}{space 2} .0967785{col 57}{space 1}  -29.34{col 66}{space 3}0.000{col 74}{space 4}-3.029586{col 87}{space 3}-2.650221
{txt}{space 25}Mexico  {c |}{col 34}{res}{space 2}-3.986988{col 46}{space 2} .0918805{col 57}{space 1}  -43.39{col 66}{space 3}0.000{col 74}{space 4}-4.167071{col 87}{space 3}-3.806906
{txt}{space 12}Michoacan de Ocampo  {c |}{col 34}{res}{space 2}-4.673059{col 46}{space 2}  .101087{col 57}{space 1}  -46.23{col 66}{space 3}0.000{col 74}{space 4}-4.871186{col 87}{space 3}-4.474932
{txt}{space 24}Morelos  {c |}{col 34}{res}{space 2}  -2.4336{col 46}{space 2} .1149266{col 57}{space 1}  -21.18{col 66}{space 3}0.000{col 74}{space 4}-2.658853{col 87}{space 3}-2.208348
{txt}{space 24}Nayarit  {c |}{col 34}{res}{space 2}-4.166692{col 46}{space 2} .1343065{col 57}{space 1}  -31.02{col 66}{space 3}0.000{col 74}{space 4}-4.429928{col 87}{space 3}-3.903456
{txt}{space 21}Nuevo Leon  {c |}{col 34}{res}{space 2}-3.963991{col 46}{space 2} .1101706{col 57}{space 1}  -35.98{col 66}{space 3}0.000{col 74}{space 4}-4.179921{col 87}{space 3} -3.74806
{txt}{space 25}Oaxaca  {c |}{col 34}{res}{space 2}-3.710361{col 46}{space 2} .1041641{col 57}{space 1}  -35.62{col 66}{space 3}0.000{col 74}{space 4}-3.914519{col 87}{space 3}-3.506203
{txt}{space 25}Puebla  {c |}{col 34}{res}{space 2}-3.907356{col 46}{space 2} .0986386{col 57}{space 1}  -39.61{col 66}{space 3}0.000{col 74}{space 4}-4.100684{col 87}{space 3}-3.714028
{txt}{space 22}Queretaro  {c |}{col 34}{res}{space 2}-1.557073{col 46}{space 2} .1130063{col 57}{space 1}  -13.78{col 66}{space 3}0.000{col 74}{space 4}-1.778562{col 87}{space 3}-1.335585
{txt}{space 19}Quintana Roo  {c |}{col 34}{res}{space 2}-3.824662{col 46}{space 2} .1222433{col 57}{space 1}  -31.29{col 66}{space 3}0.000{col 74}{space 4}-4.064254{col 87}{space 3}-3.585069
{txt}{space 16}San Luis Potosi  {c |}{col 34}{res}{space 2}-3.662736{col 46}{space 2} .1085123{col 57}{space 1}  -33.75{col 66}{space 3}0.000{col 74}{space 4}-3.875417{col 87}{space 3}-3.450056
{txt}{space 24}Sinaloa  {c |}{col 34}{res}{space 2}-3.915108{col 46}{space 2} .1093973{col 57}{space 1}  -35.79{col 66}{space 3}0.000{col 74}{space 4}-4.129523{col 87}{space 3}-3.700693
{txt}{space 25}Sonora  {c |}{col 34}{res}{space 2}-4.435622{col 46}{space 2} .1098829{col 57}{space 1}  -40.37{col 66}{space 3}0.000{col 74}{space 4}-4.650989{col 87}{space 3}-4.220255
{txt}{space 24}Tabasco  {c |}{col 34}{res}{space 2}-3.197136{col 46}{space 2} .1051117{col 57}{space 1}  -30.42{col 66}{space 3}0.000{col 74}{space 4}-3.403151{col 87}{space 3}-2.991121
{txt}{space 21}Tamaulipas  {c |}{col 34}{res}{space 2}-1.799673{col 46}{space 2}  .105901{col 57}{space 1}  -16.99{col 66}{space 3}0.000{col 74}{space 4}-2.007236{col 87}{space 3}-1.592111
{txt}{space 23}Tlaxcala  {c |}{col 34}{res}{space 2}-4.929794{col 46}{space 2} .1220629{col 57}{space 1}  -40.39{col 66}{space 3}0.000{col 74}{space 4}-5.169033{col 87}{space 3}-4.690554
{txt}Veracruz de Ignacio de la Llave  {c |}{col 34}{res}{space 2}-3.675629{col 46}{space 2}  .096445{col 57}{space 1}  -38.11{col 66}{space 3}0.000{col 74}{space 4}-3.864658{col 87}{space 3}  -3.4866
{txt}{space 24}Yucatan  {c |}{col 34}{res}{space 2}-4.688124{col 46}{space 2} .1225257{col 57}{space 1}  -38.26{col 66}{space 3}0.000{col 74}{space 4} -4.92827{col 87}{space 3}-4.447978
{txt}{space 22}Zacatecas  {c |}{col 34}{res}{space 2}-4.776527{col 46}{space 2} .1182367{col 57}{space 1}  -40.40{col 66}{space 3}0.000{col 74}{space 4}-5.008267{col 87}{space 3}-4.544787
{txt}Estaduos Unidos de Norteamerica  {c |}{col 34}{res}{space 2}-31.43081{col 46}{space 2} 11.03892{col 57}{space 1}   -2.85{col 66}{space 3}0.004{col 74}{space 4}-53.06671{col 87}{space 3}-9.794907
{txt}{space 2}Otros paises latinoamericanos  {c |}{col 34}{res}{space 2}-.8474744{col 46}{space 2}  .631011{col 57}{space 1}   -1.34{col 66}{space 3}0.179{col 74}{space 4}-2.084235{col 87}{space 3} .3892858
{txt}{space 19}Otros paises  {c |}{col 34}{res}{space 2}-8.930808{col 46}{space 2} 5.519976{col 57}{space 1}   -1.62{col 66}{space 3}0.106{col 74}{space 4}-19.74977{col 87}{space 3} 1.888158
{txt}{space 16}No Especificado  {c |}{col 34}{res}{space 2}-6.097474{col 46}{space 2} .8206565{col 57}{space 1}   -7.43{col 66}{space 3}0.000{col 74}{space 4}-7.705933{col 87}{space 3}-4.489016
{txt}{space 32} {c |}
{space 27}_cons {c |}{col 34}{res}{space 2} 40.43081{col 46}{space 2} .0873495{col 57}{space 1}  462.86{col 66}{space 3}0.000{col 74}{space 4} 40.25961{col 87}{space 3} 40.60201
{txt}{hline 33}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. reg gestac i.aborto_nos

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res}   118,005
{txt}{hline 13}{c +}{hline 34}   F(9, 117995)    = {res}    48.88
{txt}       Model {c |} {res} 359814.824         9  39979.4249   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res} 96516439.3   117,995  817.970586   {txt}R-squared       ={res}    0.0037
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0036
{txt}       Total {c |} {res} 96876254.1   118,004  820.957375   {txt}Root MSE        =   {res}   28.6

{txt}{hline 18}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}           gestac{col 19}{c |}      Coef.{col 31}   Std. Err.{col 43}      t{col 51}   P>|t|{col 59}     [95% Con{col 72}f. Interval]
{hline 18}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 7}aborto_nos {c |}
{space 7}O01 Molar  {c |}{col 19}{res}{space 2} 3.338408{col 31}{space 2} 1.069779{col 42}{space 1}    3.12{col 51}{space 3}0.002{col 59}{space 4} 1.241657{col 72}{space 3} 5.435158
{txt}{space 4}O02 OthrProd  {c |}{col 19}{res}{space 2} -5.04138{col 31}{space 2} .4766223{col 42}{space 1}  -10.58{col 51}{space 3}0.000{col 59}{space 4}-5.975552{col 72}{space 3}-4.107207
{txt}{space 1}O03 Spontaneous  {c |}{col 19}{res}{space 2} -4.23774{col 31}{space 2} .5039965{col 42}{space 1}   -8.41{col 51}{space 3}0.000{col 59}{space 4}-5.225565{col 72}{space 3}-3.249915
{txt}{space 5}O04 Medical  {c |}{col 19}{res}{space 2} 18.91419{col 31}{space 2} 2.141361{col 42}{space 1}    8.83{col 51}{space 3}0.000{col 59}{space 4} 14.71715{col 72}{space 3} 23.11122
{txt}{space 3}O05 OthrAbort  {c |}{col 19}{res}{space 2}-.8673012{col 31}{space 2} .6537586{col 42}{space 1}   -1.33{col 51}{space 3}0.185{col 59}{space 4}-2.148658{col 72}{space 3} .4140553
{txt}{space 1}O06 Unspecified  {c |}{col 19}{res}{space 2}-2.268683{col 31}{space 2} .4460214{col 42}{space 1}   -5.09{col 51}{space 3}0.000{col 59}{space 4}-3.142878{col 72}{space 3}-1.394488
{txt}{space 3}O07 FailAttem  {c |}{col 19}{res}{space 2}-10.93528{col 31}{space 2} 28.60347{col 42}{space 1}   -0.38{col 51}{space 3}0.702{col 59}{space 4}-66.99762{col 72}{space 3} 45.12706
{txt}O08 ComplEcMoAbo  {c |}{col 19}{res}{space 2} 6.324157{col 31}{space 2} 2.011489{col 42}{space 1}    3.14{col 51}{space 3}0.002{col 59}{space 4} 2.381671{col 72}{space 3} 10.26664
{txt}{space 4}TipAtenAbort  {c |}{col 19}{res}{space 2} .2451376{col 31}{space 2}   .68909{col 42}{space 1}    0.36{col 51}{space 3}0.722{col 59}{space 4}-1.105468{col 72}{space 3} 1.595743
{txt}{space 17} {c |}
{space 12}_cons {c |}{col 19}{res}{space 2} 22.93528{col 31}{space 2} .4332864{col 42}{space 1}   52.93{col 51}{space 3}0.000{col 59}{space 4} 22.08604{col 72}{space 3} 23.78451
{txt}{hline 18}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. br gestac

. tab gestac

     {txt}GESTAC {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}        347        0.03        0.03
{txt}          2 {c |}{res}        193        0.02        0.05
{txt}          3 {c |}{res}        271        0.02        0.07
{txt}          4 {c |}{res}      1,139        0.10        0.17
{txt}          5 {c |}{res}      3,109        0.27        0.44
{txt}          6 {c |}{res}      7,854        0.69        1.13
{txt}          7 {c |}{res}      8,672        0.76        1.89
{txt}          8 {c |}{res}     14,324        1.26        3.15
{txt}          9 {c |}{res}     15,068        1.32        4.47
{txt}         10 {c |}{res}     19,948        1.75        6.22
{txt}         11 {c |}{res}      6,646        0.58        6.81
{txt}         12 {c |}{res}     10,309        0.90        7.71
{txt}         13 {c |}{res}      3,650        0.32        8.03
{txt}         14 {c |}{res}      2,760        0.24        8.28
{txt}         15 {c |}{res}      2,056        0.18        8.46
{txt}         16 {c |}{res}      1,879        0.16        8.62
{txt}         17 {c |}{res}      1,310        0.11        8.74
{txt}         18 {c |}{res}      1,605        0.14        8.88
{txt}         19 {c |}{res}      1,310        0.11        8.99
{txt}         20 {c |}{res}      1,830        0.16        9.15
{txt}         21 {c |}{res}          9        0.00        9.15
{txt}         22 {c |}{res}      1,174        0.10        9.26
{txt}         23 {c |}{res}        894        0.08        9.33
{txt}         24 {c |}{res}        982        0.09        9.42
{txt}         25 {c |}{res}      1,030        0.09        9.51
{txt}         26 {c |}{res}      1,106        0.10        9.61
{txt}         27 {c |}{res}      1,230        0.11        9.72
{txt}         28 {c |}{res}      1,564        0.14        9.85
{txt}         29 {c |}{res}      1,511        0.13        9.99
{txt}         30 {c |}{res}      2,957        0.26       10.25
{txt}         31 {c |}{res}      2,538        0.22       10.47
{txt}         32 {c |}{res}      4,479        0.39       10.86
{txt}         33 {c |}{res}      5,226        0.46       11.32
{txt}         34 {c |}{res}      8,265        0.73       12.05
{txt}         35 {c |}{res}     13,428        1.18       13.22
{txt}         36 {c |}{res}     29,431        2.58       15.81
{txt}         37 {c |}{res}     72,297        6.35       22.15
{txt}         38 {c |}{res}    175,388       15.39       37.54
{txt}         39 {c |}{res}    283,517       24.88       62.43
{txt}         40 {c |}{res}    328,815       28.86       91.29
{txt}         41 {c |}{res}     72,338        6.35       97.63
{txt}         42 {c |}{res}     12,004        1.05       98.69
{txt}         43 {c |}{res}        456        0.04       98.73
{txt}         44 {c |}{res}        126        0.01       98.74
{txt}         45 {c |}{res}         88        0.01       98.75
{txt}         99 {c |}{res}     14,287        1.25      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  1,139,420      100.00

{com}. replace gestac = . if gestac == 99 
{txt}(14,287 real changes made, 14,287 to missing)

{com}. reg gestac i.aborto_nos

{txt}      Source {c |}       SS           df       MS      Number of obs   ={res}   104,364
{txt}{hline 13}{c +}{hline 34}   F(9, 104354)    = {res}   492.67
{txt}       Model {c |} {res} 49635.2939         9  5515.03265   {txt}Prob > F        ={res}    0.0000
{txt}    Residual {c |} {res} 1168153.78   104,354  11.1941447   {txt}R-squared       ={res}    0.0408
{txt}{hline 13}{c +}{hline 34}   Adj R-squared   ={res}    0.0407
{txt}       Total {c |} {res} 1217789.07   104,363  11.6687818   {txt}Root MSE        =   {res} 3.3458

{txt}{hline 18}{c TT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{col 1}           gestac{col 19}{c |}      Coef.{col 31}   Std. Err.{col 43}      t{col 51}   P>|t|{col 59}     [95% Con{col 72}f. Interval]
{hline 18}{c +}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{space 7}aborto_nos {c |}
{space 7}O01 Molar  {c |}{col 19}{res}{space 2} 2.142825{col 31}{space 2}  .138074{col 42}{space 1}   15.52{col 51}{space 3}0.000{col 59}{space 4} 1.872201{col 72}{space 3} 2.413448
{txt}{space 4}O02 OthrProd  {c |}{col 19}{res}{space 2} 1.427612{col 31}{space 2} .0605687{col 42}{space 1}   23.57{col 51}{space 3}0.000{col 59}{space 4} 1.308898{col 72}{space 3} 1.546326
{txt}{space 1}O03 Spontaneous  {c |}{col 19}{res}{space 2}  1.94983{col 31}{space 2} .0638614{col 42}{space 1}   30.53{col 51}{space 3}0.000{col 59}{space 4} 1.824662{col 72}{space 3} 2.074997
{txt}{space 5}O04 Medical  {c |}{col 19}{res}{space 2} 2.389491{col 31}{space 2} .3104148{col 42}{space 1}    7.70{col 51}{space 3}0.000{col 59}{space 4} 1.781082{col 72}{space 3}   2.9979
{txt}{space 3}O05 OthrAbort  {c |}{col 19}{res}{space 2}    1.906{col 31}{space 2} .0828854{col 42}{space 1}   23.00{col 51}{space 3}0.000{col 59}{space 4} 1.743545{col 72}{space 3} 2.068454
{txt}{space 1}O06 Unspecified  {c |}{col 19}{res}{space 2} 2.111755{col 31}{space 2} .0569792{col 42}{space 1}   37.06{col 51}{space 3}0.000{col 59}{space 4} 2.000076{col 72}{space 3} 2.223433
{txt}{space 3}O07 FailAttem  {c |}{col 19}{res}{space 2} 3.972825{col 31}{space 2} 3.346224{col 42}{space 1}    1.19{col 51}{space 3}0.235{col 59}{space 4}-2.585731{col 72}{space 3} 10.53138
{txt}O08 ComplEcMoAbo  {c |}{col 19}{res}{space 2} 13.96762{col 31}{space 2}  .247741{col 42}{space 1}   56.38{col 51}{space 3}0.000{col 59}{space 4} 13.48205{col 72}{space 3} 14.45319
{txt}{space 4}TipAtenAbort  {c |}{col 19}{res}{space 2} 2.661296{col 31}{space 2} .0874602{col 42}{space 1}   30.43{col 51}{space 3}0.000{col 59}{space 4} 2.489875{col 72}{space 3} 2.832716
{txt}{space 17} {c |}
{space 12}_cons {c |}{col 19}{res}{space 2} 8.027175{col 31}{space 2} .0554327{col 42}{space 1}  144.81{col 51}{space 3}0.000{col 59}{space 4} 7.918528{col 72}{space 3} 8.135823
{txt}{hline 18}{c BT}{hline 11}{hline 11}{hline 9}{hline 8}{hline 13}{hline 12}
{res}
{com}. preserve 

. br aborto_nos 

. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00

{com}. tab aborto_nos, nola

 {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}      6,726        5.15        5.15
{txt}          1 {c |}{res}      1,180        0.90        6.05
{txt}          2 {c |}{res}     23,013       17.62       23.68
{txt}          3 {c |}{res}     14,179       10.86       34.54
{txt}          4 {c |}{res}        260        0.20       34.74
{txt}          5 {c |}{res}      4,107        3.15       37.88
{txt}          6 {c |}{res}     77,923       59.68       97.56
{txt}          7 {c |}{res}         22        0.02       97.58
{txt}          8 {c |}{res}        316        0.24       97.82
{txt}          9 {c |}{res}      2,849        2.18      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    130,575      100.00

{com}. tab abortion

   {txt}abortion {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          0 {c |}{res}  2,838,608       95.92       95.92
{txt}          1 {c |}{res}    120,589        4.08      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. tab aborto
{bf}{err}aborto{sf} ambiguous abbreviation
{txt}{search r(111), local:r(111);}

{com}. tab aborto_nos

      {txt}aborto_nos {c |}      Freq.     Percent        Cum.
{hline 17}{c +}{hline 35}
     O00 Ectopic {c |}{res}      6,726        5.15        5.15
{txt}       O01 Molar {c |}{res}      1,180        0.90        6.05
{txt}    O02 OthrProd {c |}{res}     23,013       17.62       23.68
{txt} O03 Spontaneous {c |}{res}     14,179       10.86       34.54
{txt}     O04 Medical {c |}{res}        260        0.20       34.74
{txt}   O05 OthrAbort {c |}{res}      4,107        3.15       37.88
{txt} O06 Unspecified {c |}{res}     77,923       59.68       97.56
{txt}   O07 FailAttem {c |}{res}         22        0.02       97.58
{txt}O08 ComplEcMoAbo {c |}{res}        316        0.24       97.82
{txt}    TipAtenAbort {c |}{res}      2,849        2.18      100.00
{txt}{hline 17}{c +}{hline 35}
           Total {c |}{res}    130,575      100.00

{com}. count if aborto_nos != 0 & aborto_nos !=1 & aborto_nos!=. & gestac == . 
  {res}22,648

{com}. count if aborto_nos != 0 & aborto_nos !=1 & aborto_nos!=. & trim23 != . & entidad == 9 
  {res}951

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/OBSTET14/OBSTET14.DTA"
{err}no; data in memory would be lost
{txt}{search r(4), local:r(4);}

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/OBSTET14/OBSTET14.DTA", clear

. count
  {res}84,508

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Aborto en 2trimestre.dta", clear

. count if year == 2014
  {res}84,508

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/SAEH2014/SAEH2014.DTA"

. count
  {res}304,762

{com}. count if entidad == 9
{err}type mismatch
{txt}{search r(109), local:r(109);}

{com}. tab entidad

    {txt}entidad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
         01 {c |}{res}        113        0.04        0.04
{txt}         02 {c |}{res}         84        0.03        0.06
{txt}         03 {c |}{res}         49        0.02        0.08
{txt}         04 {c |}{res}         72        0.02        0.10
{txt}         05 {c |}{res}         88        0.03        0.13
{txt}         06 {c |}{res}         30        0.01        0.14
{txt}         07 {c |}{res}        683        0.22        0.37
{txt}         08 {c |}{res}        102        0.03        0.40
{txt}         09 {c |}{res}    203,597       66.81       67.21
{txt}         10 {c |}{res}        114        0.04       67.24
{txt}         11 {c |}{res}        891        0.29       67.54
{txt}         12 {c |}{res}      3,278        1.08       68.61
{txt}         13 {c |}{res}      3,268        1.07       69.68
{txt}         14 {c |}{res}        161        0.05       69.74
{txt}         15 {c |}{res}     70,283       23.06       92.80
{txt}         16 {c |}{res}      1,683        0.55       93.35
{txt}         17 {c |}{res}      1,853        0.61       93.96
{txt}         18 {c |}{res}         40        0.01       93.97
{txt}         19 {c |}{res}         57        0.02       93.99
{txt}         20 {c |}{res}      1,604        0.53       94.52
{txt}         21 {c |}{res}      2,063        0.68       95.19
{txt}         22 {c |}{res}        678        0.22       95.42
{txt}         23 {c |}{res}        128        0.04       95.46
{txt}         24 {c |}{res}        163        0.05       95.51
{txt}         25 {c |}{res}        138        0.05       95.56
{txt}         26 {c |}{res}         82        0.03       95.58
{txt}         27 {c |}{res}        261        0.09       95.67
{txt}         28 {c |}{res}        126        0.04       95.71
{txt}         29 {c |}{res}        868        0.28       96.00
{txt}         30 {c |}{res}      2,273        0.75       96.74
{txt}         31 {c |}{res}         62        0.02       96.76
{txt}         32 {c |}{res}        132        0.04       96.80
{txt}         33 {c |}{res}          4        0.00       96.81
{txt}         34 {c |}{res}         13        0.00       96.81
{txt}         35 {c |}{res}          2        0.00       96.81
{txt}         99 {c |}{res}      9,719        3.19      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    304,762      100.00

{com}. br entidad

. count if entidad == "09"
  {res}203,597

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", clear

. count if entidad == "09" 
{err}type mismatch
{txt}{search r(109), local:r(109);}

{com}. count if entidad == 9
  {res}205,745

{com}. br entidad

. tab entidad

    {txt}ENTIDAD {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
          1 {c |}{res}     43,187        1.46        1.46
{txt}          2 {c |}{res}     52,122        1.76        3.22
{txt}          3 {c |}{res}     18,131        0.61        3.83
{txt}          4 {c |}{res}     30,082        1.02        4.85
{txt}          5 {c |}{res}     49,492        1.67        6.52
{txt}          6 {c |}{res}     20,371        0.69        7.21
{txt}          7 {c |}{res}    139,371        4.71       11.92
{txt}          8 {c |}{res}     77,235        2.61       14.53
{txt}          9 {c |}{res}    205,745        6.95       21.48
{txt}         10 {c |}{res}     50,341        1.70       23.18
{txt}         11 {c |}{res}    162,737        5.50       28.68
{txt}         12 {c |}{res}     94,962        3.21       31.89
{txt}         13 {c |}{res}     64,633        2.18       34.08
{txt}         14 {c |}{res}    215,566        7.28       41.36
{txt}         15 {c |}{res}    397,698       13.44       54.80
{txt}         16 {c |}{res}    137,206        4.64       59.44
{txt}         17 {c |}{res}     51,739        1.75       61.19
{txt}         18 {c |}{res}     28,236        0.95       62.14
{txt}         19 {c |}{res}     57,795        1.95       64.09
{txt}         20 {c |}{res}     94,853        3.21       67.30
{txt}         21 {c |}{res}    124,250        4.20       71.50
{txt}         22 {c |}{res}     55,048        1.86       73.36
{txt}         23 {c |}{res}     39,978        1.35       74.71
{txt}         24 {c |}{res}     67,229        2.27       76.98
{txt}         25 {c |}{res}     75,875        2.56       79.54
{txt}         26 {c |}{res}     77,296        2.61       82.16
{txt}         27 {c |}{res}    109,024        3.68       85.84
{txt}         28 {c |}{res}     86,244        2.91       88.76
{txt}         29 {c |}{res}     46,400        1.57       90.32
{txt}         30 {c |}{res}    176,466        5.96       96.29
{txt}         31 {c |}{res}     53,680        1.81       98.10
{txt}         32 {c |}{res}     44,871        1.52       99.62
{txt}         33 {c |}{res}         78        0.00       99.62
{txt}         34 {c |}{res}        842        0.03       99.65
{txt}         35 {c |}{res}         44        0.00       99.65
{txt}         99 {c |}{res}     10,370        0.35      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}  2,959,197      100.00

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/SAEH2014/SAEH2014.DTA"

. tab entidad

    {txt}entidad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
         01 {c |}{res}        113        0.04        0.04
{txt}         02 {c |}{res}         84        0.03        0.06
{txt}         03 {c |}{res}         49        0.02        0.08
{txt}         04 {c |}{res}         72        0.02        0.10
{txt}         05 {c |}{res}         88        0.03        0.13
{txt}         06 {c |}{res}         30        0.01        0.14
{txt}         07 {c |}{res}        683        0.22        0.37
{txt}         08 {c |}{res}        102        0.03        0.40
{txt}         09 {c |}{res}    203,597       66.81       67.21
{txt}         10 {c |}{res}        114        0.04       67.24
{txt}         11 {c |}{res}        891        0.29       67.54
{txt}         12 {c |}{res}      3,278        1.08       68.61
{txt}         13 {c |}{res}      3,268        1.07       69.68
{txt}         14 {c |}{res}        161        0.05       69.74
{txt}         15 {c |}{res}     70,283       23.06       92.80
{txt}         16 {c |}{res}      1,683        0.55       93.35
{txt}         17 {c |}{res}      1,853        0.61       93.96
{txt}         18 {c |}{res}         40        0.01       93.97
{txt}         19 {c |}{res}         57        0.02       93.99
{txt}         20 {c |}{res}      1,604        0.53       94.52
{txt}         21 {c |}{res}      2,063        0.68       95.19
{txt}         22 {c |}{res}        678        0.22       95.42
{txt}         23 {c |}{res}        128        0.04       95.46
{txt}         24 {c |}{res}        163        0.05       95.51
{txt}         25 {c |}{res}        138        0.05       95.56
{txt}         26 {c |}{res}         82        0.03       95.58
{txt}         27 {c |}{res}        261        0.09       95.67
{txt}         28 {c |}{res}        126        0.04       95.71
{txt}         29 {c |}{res}        868        0.28       96.00
{txt}         30 {c |}{res}      2,273        0.75       96.74
{txt}         31 {c |}{res}         62        0.02       96.76
{txt}         32 {c |}{res}        132        0.04       96.80
{txt}         33 {c |}{res}          4        0.00       96.81
{txt}         34 {c |}{res}         13        0.00       96.81
{txt}         35 {c |}{res}          2        0.00       96.81
{txt}         99 {c |}{res}      9,719        3.19      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    304,762      100.00

{com}. import delimited using "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/EGRESOS.csv", clear
{res}{err}file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/EGRESOS.csv not found
{txt}{search r(601), local:r(601);}

{com}. import delimited using "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/SAEH_BD2014/EGRESOS/Base de Datos/EGRESO.csv", clear
{res}{text}(45 vars, 2,959,197 obs)

{com}. count if year == 2014
{err}year not found
{txt}{search r(111), local:r(111);}

{com}. br 

. count if entidad == "09"
{err}type mismatch
{txt}{search r(109), local:r(109);}

{com}. br entidad

. count if entidad == 9 
  {res}205,745

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/SAEH2014/SAEH2014.DTA"
{err}no; data in memory would be lost
{txt}{search r(4), local:r(4);}

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Primera formacioÌn de base/SAEH2014/SAEH2014.DTA", clear

. count if entidad == 9 
{err}type mismatch
{txt}{search r(109), local:r(109);}

{com}. count if entidad == "09" 
  {res}203,597

{com}. tab entidad

    {txt}entidad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
         01 {c |}{res}        113        0.04        0.04
{txt}         02 {c |}{res}         84        0.03        0.06
{txt}         03 {c |}{res}         49        0.02        0.08
{txt}         04 {c |}{res}         72        0.02        0.10
{txt}         05 {c |}{res}         88        0.03        0.13
{txt}         06 {c |}{res}         30        0.01        0.14
{txt}         07 {c |}{res}        683        0.22        0.37
{txt}         08 {c |}{res}        102        0.03        0.40
{txt}         09 {c |}{res}    203,597       66.81       67.21
{txt}         10 {c |}{res}        114        0.04       67.24
{txt}         11 {c |}{res}        891        0.29       67.54
{txt}         12 {c |}{res}      3,278        1.08       68.61
{txt}         13 {c |}{res}      3,268        1.07       69.68
{txt}         14 {c |}{res}        161        0.05       69.74
{txt}         15 {c |}{res}     70,283       23.06       92.80
{txt}         16 {c |}{res}      1,683        0.55       93.35
{txt}         17 {c |}{res}      1,853        0.61       93.96
{txt}         18 {c |}{res}         40        0.01       93.97
{txt}         19 {c |}{res}         57        0.02       93.99
{txt}         20 {c |}{res}      1,604        0.53       94.52
{txt}         21 {c |}{res}      2,063        0.68       95.19
{txt}         22 {c |}{res}        678        0.22       95.42
{txt}         23 {c |}{res}        128        0.04       95.46
{txt}         24 {c |}{res}        163        0.05       95.51
{txt}         25 {c |}{res}        138        0.05       95.56
{txt}         26 {c |}{res}         82        0.03       95.58
{txt}         27 {c |}{res}        261        0.09       95.67
{txt}         28 {c |}{res}        126        0.04       95.71
{txt}         29 {c |}{res}        868        0.28       96.00
{txt}         30 {c |}{res}      2,273        0.75       96.74
{txt}         31 {c |}{res}         62        0.02       96.76
{txt}         32 {c |}{res}        132        0.04       96.80
{txt}         33 {c |}{res}          4        0.00       96.81
{txt}         34 {c |}{res}         13        0.00       96.81
{txt}         35 {c |}{res}          2        0.00       96.81
{txt}         99 {c |}{res}      9,719        3.19      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}    304,762      100.00

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/SFP_2017-2019/04 Aim 1a - SAEH/01 Datos/Bases/Lily_data/Datos nacionales/compiled_2014.dta", clear

. br afec*

. br entidad afec*

. br entidad afec*

. br clues

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * Modifications from January - July 2017
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}. 
{txt}end of do-file

{com}. br 

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * Modifications from January - July 2017
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}. 
{txt}end of do-file

{com}. tab ar_narrow

                   {txt}ar_narrow {c |}      Freq.     Percent        Cum.
{hline 29}{c +}{hline 35}
                    building {c |}{res}          2        1.85        1.85
{txt}        clinical consumables {c |}{res}          1        0.93        2.78
{txt}                 consumables {c |}{res}          4        3.70        6.48
{txt}          full costing total {c |}{res}         39       36.11       42.59
{txt}                   key_drugs {c |}{res}         12       11.11       53.70
{txt}                    lab test {c |}{res}          1        0.93       54.63
{txt}              maint_and_util {c |}{res}          2        1.85       56.48
{txt}                 maintenance {c |}{res}          4        3.70       60.19
{txt}                      rental {c |}{res}          3        2.78       62.96
{txt}                    subtotal {c |}{res}          4        3.70       66.67
{txt}                    training {c |}{res}          2        1.85       68.52
{txt}                   transport {c |}{res}          1        0.93       69.44
{txt}                 unspecified {c |}{res}         31       28.70       98.15
{txt}                    vehicles {c |}{res}          2        1.85      100.00
{txt}{hline 29}{c +}{hline 35}
                       Total {c |}{res}        108      100.00

{com}. br 

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * Modifications from January - July 2017
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. 
{txt}end of do-file

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * Modifications from January - July 2017
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                                 rename recservices_equipment_maintenanc recserv_equip_maint
{res}{err}variable {bf}recservices_equipment_maintenanc{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                                 rename recservices_technology_maintenan recserv_tech_maint
{res}{err}variable {bf}recservices_technology_maintenan{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * Modifications from January - July 2017
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         /*
> * Next, Encode Procedure for Standardized Inputs
> ************************************************
> 
> save temp_dta/costs.dta,replace 
> clear all
> use temp_dta/costs.dta
> 
> 
>                         *Input Broad Categories
>                         ***********************
>                         replace si_broad = lower(si_broad)                      
>                         *First, make the broad names (that will be in use from HIV) usable
>                         replace si_broad="recurrent" if si_broad=="recurrent - other"
>                                 ***** Should do the same here for TB coding including:
>                                                 * Patient direct, medical
>                                                 * Patient direct, non medical
>                                                 * Patient indirect
>                                                 * Patient direct
>                                                 * Patient mixed
>                                                 * Patient coping strategies
>                         
>                                 *Encode and create categorical
>                                 encode si_broad, generate(si_broad1) label(si_broad)
>                                 move si_broad1 si_broad
>                                 *drop input_broad_cat
>                                 rename si_broad1 si_broad2
>                                 rename si_broad si_broad1
>                                 rename si_broad2 si_broad
>                 
>                                 *Create binaries for each category using value labels
>                                         *set trace on
>                                 tab si_broad, gen(v_)   
>                                 labellist si_broad, rc0
>                                 return list
>                                 local K: word count `r(labels)'
>                                 display "`K'"
>                                 forvalues k = 1/`K' {c -(}
>                                         qui labellist si_broad, rc0
>                                         local name : word `k' of `r(labels)'
>                                         local name = strtoname("`name'")
>                                         rename v_`k' `name'             
>                                 {c )-} 
>                         *
> 
> 
>                         * Narrow input cost categories
>                         * Applying these directly to the broad categories to break out later
>                         ******************************
>                         replace si_narrow = lower(si_narrow)
>                         
>                         * Now fix variable names to get rid of symbols
>                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
>                         replace si_narrow="support" if si_narrow=="support personnel"
>                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
>                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
>                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
>                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
>                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
>                         replace si_narrow="other" if si_narrow=="other capital"
>                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
>                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
>                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
>                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
>                         replace si_narrow="other" if si_narrow=="other recurrent"
>                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
> 
>                         tostring capital-recurrent, replace
> 
>                                 foreach i of varlist capital-recurrent {c -(}
>                                         replace `i'="" if `i'=="0" | `i'=="."
>                                         replace `i'=si_narrow if `i'=="1"
>                                         replace `i'= lower(`i')
>                                         encode `i', gen(`i'_1) label(`i')
>                                         drop `i'
>                                         rename `i'_1 `i' 
>                                 {c )-}
>                                 * Now destring and encode input_narrow_cost 
>                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
>                                         move si_narrow1 si_narrow
>                                         *drop input_narrow_cat
>                                         rename si_narrow1 si_narrow2
>                                         rename si_narrow si_narrow1
>                                         rename si_narrow2 si_narrow
> 
>                         
>                         * Now create binaries for the reshape command (need to finalize)
>                         *********************************************
>                                 *create prefix
>                                 gen si_broad11=si_broad1
>                                 replace si_broad11=substr(si_broad1,1,3)
>                                 gen _="_"
>                                 gen prefix=si_broad11+_
>                                                 drop si_broad11-_
>                                 *combine prefix with narrow cat var
>                                 gen narrow_cat=prefix+si_narrow1
>                                         drop prefix
>                                 *encode categorical
>                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
>                                         drop narrow_cat
>                                         rename narrow_cat1 narrow
>                                 
>                         
>                                 
>                                 *Now generate binaries
>                                 tab narrow, gen(v_)     
>                                 labellist narrow, rc0
>                                 return list
>                                 local K: word count `r(labels)'
>                                 display "`K'"
>                                 forvalues k = 1/`K' {c -(}
>                                         qui labellist narrow, rc0
>                                         local name : word `k' of `r(labels)'
>                                         local name = strtoname("`name'")
>                                         rename v_`k' `name'
>                                 {c )-} 
>                                         drop narrow
>                                         *drop _
>                                 
>                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
>                                 *clean up
>                                 foreach i of varlist  cap_equip_non_medical_inter-rec_other {c -(}
>                                         replace `i'=. if `i'==0
>                                 {c )-}
>                         
>                         
>                         *Now replace all cat and subcat binaries with values of mean_cost
>                                 foreach i of varlist capital-recurrent{c -(}
>                                         egen unique`i'=group(`i')
>                                         {c )-}
>                                         drop capital-recurrent
>                                         rename unique* *
>                                         
>                                         *STILL NEED TO REORDER VARS
>                                 foreach i of varlist capital-recurrent {c -(}
>                                         move `i'  cap_equip_non_medical_inter 
>                                 {c )-}
>                                 
>                         * Apply all mean_costs to these variables with missing obs for all      
>                                 foreach i of varlist capital-rec_other {c -(}
>                                         replace `i'=mean_cost if `i'!=.
>                                 {c )-}
>                         *
>                                         
>                         *Finally add a prefix to these new variables si_
>                         foreach i of varlist capital-rec_other {c -(}
>                                 rename `i'      si_`i'          
>                         {c )-}
> *       
> 
> 
> 
> 
> * Finally, Encode Procedure for Activity Costs
> **********************************************
>         
> save temp_dta/costs.dta,replace 
> clear all
> use temp_dta/costs.dta
>         
>         
>         
>                 *Activity Broad Categories
>                         ***********************
>                         replace a_broad = lower(a_broad)                        
>                         *First, make the broad names (that will be in use from HIV) usable
>                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
>                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
>                                 ***** Would be nice if these were better conceived, but whatever.
>                         
>                                 *Encode and create categorical
>                                 encode a_broad, generate(a_broad1) label(a_broad)
>                                 move a_broad1 a_broad
>                                 *drop input_broad_cat
>                                 rename a_broad1 a_broad2
>                                 rename a_broad a_broad1
>                                 rename a_broad2 a_broad
>                 
>                                 *Create binaries for each category
>                                 *set trace on
>                                 tab a_broad, gen(v_)    
>                                 labellist a_broad, rc0
>                                 return list
>                                 local K: word count `r(labels)'
>                                 display "`K'"
>                                 forvalues k = 1/`K' {c -(}
>                                         qui labellist a_broad, rc0
>                                         local name : word `k' of `r(labels)'
>                                         local name = strtoname("`name'")
>                                         rename v_`k' `name'             
>                                 {c )-} 
>                         *
> 
> 
>         
>                 * Narrow activity cost categories
>                         * Applying these directly to the broad categories to break out later
>                         ******************************
>                         replace a_narrow = lower(a_narrow)
>                         
>                         * Now fix variable names to get rid of symbols
>                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
>                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
>                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
>                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
>                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
>                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
>                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
>                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
>                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
>                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
>                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
>                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
>                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
>                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
>                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
>                 
>                         tostring combo-primary_sd, replace
>         
>                         foreach i of varlist combo-primary_sd {c -(}
>                                         replace `i'="" if `i'=="0" | `i'=="."
>                                         replace `i'=a_narrow if `i'=="1"
>                                         replace `i'= lower(`i')
>                                         encode `i', gen(`i'_1) label(`i')
>                                         drop `i'
>                                         rename `i'_1 `i' 
>                                 {c )-}
>                                 * Now destring and encode input_narrow_cost 
>                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
>                                         move a_narrow1 a_narrow
>                                         *drop input_narrow_cat
>                                         rename a_narrow1 a_narrow2
>                                         rename a_narrow a_narrow1
>                                         rename a_narrow2 a_narrow
> 
>                                         
>         * Now create binaries for the reshape command (need to finalize)
>                         *********************************************
>                                 *create prefix
>                                 
>                                 split a_broad1, p(" " "_" "-")
>                                 replace a_broad11=substr(a_broad11,1,3)
>                                 gen _="_"
>                                 gen prefix=a_broad11+a_broad12+_
>                                                 drop a_broad11-_
>                                 *combine prefix with narrow cat var
>                                 gen narrow_cat=prefix+a_narrow1
>                                         drop prefix
>                                 *encode categorical
>                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
>                                         drop narrow_cat
>                                         rename narrow_cat1 narrow
>                                 
>                                 
>                                 *Now generate binaries
>                                 tab narrow, gen(v_)     
>                                 labellist narrow, rc0
>                                 return list
>                                 local K: word count `r(labels)'
>                                 display "`K'"
>                                 forvalues k = 1/`K' {c -(}
>                                         qui labellist narrow, rc0
>                                         local name : word `k' of `r(labels)'
>                                         local name = strtoname("`name'")
>                                         rename v_`k' `name'
>                                 {c )-} 
>                                         drop narrow
>                                         *drop _
>         
>                                 *clean up
>                                 foreach i of varlist com_combo-prisd_unspecified {c -(}
>                                         replace `i'=. if `i'==0
>                                 {c )-}
>                         
>                         
>                         *Now replace all cat and subcat binaries with values of mean_cost
>                                 foreach i of varlist combo-primary_sd{c -(}
>                                         egen unique`i'=group(`i')
>                                         {c )-}
>                                         drop combo-primary_sd
>                                         rename unique* *
>                                         
>                                         *STILL NEED TO REORDER VARS
>                                 foreach i of varlist combo-primary_sd {c -(}
>                                         move `i' com_combo
>                                 {c )-}
>                                 
>                         * Apply all mean_costs to these variables with missing obs for all      
>                                 foreach i of varlist combo-prisd_unspecified{c -(}
>                                         replace `i'=mean_cost if `i'!=.
>                                 {c )-}
>                         
>                         *Finally add a prefix to these new variables si_
>                         foreach i of varlist combo-prisd_unspecified{c -(}
>                                 rename `i'      a_`i'           
>                         {c )-}
> *       
>         
> ** Encoding remaining variables
> *******************************
>                         
>                           
>                         
>                 * Encode categorical variables for long version
>                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
>                         *replace `i' = lower(`i')
>                         encode `i', gen(`i'_1) label(`i')
>                         move `i'_1 `i'
>                         drop `i'
>                         rename `i'_1 `i' 
>                         {c )-}
>                         
>                         
>                         
>                         * To add below??:
>                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
>                         
>                         
>                 * Encode reporting standards variables for long version
>                         *set trace on
>                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
>                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
>                         replace `i' = lower(`i')
>                         replace `i' = "1" if `i'== "explicit"
>                         replace `i' = "2" if `i'== "inferred"
>                         replace `i' = "3" if `i'== "n/a"
>                         replace `i' = "4" if `i'== "nr"
>                         destring `i', replace
>                                 label values `i' rs
>                         *consider changing label for NR to .    
>                         {c )-}
> 
>                         
>                 * Numeric variables to recode NR to missing and destring to numeric
>                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
>                         replace `i' = lower(`i')
>                         replace `i'="." if `i'=="nr" | `i'=="n/a"
>                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
>                         destring `i', replace
>                         {c )-}
>                 *
>                 
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> 
>                                                 
>         
>                 * Finally rename id variable for merge
>                 * rename substudyid id
>                 save temp_dta/costs.dta,replace 
>                 clear all
> 
> 
> * Load in and clean study-level dataset
> ****************************************
> 
> 
>                 use temp_dta/study_attributes.dta
> 
> 
>                 * DROP NR for following Variables for encoding:
>                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
>                                 replace `i'="" if `i'=="NR" | `i'=="nr"
>                         {c )-}
> 
>                         * Generate a new country string variable so you can merge in other information later:
>                         gen country_alt=country
>                         
>                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
>                         *replace `i' = lower(`i')
>                         replace `i'="." if `i'=="NR"
>                         encode `i', gen(`i'_1) label(`i')
>                         move `i'_1 `i'
>                         drop `i'
>                         rename `i'_1 `i' 
>                         {c )-}
>                         *
> 
>                         * Additional recent variables (categorical)
>                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
>                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
>                         {c )-}
>                                 destring hiv_prev, replace
>                         
>                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
>                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
> 
>                         
>                         replace coverage="" if coverage=="NR"
>                                 destring coverage, replace
>                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
>                                 destring discount_rate, replace
>                         replace location="" if location=="NR"
>                         
>                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
>                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
>                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
>                         *set trace on
>                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
>                         replace `i' = lower(`i')
>                         replace `i' = "1" if `i'== "explicit"
>                         replace `i' = "2" if `i'== "inferred"
>                         replace `i' = "3" if `i'== "n/a"
>                         replace `i' = "" if `i'== "nr"
>                         replace `i' = "" if `i'== "none"
>                         destring `i', replace
>                                 label values `i' rs
>                         {c )-}
>                                 
>                         *consider changing label for NR to .    
> 
> * And destring remaining numeric variables:
>                         *Years
>                         foreach i of varlist start_year end_year year_intro{c -(}
>                                 replace `i'=lower(`i')
>                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
>                                 destring `i', replace
>                                 {c )-}
>                         
>                         *Months
>                         foreach i of varlist start_month end_month{c -(}
>                                 replace `i'=lower(`i')
>                                 replace `i'="1" if `i'=="january"
>                                 replace `i'="2" if `i'=="february"
>                                 replace `i'="3" if `i'=="march"
>                                 replace `i'="4" if `i'=="april"
>                                 replace `i'="5" if `i'=="may"
>                                 replace `i'="6" if `i'=="june"
>                                 replace `i'="7" if `i'=="july"
>                                 replace `i'="8" if `i'=="august"
>                                 replace `i'="9" if `i'=="september"
>                                 replace `i'="10" if `i'=="october"
>                                 replace `i'="11" if `i'=="november"
>                                 replace `i'="12" if `i'=="december"
>                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
>                                 destring `i', replace
>                                 {c )-}
>                                 
>                 
>                 * id_facility (coding structure, from codebook)
>                 
>                                 *Create meta_category
>                                 gen meta_facility=.
>                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
>                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
>                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
>                                 replace meta_facility=4 if id_facility=="PW01"
>                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
>                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
>                                 label values meta_facility meta_facility
>                                 label var meta_facility "Broad Facility Category"
>                                 
>                         *Now create numeric for better encoding 
>                         gen facility_cat=.
>                                 replace facility_cat=   101     if id_facility=="HC01"
>                                 replace facility_cat=   102     if id_facility=="HC02"
>                                 replace facility_cat=   103     if id_facility=="HC03"
>                                 replace facility_cat=   104     if id_facility=="HC04"
>                                 replace facility_cat=   105     if id_facility=="HC05"
>                                 replace facility_cat=   107     if id_facility=="HC07"
>                                 replace facility_cat=   108     if id_facility=="HC08"
>                                 replace facility_cat=   109     if id_facility=="HC09"
>                                 replace facility_cat=   110     if id_facility=="HC10"
>                                 replace facility_cat=   111     if id_facility=="HC11"
>                                 replace facility_cat=   201     if id_facility=="OR01"
>                                 replace facility_cat=   202     if id_facility=="OR02"
>                                 replace facility_cat=   203     if id_facility=="OR03"
>                                 replace facility_cat=   204     if id_facility=="OR04"
>                                 replace facility_cat=   205     if id_facility=="OR05"
>                                 replace facility_cat=   301     if id_facility=="CB01"
>                                 replace facility_cat=   302     if id_facility=="CB02"
>                                 replace facility_cat=   303     if id_facility=="CB03"
>                                 replace facility_cat=   304     if id_facility=="CB04"
>                                 replace facility_cat=   401     if id_facility=="PW01"
>                                 replace facility_cat=   501     if id_facility=="OT01"
>                                 replace facility_cat=   502     if id_facility=="OT02"
>                                 
>                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
>                                         label values facility_cat facility_cat
>                                         label variable facility_cat "Narrow Facility Category"
>         
>         
>                         *Finally, can we create mid-level variables for type of facility:
>                         gen fac_type=.
>                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
>                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
>                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
>                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
>                                 replace fac_type=5 if meta_facility==2
>                                 replace fac_type=6 if meta_facility==3
>                                 replace fac_type=7 if meta_facility==4
>                                 replace fac_type=8 if meta_facility==5
>                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
>                                 label values fac_type fac_type
>                                         label variable fac_type "Facility Type for Analysis"
>                                 
>                         
>                         * And binaries for facility_type
>                         tab fac_type, gen(v_)
>                                 rename v_1 ft_hospitals
>                                 rename v_2 ft_unspecified_hc
>                         
>                                         // note not appropriate for other intervention types
>                                 
>                         * And binaries for faclity_category
>                         tab facility_cat, gen(v_)
>                                 rename v_1 tertiary_hospital
>                                 rename v_2 unspecified_healthfac
>                                 
>                                 ** Try adding both to the models to see how it might differ.
>         
>         * Do I need to destring or recode: id_details; id_phase; 
>         
>         
>         * Save progress
>         save temp_dta/study_attributes.dta,replace      
>         
> 
> *************************************************************************
> * Part II
> * Above, everything from cost_data sheet is encoded and ready for merging
> * Below, we create two separate datasets for analysis
> *               1. Long DS with each row = cost input, combined with study level data
> *               2. Wide DS with each row as a study, collapsed and combined with study level data
> *************************************************************************
> 
> 
>         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
>         *************************************************************************
>         
>         clear
>         use temp_dta/costs.dta
>                 drop ar_capital-a_prisd_unspecified
>         merge m:1 id using temp_dta/study_attributes.dta
>                 order extractor_initials-consistency_rmk
>                 order id
>                                 drop if _merge!=3
>                                 drop _merge
>         
>                                 save final_dtas/long_file.dta, replace
>                                 *This dataset may require some additional cleaning and culling for appropriate use
>                                 
>         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
>         **********************************************************************************
>         clear
>         use temp_dta/costs.dta
> 
>         
>         * First set up the desired order of the collapsed cost variable with markers
>                         *Broad as reported costs
>                                 gen broad_asreported=.
>                                 move broad_asreported ar_capital
>                         *Narrow as reported costs
>                                 gen narrow_asreported=.
>                                 move narrow_asreported ar_cap_admin_equip
>                         
>                         *Broad Standardized Input costs
>                                 gen broad_stdinput=.
>                                 move broad_stdinput si_capital
>                         * Narrow Standardized Input costs
>                                 gen narrow_stdinput=.
>                                 move narrow_stdinput si_cap_equip_non_medical_inter
>                         
>                                 
>                         *Broad Activity Costs
>                                 gen broad_activity=.
>                                 move broad_activity a_combo
>                 
>                         * Narrow Activity costs
>                                 gen narrow_activity=.
>                                 move narrow_activity a_com_combo
>                         
>         
>                         save temp_dta/costs.dta, replace
> 
> 
> 
>                 * Collapse for reshape wide 
>                 * (here, in two parts,  1) collapse cost variables, and 
>                 *                                               2) remove non-total rows for all categorical variables).
>                 ************************************************************************************
> 
>                         *1. Collapse cost variables into new dataset
>                         *Need to collapse one var at a time and append to a new dataset
>                                 collapse broad_asreported, by (unit_cost)
>                                 save temp_dta/costs_temp.dta,replace
>                                         clear
>                                         use temp_dta/costs.dta
>                                 *set trace on
>                                 foreach i of varlist ar_capital-a_prisd_unspecified {c -(}
>                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
>                                                 collapse (sum) `i' (min) miss, by (unit_cost)
>                                                 replace `i'=. if miss==1
>                                                         drop miss
>                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
>                                                         drop _merge
>                                                         save temp_dta/costs_temp.dta,replace
>                                                                 clear
>                                                 use temp_dta/costs.dta
>                                                 {c )-}
>                                                 *
>                         *2. Now collapse all of the categorical variables just by total
>                                 drop ar_capital-a_prisd_unspecified
>                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
>                                         save temp_dta/c_categoricals.dta,replace
>                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
>                                                         drop if _merge!=3
>                                                                         * In this case, drops 6 that we dont want anyway
>                                                         drop _merge
>                                                         
>                                 * reorder for ease of finding 
>                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
>                                 order id unit_cost broad_asreported ar_broad ar_capital ar_overhead ar_personnel ar_recurring_services ar_total ar_narrow narrow_asreported ar_cap_admin_equip ar_cap_medical_equipment ar_cap_technology_development ar_ove_unspecified ar_per_admin_support ar_per_clinical_officer ar_per_counselors ar_recserv_equip_maint ar_recserv_tech_maint ar_tot_full_costing_total broad_stdinput si_broad si_capital si_combined si_personnel si_recurrent narrow_stdinput si_narrow si_cap_equip_non_medical_inter si_cap_medical_equip si_com_unit_cost_total si_per_service_delivery si_per_support si_rec_med_int_supplies si_rec_other broad_activity a_combo a_operational a_primary_sd narrow_activity a_narrow a_ope_bldg_equip a_ope_program_mgmt a_ope_supervision a_ope_technology_development a_ope_technology_maintenance a_ope_unspecified a_prisd_rc_counseling a_prisd_unspecified output_pmonth output_pyear output_pyear2 output_pmonth2 output1k_mo output1k_yr output1k_yr2 output1k_mo2       
>                                                         
>                                 * First label organizational variables after resort
>                                 label variable broad_asreported "----------------------------------"
>                                 label variable narrow_asreported "----------------------------------"
>                                 label variable broad_stdinput "----------------------------------"      
>                                 label variable narrow_stdinput "----------------------------------"
>                                 label variable broad_activity "----------------------------------"
>                                 label variable narrow_activity "----------------------------------"
>                         
>                                 * Generate a Unit Cost Total "uc_total"
>                                 move mean_cost ar_broad
>                                 
>                                 * Finally merge in study_attribute dataset
>                                 merge m:1 id using temp_dta/study_attributes.dta
>                                         drop if _merge!=3
>                                                 * In this case it drops the 6 sub-studies that we dont want
>                                                 drop _merge
>                         
>                         
>                         *Final cleaning and creation of organizational variables
>                         *********************************************************
>                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
>                         
>                         gen COVARIATES=.
>                         move COVARIATES output_pmonth
>                         label variable COVARIATES "----------------------------------"
>                         
>                         gen output_vars=.
>                         move output_vars output_pmonth
>                         label variable output_vars "----------------------------------"
>                         
>                         * Save version before importing GDPPC data:
>                         save final_dtas/wide_file.dta, replace
>                         
>                         * Finally, import GDPPC data for each study.
>                         ********************************************
>                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
>                                 * Simply download EXCEL file option for ALL countries (should be default). 
>                                 * Download for this presentation was done on 25 October 2017
>                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
>                                 * place file in path along with data extraction template
>                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
>                                 * ...so check that import and file manipulation commands below work. 
>                         
>                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/Retention_and_adherence/wide_files/Retention_wide_file_Mar2018.dta", replace
> 
>                         clear
>                         
>                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * Modifications from January - July 2017
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
. 
{txt}end of do-file

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equipment__non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{err}1 new variable name invalid
{p 4 4 2}
You attempted to rename {bf:cap_equipment__non_medical_inter} to {bf:si_cap_equipment__non_medical_inter}{err}.
That is an invalid Stata variable name.
{p_end}
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. /*
> 
> * Finally, Encode Procedure for Activity Costs
> **********************************************
>         
> save temp_dta/costs.dta,replace 
> clear all
> use temp_dta/costs.dta
>         
>         
>         
>                 *Activity Broad Categories
>                         ***********************
>                         replace a_broad = lower(a_broad)                        
>                         *First, make the broad names (that will be in use from HIV) usable
>                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
>                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
>                                 ***** Would be nice if these were better conceived, but whatever.
>                         
>                                 *Encode and create categorical
>                                 encode a_broad, generate(a_broad1) label(a_broad)
>                                 move a_broad1 a_broad
>                                 *drop input_broad_cat
>                                 rename a_broad1 a_broad2
>                                 rename a_broad a_broad1
>                                 rename a_broad2 a_broad
>                 
>                                 *Create binaries for each category
>                                 *set trace on
>                                 tab a_broad, gen(v_)    
>                                 labellist a_broad, rc0
>                                 return list
>                                 local K: word count `r(labels)'
>                                 display "`K'"
>                                 forvalues k = 1/`K' {c -(}
>                                         qui labellist a_broad, rc0
>                                         local name : word `k' of `r(labels)'
>                                         local name = strtoname("`name'")
>                                         rename v_`k' `name'             
>                                 {c )-} 
>                         *
> 
> 
>         
>                 * Narrow activity cost categories
>                         * Applying these directly to the broad categories to break out later
>                         ******************************
>                         replace a_narrow = lower(a_narrow)
>                         
>                         * Now fix variable names to get rid of symbols
>                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
>                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
>                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
>                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
>                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
>                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
>                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
>                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
>                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
>                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
>                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
>                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
>                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
>                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
>                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
>                 
>                         tostring combo-primary_sd, replace
>         
>                         foreach i of varlist combo-primary_sd {c -(}
>                                         replace `i'="" if `i'=="0" | `i'=="."
>                                         replace `i'=a_narrow if `i'=="1"
>                                         replace `i'= lower(`i')
>                                         encode `i', gen(`i'_1) label(`i')
>                                         drop `i'
>                                         rename `i'_1 `i' 
>                                 {c )-}
>                                 * Now destring and encode input_narrow_cost 
>                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
>                                         move a_narrow1 a_narrow
>                                         *drop input_narrow_cat
>                                         rename a_narrow1 a_narrow2
>                                         rename a_narrow a_narrow1
>                                         rename a_narrow2 a_narrow
> 
>                                         
>         * Now create binaries for the reshape command (need to finalize)
>                         *********************************************
>                                 *create prefix
>                                 
>                                 split a_broad1, p(" " "_" "-")
>                                 replace a_broad11=substr(a_broad11,1,3)
>                                 gen _="_"
>                                 gen prefix=a_broad11+a_broad12+_
>                                                 drop a_broad11-_
>                                 *combine prefix with narrow cat var
>                                 gen narrow_cat=prefix+a_narrow1
>                                         drop prefix
>                                 *encode categorical
>                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
>                                         drop narrow_cat
>                                         rename narrow_cat1 narrow
>                                 
>                                 
>                                 *Now generate binaries
>                                 tab narrow, gen(v_)     
>                                 labellist narrow, rc0
>                                 return list
>                                 local K: word count `r(labels)'
>                                 display "`K'"
>                                 forvalues k = 1/`K' {c -(}
>                                         qui labellist narrow, rc0
>                                         local name : word `k' of `r(labels)'
>                                         local name = strtoname("`name'")
>                                         rename v_`k' `name'
>                                 {c )-} 
>                                         drop narrow
>                                         *drop _
>         
>                                 *clean up
>                                 foreach i of varlist com_combo-prisd_unspecified {c -(}
>                                         replace `i'=. if `i'==0
>                                 {c )-}
>                         
>                         
>                         *Now replace all cat and subcat binaries with values of mean_cost
>                                 foreach i of varlist combo-primary_sd{c -(}
>                                         egen unique`i'=group(`i')
>                                         {c )-}
>                                         drop combo-primary_sd
>                                         rename unique* *
>                                         
>                                         *STILL NEED TO REORDER VARS
>                                 foreach i of varlist combo-primary_sd {c -(}
>                                         move `i' com_combo
>                                 {c )-}
>                                 
>                         * Apply all mean_costs to these variables with missing obs for all      
>                                 foreach i of varlist combo-prisd_unspecified{c -(}
>                                         replace `i'=mean_cost if `i'!=.
>                                 {c )-}
>                         
>                         *Finally add a prefix to these new variables si_
>                         foreach i of varlist combo-prisd_unspecified{c -(}
>                                 rename `i'      a_`i'           
>                         {c )-}
> *       
>         
> ** Encoding remaining variables
> *******************************
>                         
>                           
>                         
>                 * Encode categorical variables for long version
>                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
>                         *replace `i' = lower(`i')
>                         encode `i', gen(`i'_1) label(`i')
>                         move `i'_1 `i'
>                         drop `i'
>                         rename `i'_1 `i' 
>                         {c )-}
>                         
>                         
>                         
>                         * To add below??:
>                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
>                         
>                         
>                 * Encode reporting standards variables for long version
>                         *set trace on
>                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
>                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
>                         replace `i' = lower(`i')
>                         replace `i' = "1" if `i'== "explicit"
>                         replace `i' = "2" if `i'== "inferred"
>                         replace `i' = "3" if `i'== "n/a"
>                         replace `i' = "4" if `i'== "nr"
>                         destring `i', replace
>                                 label values `i' rs
>                         *consider changing label for NR to .    
>                         {c )-}
> 
>                         
>                 * Numeric variables to recode NR to missing and destring to numeric
>                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
>                         replace `i' = lower(`i')
>                         replace `i'="." if `i'=="nr" | `i'=="n/a"
>                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
>                         destring `i', replace
>                         {c )-}
>                 *
>                 
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> 
>                                                 
>         
>                 * Finally rename id variable for merge
>                 * rename substudyid id
>                 save temp_dta/costs.dta,replace 
>                 clear all
> 
> 
> * Load in and clean study-level dataset
> ****************************************
> 
> 
>                 use temp_dta/study_attributes.dta
> 
> 
>                 * DROP NR for following Variables for encoding:
>                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
>                                 replace `i'="" if `i'=="NR" | `i'=="nr"
>                         {c )-}
> 
>                         * Generate a new country string variable so you can merge in other information later:
>                         gen country_alt=country
>                         
>                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
>                         *replace `i' = lower(`i')
>                         replace `i'="." if `i'=="NR"
>                         encode `i', gen(`i'_1) label(`i')
>                         move `i'_1 `i'
>                         drop `i'
>                         rename `i'_1 `i' 
>                         {c )-}
>                         *
> 
>                         * Additional recent variables (categorical)
>                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
>                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
>                         {c )-}
>                                 destring hiv_prev, replace
>                         
>                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
>                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
> 
>                         
>                         replace coverage="" if coverage=="NR"
>                                 destring coverage, replace
>                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
>                                 destring discount_rate, replace
>                         replace location="" if location=="NR"
>                         
>                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
>                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
>                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
>                         *set trace on
>                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
>                         replace `i' = lower(`i')
>                         replace `i' = "1" if `i'== "explicit"
>                         replace `i' = "2" if `i'== "inferred"
>                         replace `i' = "3" if `i'== "n/a"
>                         replace `i' = "" if `i'== "nr"
>                         replace `i' = "" if `i'== "none"
>                         destring `i', replace
>                                 label values `i' rs
>                         {c )-}
>                                 
>                         *consider changing label for NR to .    
> 
> * And destring remaining numeric variables:
>                         *Years
>                         foreach i of varlist start_year end_year year_intro{c -(}
>                                 replace `i'=lower(`i')
>                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
>                                 destring `i', replace
>                                 {c )-}
>                         
>                         *Months
>                         foreach i of varlist start_month end_month{c -(}
>                                 replace `i'=lower(`i')
>                                 replace `i'="1" if `i'=="january"
>                                 replace `i'="2" if `i'=="february"
>                                 replace `i'="3" if `i'=="march"
>                                 replace `i'="4" if `i'=="april"
>                                 replace `i'="5" if `i'=="may"
>                                 replace `i'="6" if `i'=="june"
>                                 replace `i'="7" if `i'=="july"
>                                 replace `i'="8" if `i'=="august"
>                                 replace `i'="9" if `i'=="september"
>                                 replace `i'="10" if `i'=="october"
>                                 replace `i'="11" if `i'=="november"
>                                 replace `i'="12" if `i'=="december"
>                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
>                                 destring `i', replace
>                                 {c )-}
>                                 
>                 
>                 * id_facility (coding structure, from codebook)
>                 
>                                 *Create meta_category
>                                 gen meta_facility=.
>                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
>                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
>                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
>                                 replace meta_facility=4 if id_facility=="PW01"
>                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
>                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
>                                 label values meta_facility meta_facility
>                                 label var meta_facility "Broad Facility Category"
>                                 
>                         *Now create numeric for better encoding 
>                         gen facility_cat=.
>                                 replace facility_cat=   101     if id_facility=="HC01"
>                                 replace facility_cat=   102     if id_facility=="HC02"
>                                 replace facility_cat=   103     if id_facility=="HC03"
>                                 replace facility_cat=   104     if id_facility=="HC04"
>                                 replace facility_cat=   105     if id_facility=="HC05"
>                                 replace facility_cat=   107     if id_facility=="HC07"
>                                 replace facility_cat=   108     if id_facility=="HC08"
>                                 replace facility_cat=   109     if id_facility=="HC09"
>                                 replace facility_cat=   110     if id_facility=="HC10"
>                                 replace facility_cat=   111     if id_facility=="HC11"
>                                 replace facility_cat=   201     if id_facility=="OR01"
>                                 replace facility_cat=   202     if id_facility=="OR02"
>                                 replace facility_cat=   203     if id_facility=="OR03"
>                                 replace facility_cat=   204     if id_facility=="OR04"
>                                 replace facility_cat=   205     if id_facility=="OR05"
>                                 replace facility_cat=   301     if id_facility=="CB01"
>                                 replace facility_cat=   302     if id_facility=="CB02"
>                                 replace facility_cat=   303     if id_facility=="CB03"
>                                 replace facility_cat=   304     if id_facility=="CB04"
>                                 replace facility_cat=   401     if id_facility=="PW01"
>                                 replace facility_cat=   501     if id_facility=="OT01"
>                                 replace facility_cat=   502     if id_facility=="OT02"
>                                 
>                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
>                                         label values facility_cat facility_cat
>                                         label variable facility_cat "Narrow Facility Category"
>         
>         
>                         *Finally, can we create mid-level variables for type of facility:
>                         gen fac_type=.
>                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
>                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
>                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
>                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
>                                 replace fac_type=5 if meta_facility==2
>                                 replace fac_type=6 if meta_facility==3
>                                 replace fac_type=7 if meta_facility==4
>                                 replace fac_type=8 if meta_facility==5
>                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
>                                 label values fac_type fac_type
>                                         label variable fac_type "Facility Type for Analysis"
>                                 
>                         
>                         * And binaries for facility_type
>                         tab fac_type, gen(v_)
>                                 rename v_1 ft_hospitals
>                                 rename v_2 ft_unspecified_hc
>                         
>                                         // note not appropriate for other intervention types
>                                 
>                         * And binaries for faclity_category
>                         tab facility_cat, gen(v_)
>                                 rename v_1 tertiary_hospital
>                                 rename v_2 unspecified_healthfac
>                                 
>                                 ** Try adding both to the models to see how it might differ.
>         
>         * Do I need to destring or recode: id_details; id_phase; 
>         
>         
>         * Save progress
>         save temp_dta/study_attributes.dta,replace      
>         
> 
> *************************************************************************
> * Part II
> * Above, everything from cost_data sheet is encoded and ready for merging
> * Below, we create two separate datasets for analysis
> *               1. Long DS with each row = cost input, combined with study level data
> *               2. Wide DS with each row as a study, collapsed and combined with study level data
> *************************************************************************
> 
> 
>         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
>         *************************************************************************
>         
>         clear
>         use temp_dta/costs.dta
>                 drop ar_capital-a_prisd_unspecified
>         merge m:1 id using temp_dta/study_attributes.dta
>                 order extractor_initials-consistency_rmk
>                 order id
>                                 drop if _merge!=3
>                                 drop _merge
>         
>                                 save final_dtas/long_file.dta, replace
>                                 *This dataset may require some additional cleaning and culling for appropriate use
>                                 
>         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
>         **********************************************************************************
>         clear
>         use temp_dta/costs.dta
> 
>         
>         * First set up the desired order of the collapsed cost variable with markers
>                         *Broad as reported costs
>                                 gen broad_asreported=.
>                                 move broad_asreported ar_capital
>                         *Narrow as reported costs
>                                 gen narrow_asreported=.
>                                 move narrow_asreported ar_cap_admin_equip
>                         
>                         *Broad Standardized Input costs
>                                 gen broad_stdinput=.
>                                 move broad_stdinput si_capital
>                         * Narrow Standardized Input costs
>                                 gen narrow_stdinput=.
>                                 move narrow_stdinput si_cap_equip_non_medical_inter
>                         
>                                 
>                         *Broad Activity Costs
>                                 gen broad_activity=.
>                                 move broad_activity a_combo
>                 
>                         * Narrow Activity costs
>                                 gen narrow_activity=.
>                                 move narrow_activity a_com_combo
>                         
>         
>                         save temp_dta/costs.dta, replace
> 
> 
> 
>                 * Collapse for reshape wide 
>                 * (here, in two parts,  1) collapse cost variables, and 
>                 *                                               2) remove non-total rows for all categorical variables).
>                 ************************************************************************************
> 
>                         *1. Collapse cost variables into new dataset
>                         *Need to collapse one var at a time and append to a new dataset
>                                 collapse broad_asreported, by (unit_cost)
>                                 save temp_dta/costs_temp.dta,replace
>                                         clear
>                                         use temp_dta/costs.dta
>                                 *set trace on
>                                 foreach i of varlist ar_capital-a_prisd_unspecified {c -(}
>                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
>                                                 collapse (sum) `i' (min) miss, by (unit_cost)
>                                                 replace `i'=. if miss==1
>                                                         drop miss
>                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
>                                                         drop _merge
>                                                         save temp_dta/costs_temp.dta,replace
>                                                                 clear
>                                                 use temp_dta/costs.dta
>                                                 {c )-}
>                                                 *
>                         *2. Now collapse all of the categorical variables just by total
>                                 drop ar_capital-a_prisd_unspecified
>                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
>                                         save temp_dta/c_categoricals.dta,replace
>                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
>                                                         drop if _merge!=3
>                                                                         * In this case, drops 6 that we dont want anyway
>                                                         drop _merge
>                                                         
>                                 * reorder for ease of finding 
>                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
>                                 order id unit_cost broad_asreported ar_broad ar_capital ar_overhead ar_personnel ar_recurring_services ar_total ar_narrow narrow_asreported ar_cap_admin_equip ar_cap_medical_equipment ar_cap_technology_development ar_ove_unspecified ar_per_admin_support ar_per_clinical_officer ar_per_counselors ar_recserv_equip_maint ar_recserv_tech_maint ar_tot_full_costing_total broad_stdinput si_broad si_capital si_combined si_personnel si_recurrent narrow_stdinput si_narrow si_cap_equip_non_medical_inter si_cap_medical_equip si_com_unit_cost_total si_per_service_delivery si_per_support si_rec_med_int_supplies si_rec_other broad_activity a_combo a_operational a_primary_sd narrow_activity a_narrow a_ope_bldg_equip a_ope_program_mgmt a_ope_supervision a_ope_technology_development a_ope_technology_maintenance a_ope_unspecified a_prisd_rc_counseling a_prisd_unspecified output_pmonth output_pyear output_pyear2 output_pmonth2 output1k_mo output1k_yr output1k_yr2 output1k_mo2       
>                                                         
>                                 * First label organizational variables after resort
>                                 label variable broad_asreported "----------------------------------"
>                                 label variable narrow_asreported "----------------------------------"
>                                 label variable broad_stdinput "----------------------------------"      
>                                 label variable narrow_stdinput "----------------------------------"
>                                 label variable broad_activity "----------------------------------"
>                                 label variable narrow_activity "----------------------------------"
>                         
>                                 * Generate a Unit Cost Total "uc_total"
>                                 move mean_cost ar_broad
>                                 
>                                 * Finally merge in study_attribute dataset
>                                 merge m:1 id using temp_dta/study_attributes.dta
>                                         drop if _merge!=3
>                                                 * In this case it drops the 6 sub-studies that we dont want
>                                                 drop _merge
>                         
>                         
>                         *Final cleaning and creation of organizational variables
>                         *********************************************************
>                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
>                         
>                         gen COVARIATES=.
>                         move COVARIATES output_pmonth
>                         label variable COVARIATES "----------------------------------"
>                         
>                         gen output_vars=.
>                         move output_vars output_pmonth
>                         label variable output_vars "----------------------------------"
>                         
>                         * Save version before importing GDPPC data:
>                         save final_dtas/wide_file.dta, replace
>                         
>                         * Finally, import GDPPC data for each study.
>                         ********************************************
>                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
>                                 * Simply download EXCEL file option for ALL countries (should be default). 
>                                 * Download for this presentation was done on 25 October 2017
>                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
>                                 * place file in path along with data extraction template
>                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
>                                 * ...so check that import and file manipulation commands below work. 
>                         
>                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/Retention_and_adherence/wide_files/Retention_wide_file_Mar2018.dta", replace
> 
>                         clear
>                         
>                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                combo {c |}{res}         39       36.11       36.11
{txt}                                mixed {c |}{res}         13       12.04       48.15
{txt}                          operational {c |}{res}         37       34.26       82.41
{txt}             operational, unspecified {c |}{res}          9        8.33       90.74
{txt}primary service delivery, unspecified {c |}{res}          3        2.78       93.52
{txt}                           primary_sd {c |}{res}          3        2.78       96.30
{txt}                          unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary service delivery, unspecified 
           6 primary_sd 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary service delive{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_service_delivery__unspec was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.         
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational__unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_service_delivery__unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{err}primary_service_delivery__unspec_1 invalid varname
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                combo {c |}{res}         39       36.11       36.11
{txt}                                mixed {c |}{res}         13       12.04       48.15
{txt}                          operational {c |}{res}         37       34.26       82.41
{txt}             operational, unspecified {c |}{res}          9        8.33       90.74
{txt}primary service delivery, unspecified {c |}{res}          3        2.78       93.52
{txt}                           primary_sd {c |}{res}          3        2.78       96.30
{txt}                          unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary service delivery, unspecified 
           6 primary_sd 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary service delive{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                 
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_service_delivery__unspec was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.         
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational__unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_service_delivery__unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{err}primary_service_delivery__unspec_1 invalid varname
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                                 *clean up
.                                 foreach i of varlist com_combo-prisd_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{err}variable {bf}com_combo{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                combo {c |}{res}         39       36.11       36.11
{txt}                                mixed {c |}{res}         13       12.04       48.15
{txt}                          operational {c |}{res}         37       34.26       82.41
{txt}             operational, unspecified {c |}{res}          9        8.33       90.74
{txt}primary service delivery, unspecified {c |}{res}          3        2.78       93.52
{txt}                           primary_sd {c |}{res}          3        2.78       96.30
{txt}                          unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary service delivery, unspecified 
           6 primary_sd 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary service delive{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                 
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_service_delivery__unspec was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.         
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational__unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_service_delivery__unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{err}primary_service_delivery__unspec_1 invalid varname
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                combo {c |}{res}         39       36.11       36.11
{txt}                                mixed {c |}{res}         13       12.04       48.15
{txt}                          operational {c |}{res}         37       34.26       82.41
{txt}             operational, unspecified {c |}{res}          9        8.33       90.74
{txt}primary service delivery, unspecified {c |}{res}          3        2.78       93.52
{txt}                           primary_sd {c |}{res}          3        2.78       96.30
{txt}                          unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary service delivery, unspecified 
           6 primary_sd 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary service delive{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_service_delivery__unspec was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.         
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational__unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_service_delivery__unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{err}primary_service_delivery__unspec_1 invalid varname
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                combo {c |}{res}         39       36.11       36.11
{txt}                                mixed {c |}{res}         13       12.04       48.15
{txt}                          operational {c |}{res}         37       34.26       82.41
{txt}             operational, unspecified {c |}{res}          9        8.33       90.74
{txt}primary service delivery, unspecified {c |}{res}          3        2.78       93.52
{txt}                           primary_sd {c |}{res}          3        2.78       96.30
{txt}                          unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary service delivery, unspecified 
           6 primary_sd 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary service delive{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_service_delivery__unspec was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                         
.                         rename primary_service_delivery__unspec primary_service_delivery_unspec
{res}{txt}
{com}.                         rename operational__unspecified operational_unspecified 
{res}{txt}
{com}.                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational_unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_service_delivery_unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{err}primary_service_delivery_unspec_1 invalid varname
{txt}{search r(198), local:r(198);}

end of do-file

{search r(198), local:r(198);}

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd_unspec" if a_broad=="primary service delivery, unspecified"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                 {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 25}{c +}{hline 35}
                   combo {c |}{res}         39       36.11       36.11
{txt}                   mixed {c |}{res}         13       12.04       48.15
{txt}             operational {c |}{res}         37       34.26       82.41
{txt}operational, unspecified {c |}{res}          9        8.33       90.74
{txt}              primary_sd {c |}{res}          3        2.78       93.52
{txt}       primary_sd_unspec {c |}{res}          3        2.78       96.30
{txt}             unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 25}{c +}{hline 35}
                   Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary_sd 
           6 primary_sd_unspec 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary_sd" "primary_s{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
primary_sd_unspec was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                         
.                         rename operational__unspecified operational_unspecified 
{res}{txt}
{com}.                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational_unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(3 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_sd_unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12{col 23}a_broad13

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                    {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 27}{c +}{hline 35}
                 com_combo {c |}{res}         39       36.11       36.11
{txt}                 mix_mixed {c |}{res}         13       12.04       48.15
{txt}            ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}        ope_mass education {c |}{res}          1        0.93       52.78
{txt}           ope_supervision {c |}{res}          1        0.93       53.70
{txt}              ope_training {c |}{res}          8        7.41       61.11
{txt}        ope_transportation {c |}{res}          4        3.70       64.81
{txt}           ope_unspecified {c |}{res}         19       17.59       82.41
{txt}opeunspecified_unspecified {c |}{res}          9        8.33       90.74
{txt}        prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}         prisd_unspecified {c |}{res}          5        4.63       96.30
{txt}           uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 27}{c +}{hline 35}
                     Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_supervision 
           6 ope_training 
           7 ope_transportation 
           8 ope_unspecified 
           9 opeunspecified_unspecified 
          10 prisd_lab_services 
          11 prisd_unspecified 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_supervision" {txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd_unspec" if a_broad=="primary service delivery, unspecified"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                 {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 25}{c +}{hline 35}
                   combo {c |}{res}         39       36.11       36.11
{txt}                   mixed {c |}{res}         13       12.04       48.15
{txt}             operational {c |}{res}         37       34.26       82.41
{txt}operational, unspecified {c |}{res}          9        8.33       90.74
{txt}              primary_sd {c |}{res}          3        2.78       93.52
{txt}       primary_sd_unspec {c |}{res}          3        2.78       96.30
{txt}             unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 25}{c +}{hline 35}
                   Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary_sd 
           6 primary_sd_unspec 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary_sd" "primary_s{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="primary service delivery, unspecified"                     
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
operational__unspecified was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
primary_sd_unspec was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                         
.                         rename operational__unspecified operational_unspecified 
{res}{txt}
{com}.                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(71 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(37 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}operational_unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(3 real changes made)
(0 real changes made)
{res}{txt}(105 real changes made)
variable {bf}primary_sd_unspec{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(3 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12{col 23}a_broad13

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                    {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 27}{c +}{hline 35}
                 com_combo {c |}{res}         39       36.11       36.11
{txt}                 mix_mixed {c |}{res}         13       12.04       48.15
{txt}            ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}        ope_mass education {c |}{res}          1        0.93       52.78
{txt}           ope_supervision {c |}{res}          1        0.93       53.70
{txt}              ope_training {c |}{res}          8        7.41       61.11
{txt}        ope_transportation {c |}{res}          4        3.70       64.81
{txt}           ope_unspecified {c |}{res}         19       17.59       82.41
{txt}opeunspecified_unspecified {c |}{res}          9        8.33       90.74
{txt}        prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}         prisd_unspecified {c |}{res}          5        4.63       96.30
{txt}           uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 27}{c +}{hline 35}
                     Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_supervision 
           6 ope_training 
           7 ope_transportation 
           8 ope_unspecified 
           9 opeunspecified_unspecified 
          10 prisd_lab_services 
          11 prisd_unspecified 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_supervision" {txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(89 real changes made, 89 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(71 missing values generated)
(99 missing values generated)
(105 missing values generated)
(105 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-primary_sd
{txt}
{com}.                                         rename unique* *
{res}{err}2 variables already exist
{p 4 4 2}
For instance, you
requested that variable {bf:uniqueprimary_sd_unspec}
be renamed {bf:primary_sd_unspec}.
{bf:primary_sd_unspec} is already
an existing variable in the data.
The variables you specified that already
exist are
{bf:primary_sd_unspec}{err} and
{bf:unspecified}{err}.
{p_end}
{txt}{search r(110), local:r(110);}

end of do-file

{search r(110), local:r(110);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                combo {c |}{res}         39       36.11       36.11
{txt}                                mixed {c |}{res}         13       12.04       48.15
{txt}                          operational {c |}{res}         37       34.26       82.41
{txt}             operational, unspecified {c |}{res}          9        8.33       90.74
{txt}primary service delivery, unspecified {c |}{res}          3        2.78       93.52
{txt}                           primary_sd {c |}{res}          3        2.78       96.30
{txt}                          unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary service delivery, unspecified 
           6 primary_sd 
           7 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}7
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}7

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary service delive{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}7
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}. 
{txt}end of do-file

{com}. br

. tab ar_broad

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00

{com}. tab a_broad

                              {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 38}{c +}{hline 35}
                                Mixed {c |}{res}          9        8.33        8.33
{txt}                          Operational {c |}{res}         37       34.26       42.59
{txt}             Operational, unspecified {c |}{res}          9        8.33       50.93
{txt}             Primary service delivery {c |}{res}          3        2.78       53.70
{txt}Primary service delivery, unspecified {c |}{res}          3        2.78       56.48
{txt}                          Unspecified {c |}{res}          4        3.70       60.19
{txt}                                combo {c |}{res}         39       36.11       96.30
{txt}                                mixed {c |}{res}          4        3.70      100.00
{txt}{hline 38}{c +}{hline 35}
                                Total {c |}{res}        108      100.00

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="Operational, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

                 {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 25}{c +}{hline 35}
                   combo {c |}{res}         39       36.11       36.11
{txt}                   mixed {c |}{res}         13       12.04       48.15
{txt}             operational {c |}{res}         37       34.26       82.41
{txt}operational, unspecified {c |}{res}          9        8.33       90.74
{txt}              primary_sd {c |}{res}          6        5.56       96.30
{txt}             unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 25}{c +}{hline 35}
                   Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 operational, unspecified 
           5 primary_sd 
           6 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}6
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}6

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "operational, unspecified" "primary_sd" "unspecifi{txt}.."
             r(values) : "{res}1 2 3 4 5 6{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}6
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         /*
>                         * And binaries for facility_type
>                         tab fac_type, gen(v_)
>                                 rename v_1 ft_hospitals
>                                 rename v_2 ft_unspecified_hc
>                         
>                                         // note not appropriate for other intervention types
>                                 
>                         * And binaries for faclity_category
>                         tab facility_cat, gen(v_)
>                                 rename v_1 tertiary_hospital
>                                 rename v_2 unspecified_healthfac
>                                 
>                                 ** Try adding both to the models to see how it might differ.
>         
>         * Do I need to destring or recode: id_details; id_phase; 
>         
>         
>         * Save progress
>         save temp_dta/study_attributes.dta,replace      
>         
> 
> *************************************************************************
> * Part II
> * Above, everything from cost_data sheet is encoded and ready for merging
> * Below, we create two separate datasets for analysis
> *               1. Long DS with each row = cost input, combined with study level data
> *               2. Wide DS with each row as a study, collapsed and combined with study level data
> *************************************************************************
> 
> 
>         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
>         *************************************************************************
>         
>         clear
>         use temp_dta/costs.dta
>                 drop ar_capital-a_prisd_unspecified
>         merge m:1 id using temp_dta/study_attributes.dta
>                 order extractor_initials-consistency_rmk
>                 order id
>                                 drop if _merge!=3
>                                 drop _merge
>         
>                                 save final_dtas/long_file.dta, replace
>                                 *This dataset may require some additional cleaning and culling for appropriate use
>                                 
>         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
>         **********************************************************************************
>         clear
>         use temp_dta/costs.dta
> 
>         
>         * First set up the desired order of the collapsed cost variable with markers
>                         *Broad as reported costs
>                                 gen broad_asreported=.
>                                 move broad_asreported ar_capital
>                         *Narrow as reported costs
>                                 gen narrow_asreported=.
>                                 move narrow_asreported ar_cap_admin_equip
>                         
>                         *Broad Standardized Input costs
>                                 gen broad_stdinput=.
>                                 move broad_stdinput si_capital
>                         * Narrow Standardized Input costs
>                                 gen narrow_stdinput=.
>                                 move narrow_stdinput si_cap_equip_non_medical_inter
>                         
>                                 
>                         *Broad Activity Costs
>                                 gen broad_activity=.
>                                 move broad_activity a_combo
>                 
>                         * Narrow Activity costs
>                                 gen narrow_activity=.
>                                 move narrow_activity a_com_combo
>                         
>         
>                         save temp_dta/costs.dta, replace
> 
> 
> 
>                 * Collapse for reshape wide 
>                 * (here, in two parts,  1) collapse cost variables, and 
>                 *                                               2) remove non-total rows for all categorical variables).
>                 ************************************************************************************
> 
>                         *1. Collapse cost variables into new dataset
>                         *Need to collapse one var at a time and append to a new dataset
>                                 collapse broad_asreported, by (unit_cost)
>                                 save temp_dta/costs_temp.dta,replace
>                                         clear
>                                         use temp_dta/costs.dta
>                                 *set trace on
>                                 foreach i of varlist ar_capital-a_prisd_unspecified {c -(}
>                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
>                                                 collapse (sum) `i' (min) miss, by (unit_cost)
>                                                 replace `i'=. if miss==1
>                                                         drop miss
>                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
>                                                         drop _merge
>                                                         save temp_dta/costs_temp.dta,replace
>                                                                 clear
>                                                 use temp_dta/costs.dta
>                                                 {c )-}
>                                                 *
>                         *2. Now collapse all of the categorical variables just by total
>                                 drop ar_capital-a_prisd_unspecified
>                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
>                                         save temp_dta/c_categoricals.dta,replace
>                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
>                                                         drop if _merge!=3
>                                                                         * In this case, drops 6 that we dont want anyway
>                                                         drop _merge
>                                                         
>                                 * reorder for ease of finding 
>                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
>                                 order id unit_cost broad_asreported ar_broad ar_capital ar_overhead ar_personnel ar_recurring_services ar_total ar_narrow narrow_asreported ar_cap_admin_equip ar_cap_medical_equipment ar_cap_technology_development ar_ove_unspecified ar_per_admin_support ar_per_clinical_officer ar_per_counselors ar_recserv_equip_maint ar_recserv_tech_maint ar_tot_full_costing_total broad_stdinput si_broad si_capital si_combined si_personnel si_recurrent narrow_stdinput si_narrow si_cap_equip_non_medical_inter si_cap_medical_equip si_com_unit_cost_total si_per_service_delivery si_per_support si_rec_med_int_supplies si_rec_other broad_activity a_combo a_operational a_primary_sd narrow_activity a_narrow a_ope_bldg_equip a_ope_program_mgmt a_ope_supervision a_ope_technology_development a_ope_technology_maintenance a_ope_unspecified a_prisd_rc_counseling a_prisd_unspecified output_pmonth output_pyear output_pyear2 output_pmonth2 output1k_mo output1k_yr output1k_yr2 output1k_mo2       
>                                                         
>                                 * First label organizational variables after resort
>                                 label variable broad_asreported "----------------------------------"
>                                 label variable narrow_asreported "----------------------------------"
>                                 label variable broad_stdinput "----------------------------------"      
>                                 label variable narrow_stdinput "----------------------------------"
>                                 label variable broad_activity "----------------------------------"
>                                 label variable narrow_activity "----------------------------------"
>                         
>                                 * Generate a Unit Cost Total "uc_total"
>                                 move mean_cost ar_broad
>                                 
>                                 * Finally merge in study_attribute dataset
>                                 merge m:1 id using temp_dta/study_attributes.dta
>                                         drop if _merge!=3
>                                                 * In this case it drops the 6 sub-studies that we dont want
>                                                 drop _merge
>                         
>                         
>                         *Final cleaning and creation of organizational variables
>                         *********************************************************
>                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
>                         
>                         gen COVARIATES=.
>                         move COVARIATES output_pmonth
>                         label variable COVARIATES "----------------------------------"
>                         
>                         gen output_vars=.
>                         move output_vars output_pmonth
>                         label variable output_vars "----------------------------------"
>                         
>                         * Save version before importing GDPPC data:
>                         save final_dtas/wide_file.dta, replace
>                         
>                         * Finally, import GDPPC data for each study.
>                         ********************************************
>                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
>                                 * Simply download EXCEL file option for ALL countries (should be default). 
>                                 * Download for this presentation was done on 25 October 2017
>                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
>                                 * place file in path along with data extraction template
>                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
>                                 * ...so check that import and file manipulation commands below work. 
>                         
>                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/Retention_and_adherence/wide_files/Retention_wide_file_Mar2018.dta", replace
> 
>                         clear
>                         
>                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. tab fac_type

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{err}variable {bf}v_1{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}. 
{txt}end of do-file

{com}. br facility_cat

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
{txt}end of do-file

{com}. br

. br ar*

. br a_*

. br si_*

. br a_*

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}.                 drop ar_capital-a_uns_unspecified
{txt}
{com}.         merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               1
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 order extractor_initials-consistency_rmk
{txt}
{com}.                 order id
{txt}
{com}.                                 drop if _merge!=3
{txt}(1 observation deleted)

{com}.                                 drop _merge
{txt}
{com}.         
.                                 save final_dtas/long_file.dta, replace
{txt}(note: file final_dtas/long_file.dta not found)
file final_dtas/long_file.dta saved

{com}.                                 *This dataset may require some additional cleaning and culling for appropriate use
.                                 
.         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
.         **********************************************************************************
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
.         
.         * First set up the desired order of the collapsed cost variable with markers
.                         *Broad as reported costs
.                                 gen broad_asreported=.
{txt}(108 missing values generated)

{com}.                                 move broad_asreported ar_capital
{txt}
{com}.                         *Narrow as reported costs
.                                 gen narrow_asreported=.
{txt}(108 missing values generated)

{com}.                                 move narrow_asreported ar_cap_building
{txt}
{com}.                         
.                         *Broad Standardized Input costs
.                                 gen broad_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move broad_stdinput si_capital
{txt}
{com}.                         * Narrow Standardized Input costs
.                                 gen narrow_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move narrow_stdinput si_cap_building_space
{txt}
{com}.                         
.                                 
.                         *Broad Activity Costs
.                                 gen broad_activity=.
{txt}(108 missing values generated)

{com}.                                 move broad_activity a_combo
{txt}
{com}.                 
.                         * Narrow Activity costs
.                                 gen narrow_activity=.
{txt}(108 missing values generated)

{com}.                                 move narrow_activity a_com_combo
{txt}
{com}.                         
.         
.                         save temp_dta/costs.dta, replace
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. 
.                 * Collapse for reshape wide 
.                 * (here, in two parts,  1) collapse cost variables, and 
.                 *                                               2) remove non-total rows for all categorical variables).
.                 ************************************************************************************
. 
.                         *1. Collapse cost variables into new dataset
.                         *Need to collapse one var at a time and append to a new dataset
.                                 collapse broad_asreported, by (unit_cost)
{txt}
{com}.                                 save temp_dta/costs_temp.dta,replace
{txt}file temp_dta/costs_temp.dta saved

{com}.                                         clear
{txt}
{com}.                                         use temp_dta/costs.dta
{txt}
{com}.                                 *set trace on
.                                 foreach i of varlist ar_capital-a_uns_unspecified {c -(}
{txt}  2{com}.                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
{txt}  3{com}.                                                 collapse (sum) `i' (min) miss, by (unit_cost)
{txt}  4{com}.                                                 replace `i'=. if miss==1
{txt}  5{com}.                                                         drop miss
{txt}  6{com}.                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
{txt}  7{com}.                                                         drop _merge
{txt}  8{com}.                                                         save temp_dta/costs_temp.dta,replace
{txt}  9{com}.                                                                 clear
{txt} 10{com}.                                                 use temp_dta/costs.dta
{txt} 11{com}.                                                 {c )-}
{txt}(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(29 real changes made, 29 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(30 real changes made, 30 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved

{com}.                                                 *
.                         *2. Now collapse all of the categorical variables just by total
.                                 drop ar_capital-a_uns_unspecified
{txt}
{com}.                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
{txt}(69 observations deleted)

{com}.                                         save temp_dta/c_categoricals.dta,replace
{txt}file temp_dta/c_categoricals.dta saved

{com}.                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              12
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              12{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                                         drop if _merge!=3
{txt}(12 observations deleted)

{com}.                                                                         * In this case, drops 6 that we dont want anyway
.                                                         drop _merge
{txt}
{com}.                                                         
.                                 * reorder for ease of finding 
.                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
.                                 order id unit_cost broad_asreported ar_broad ar_capital ar_facility ar_overhead ar_personnel ar_recurring_goods ar_recurring_services ar_subtotal ar_total ar_vehicles /// 
>                                 ar_narrow narrow_asreported ar_cap_building ar_cap_unspecified ar_cap_vehicles ar_fac_maint_and_util ar_fac_maintenance ar_fac_rental ar_ove_unspecified ar_per_unspecified ar_recgoods_clinical_consumables ar_recgoods_consumables ar_recgoods_key_drugs ar_recgoods_unspecified ar_recservices_lab_test ar_recservices_maintenance ar_recservices_training ar_recservices_transport ar_sub_subtotal ar_tot_full_costing_total ar_veh_maint_and_util /// 
>                                 broad_stdinput si_broad si_capital si_combined si_mixed si_personnel si_recurrent ///
>                                 narrow_stdinput si_narrow si_cap_building_space si_cap_equip_non_medical_inter si_cap_medical_equip si_cap_other si_cap_vehicles si_com_unit_cost_total si_mix_mixed si_per_mixed_unspec si_per_support si_rec_building_space si_rec_key_drugs si_rec_med_int_supplies si_rec_nonmed_int_supplies si_rec_other ///
>                                 broad_activity a_combo a_mixed a_operational a_primary_sd a_unspecified ///
>                                 narrow_activity a_narrow a_com_combo a_mix_mixed a_ope_bldg_equip a_ope_mass_education a_ope_primary_sd_unspec a_ope_supervision a_ope_training a_ope_transportation a_ope_unspecified a_prisd_lab_services a_prisd_primary_sd_unspec a_uns_unspecified
{txt}
{com}.                                 
.                                 
.                                 * First label organizational variables after resort
.                                 label variable broad_asreported "----------------------------------"
{txt}
{com}.                                 label variable narrow_asreported "----------------------------------"
{txt}
{com}.                                 label variable broad_stdinput "----------------------------------"      
{txt}
{com}.                                 label variable narrow_stdinput "----------------------------------"
{txt}
{com}.                                 label variable broad_activity "----------------------------------"
{txt}
{com}.                                 label variable narrow_activity "----------------------------------"
{txt}
{com}.                         
.                                 * Generate a Unit Cost Total "uc_total"
.                                 move mean_cost ar_broad
{txt}
{com}.                                 
.                                 * Finally merge in study_attribute dataset
.                                 merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              13
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              13{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                         drop if _merge!=3
{txt}(13 observations deleted)

{com}.                                                 * In this case it drops the 6 sub-studies that we dont want
.                                                 drop _merge
{txt}
{com}.                         
.                         
.                         *Final cleaning and creation of organizational variables
.                         *********************************************************
.                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
{txt}
{com}.                         
.                         gen COVARIATES=.
{txt}(39 missing values generated)

{com}.                         move COVARIATES output_pmonth
{err}variable {bf}output_pmonth{sf} not found
{txt}{search r(111), local:r(111);}

end of do-file

{search r(111), local:r(111);}

{com}. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}.                 drop ar_capital-a_uns_unspecified
{txt}
{com}.         merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               1
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 order extractor_initials-consistency_rmk
{txt}
{com}.                 order id
{txt}
{com}.                                 drop if _merge!=3
{txt}(1 observation deleted)

{com}.                                 drop _merge
{txt}
{com}.         
.                                 save final_dtas/long_file.dta, replace
{txt}file final_dtas/long_file.dta saved

{com}.                                 *This dataset may require some additional cleaning and culling for appropriate use
.                                 
.         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
.         **********************************************************************************
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
.         
.         * First set up the desired order of the collapsed cost variable with markers
.                         *Broad as reported costs
.                                 gen broad_asreported=.
{txt}(108 missing values generated)

{com}.                                 move broad_asreported ar_capital
{txt}
{com}.                         *Narrow as reported costs
.                                 gen narrow_asreported=.
{txt}(108 missing values generated)

{com}.                                 move narrow_asreported ar_cap_building
{txt}
{com}.                         
.                         *Broad Standardized Input costs
.                                 gen broad_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move broad_stdinput si_capital
{txt}
{com}.                         * Narrow Standardized Input costs
.                                 gen narrow_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move narrow_stdinput si_cap_building_space
{txt}
{com}.                         
.                                 
.                         *Broad Activity Costs
.                                 gen broad_activity=.
{txt}(108 missing values generated)

{com}.                                 move broad_activity a_combo
{txt}
{com}.                 
.                         * Narrow Activity costs
.                                 gen narrow_activity=.
{txt}(108 missing values generated)

{com}.                                 move narrow_activity a_com_combo
{txt}
{com}.                         
.         
.                         save temp_dta/costs.dta, replace
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. 
.                 * Collapse for reshape wide 
.                 * (here, in two parts,  1) collapse cost variables, and 
.                 *                                               2) remove non-total rows for all categorical variables).
.                 ************************************************************************************
. 
.                         *1. Collapse cost variables into new dataset
.                         *Need to collapse one var at a time and append to a new dataset
.                                 collapse broad_asreported, by (unit_cost)
{txt}
{com}.                                 save temp_dta/costs_temp.dta,replace
{txt}file temp_dta/costs_temp.dta saved

{com}.                                         clear
{txt}
{com}.                                         use temp_dta/costs.dta
{txt}
{com}.                                 *set trace on
.                                 foreach i of varlist ar_capital-a_uns_unspecified {c -(}
{txt}  2{com}.                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
{txt}  3{com}.                                                 collapse (sum) `i' (min) miss, by (unit_cost)
{txt}  4{com}.                                                 replace `i'=. if miss==1
{txt}  5{com}.                                                         drop miss
{txt}  6{com}.                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
{txt}  7{com}.                                                         drop _merge
{txt}  8{com}.                                                         save temp_dta/costs_temp.dta,replace
{txt}  9{com}.                                                                 clear
{txt} 10{com}.                                                 use temp_dta/costs.dta
{txt} 11{com}.                                                 {c )-}
{txt}(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(29 real changes made, 29 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(30 real changes made, 30 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved

{com}.                                                 *
.                         *2. Now collapse all of the categorical variables just by total
.                                 drop ar_capital-a_uns_unspecified
{txt}
{com}.                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
{txt}(69 observations deleted)

{com}.                                         save temp_dta/c_categoricals.dta,replace
{txt}file temp_dta/c_categoricals.dta saved

{com}.                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              12
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              12{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                                         drop if _merge!=3
{txt}(12 observations deleted)

{com}.                                                                         * In this case, drops 6 that we dont want anyway
.                                                         drop _merge
{txt}
{com}.                                                         
.                                 * reorder for ease of finding 
.                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
.                                 order id unit_cost broad_asreported ar_broad ar_capital ar_facility ar_overhead ar_personnel ar_recurring_goods ar_recurring_services ar_subtotal ar_total ar_vehicles /// 
>                                 ar_narrow narrow_asreported ar_cap_building ar_cap_unspecified ar_cap_vehicles ar_fac_maint_and_util ar_fac_maintenance ar_fac_rental ar_ove_unspecified ar_per_unspecified ar_recgoods_clinical_consumables ar_recgoods_consumables ar_recgoods_key_drugs ar_recgoods_unspecified ar_recservices_lab_test ar_recservices_maintenance ar_recservices_training ar_recservices_transport ar_sub_subtotal ar_tot_full_costing_total ar_veh_maint_and_util /// 
>                                 broad_stdinput si_broad si_capital si_combined si_mixed si_personnel si_recurrent ///
>                                 narrow_stdinput si_narrow si_cap_building_space si_cap_equip_non_medical_inter si_cap_medical_equip si_cap_other si_cap_vehicles si_com_unit_cost_total si_mix_mixed si_per_mixed_unspec si_per_support si_rec_building_space si_rec_key_drugs si_rec_med_int_supplies si_rec_nonmed_int_supplies si_rec_other ///
>                                 broad_activity a_combo a_mixed a_operational a_primary_sd a_unspecified ///
>                                 narrow_activity a_narrow a_com_combo a_mix_mixed a_ope_bldg_equip a_ope_mass_education a_ope_primary_sd_unspec a_ope_supervision a_ope_training a_ope_transportation a_ope_unspecified a_prisd_lab_services a_prisd_primary_sd_unspec a_uns_unspecified
{txt}
{com}.                                 
.                                 
.                                 * First label organizational variables after resort
.                                 label variable broad_asreported "----------------------------------"
{txt}
{com}.                                 label variable narrow_asreported "----------------------------------"
{txt}
{com}.                                 label variable broad_stdinput "----------------------------------"      
{txt}
{com}.                                 label variable narrow_stdinput "----------------------------------"
{txt}
{com}.                                 label variable broad_activity "----------------------------------"
{txt}
{com}.                                 label variable narrow_activity "----------------------------------"
{txt}
{com}.                         
.                                 * Generate a Unit Cost Total "uc_total"
.                                 move mean_cost ar_broad
{txt}
{com}.                                 
.                                 * Finally merge in study_attribute dataset
.                                 merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              13
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              13{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                         drop if _merge!=3
{txt}(13 observations deleted)

{com}.                                                 * In this case it drops the 6 sub-studies that we dont want
.                                                 drop _merge
{txt}
{com}.                         
.                         
.                         *Final cleaning and creation of organizational variables
.                         *********************************************************
.                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
{txt}
{com}.         
.                         
.                         * Save version before importing GDPPC data:
.                         save final_dtas/wide_file.dta, replace
{txt}(note: file final_dtas/wide_file.dta not found)
file final_dtas/wide_file.dta saved

{com}.                         
.                         * Finally, import GDPPC data for each study.
.                         ********************************************
.                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
.                                 * Simply download EXCEL file option for ALL countries (should be default). 
.                                 * Download for this presentation was done on 25 October 2017
.                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
.                                 * place file in path along with data extraction template
.                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
.                                 * ...so check that import and file manipulation commands below work. 
.                         
.                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta", replace
{txt}(note: file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta not found)
file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta saved

{com}. 
.                         clear
{txt}
{com}.                         
.                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}.                 drop ar_capital-a_uns_unspecified
{txt}
{com}.         merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               1
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 order extractor_initials-consistency_rmk
{txt}
{com}.                 order id
{txt}
{com}.                                 drop if _merge!=3
{txt}(1 observation deleted)

{com}.                                 drop _merge
{txt}
{com}.         
.                                 save final_dtas/long_file.dta, replace
{txt}file final_dtas/long_file.dta saved

{com}.                                 *This dataset may require some additional cleaning and culling for appropriate use
.                                 
.         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
.         **********************************************************************************
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
.         
.         * First set up the desired order of the collapsed cost variable with markers
.                         *Broad as reported costs
.                                 gen broad_asreported=.
{txt}(108 missing values generated)

{com}.                                 move broad_asreported ar_capital
{txt}
{com}.                         *Narrow as reported costs
.                                 gen narrow_asreported=.
{txt}(108 missing values generated)

{com}.                                 move narrow_asreported ar_cap_building
{txt}
{com}.                         
.                         *Broad Standardized Input costs
.                                 gen broad_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move broad_stdinput si_capital
{txt}
{com}.                         * Narrow Standardized Input costs
.                                 gen narrow_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move narrow_stdinput si_cap_building_space
{txt}
{com}.                         
.                                 
.                         *Broad Activity Costs
.                                 gen broad_activity=.
{txt}(108 missing values generated)

{com}.                                 move broad_activity a_combo
{txt}
{com}.                 
.                         * Narrow Activity costs
.                                 gen narrow_activity=.
{txt}(108 missing values generated)

{com}.                                 move narrow_activity a_com_combo
{txt}
{com}.                         
.         
.                         save temp_dta/costs.dta, replace
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. 
.                 * Collapse for reshape wide 
.                 * (here, in two parts,  1) collapse cost variables, and 
.                 *                                               2) remove non-total rows for all categorical variables).
.                 ************************************************************************************
. 
.                         *1. Collapse cost variables into new dataset
.                         *Need to collapse one var at a time and append to a new dataset
.                                 collapse broad_asreported, by (unit_cost)
{txt}
{com}.                                 save temp_dta/costs_temp.dta,replace
{txt}file temp_dta/costs_temp.dta saved

{com}.                                         clear
{txt}
{com}.                                         use temp_dta/costs.dta
{txt}
{com}.                                 *set trace on
.                                 foreach i of varlist ar_capital-a_uns_unspecified {c -(}
{txt}  2{com}.                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
{txt}  3{com}.                                                 collapse (sum) `i' (min) miss, by (unit_cost)
{txt}  4{com}.                                                 replace `i'=. if miss==1
{txt}  5{com}.                                                         drop miss
{txt}  6{com}.                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
{txt}  7{com}.                                                         drop _merge
{txt}  8{com}.                                                         save temp_dta/costs_temp.dta,replace
{txt}  9{com}.                                                                 clear
{txt} 10{com}.                                                 use temp_dta/costs.dta
{txt} 11{com}.                                                 {c )-}
{txt}(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(29 real changes made, 29 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(30 real changes made, 30 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved

{com}.                                                 *
.                         *2. Now collapse all of the categorical variables just by total
.                                 drop ar_capital-a_uns_unspecified
{txt}
{com}.                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
{txt}(69 observations deleted)

{com}.                                         save temp_dta/c_categoricals.dta,replace
{txt}file temp_dta/c_categoricals.dta saved

{com}.                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              12
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              12{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                                         drop if _merge!=3
{txt}(12 observations deleted)

{com}.                                                                         * In this case, drops 6 that we dont want anyway
.                                                         drop _merge
{txt}
{com}.                                                         
.                                 * reorder for ease of finding 
.                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
.                                 order id unit_cost broad_asreported ar_broad ar_capital ar_facility ar_overhead ar_personnel ar_recurring_goods ar_recurring_services ar_subtotal ar_total ar_vehicles /// 
>                                 ar_narrow narrow_asreported ar_cap_building ar_cap_unspecified ar_cap_vehicles ar_fac_maint_and_util ar_fac_maintenance ar_fac_rental ar_ove_unspecified ar_per_unspecified ar_recgoods_clinical_consumables ar_recgoods_consumables ar_recgoods_key_drugs ar_recgoods_unspecified ar_recservices_lab_test ar_recservices_maintenance ar_recservices_training ar_recservices_transport ar_sub_subtotal ar_tot_full_costing_total ar_veh_maint_and_util /// 
>                                 broad_stdinput si_broad si_capital si_combined si_mixed si_personnel si_recurrent ///
>                                 narrow_stdinput si_narrow si_cap_building_space si_cap_equip_non_medical_inter si_cap_medical_equip si_cap_other si_cap_vehicles si_com_unit_cost_total si_mix_mixed si_per_mixed_unspec si_per_support si_rec_building_space si_rec_key_drugs si_rec_med_int_supplies si_rec_nonmed_int_supplies si_rec_other ///
>                                 broad_activity a_combo a_mixed a_operational a_primary_sd a_unspecified ///
>                                 narrow_activity a_narrow a_com_combo a_mix_mixed a_ope_bldg_equip a_ope_mass_education a_ope_primary_sd_unspec a_ope_supervision a_ope_training a_ope_transportation a_ope_unspecified a_prisd_lab_services a_prisd_primary_sd_unspec a_uns_unspecified
{txt}
{com}.                                 
.                                 /*
>                                 
>                                 * First label organizational variables after resort
>                                 label variable broad_asreported "----------------------------------"
>                                 label variable narrow_asreported "----------------------------------"
>                                 label variable broad_stdinput "----------------------------------"      
>                                 label variable narrow_stdinput "----------------------------------"
>                                 label variable broad_activity "----------------------------------"
>                                 label variable narrow_activity "----------------------------------"
>                         
>                                 * Generate a Unit Cost Total "uc_total"
>                                 move mean_cost ar_broad
>                                 
>                                 * Finally merge in study_attribute dataset
>                                 merge m:1 id using temp_dta/study_attributes.dta
>                                         drop if _merge!=3
>                                                 * In this case it drops the 6 sub-studies that we dont want
>                                                 drop _merge
>                         
>                         
>                         *Final cleaning and creation of organizational variables
>                         *********************************************************
>                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
>         
>                         
>                         * Save version before importing GDPPC data:
>                         save final_dtas/wide_file.dta, replace
>                         
>                         * Finally, import GDPPC data for each study.
>                         ********************************************
>                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
>                                 * Simply download EXCEL file option for ALL countries (should be default). 
>                                 * Download for this presentation was done on 25 October 2017
>                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
>                                 * place file in path along with data extraction template
>                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
>                                 * ...so check that import and file manipulation commands below work. 
>                         
>                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta", replace
> 
>                         clear
>                         
>                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. br

. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}.                 drop ar_capital-a_uns_unspecified
{txt}
{com}.         merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               1
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 order extractor_initials-consistency_rmk
{txt}
{com}.                 order id
{txt}
{com}.                                 drop if _merge!=3
{txt}(1 observation deleted)

{com}.                                 drop _merge
{txt}
{com}.         
.                                 save final_dtas/long_file.dta, replace
{txt}file final_dtas/long_file.dta saved

{com}.                                 *This dataset may require some additional cleaning and culling for appropriate use
.                                 
.         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
.         **********************************************************************************
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
.         
.         * First set up the desired order of the collapsed cost variable with markers
.                         *Broad as reported costs
.                                 gen broad_asreported=.
{txt}(108 missing values generated)

{com}.                                 move broad_asreported ar_capital
{txt}
{com}.                         *Narrow as reported costs
.                                 gen narrow_asreported=.
{txt}(108 missing values generated)

{com}.                                 move narrow_asreported ar_cap_building
{txt}
{com}.                         
.                         *Broad Standardized Input costs
.                                 gen broad_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move broad_stdinput si_capital
{txt}
{com}.                         * Narrow Standardized Input costs
.                                 gen narrow_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move narrow_stdinput si_cap_building_space
{txt}
{com}.                         
.                                 
.                         *Broad Activity Costs
.                                 gen broad_activity=.
{txt}(108 missing values generated)

{com}.                                 move broad_activity a_combo
{txt}
{com}.                 
.                         * Narrow Activity costs
.                                 gen narrow_activity=.
{txt}(108 missing values generated)

{com}.                                 move narrow_activity a_com_combo
{txt}
{com}.                         
.         
.                         save temp_dta/costs.dta, replace
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. 
.                 * Collapse for reshape wide 
.                 * (here, in two parts,  1) collapse cost variables, and 
.                 *                                               2) remove non-total rows for all categorical variables).
.                 ************************************************************************************
. 
.                         *1. Collapse cost variables into new dataset
.                         *Need to collapse one var at a time and append to a new dataset
.                                 collapse broad_asreported, by (unit_cost)
{txt}
{com}.                                 save temp_dta/costs_temp.dta,replace
{txt}file temp_dta/costs_temp.dta saved

{com}.                                         clear
{txt}
{com}.                                         use temp_dta/costs.dta
{txt}
{com}.                                 *set trace on
.                                 foreach i of varlist ar_capital-a_uns_unspecified {c -(}
{txt}  2{com}.                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
{txt}  3{com}.                                                 collapse (sum) `i' (min) miss, by (unit_cost)
{txt}  4{com}.                                                 replace `i'=. if miss==1
{txt}  5{com}.                                                         drop miss
{txt}  6{com}.                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
{txt}  7{com}.                                                         drop _merge
{txt}  8{com}.                                                         save temp_dta/costs_temp.dta,replace
{txt}  9{com}.                                                                 clear
{txt} 10{com}.                                                 use temp_dta/costs.dta
{txt} 11{com}.                                                 {c )-}
{txt}(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(29 real changes made, 29 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(30 real changes made, 30 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved

{com}.                                                 *
.                         *2. Now collapse all of the categorical variables just by total
.                                 drop ar_capital-a_uns_unspecified
{txt}
{com}.                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
{txt}(69 observations deleted)

{com}.                                         save temp_dta/c_categoricals.dta,replace
{txt}file temp_dta/c_categoricals.dta saved

{com}.                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              12
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              12{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                                         drop if _merge!=3
{txt}(12 observations deleted)

{com}.                                                                         * In this case, drops 6 that we dont want anyway
.                                                         drop _merge
{txt}
{com}.                                                         
.                                 * reorder for ease of finding 
.                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
.                                 order id unit_cost broad_asreported ar_broad ar_capital ar_facility ar_overhead ar_personnel ar_recurring_goods ar_recurring_services ar_subtotal  ar_vehicles ar_total /// 
>                                 ar_narrow narrow_asreported ar_cap_building ar_cap_unspecified ar_cap_vehicles ar_fac_maint_and_util ar_fac_maintenance ar_fac_rental ar_ove_unspecified ar_per_unspecified ar_recgoods_clinical_consumables ar_recgoods_consumables ar_recgoods_key_drugs ar_recgoods_unspecified ar_recservices_lab_test ar_recservices_maintenance ar_recservices_training ar_recservices_transport ar_veh_maint_and_util ar_sub_subtotal ar_tot_full_costing_total /// 
>                                 broad_stdinput si_broad si_capital si_combined si_mixed si_personnel si_recurrent ///
>                                 narrow_stdinput si_narrow si_cap_building_space si_cap_equip_non_medical_inter si_cap_medical_equip si_cap_other si_cap_vehicles si_com_unit_cost_total si_mix_mixed si_per_mixed_unspec si_per_support si_rec_building_space si_rec_key_drugs si_rec_med_int_supplies si_rec_nonmed_int_supplies si_rec_other ///
>                                 broad_activity a_combo a_mixed a_operational a_primary_sd a_unspecified ///
>                                 narrow_activity a_narrow a_com_combo a_mix_mixed a_ope_bldg_equip a_ope_mass_education a_ope_primary_sd_unspec a_ope_supervision a_ope_training a_ope_transportation a_ope_unspecified a_prisd_lab_services a_prisd_primary_sd_unspec a_uns_unspecified
{txt}
{com}.                                 
.                                 /*
>                                 
>                                 * First label organizational variables after resort
>                                 label variable broad_asreported "----------------------------------"
>                                 label variable narrow_asreported "----------------------------------"
>                                 label variable broad_stdinput "----------------------------------"      
>                                 label variable narrow_stdinput "----------------------------------"
>                                 label variable broad_activity "----------------------------------"
>                                 label variable narrow_activity "----------------------------------"
>                         
>                                 * Generate a Unit Cost Total "uc_total"
>                                 move mean_cost ar_broad
>                                 
>                                 * Finally merge in study_attribute dataset
>                                 merge m:1 id using temp_dta/study_attributes.dta
>                                         drop if _merge!=3
>                                                 * In this case it drops the 6 sub-studies that we dont want
>                                                 drop _merge
>                         
>                         
>                         *Final cleaning and creation of organizational variables
>                         *********************************************************
>                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
>         
>                         
>                         * Save version before importing GDPPC data:
>                         save final_dtas/wide_file.dta, replace
>                         
>                         * Finally, import GDPPC data for each study.
>                         ********************************************
>                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
>                                 * Simply download EXCEL file option for ALL countries (should be default). 
>                                 * Download for this presentation was done on 25 October 2017
>                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
>                                 * place file in path along with data extraction template
>                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
>                                 * ...so check that import and file manipulation commands below work. 
>                         
>                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta", replace
> 
>                         clear
>                         
>                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}.                 drop ar_capital-a_uns_unspecified
{txt}
{com}.         merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               1
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 order extractor_initials-consistency_rmk
{txt}
{com}.                 order id
{txt}
{com}.                                 drop if _merge!=3
{txt}(1 observation deleted)

{com}.                                 drop _merge
{txt}
{com}.         
.                                 save final_dtas/long_file.dta, replace
{txt}file final_dtas/long_file.dta saved

{com}.                                 *This dataset may require some additional cleaning and culling for appropriate use
.                                 
.         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
.         **********************************************************************************
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
.         
.         * First set up the desired order of the collapsed cost variable with markers
.                         *Broad as reported costs
.                                 gen broad_asreported=.
{txt}(108 missing values generated)

{com}.                                 move broad_asreported ar_capital
{txt}
{com}.                         *Narrow as reported costs
.                                 gen narrow_asreported=.
{txt}(108 missing values generated)

{com}.                                 move narrow_asreported ar_cap_building
{txt}
{com}.                         
.                         *Broad Standardized Input costs
.                                 gen broad_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move broad_stdinput si_capital
{txt}
{com}.                         * Narrow Standardized Input costs
.                                 gen narrow_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move narrow_stdinput si_cap_building_space
{txt}
{com}.                         
.                                 
.                         *Broad Activity Costs
.                                 gen broad_activity=.
{txt}(108 missing values generated)

{com}.                                 move broad_activity a_combo
{txt}
{com}.                 
.                         * Narrow Activity costs
.                                 gen narrow_activity=.
{txt}(108 missing values generated)

{com}.                                 move narrow_activity a_com_combo
{txt}
{com}.                         
.         
.                         save temp_dta/costs.dta, replace
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. 
.                 * Collapse for reshape wide 
.                 * (here, in two parts,  1) collapse cost variables, and 
.                 *                                               2) remove non-total rows for all categorical variables).
.                 ************************************************************************************
. 
.                         *1. Collapse cost variables into new dataset
.                         *Need to collapse one var at a time and append to a new dataset
.                                 collapse broad_asreported, by (unit_cost)
{txt}
{com}.                                 save temp_dta/costs_temp.dta,replace
{txt}file temp_dta/costs_temp.dta saved

{com}.                                         clear
{txt}
{com}.                                         use temp_dta/costs.dta
{txt}
{com}.                                 *set trace on
.                                 foreach i of varlist ar_capital-a_uns_unspecified {c -(}
{txt}  2{com}.                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
{txt}  3{com}.                                                 collapse (sum) `i' (min) miss, by (unit_cost)
{txt}  4{com}.                                                 replace `i'=. if miss==1
{txt}  5{com}.                                                         drop miss
{txt}  6{com}.                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
{txt}  7{com}.                                                         drop _merge
{txt}  8{com}.                                                         save temp_dta/costs_temp.dta,replace
{txt}  9{com}.                                                                 clear
{txt} 10{com}.                                                 use temp_dta/costs.dta
{txt} 11{com}.                                                 {c )-}
{txt}(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(29 real changes made, 29 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(30 real changes made, 30 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved

{com}.                                                 *
.                         *2. Now collapse all of the categorical variables just by total
.                                 drop ar_capital-a_uns_unspecified
{txt}
{com}.                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
{txt}(69 observations deleted)

{com}.                                         save temp_dta/c_categoricals.dta,replace
{txt}file temp_dta/c_categoricals.dta saved

{com}.                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              12
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              12{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                                         drop if _merge!=3
{txt}(12 observations deleted)

{com}.                                                                         * In this case, drops 6 that we dont want anyway
.                                                         drop _merge
{txt}
{com}.                                                         
.                                 * reorder for ease of finding 
.                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
.                                 order id unit_cost broad_asreported ar_broad ar_capital ar_facility ar_overhead ar_personnel ar_recurring_goods ar_recurring_services ar_subtotal  ar_vehicles ar_total /// 
>                                 ar_narrow narrow_asreported ar_cap_building ar_cap_unspecified ar_cap_vehicles ar_fac_maint_and_util ar_fac_maintenance ar_fac_rental ar_ove_unspecified ar_per_unspecified ar_recgoods_clinical_consumables ar_recgoods_consumables ar_recgoods_key_drugs ar_recgoods_unspecified ar_recservices_lab_test ar_recservices_maintenance ar_recservices_training ar_recservices_transport ar_veh_maint_and_util ar_sub_subtotal ar_tot_full_costing_total /// 
>                                 broad_stdinput si_broad si_capital si_combined si_mixed si_personnel si_recurrent ///
>                                 narrow_stdinput si_narrow si_cap_building_space si_cap_equip_non_medical_inter si_cap_medical_equip si_cap_other si_cap_vehicles si_com_unit_cost_total si_mix_mixed si_per_mixed_unspec si_per_support si_rec_building_space si_rec_key_drugs si_rec_med_int_supplies si_rec_nonmed_int_supplies si_rec_other ///
>                                 broad_activity a_combo a_mixed a_operational a_primary_sd a_unspecified ///
>                                 narrow_activity a_narrow a_com_combo a_mix_mixed a_ope_bldg_equip a_ope_mass_education a_ope_primary_sd_unspec a_ope_supervision a_ope_training a_ope_transportation a_ope_unspecified a_prisd_lab_services a_prisd_primary_sd_unspec a_uns_unspecified
{txt}
{com}.                                 
.                                 /*
>                                 
>                                 * First label organizational variables after resort
>                                 label variable broad_asreported "----------------------------------"
>                                 label variable narrow_asreported "----------------------------------"
>                                 label variable broad_stdinput "----------------------------------"      
>                                 label variable narrow_stdinput "----------------------------------"
>                                 label variable broad_activity "----------------------------------"
>                                 label variable narrow_activity "----------------------------------"
>                         
>                                 * Generate a Unit Cost Total "uc_total"
>                                 move mean_cost ar_broad
>                                 
>                                 * Finally merge in study_attribute dataset
>                                 merge m:1 id using temp_dta/study_attributes.dta
>                                         drop if _merge!=3
>                                                 * In this case it drops the 6 sub-studies that we dont want
>                                                 drop _merge
>                         
>                         
>                         *Final cleaning and creation of organizational variables
>                         *********************************************************
>                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
>         
>                         
>                         * Save version before importing GDPPC data:
>                         save final_dtas/wide_file.dta, replace
>                         
>                         * Finally, import GDPPC data for each study.
>                         ********************************************
>                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
>                                 * Simply download EXCEL file option for ALL countries (should be default). 
>                                 * Download for this presentation was done on 25 October 2017
>                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
>                                 * place file in path along with data extraction template
>                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
>                                 * ...so check that import and file manipulation commands below work. 
>                         
>                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta", replace
> 
>                         clear
>                         
>                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta", clear

. br mean_cost

. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. ******************************************************
. * Data Cleaning and Transformation Do File
. * Global Health Costing Consortium (GHCC)
. * 
. * Latest update date: March 26, 2018
. *
. * Lily Alexander, MPH, University of Washington
. * lilyalexander18@gmail.com
. ******************************************************
. 
. ********************************************************************************
. *Instructions for Future Users
. ********************************************************************************
. * All relevant files should be contained within the same folder named "GCHH"
. * And include the following subfolders: 
.                 * 1. The underlying data extraciton form in .xlsx format for each intervention area:
.                                 * a. VMMC studies
.                                 * b. ART studies
.                                 * c. other study types... 
.                         * Leave excel files in GHCC/ 
.                         * Naming convention is: "GHCC_Data_Extraction_[intervention]_v#_day-month-year.xlsx"
.                 * 2. Other relevant files?
.                 * 3. Path should contain the following subfolders and structures
.                                 * GHCC/temp_dta
.                                 * GHCC/logs
.                                 * GHCC/outputs
.                                 * GHCC/do_files
.                                 * GHCC/final_dta
.                                 * GHCC/external_data
.                                 * GHCC/UCSR_exports
.                 * 4. Future user should change path as well as change the name of the excel file
.                 *        (ie. excel file name "GHCC_Data_Extraction_VMMC_v54_16-June-2017") 
.                 *    in step 1 for both the "Cost data" tab/sheet, and the "Study attributes" tab/sheet                 
.                 
. * Goals are:
.                 * a. Combine 'study attributes' and 'cost data' tabs to create one "long" dataset 
.                 *                       at "mean_cost" and "input_cost" levels "/long_file.dta"
.                 * b. Create one dataset relevant for econometric analysis
.                 *                       reshaped "wide" at the "unit_cost" level (relevant for dynamic 
.                 *                       unit costing tool) "/wide_file.dta"
.                 * c. Create one dataset for Unit Cost Study Repository structured same as (b) above, 
.                 *                       but including any eliminated subcategories of data (ie. "per visit costs"
.                 *                       for ART, as opposed to the more commonly reported "costs per annum")
. ********************************************************************************
. 
. 
. 
. 
.         *** Still Need to incorporate
.         ******************************
.         * strim (to trim off extra spaces from excel for pre-encoded fields)
.         
.         
.         
. *************************************************
. * Part I: Load, select, and clean cost-level data 
. *************************************************
. 
. * 0: Change directory (adjust directory as appropriate)
. ***********************
.         clear all
{res}{txt}
{com}.         //cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/VMMC/"
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI
{txt}
{com}. * 1: Load in both data files (change title of excel file as appropriate)
. ***********************
. 
. * Costs data sheet
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Cost data") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == ""
{txt}(1,147 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear
{txt}
{com}.                 
. * Study Attributes data sheet   
.         import excel extraction_templates/GHCC_STI_Management_v2_MERGED_20-Mar-18.xlsx, firstrow sh("Study attributes") cellrange(A4) case(l)
{res}{txt}
{com}.                 
.                 drop if id == "" 
{txt}(963 observations deleted)

{com}.                 *Save for working later
.                 save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.                 clear
{txt}
{com}.                 
.                 *Will need to import and append additional cost_level datafiles here as they are created
.         
.                 
. * 2: Load any relevant packages
. *******************************
.         *ssc install labutil2
. 
. 
. * 3: Create unique unit_cost variable
. *************************************
.         *Drop this later
.                 use temp_dta/costs.dta
{txt}
{com}. 
.         *First concatinate cost level data into unit_cost level observations
.                 gen _="_"
{txt}
{com}.                 gen unit_cost1=id+_+unit_cost
{txt}
{com}.                 move unit_cost1 unit_cost
{txt}
{com}.                 drop unit_cost
{txt}
{com}.                 drop _
{txt}
{com}.                 rename unit_cost1 unit_cost
{res}{txt}
{com}.                 
.         *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. *****************************************************************************
. * Part II: Standardizing and inflating costs for analysis of apples to apples
. *****************************************************************************
. 
. * Start by inflating the prices to 2016 dollars using US CPI
. ************************************************************
.         * First merge in study-attributes data for the currency_year variable
.         merge m:1 id using temp_dta/study_attributes.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              16
{txt}{col 9}from master{col 30}{res}              15{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 drop if _merge!=3
{txt}(16 observations deleted)

{com}.                 drop extractor_initials-discount_rate_rs 
{txt}
{com}.                 drop currency_yr_rs-_merge
{txt}
{com}.                         * No need to destring numerics
. 
.                         *Include adjustments for Lori's data here: 
.                         ******************************************
.                                 
.                         
.                         * GDP Price Deflator
.                         ********************
.                                 gen gdp_current = 111.416                               
{txt}
{com}.                                 gen gdp_old=.                           
{txt}(108 missing values generated)

{com}.                                         replace gdp_old=        66.773  if currency_yr==        1990
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        68.996  if currency_yr==        1991
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        70.569  if currency_yr==        1992
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        72.248  if currency_yr==        1993
{txt}(21 real changes made)

{com}.                                         replace gdp_old=        73.785  if currency_yr==        1994
{txt}(12 real changes made)

{com}.                                         replace gdp_old=        75.324  if currency_yr==        1995
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        76.699  if currency_yr==        1996
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.012  if currency_yr==        1997
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        78.859  if currency_yr==        1998
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        80.065  if currency_yr==        1999
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        81.887  if currency_yr==        2000
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        83.754  if currency_yr==        2001
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        85.039  if currency_yr==        2002
{txt}(26 real changes made)

{com}.                                         replace gdp_old=        86.735  if currency_yr==        2003
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        89.12   if currency_yr==        2004
{txt}(18 real changes made)

{com}.                                         replace gdp_old=        91.988  if currency_yr==        2005
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        94.814  if currency_yr==        2006
{txt}(3 real changes made)

{com}.                                         replace gdp_old=        97.337  if currency_yr==        2007
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        99.246  if currency_yr==        2008
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        100             if currency_yr==        2009
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        101.221 if currency_yr==        2010
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        103.311 if currency_yr==        2011
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        105.214 if currency_yr==        2012
{txt}(8 real changes made)

{com}.                                         replace gdp_old=        106.913 if currency_yr==        2013
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        108.832 if currency_yr==        2014
{txt}(0 real changes made)

{com}.                                         replace gdp_old=        110.012 if currency_yr==        2015
{txt}(0 real changes made)

{com}.                                                                 
.                                                 replace mean_cost=mean_cost*(gdp_current/gdp_old)               
{txt}(107 real changes made)

{com}.                                                         drop gdp_current gdp_old        
{txt}
{com}.                                                 * All can easily be updated for 2017 dollars later.
.                         
.                         
.                 *Save for working later
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. 
.                 
. *
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
.         * Replace miscategorized "mixed" values for totals in si_ and a_ categories
.         foreach i of varlist si_narrow si_broad {c -(}
{txt}  2{com}.                 replace `i'="Combined" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.         {c )-}
{txt}(0 real changes made)
(39 real changes made)

{com}.         foreach i of varlist a_narrow a_broad {c -(}
{txt}  2{com}.                 replace `i'="combo" if `i'=="Mixed" & ar_broad=="Total"
{txt}  3{com}.                 replace `i'="combo" if `i'=="mixed" & ar_broad=="Total"
{txt}  4{com}. 
.         {c )-}
{txt}(39 real changes made)
(0 real changes made)
(3 real changes made)
(36 real changes made)

{com}.         * Get rid of any sub-category costs in the costing sheet (theyre screwing things up)
.                 replace mean_cost=. if ar_narrow=="Subtotal" | ar_broad=="Subtotal"
{txt}(4 real changes made, 4 to missing)

{com}.         
. *!******* THIS TO BE REMOVED AFTER BEN FIXES EVERYTHING
. *
. 
. * Eventually include GDPPC designtations here for study attributes tab 
. * (need to also find a clever way to  not sum gdppc during reshape)
. 
. 
. 
. *****************************************************   
. * Part III: Cleaning (destring, recode, gen new vars)
. *****************************************************
. 
. 
. 
. * First, encode the for "As Reported" Costs
. ******************************************
. 
.                         *Input Broad Categories
.                         ***********************
.                                 *Encode and create categorical
.                                 replace ar_broad = lower(ar_broad)
{txt}(108 real changes made)

{com}.                                 
.                                 encode ar_broad, generate(ar_broad1) label(ar_broad)
{txt}
{com}.                                 move ar_broad1 ar_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename ar_broad1 ar_broad2
{res}{txt}
{com}.                                 rename ar_broad ar_broad1
{res}{txt}
{com}.                                 rename ar_broad2 ar_broad
{res}{txt}
{com}.                                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab ar_broad, gen(v_)   

          {txt}ar_broad {c |}      Freq.     Percent        Cum.
{hline 19}{c +}{hline 35}
           capital {c |}{res}         18       16.67       16.67
{txt}          facility {c |}{res}          5        4.63       21.30
{txt}          overhead {c |}{res}          1        0.93       22.22
{txt}         personnel {c |}{res}          9        8.33       30.56
{txt}   recurring goods {c |}{res}         24       22.22       52.78
{txt}recurring services {c |}{res}          7        6.48       59.26
{txt}          subtotal {c |}{res}          4        3.70       62.96
{txt}             total {c |}{res}         39       36.11       99.07
{txt}          vehicles {c |}{res}          1        0.93      100.00
{txt}{hline 19}{c +}{hline 35}
             Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist ar_broad, rc0
{res}ar_broad:
           1 capital 
           2 facility 
           3 overhead 
           4 personnel 
           5 recurring goods 
           6 recurring services 
           7 subtotal 
           8 total 
           9 vehicles 
{txt}
{com}.                                 return list

{txt}scalars:
       r(ar_broad_min) =  {res}1
       {txt}r(ar_broad_max) =  {res}9
    {txt}r(ar_broad_nemiss) =  {res}0
         {txt}r(ar_broad_k) =  {res}9

{txt}macros:
             r(labels) : "{res}"capital" "facility" "overhead" "personnel" "recurring goods" "recurring service{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9{txt}"
            r(lblname) : "{res}ar_broad{txt}"
           r(varlabel) : "{res}ar_broad{txt}"
            r(varlist) : "{res}ar_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}9
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist ar_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow 'as reported' input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace ar_narrow = lower(ar_narrow)
{txt}(72 real changes made)

{com}.                         
.                         * First must simplify some of the var names for easier coding
.                         replace ar_narrow="admin_support" if ar_narrow=="administration/support"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="admin_equip" if ar_narrow=="administrative equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="capital, unspecified"
{txt}(14 real changes made)

{com}.                         replace ar_narrow="key_drugs" if ar_narrow=="drugs - key"
{txt}(12 real changes made)

{com}.                         replace ar_narrow="nonkey_drugs" if ar_narrow=="drugs - non-key"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="maintenance" if ar_narrow=="facility maintenance"
{txt}(4 real changes made)

{com}.                         replace ar_narrow="rental" if ar_narrow=="facility rental"
{txt}(3 real changes made)

{com}.                         replace ar_narrow="hct" if ar_narrow=="hiv counseling and testing"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="indirect" if ar_narrow=="indirect costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="inpatient" if ar_narrow=="inpatient service"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="intangible" if ar_narrow=="intangible costs"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab consumables" if ar_narrow=="laboratory consumables"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab equip" if ar_narrow=="laboratory equipment"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab personnel" if ar_narrow=="laboratory personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="lab test" if ar_narrow=="laboratory test"
{txt}(1 real change made)

{com}.                         replace ar_narrow="maint_and_util" if ar_narrow=="maintenance and utilities"
{txt}(2 real changes made)

{com}.                         replace ar_narrow="mgmt" if ar_narrow=="management"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="mconsult" if ar_narrow=="medical consultation"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="overhead, unspecified"
{txt}(1 real change made)

{com}.                         replace ar_narrow="partial costing" if ar_narrow=="partial costing total"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="personnel, unspecified"
{txt}(9 real changes made)

{com}.                         replace ar_narrow="pharmacy" if ar_narrow=="pharmacy personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring goods, unspecified"
{txt}(7 real changes made)

{com}.                         replace ar_narrow="unspecified" if ar_narrow=="recurring services, unspecified"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="service delivery" if ar_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="sterilization" if ar_narrow=="sterilization/cleaning"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="adverse_events" if ar_narrow=="treating adverse event"
{txt}(0 real changes made)

{com}.                         replace ar_narrow="transport" if ar_narrow=="transportation"
{txt}(1 real change made)

{com}.                         replace ar_narrow="nclinical_consum" if ar_narrow=="non-clinical consumables"
{txt}(0 real changes made)

{com}.                         
.                         ******************************
.                                 tostring capital-vehicles, replace
{txt}capital was {res:byte} now {res:str1}
facility was {res:byte} now {res:str1}
overhead was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurring_goods was {res:byte} now {res:str1}
recurring_services was {res:byte} now {res:str1}
subtotal was {res:byte} now {res:str1}
total was {res:byte} now {res:str1}
vehicles was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0"
{txt}  3{com}.                                         replace `i'=ar_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(90 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(18 real changes made)
(0 real changes made)
{res}{txt}(103 real changes made)
variable {bf}facility{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(5 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}overhead{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(84 real changes made)
variable {bf}recurring_goods{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str20{sf}
{txt}(24 real changes made)
(0 real changes made)
{res}{txt}(101 real changes made)
variable {bf}recurring_services{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(7 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}subtotal{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str8{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}total{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str18{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(107 real changes made)
variable {bf}vehicles{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str14{sf}
{txt}(1 real change made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode ar_narrow, gen(ar_narrow1) label(ar_narrow)
{txt}
{com}.                                         move ar_narrow1 ar_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename ar_narrow1 ar_narrow2
{res}{txt}
{com}.                                         rename ar_narrow ar_narrow1
{res}{txt}
{com}.                                         rename ar_narrow2 ar_narrow
{res}{txt}
{com}. 
.                                         
.                                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 split ar_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}ar_broad11{col 13}ar_broad12

{com}.                                 replace ar_broad11=substr(ar_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=ar_broad11+ar_broad12+_
{txt}
{com}.                                                 drop ar_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+ar_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                       {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 30}{c +}{hline 35}
                 cap_building {c |}{res}          2        1.85        1.85
{txt}              cap_unspecified {c |}{res}         14       12.96       14.81
{txt}                 cap_vehicles {c |}{res}          2        1.85       16.67
{txt}           fac_maint_and_util {c |}{res}          1        0.93       17.59
{txt}              fac_maintenance {c |}{res}          1        0.93       18.52
{txt}                   fac_rental {c |}{res}          3        2.78       21.30
{txt}              ove_unspecified {c |}{res}          1        0.93       22.22
{txt}              per_unspecified {c |}{res}          9        8.33       30.56
{txt}recgoods_clinical consumables {c |}{res}          1        0.93       31.48
{txt}         recgoods_consumables {c |}{res}          4        3.70       35.19
{txt}           recgoods_key_drugs {c |}{res}         12       11.11       46.30
{txt}         recgoods_unspecified {c |}{res}          7        6.48       52.78
{txt}         recservices_lab test {c |}{res}          1        0.93       53.70
{txt}      recservices_maintenance {c |}{res}          3        2.78       56.48
{txt}         recservices_training {c |}{res}          2        1.85       58.33
{txt}        recservices_transport {c |}{res}          1        0.93       59.26
{txt}                 sub_subtotal {c |}{res}          4        3.70       62.96
{txt}       tot_full costing total {c |}{res}         39       36.11       99.07
{txt}           veh_maint_and_util {c |}{res}          1        0.93      100.00
{txt}{hline 30}{c +}{hline 35}
                        Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building 
           2 cap_unspecified 
           3 cap_vehicles 
           4 fac_maint_and_util 
           5 fac_maintenance 
           6 fac_rental 
           7 ove_unspecified 
           8 per_unspecified 
           9 recgoods_clinical consumables 
          10 recgoods_consumables 
          11 recgoods_key_drugs 
          12 recgoods_unspecified 
          13 recservices_lab test 
          14 recservices_maintenance 
          15 recservices_training 
          16 recservices_transport 
          17 sub_subtotal 
          18 tot_full costing total 
          19 veh_maint_and_util 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}19
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}19

{txt}macros:
             r(labels) : "{res}"cap_building" "cap_unspecified" "cap_vehicles" "fac_maint_and_util" "fac_mainte{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}19
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}. *!*                                     *drop _
.                                 *clean up
.                                 foreach i of varlist cap_building-veh_maint_and_util {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(94 real changes made, 94 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(107 real changes made, 107 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(101 real changes made, 101 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(104 real changes made, 104 to missing)
(69 real changes made, 69 to missing)
(107 real changes made, 107 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-vehicles{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(90 missing values generated)
(103 missing values generated)
(107 missing values generated)
(99 missing values generated)
(84 missing values generated)
(101 missing values generated)
(104 missing values generated)
(69 missing values generated)
(107 missing values generated)

{com}.                                         drop capital-vehicles
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-vehicles {c -(}
{txt}  2{com}.                                         move `i' cap_building
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                                         
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(18 real changes made)
(5 real changes made)
(1 real change made)
(9 real changes made)
(24 real changes made)
(7 real changes made)
(4 real changes made, 4 to missing)
(39 real changes made)
(1 real change made)
variable {bf}cap_building{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(14 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}fac_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}fac_rental{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}ove_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}per_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}recgoods_clinical_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recgoods_consumables{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}recgoods_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}recgoods_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}recservices_lab_test{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}recservices_maintenance{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}recservices_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}recservices_transport{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
(4 real changes made, 4 to missing)
variable {bf}tot_full_costing_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}veh_maint_and_util{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)

{com}. 
.                         
.                         *Finally add a prefix to these new variables ar_
.                         foreach i of varlist capital-veh_maint_and_util{c -(}
{txt}  2{com}.                                 rename `i'      ar_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *
.         
.         
. * Next, Encode Procedure for Standardized Inputs
. ************************************************
. 
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}. 
. 
.                         *Input Broad Categories
.                         ***********************
.                         replace si_broad = lower(si_broad)                      
{txt}(99 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace si_broad="recurrent" if si_broad=="recurrent - other"
{txt}(41 real changes made)

{com}.                                 ***** Should do the same here for TB coding including:
.                                                 * Patient direct, medical
.                                                 * Patient direct, non medical
.                                                 * Patient indirect
.                                                 * Patient direct
.                                                 * Patient mixed
.                                                 * Patient coping strategies
.                         
.                                 *Encode and create categorical
.                                 encode si_broad, generate(si_broad1) label(si_broad)
{txt}
{com}.                                 move si_broad1 si_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename si_broad1 si_broad2
{res}{txt}
{com}.                                 rename si_broad si_broad1
{res}{txt}
{com}.                                 rename si_broad2 si_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category using value labels
.                                         *set trace on
.                                 tab si_broad, gen(v_)   

   {txt}si_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
    capital {c |}{res}         15       13.89       13.89
{txt}   combined {c |}{res}         39       36.11       50.00
{txt}      mixed {c |}{res}          4        3.70       53.70
{txt}  personnel {c |}{res}          9        8.33       62.04
{txt}  recurrent {c |}{res}         41       37.96      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist si_broad, rc0
{res}si_broad:
           1 capital 
           2 combined 
           3 mixed 
           4 personnel 
           5 recurrent 
{txt}
{com}.                                 return list

{txt}scalars:
       r(si_broad_min) =  {res}1
       {txt}r(si_broad_max) =  {res}5
    {txt}r(si_broad_nemiss) =  {res}0
         {txt}r(si_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"capital" "combined" "mixed" "personnel" "recurrent"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}si_broad{txt}"
           r(varlabel) : "{res}si_broad{txt}"
            r(varlist) : "{res}si_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist si_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.                         * Narrow input cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace si_narrow = lower(si_narrow)
{txt}(104 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace si_narrow="service_delivery" if si_narrow=="service delivery personnel"
{txt}(0 real changes made)

{com}.                         replace si_narrow="support" if si_narrow=="support personnel"
{txt}(2 real changes made)

{com}.                         replace si_narrow="mixed_unspec" if si_narrow=="personnel - mixed or unspecified"
{txt}(7 real changes made)

{com}.                         replace si_narrow="medical_equip" if si_narrow=="equipment (medical/intervention)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="nonmed_equip" if si_narrow=="equipment (non-medical/non-intervention or unspecified)"
{txt}(0 real changes made)

{com}.                         replace si_narrow="vehicles" if si_narrow=="vehicles, capital"
{txt}(2 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, capital"
{txt}(5 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other capital"
{txt}(10 real changes made)

{com}.                         replace si_narrow="building_space" if si_narrow=="building/space, recurrent"
{txt}(1 real change made)

{com}.                         replace si_narrow="med_int_supplies" if si_narrow=="supplies (medical/intervention, excl. key drugs)"
{txt}(3 real changes made)

{com}.                         replace si_narrow="key_drugs" if si_narrow=="supplies (key drugs)"
{txt}(12 real changes made)

{com}.                         replace si_narrow="nonmed_int_supplies" if si_narrow=="supplies (non-medical/non-intervention or unspecified)"
{txt}(2 real changes made)

{com}.                         replace si_narrow="other" if si_narrow=="other recurrent"
{txt}(17 real changes made)

{com}.                                         * Not making changes to the TB categories now b/c not applicable yet and we may adapt these categories first
. 
.                         tostring capital-recurrent, replace
{txt}capital was {res:byte} now {res:str1}
combined was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
personnel was {res:byte} now {res:str1}
recurrent was {res:byte} now {res:str1}

{com}. 
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=si_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(93 real changes made)
variable {bf}capital{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str51{sf}
{txt}(15 real changes made)
(0 real changes made)
{res}{txt}(69 real changes made)
variable {bf}combined{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str15{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}(99 real changes made)
variable {bf}personnel{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str12{sf}
{txt}(9 real changes made)
(0 real changes made)
{res}{txt}(67 real changes made)
variable {bf}recurrent{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str19{sf}
{txt}(41 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode si_narrow, gen(si_narrow1) label(si_narrow)
{txt}
{com}.                                         move si_narrow1 si_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename si_narrow1 si_narrow2
{res}{txt}
{com}.                                         rename si_narrow si_narrow1
{res}{txt}
{com}.                                         rename si_narrow2 si_narrow
{res}{txt}
{com}. 
.                         
.                         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 gen si_broad11=si_broad1
{txt}
{com}.                                 replace si_broad11=substr(si_broad1,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=si_broad11+_
{txt}
{com}.                                                 drop si_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+si_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                         
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
                     cap_building_space {c |}{res}          2        1.85        1.85
{txt}cap_equipment (non-medical/intervention {c |}{res}          1        0.93        2.78
{txt}                      cap_medical_equip {c |}{res}          3        2.78        5.56
{txt}                              cap_other {c |}{res}          7        6.48       12.04
{txt}                           cap_vehicles {c |}{res}          2        1.85       13.89
{txt}                    com_unit cost total {c |}{res}         39       36.11       50.00
{txt}                              mix_mixed {c |}{res}          4        3.70       53.70
{txt}                       per_mixed_unspec {c |}{res}          7        6.48       60.19
{txt}                            per_support {c |}{res}          2        1.85       62.04
{txt}                     rec_building_space {c |}{res}          4        3.70       65.74
{txt}                          rec_key_drugs {c |}{res}         12       11.11       76.85
{txt}                   rec_med_int_supplies {c |}{res}          3        2.78       79.63
{txt}                rec_nonmed_int_supplies {c |}{res}          2        1.85       81.48
{txt}                              rec_other {c |}{res}         20       18.52      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 cap_building_space 
           2 cap_equipment (non-medical/intervention or unspecified) 
           3 cap_medical_equip 
           4 cap_other 
           5 cap_vehicles 
           6 com_unit cost total 
           7 mix_mixed 
           8 per_mixed_unspec 
           9 per_support 
          10 rec_building_space 
          11 rec_key_drugs 
          12 rec_med_int_supplies 
          13 rec_nonmed_int_supplies 
          14 rec_other 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}14
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}14

{txt}macros:
             r(labels) : "{res}"cap_building_space" "cap_equipment (non-medical/intervention or unspecified)" "{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12 13 14{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}14
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                                 rename cap_equipment__non_medical_inter cap_equip_non_medical_inter 
{res}{txt}
{com}. 
.                                 *clean up
.                                 foreach i of varlist  cap_building_space-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(106 real changes made, 106 to missing)
(107 real changes made, 107 to missing)
(105 real changes made, 105 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(69 real changes made, 69 to missing)
(104 real changes made, 104 to missing)
(101 real changes made, 101 to missing)
(106 real changes made, 106 to missing)
(104 real changes made, 104 to missing)
(96 real changes made, 96 to missing)
(105 real changes made, 105 to missing)
(106 real changes made, 106 to missing)
(88 real changes made, 88 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist capital-recurrent{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(93 missing values generated)
(69 missing values generated)
(104 missing values generated)
(99 missing values generated)
(67 missing values generated)

{com}.                                         drop capital-recurrent
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist capital-recurrent {c -(}
{txt}  2{com}.                                         move `i'  cap_building_space
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(15 real changes made)
(39 real changes made)
(4 real changes made, 4 to missing)
(9 real changes made)
(41 real changes made)
variable {bf}cap_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}cap_equip_non_medical_inter{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}cap_medical_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}cap_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}cap_vehicles{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}com_unit_cost_total{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
(4 real changes made, 4 to missing)
variable {bf}per_mixed_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(7 real changes made)
variable {bf}per_support{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_building_space{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}rec_key_drugs{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(12 real changes made)
variable {bf}rec_med_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(3 real changes made)
variable {bf}rec_nonmed_int_supplies{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(2 real changes made)
variable {bf}rec_other{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(20 real changes made)

{com}.                         *
.                                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist capital-rec_other {c -(}
{txt}  2{com}.                                 rename `i'      si_`i'          
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
. 
. 
. 
. 
. * Finally, Encode Procedure for Activity Costs
. **********************************************
.         
. save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}. clear all
{res}{txt}
{com}. use temp_dta/costs.dta
{txt}
{com}.         
.         
.         
.                 *Activity Broad Categories
.                         ***********************
.                         replace a_broad = lower(a_broad)                        
{txt}(65 real changes made)

{com}.                         *First, make the broad names (that will be in use from HIV) usable
.                         replace a_broad="primary_sd" if a_broad=="primary service delivery"
{txt}(3 real changes made)

{com}.                         replace a_broad="primary_sd" if a_broad=="primary service delivery, unspecified" 
{txt}(3 real changes made)

{com}.                         replace a_broad="operational" if a_broad=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_broad="secondary_sd" if a_broad=="secondary service delivery"
{txt}(0 real changes made)

{com}.                                 ***** Would be nice if these were better conceived, but whatever.
.                         
.                                 *Encode and create categorical
.                                 encode a_broad, generate(a_broad1) label(a_broad)
{txt}
{com}.                                 move a_broad1 a_broad
{txt}
{com}.                                 *drop input_broad_cat
.                                 rename a_broad1 a_broad2
{res}{txt}
{com}.                                 rename a_broad a_broad1
{res}{txt}
{com}.                                 rename a_broad2 a_broad
{res}{txt}
{com}.                 
.                                 *Create binaries for each category
.                                 *set trace on
.                                 tab a_broad, gen(v_)    

    {txt}a_broad {c |}      Freq.     Percent        Cum.
{hline 12}{c +}{hline 35}
      combo {c |}{res}         39       36.11       36.11
{txt}      mixed {c |}{res}         13       12.04       48.15
{txt}operational {c |}{res}         46       42.59       90.74
{txt} primary_sd {c |}{res}          6        5.56       96.30
{txt}unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 12}{c +}{hline 35}
      Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist a_broad, rc0
{res}a_broad:
           1 combo 
           2 mixed 
           3 operational 
           4 primary_sd 
           5 unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
        r(a_broad_min) =  {res}1
        {txt}r(a_broad_max) =  {res}5
     {txt}r(a_broad_nemiss) =  {res}0
          {txt}r(a_broad_k) =  {res}5

{txt}macros:
             r(labels) : "{res}"combo" "mixed" "operational" "primary_sd" "unspecified"{txt}"
             r(values) : "{res}1 2 3 4 5{txt}"
            r(lblname) : "{res}a_broad{txt}"
           r(varlabel) : "{res}a_broad{txt}"
            r(varlist) : "{res}a_broad{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}5
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist a_broad, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'             
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                         *
. 
. 
.         
.                 * Narrow activity cost categories
.                         * Applying these directly to the broad categories to break out later
.                         ******************************
.                         replace a_narrow = lower(a_narrow)
{txt}(69 real changes made)

{com}.                         
.                         * Now fix variable names to get rid of symbols
.                         replace a_narrow="circumcision_proced" if a_narrow=="for vmmc: circumcision procedure"
{txt}(0 real changes made)

{com}.                         replace a_narrow="pre_post_exam" if a_narrow=="for vmmc: pre- and post-examination"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="primary_sd_unspec" if a_narrow=="primary service delivery, unspecified"                       
{txt}(24 real changes made)

{com}.                         replace a_narrow="arv_delivery" if a_narrow=="for art: arv delivery"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_monitoring" if a_narrow=="for art: routine lab monitoring"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hct" if a_narrow=="for vmmc: hct"                     
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="secondary service delivery, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="lab_services" if a_narrow=="laboratory services"
{txt}(1 real change made)

{com}.                         replace a_narrow="adherence_retention" if a_narrow=="adherence/retention"
{txt}(0 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="ancillary, unspecified"
{txt}(0 real changes made)

{com}.                         replace a_narrow="program_mgmt" if a_narrow=="programme management"
{txt}(0 real changes made)

{com}.                         replace a_narrow="hmis_recordkeeping" if a_narrow=="hmis and record-keeping"
{txt}(0 real changes made)

{com}.                         replace a_narrow="bldg_equip" if a_narrow=="building and equipment (maintenance and utlilities)"
{txt}(4 real changes made)

{com}.                         replace a_narrow="unspecified" if a_narrow=="operational, unspecified"
{txt}(9 real changes made)

{com}.                         replace a_narrow="rc_counseling" if a_narrow=="for r&c: counseling"
{txt}(0 real changes made)

{com}.                         
.                         tostring combo-unspecified, replace
{txt}combo was {res:byte} now {res:str1}
mixed was {res:byte} now {res:str1}
operational was {res:byte} now {res:str1}
primary_sd was {res:byte} now {res:str1}
unspecified was {res:byte} now {res:str1}

{com}.                                 
.                 
.                         foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         replace `i'="" if `i'=="0" | `i'=="."
{txt}  3{com}.                                         replace `i'=a_narrow if `i'=="1"
{txt}  4{com}.                                         replace `i'= lower(`i')
{txt}  5{com}.                                         encode `i', gen(`i'_1) label(`i')
{txt}  6{com}.                                         drop `i'
{txt}  7{com}.                                         rename `i'_1 `i' 
{txt}  8{com}.                                 {c )-}
{txt}(69 real changes made)
variable {bf}combo{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(39 real changes made)
(0 real changes made)
{res}{txt}(95 real changes made)
variable {bf}mixed{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str5{sf}
{txt}(13 real changes made)
(0 real changes made)
{res}{txt}(62 real changes made)
variable {bf}operational{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(46 real changes made)
(0 real changes made)
{res}{txt}(102 real changes made)
variable {bf}primary_sd{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str17{sf}
{txt}(6 real changes made)
(0 real changes made)
{res}{txt}(104 real changes made)
variable {bf}unspecified{sf} was {bf}{res}str1{sf}{txt} now {bf}{res}str11{sf}
{txt}(4 real changes made)
(0 real changes made)
{res}{txt}
{com}.                                 * Now destring and encode input_narrow_cost 
.                                         encode a_narrow, gen(a_narrow1) label(a_narrow)
{txt}
{com}.                                         move a_narrow1 a_narrow
{txt}
{com}.                                         *drop input_narrow_cat
.                                         rename a_narrow1 a_narrow2
{res}{txt}
{com}.                                         rename a_narrow a_narrow1
{res}{txt}
{com}.                                         rename a_narrow2 a_narrow
{res}{txt}
{com}. 
.                                         
.                         
.                 
.         * Now create binaries for the reshape command (need to finalize)
.                         *********************************************
.                                 *create prefix
.                                 
.                                 split a_broad1, p(" " "_" "-")
{res}variables created as string: 
{txt}{col 1}a_broad11{col 12}a_broad12

{com}.                                 replace a_broad11=substr(a_broad11,1,3)
{txt}(108 real changes made)

{com}.                                 gen _="_"
{txt}
{com}.                                 gen prefix=a_broad11+a_broad12+_
{txt}
{com}.                                                 drop a_broad11-_
{txt}
{com}.                                 *combine prefix with narrow cat var
.                                 gen narrow_cat=prefix+a_narrow1
{txt}
{com}.                                         drop prefix
{txt}
{com}.                                 *encode categorical
.                                 encode narrow_cat, gen(narrow_cat1) label(narrow_cat)
{txt}
{com}.                                         drop narrow_cat
{txt}
{com}.                                         rename narrow_cat1 narrow
{res}{txt}
{com}.                                 
.                 
.                                 
.                                 *Now generate binaries
.                                 tab narrow, gen(v_)     

                 {txt}narrow {c |}      Freq.     Percent        Cum.
{hline 24}{c +}{hline 35}
              com_combo {c |}{res}         39       36.11       36.11
{txt}              mix_mixed {c |}{res}         13       12.04       48.15
{txt}         ope_bldg_equip {c |}{res}          4        3.70       51.85
{txt}     ope_mass education {c |}{res}          1        0.93       52.78
{txt}  ope_primary_sd_unspec {c |}{res}         19       17.59       70.37
{txt}        ope_supervision {c |}{res}          1        0.93       71.30
{txt}           ope_training {c |}{res}          8        7.41       78.70
{txt}     ope_transportation {c |}{res}          4        3.70       82.41
{txt}        ope_unspecified {c |}{res}          9        8.33       90.74
{txt}     prisd_lab_services {c |}{res}          1        0.93       91.67
{txt}prisd_primary_sd_unspec {c |}{res}          5        4.63       96.30
{txt}        uns_unspecified {c |}{res}          4        3.70      100.00
{txt}{hline 24}{c +}{hline 35}
                  Total {c |}{res}        108      100.00
{txt}
{com}.                                 labellist narrow, rc0
{res}narrow_cat:
           1 com_combo 
           2 mix_mixed 
           3 ope_bldg_equip 
           4 ope_mass education 
           5 ope_primary_sd_unspec 
           6 ope_supervision 
           7 ope_training 
           8 ope_transportation 
           9 ope_unspecified 
          10 prisd_lab_services 
          11 prisd_primary_sd_unspec 
          12 uns_unspecified 
{txt}
{com}.                                 return list

{txt}scalars:
     r(narrow_cat_min) =  {res}1
     {txt}r(narrow_cat_max) =  {res}12
  {txt}r(narrow_cat_nemiss) =  {res}0
       {txt}r(narrow_cat_k) =  {res}12

{txt}macros:
             r(labels) : "{res}"com_combo" "mix_mixed" "ope_bldg_equip" "ope_mass education" "ope_primary_sd_un{txt}.."
             r(values) : "{res}1 2 3 4 5 6 7 8 9 10 11 12{txt}"
            r(lblname) : "{res}narrow_cat{txt}"
            r(varlist) : "{res}narrow{txt}"

{com}.                                 local K: word count `r(labels)'
{txt}
{com}.                                 display "`K'"
{res}12
{txt}
{com}.                                 forvalues k = 1/`K' {c -(}
{txt}  2{com}.                                         qui labellist narrow, rc0
{txt}  3{com}.                                         local name : word `k' of `r(labels)'
{txt}  4{com}.                                         local name = strtoname("`name'")
{txt}  5{com}.                                         rename v_`k' `name'
{txt}  6{com}.                                 {c )-} 
{res}{txt}
{com}.                                         drop narrow
{txt}
{com}.                                         *drop _
.                                 
.                         
.                                 
.                                 *clean up
.                                 foreach i of varlist com_combo-uns_unspecified {c -(}
{txt}  2{com}.                                         replace `i'=. if `i'==0
{txt}  3{com}.                                 {c )-}
{txt}(69 real changes made, 69 to missing)
(95 real changes made, 95 to missing)
(104 real changes made, 104 to missing)
(107 real changes made, 107 to missing)
(89 real changes made, 89 to missing)
(107 real changes made, 107 to missing)
(100 real changes made, 100 to missing)
(104 real changes made, 104 to missing)
(99 real changes made, 99 to missing)
(107 real changes made, 107 to missing)
(103 real changes made, 103 to missing)
(104 real changes made, 104 to missing)

{com}.                         
.                         
.                         *Now replace all cat and subcat binaries with values of mean_cost
.                                 foreach i of varlist combo-unspecified{c -(}
{txt}  2{com}.                                         egen unique`i'=group(`i')
{txt}  3{com}.                                         {c )-}
{txt}(69 missing values generated)
(95 missing values generated)
(62 missing values generated)
(102 missing values generated)
(104 missing values generated)

{com}.                                         drop combo-unspecified
{txt}
{com}.                                         rename unique* *
{res}{txt}
{com}.                                         
.                                         *STILL NEED TO REORDER VARS
.                                 foreach i of varlist combo-unspecified {c -(}
{txt}  2{com}.                                         move `i' com_combo
{txt}  3{com}.                                 {c )-}
{txt}
{com}.                                 
.                         * Apply all mean_costs to these variables with missing obs for all      
.                                 foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                         replace `i'=mean_cost if `i'!=.
{txt}  3{com}.                                 {c )-}
{txt}(39 real changes made)
(13 real changes made, 4 to missing)
(46 real changes made)
(6 real changes made)
(4 real changes made)
variable {bf}com_combo{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(39 real changes made)
variable {bf}mix_mixed{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(13 real changes made, 4 to missing)
variable {bf}ope_bldg_equip{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_mass_education{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(19 real changes made)
variable {bf}ope_supervision{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}ope_training{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(8 real changes made)
variable {bf}ope_transportation{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)
variable {bf}ope_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(9 real changes made)
variable {bf}prisd_lab_services{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(1 real change made)
variable {bf}prisd_primary_sd_unspec{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(5 real changes made)
variable {bf}uns_unspecified{sf} was {bf}{res}byte{sf}{txt} now {bf}{res}float{sf}
{txt}(4 real changes made)

{com}.                         
.                         *Finally add a prefix to these new variables si_
.                         foreach i of varlist combo-uns_unspecified{c -(}
{txt}  2{com}.                                 rename `i'      a_`i'           
{txt}  3{com}.                         {c )-}
{res}{txt}
{com}. *       
.         
. ** Encoding remaining variables
. *******************************
.                         
.                           
.                         
.                 * Encode categorical variables for long version
.                         foreach i of varlist cost_level disease intervention fixed_variable cost_incurred_by period output_unit_reported output_unit output_unit2 integrated_generic empirical_modeled resource_id resource_valuation price_sources full_subsidized adjustment_method data_collection recall_period output_methods data_timing inflation inflation_method amortization currency_iso currency_name {c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         encode `i', gen(`i'_1) label(`i')
{txt}  3{com}.                         move `i'_1 `i'
{txt}  4{com}.                         drop `i'
{txt}  5{com}.                         rename `i'_1 `i' 
{txt}  6{com}.                         {c )-}
{res}{txt}
{com}.                         
.                         
.                         
.                         * To add below??:
.                            *obs_fd obs_fd_rs (but these are mixed between RS and categorical and numerical
.                         
.                         
.                 * Encode reporting standards variables for long version
.                         *set trace on
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a" 4 "nr"
{txt}
{com}.                         foreach i of varlist cost_source_rs cost_allocation_method_rs resource_id_rs resource_valuation_rs price_sources_rs inputq_source_rs full_subsidized_rs adjustment_method_rs data_collection_rs recall_period_rs output_methods_rs data_timing_rs inflation_rs inflation_method_rs amortization_rs currency_rs pot_distortions_rs{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "4" if `i'== "nr"
{txt}  7{com}.                         destring `i', replace
{txt}  8{com}.                                 label values `i' rs
{txt}  9{com}.                         *consider changing label for NR to .    
.                         {c )-}
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
cost_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(68 real changes made)
(24 real changes made)
(16 real changes made)
(0 real changes made)
(68 real changes made)
cost_allocation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(3 real changes made)
(93 real changes made)
(0 real changes made)
(12 real changes made)
resource_id_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(0 real changes made)
(96 real changes made)
(0 real changes made)
(12 real changes made)
resource_valuation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(44 real changes made)
(52 real changes made)
(12 real changes made)
(32 real changes made)
(12 real changes made)
price_sources_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(12 real changes made)
(16 real changes made)
(6 real changes made)
(74 real changes made)
inputq_source_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(65 real changes made)
(34 real changes made)
(9 real changes made)
(3 real changes made)
(62 real changes made)
full_subsidized_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(105 real changes made)
(3 real changes made)
(0 real changes made)
(12 real changes made)
(93 real changes made)
adjustment_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(15 real changes made)
(28 real changes made)
(65 real changes made)
(0 real changes made)
(15 real changes made)
data_collection_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(96 real changes made)
(12 real changes made)
recall_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(96 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
output_methods_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(19 real changes made)
(77 real changes made)
(0 real changes made)
(12 real changes made)
data_timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(92 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(92 real changes made)
inflation_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(80 real changes made)
(16 real changes made)
(12 real changes made)
(0 real changes made)
(80 real changes made)
inflation_method_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(105 real changes made)
amortization_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(12 real changes made)
(84 real changes made)
(12 real changes made)
(0 real changes made)
(12 real changes made)
currency_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(99 real changes made)
(9 real changes made)
(0 real changes made)
(0 real changes made)
(99 real changes made)
pot_distortions_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}
{com}. 
.                         
.                 * Numeric variables to recode NR to missing and destring to numeric
.                         foreach i of varlist lower_ci upper_ci std_dev median_cost lower_iqr upper_iqr input_price input_quantity program_level_cost time_period_mo{c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i'="." if `i'=="nr" | `i'=="n/a"
{txt}  4{com}.                         replace `i'="." if `i'=="NR" | `i' == "N/A" 
{txt}  5{com}.                         destring `i', replace
{txt}  6{com}.                         {c )-}
{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_ci: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
std_dev: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(105 real changes made)
(105 real changes made)
(0 real changes made)
median_cost: all characters numeric; {res}replaced {txt}as {res}double
{txt}(105 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
lower_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
upper_iqr: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_price: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
input_quantity: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
program_level_cost: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}(108 real changes made)
(108 real changes made)
(0 real changes made)
time_period_mo: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(108 missing values generated)
{res}{txt}
{com}.                 *
.                 
.                 /*
>                 
> * Add some new variables for analysis later (these applicable to VMMC, probably not ART, TB, other)
> ********************************************
> 
>                                 * Single scale variable
>                                 gen output_pmonth=output_quantity/time_period_mo
>                                 tab output_pmonth
>                                 label variable output_pmonth "Site unit output per month"
> 
>                                 * Generate additional scale variable at the year level for more logic in reporting
>                                 gen output_pyear=output_pmonth*12
>                                 tab output_pyear
>                                 label variable output_pyear "Site unit output per year"
> 
>                                 * Generate quadratic terms for both scale variables
>                                 gen output_pyear2=output_pyear^2
>                                 gen output_pmonth2=output_pmonth^2
> 
> 
>                                 * Try scaling up the output variable so you can see the coeff.
>                                 **************************************************************
>                                 gen output1k_mo=output_pmonth/1000
>                                 label variable output1k_mo "Site unit output per month / 1000"
>                                 gen output1k_yr=output_pyear/1000
>                                 label variable output1k_mo "Site unit output per year / 1000"
> 
>                                 * And do the same things for the 1000k versions so its interpretable
>                                 gen output1k_yr2=output1k_yr^2
>                                 label variable output1k_yr2 "Site unit output per year^2 / 1000"
>                                 gen output1k_mo2=output1k_mo^2
>                                 label variable output1k_mo2 "Site unit output per month^2 / 1000"
> */
.                                                 
.         
.                 * Finally rename id variable for merge
.                 * rename substudyid id
.                 save temp_dta/costs.dta,replace 
{txt}file temp_dta/costs.dta saved

{com}.                 clear all
{res}{txt}
{com}. 
. 
. * Load in and clean study-level dataset
. ****************************************
. 
. 
.                 use temp_dta/study_attributes.dta
{txt}
{com}. 
. 
.                 * DROP NR for following Variables for encoding:
.                         foreach i of varlist id_tech costing_purpose_cat timing country_sampling geo_sampling_incountry site_sampling px_sampling sample_size_derived controls econ_costing omitted_costs asd_costs list_asd_costs research_costs unrelated_costs overhead_costs volunteer_time family_time currency_x ownership id_modality{c -(}
{txt}  2{com}.                                 replace `i'="" if `i'=="NR" | `i'=="nr"
{txt}  3{com}.                         {c )-}
{txt}(13 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(19 real changes made)
(16 real changes made)
(26 real changes made)
(3 real changes made)
(32 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(15 real changes made)
(23 real changes made)
(33 real changes made)
(6 real changes made)
(30 real changes made)
(0 real changes made)
(13 real changes made)
(6 real changes made)
(0 real changes made)

{com}. 
.                         * Generate a new country string variable so you can merge in other information later:
.                         gen country_alt=country
{txt}
{com}.                         
.                         foreach i of varlist extractor_initials article_dataset study_type econ_perspective_report econ_perspective_actual research_costs unrelated_costs overhead econ_costing real_world country geo_sampling_incountry country_sampling site_sampling px_sampling sample_size_derived timing exclusions personnel_dt iso_code currency_x traded volunteer_time family_time px_time aggregation subgroup scale scale_up seasonality sensitivity_analysis limitations coi ownership pop_sex id_class id_type id_int id_modality method px_costs_measured cat_cost costing_purpose_cat asd_costs pop_density int_description time_unit consistency controls pop_couples cd4_med tb_rx_resistance id_phase id_tech{c -(}
{txt}  2{com}.                         *replace `i' = lower(`i')
.                         replace `i'="." if `i'=="NR"
{txt}  3{com}.                         encode `i', gen(`i'_1) label(`i')
{txt}  4{com}.                         move `i'_1 `i'
{txt}  5{com}.                         drop `i'
{txt}  6{com}.                         rename `i'_1 `i' 
{txt}  7{com}.                         {c )-}
{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(7 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(21 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(27 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(22 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(23 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(3 real changes made)
{res}{txt}(11 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(29 real changes made)
{res}{txt}(33 real changes made)
{res}{txt}(30 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}(0 real changes made)
{res}{txt}
{com}.                         *
. 
.                         * Additional recent variables (categorical)
.                         foreach i of varlist pop_age pop_ses pop_education tb_prev cd4_range hiv_prev {c -(}
{txt}  2{com}.                                 replace `i'="." if `i'=="NR" | `i'=="N/A"
{txt}  3{com}.                         {c )-}
{txt}(28 real changes made)
(33 real changes made)
(30 real changes made)
(33 real changes made)
(33 real changes made)
(20 real changes made)

{com}.                                 destring hiv_prev, replace
{txt}hiv_prev: contains nonnumeric characters; no {res}replace
{txt}
{com}.                         
.                         * From above, there are a number that are best kept as free-text fields to be extracted as "phrases"
.                         * Then create new categorical or binary variables as appropriate. (specifically id_details, id_activities, id_tech, id_facility
. 
.                         
.                         replace coverage="" if coverage=="NR"
{txt}(33 real changes made)

{com}.                                 destring coverage, replace
{txt}coverage: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}
{com}.                         replace discount_rate="" if discount_rate=="NR" | discount_rate=="NA"
{txt}(21 real changes made)

{com}.                                 destring discount_rate, replace
{txt}discount_rate: all characters numeric; {res}replaced {txt}as {res}double
{txt}(21 missing values generated)
{res}{txt}
{com}.                         replace location="" if location=="NR"
{txt}(3 real changes made)

{com}.                         
.                 * Reporting Standards Variables for Encoding (CAN CHANGE THIS TO *_rs for ease of coding)
.                         * should try grabbing all variables that have the "RS" ending somehow, instead of managing individual vars
.                         label define rs 1 "explicit" 2 "inferred" 3 "n/a"
{txt}
{com}.                         *set trace on
.                         foreach i of varlist costing_purpose_rs period_portrayed_rs research_costs_rs unrelated_costs_rs overhead_rs omitted_costs_rs geo_incountry_rs econ_costing_rs geo_sampling_incountry_rs country_sampling_rs site_sampling_rs px_sampling_rs timing_rs discount_rate_rs currency_yr_rs currency_x_rs currency_period_rs volunteer_time_rs family_time_rs px_time_rs aggregationrs management_rs ownership_rs pop_sex_rs pop_ses_rs pop_education_rs year_intro_rs coverage_rs qual_indicator_rs breakdown_input_rs breakdown_activity_rs breakdown_funder_rs px_costs_measured_rs cat_cost_rs asd_costs_rs real_world_rs personnel_dt_rs pop_age_rs {c -(}
{txt}  2{com}.                         replace `i' = lower(`i')
{txt}  3{com}.                         replace `i' = "1" if `i'== "explicit"
{txt}  4{com}.                         replace `i' = "2" if `i'== "inferred"
{txt}  5{com}.                         replace `i' = "3" if `i'== "n/a"
{txt}  6{com}.                         replace `i' = "" if `i'== "nr"
{txt}  7{com}.                         replace `i' = "" if `i'== "none"
{txt}  8{com}.                         destring `i', replace
{txt}  9{com}.                                 label values `i' rs
{txt} 10{com}.                         {c )-}
{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
costing_purpose_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(7 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
period_portrayed_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(23 real changes made)
(10 real changes made)
(0 real changes made)
(0 real changes made)
(23 real changes made)
(0 real changes made)
research_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(23 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
unrelated_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
overhead_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(17 real changes made)
(4 real changes made)
(12 real changes made)
(0 real changes made)
(17 real changes made)
(0 real changes made)
omitted_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(17 missing values generated)
{res}{txt}(3 real changes made)
(19 real changes made)
(11 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
geo_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(17 real changes made)
(16 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
econ_costing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 real changes made)
(6 real changes made)
(8 real changes made)
(0 real changes made)
(19 real changes made)
(0 real changes made)
geo_sampling_incountry_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(19 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
country_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(16 real changes made)
(5 real changes made)
(12 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
site_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(26 real changes made)
(1 real change made)
(6 real changes made)
(0 real changes made)
(26 real changes made)
(0 real changes made)
px_sampling_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(26 missing values generated)
{res}{txt}(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
timing_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
discount_rate_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
currency_yr_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 real changes made)
(9 real changes made)
(11 real changes made)
(0 real changes made)
(13 real changes made)
(0 real changes made)
currency_x_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(13 missing values generated)
{res}{txt}(16 real changes made)
(17 real changes made)
(0 real changes made)
(0 real changes made)
(16 real changes made)
(0 real changes made)
currency_period_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(16 missing values generated)
{res}{txt}(30 real changes made)
(3 real changes made)
(0 real changes made)
(0 real changes made)
(30 real changes made)
(0 real changes made)
volunteer_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
family_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(6 real changes made)
(27 real changes made)
(0 real changes made)
px_time_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
aggregationrs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
management_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(25 real changes made)
(26 real changes made)
(1 real change made)
(0 real changes made)
(6 real changes made)
(0 real changes made)
ownership_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(6 missing values generated)
{res}{txt}(25 real changes made)
(8 real changes made)
(0 real changes made)
(0 real changes made)
(25 real changes made)
(0 real changes made)
pop_sex_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(25 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_ses_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
pop_education_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(32 real changes made)
(23 real changes made)
(0 real changes made)
(0 real changes made)
(10 real changes made)
(0 real changes made)
year_intro_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(10 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
coverage_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
qual_indicator_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(0 real changes made)
(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
breakdown_input_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 real changes made)
(6 real changes made)
(0 real changes made)
(0 real changes made)
(27 real changes made)
(0 real changes made)
breakdown_activity_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(27 missing values generated)
{res}{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
(33 real changes made)
(0 real changes made)
breakdown_funder_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 missing values generated)
{res}{txt}(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
px_costs_measured_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(33 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(30 real changes made)
(0 real changes made)
cat_cost_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(30 missing values generated)
{res}{txt}(3 real changes made)
(23 real changes made)
(7 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
asd_costs_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(0 real changes made)
(19 real changes made)
(14 real changes made)
(0 real changes made)
(0 real changes made)
(0 real changes made)
real_world_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 real changes made)
(9 real changes made)
(3 real changes made)
(0 real changes made)
(21 real changes made)
(0 real changes made)
personnel_dt_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(21 missing values generated)
{res}{txt}(28 real changes made)
(2 real changes made)
(3 real changes made)
(0 real changes made)
(28 real changes made)
(0 real changes made)
pop_age_rs: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(28 missing values generated)
{res}{txt}
{com}.                                 
.                         *consider changing label for NR to .    
. 
. * And destring remaining numeric variables:
.                         *Years
.                         foreach i of varlist start_year end_year year_intro{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na" | `i'=="no year"
{txt}  4{com}.                                 destring `i', replace
{txt}  5{com}.                                 {c )-}
{txt}(3 real changes made)
(3 real changes made)
start_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(3 real changes made)
(3 real changes made)
end_year: all characters numeric; {res}replaced {txt}as {res}int
{txt}(3 missing values generated)
{res}{txt}(10 real changes made)
(10 real changes made)
year_intro: all characters numeric; {res}replaced {txt}as {res}int
{txt}(10 missing values generated)
{res}{txt}
{com}.                         
.                         *Months
.                         foreach i of varlist start_month end_month{c -(}
{txt}  2{com}.                                 replace `i'=lower(`i')
{txt}  3{com}.                                 replace `i'="1" if `i'=="january"
{txt}  4{com}.                                 replace `i'="2" if `i'=="february"
{txt}  5{com}.                                 replace `i'="3" if `i'=="march"
{txt}  6{com}.                                 replace `i'="4" if `i'=="april"
{txt}  7{com}.                                 replace `i'="5" if `i'=="may"
{txt}  8{com}.                                 replace `i'="6" if `i'=="june"
{txt}  9{com}.                                 replace `i'="7" if `i'=="july"
{txt} 10{com}.                                 replace `i'="8" if `i'=="august"
{txt} 11{com}.                                 replace `i'="9" if `i'=="september"
{txt} 12{com}.                                 replace `i'="10" if `i'=="october"
{txt} 13{com}.                                 replace `i'="11" if `i'=="november"
{txt} 14{com}.                                 replace `i'="12" if `i'=="december"
{txt} 15{com}.                                 replace `i'="" if `i'=="n/a" | `i'=="nr" |  `i'=="na"
{txt} 16{com}.                                 destring `i', replace
{txt} 17{com}.                                 {c )-}
{txt}(33 real changes made)
(2 real changes made)
(0 real changes made)
(6 real changes made)
(1 real change made)
(4 real changes made)
(1 real change made)
(4 real changes made)
(0 real changes made)
(0 real changes made)
(12 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
start_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}(33 real changes made)
(12 real changes made)
(0 real changes made)
(1 real change made)
(1 real change made)
(1 real change made)
(0 real changes made)
(7 real changes made)
(0 real changes made)
(0 real changes made)
(3 real changes made)
(0 real changes made)
(5 real changes made)
(3 real changes made)
end_month: all characters numeric; {res}replaced {txt}as {res}byte
{txt}(3 missing values generated)
{res}{txt}
{com}.                                 
.                 
.                 * id_facility (coding structure, from codebook)
.                 
.                                 *Create meta_category
.                                 gen meta_facility=.
{txt}(33 missing values generated)

{com}.                                 replace meta_facility=1 if id_facility=="HC01" | id_facility=="HC02" | id_facility=="HC03" | id_facility=="HC04" | id_facility=="HC05" | id_facility=="HC06" | id_facility=="HC07" | id_facility=="HC08" | id_facility=="HC09" | id_facility=="HC10" | id_facility=="HC11"
{txt}(33 real changes made)

{com}.                                 replace meta_facility=2 if id_facility=="OR01" | id_facility=="OR02" | id_facility=="OR03" | id_facility=="OR04" | id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=3 if id_facility=="CB01" | id_facility=="CB02" | id_facility=="CB03" | id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=4 if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace meta_facility=5 if id_facility=="OT01" | id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 label define meta_facility 1 "Heath Care (service at fixed location)" 2 "Outreach (service in comm org/ elsewhere)" 3 "Community-based (org located in community)" 4 "Population wide" 5 "Other or not reported"
{txt}
{com}.                                 label values meta_facility meta_facility
{txt}
{com}.                                 label var meta_facility "Broad Facility Category"
{txt}
{com}.                                 
.                         *Now create numeric for better encoding 
.                         gen facility_cat=.
{txt}(33 missing values generated)

{com}.                                 replace facility_cat=   101     if id_facility=="HC01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   102     if id_facility=="HC02"
{txt}(15 real changes made)

{com}.                                 replace facility_cat=   103     if id_facility=="HC03"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   104     if id_facility=="HC04"
{txt}(3 real changes made)

{com}.                                 replace facility_cat=   105     if id_facility=="HC05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   107     if id_facility=="HC07"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   108     if id_facility=="HC08"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   109     if id_facility=="HC09"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   110     if id_facility=="HC10"
{txt}(1 real change made)

{com}.                                 replace facility_cat=   111     if id_facility=="HC11"
{txt}(13 real changes made)

{com}.                                 replace facility_cat=   201     if id_facility=="OR01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   202     if id_facility=="OR02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   203     if id_facility=="OR03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   204     if id_facility=="OR04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   205     if id_facility=="OR05"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   301     if id_facility=="CB01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   302     if id_facility=="CB02"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   303     if id_facility=="CB03"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   304     if id_facility=="CB04"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   401     if id_facility=="PW01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   501     if id_facility=="OT01"
{txt}(0 real changes made)

{com}.                                 replace facility_cat=   502     if id_facility=="OT02"
{txt}(0 real changes made)

{com}.                                 
.                                         label define facility_cat 101 "Health Post (e.g. health outpost, etc.)" 102 "Health Center (e.g. community health clinic - sometimes w/ 1-2 beds)" 103 "Clinic at hospital (not intervention- or disease-specific)" 104 "Clinic at hospital (intervention- or disease-specific)" 105 "Hospital - Primary (district)" 107 "Hospital - Secondary (regional, specialist)" 108 "Hospital - Tertiary (teaching)" 109 "Hospital - Level Unspecified" 110 "Mix of health care facility types" 111 "Unspecified health care facility type" 201 "Mobile clinic (van, truck, etc.)" 202 "Temporary site in community building" 203 "Camp (e.g. tents for a week)" 204 "At client residences (targeted or door-to-door)" 205 "In at-risk setting (e.g. in brothel, bar, etc.)" 301 "Community center" 302 "School" 303 "Workplace" 304 "Other Community facility (e.g. religious center)" 401 "No facility (e.g. legislation, human rights advocacy, mass media)" 501 "Other facility type - specify in comments" 502 "Facility type is not reported"
{txt}
{com}.                                         label values facility_cat facility_cat
{txt}
{com}.                                         label variable facility_cat "Narrow Facility Category"
{txt}
{com}.         
.         
.                         *Finally, can we create mid-level variables for type of facility:
.                         gen fac_type=.
{txt}(33 missing values generated)

{com}.                                 replace fac_type=1 if facility_cat==101 | facility_cat==102
{txt}(15 real changes made)

{com}.                                 replace fac_type=2 if facility_cat==103 | facility_cat==104
{txt}(4 real changes made)

{com}.                                 replace fac_type=3 if facility_cat==105 | facility_cat==107 | facility_cat==108 | facility_cat==108 | facility_cat==109
{txt}(0 real changes made)

{com}.                                 replace fac_type=4 if facility_cat==110 | facility_cat==111
{txt}(14 real changes made)

{com}.                                 replace fac_type=5 if meta_facility==2
{txt}(0 real changes made)

{com}.                                 replace fac_type=6 if meta_facility==3
{txt}(0 real changes made)

{com}.                                 replace fac_type=7 if meta_facility==4
{txt}(0 real changes made)

{com}.                                 replace fac_type=8 if meta_facility==5
{txt}(0 real changes made)

{com}.                                 label define fac_type 1 "Clinics" 2 "Integrated clinics" 3 "Hospitals" 4 "HC unspecified/other" 5 "Mobile outreach" 6 "Community-based" 7 "Population level" 8 "Other/Unspecified" 
{txt}
{com}.                                 label values fac_type fac_type
{txt}
{com}.                                         label variable fac_type "Facility Type for Analysis"
{txt}
{com}.                                 
.                         
.                         
.                         * And binaries for facility_type
.                         tab fac_type, gen(v_)

   {txt}Facility Type for {c |}
            Analysis {c |}      Freq.     Percent        Cum.
{hline 21}{c +}{hline 35}
             Clinics {c |}{res}         15       45.45       45.45
{txt}  Integrated clinics {c |}{res}          4       12.12       57.58
{txt}HC unspecified/other {c |}{res}         14       42.42      100.00
{txt}{hline 21}{c +}{hline 35}
               Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 ft_clinics
{res}{txt}
{com}.                                 rename v_2 ft_intclinics
{res}{txt}
{com}.                                 rename v_3 ft_unspecified_hc
{res}{txt}
{com}. 
.                         
.                                         // note not appropriate for other intervention types
.                                 
.                         * And binaries for faclity_category
.                         tab facility_cat, gen(v_)

               {txt}Narrow Facility Category {c |}      Freq.     Percent        Cum.
{hline 40}{c +}{hline 35}
Health Center (e.g. community health cl {c |}{res}         15       45.45       45.45
{txt}Clinic at hospital (not intervention- o {c |}{res}          1        3.03       48.48
{txt}Clinic at hospital (intervention- or di {c |}{res}          3        9.09       57.58
{txt}      Mix of health care facility types {c |}{res}          1        3.03       60.61
{txt}  Unspecified health care facility type {c |}{res}         13       39.39      100.00
{txt}{hline 40}{c +}{hline 35}
                                  Total {c |}{res}         33      100.00
{txt}
{com}.                                 rename v_1 health_center
{res}{txt}
{com}.                                 rename v_2 hosp_clinic
{res}{txt}
{com}.                                 rename v_3 hosp_clinic_disease
{res}{txt}
{com}.                                 rename v_4 mixed_healthfac
{res}{txt}
{com}.                                 rename v_5 unspecified_healthfac
{res}{txt}
{com}.                                 
.                                 ** Try adding both to the models to see how it might differ.
.         
.         * Do I need to destring or recode: id_details; id_phase; 
.         
.         
.         * Save progress
.         save temp_dta/study_attributes.dta,replace      
{txt}file temp_dta/study_attributes.dta saved

{com}.         
. 
. *************************************************************************
. * Part II
. * Above, everything from cost_data sheet is encoded and ready for merging
. * Below, we create two separate datasets for analysis
. *               1. Long DS with each row = cost input, combined with study level data
. *               2. Wide DS with each row as a study, collapsed and combined with study level data
. *************************************************************************
. 
. 
.         * II.1 - Create Long Dataset (simply load in clean study_attributes data)
.         *************************************************************************
.         
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}.                 drop ar_capital-a_uns_unspecified
{txt}
{com}.         merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               1
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}               1{txt}  (_merge==2)

{col 5}matched{col 30}{res}             108{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                 order extractor_initials-consistency_rmk
{txt}
{com}.                 order id
{txt}
{com}.                                 drop if _merge!=3
{txt}(1 observation deleted)

{com}.                                 drop _merge
{txt}
{com}.         
.                                 save final_dtas/long_file.dta, replace
{txt}file final_dtas/long_file.dta saved

{com}.                                 *This dataset may require some additional cleaning and culling for appropriate use
.                                 
.         * II.2 - Create Wide Dataset (collapse by unit_cost and add study_attributes data)
.         **********************************************************************************
.         clear
{txt}
{com}.         use temp_dta/costs.dta
{txt}
{com}. 
.         
.         * First set up the desired order of the collapsed cost variable with markers
.                         *Broad as reported costs
.                                 gen broad_asreported=.
{txt}(108 missing values generated)

{com}.                                 move broad_asreported ar_capital
{txt}
{com}.                         *Narrow as reported costs
.                                 gen narrow_asreported=.
{txt}(108 missing values generated)

{com}.                                 move narrow_asreported ar_cap_building
{txt}
{com}.                         
.                         *Broad Standardized Input costs
.                                 gen broad_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move broad_stdinput si_capital
{txt}
{com}.                         * Narrow Standardized Input costs
.                                 gen narrow_stdinput=.
{txt}(108 missing values generated)

{com}.                                 move narrow_stdinput si_cap_building_space
{txt}
{com}.                         
.                                 
.                         *Broad Activity Costs
.                                 gen broad_activity=.
{txt}(108 missing values generated)

{com}.                                 move broad_activity a_combo
{txt}
{com}.                 
.                         * Narrow Activity costs
.                                 gen narrow_activity=.
{txt}(108 missing values generated)

{com}.                                 move narrow_activity a_com_combo
{txt}
{com}.                         
.         
.                         save temp_dta/costs.dta, replace
{txt}file temp_dta/costs.dta saved

{com}. 
. 
. 
.                 * Collapse for reshape wide 
.                 * (here, in two parts,  1) collapse cost variables, and 
.                 *                                               2) remove non-total rows for all categorical variables).
.                 ************************************************************************************
. 
.                         *1. Collapse cost variables into new dataset
.                         *Need to collapse one var at a time and append to a new dataset
.                                 collapse broad_asreported, by (unit_cost)
{txt}
{com}.                                 save temp_dta/costs_temp.dta,replace
{txt}file temp_dta/costs_temp.dta saved

{com}.                                         clear
{txt}
{com}.                                         use temp_dta/costs.dta
{txt}
{com}.                                 *set trace on
.                                 foreach i of varlist ar_capital-a_uns_unspecified {c -(}
{txt}  2{com}.                                                 bysort unit_cost (`i') : gen miss = mi(`i'[1])
{txt}  3{com}.                                                 collapse (sum) `i' (min) miss, by (unit_cost)
{txt}  4{com}.                                                 replace `i'=. if miss==1
{txt}  5{com}.                                                         drop miss
{txt}  6{com}.                                                 merge 1:1 unit_cost using temp_dta/costs_temp.dta
{txt}  7{com}.                                                         drop _merge
{txt}  8{com}.                                                         save temp_dta/costs_temp.dta,replace
{txt}  9{com}.                                                                 clear
{txt} 10{com}.                                                 use temp_dta/costs.dta
{txt} 11{com}.                                                 {c )-}
{txt}(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(26 real changes made, 26 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(41 real changes made, 41 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(39 real changes made, 39 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(34 real changes made, 34 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(38 real changes made, 38 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(29 real changes made, 29 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(46 real changes made, 46 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(12 real changes made, 12 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(30 real changes made, 30 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(43 real changes made, 43 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(45 real changes made, 45 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(42 real changes made, 42 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved
(44 real changes made, 44 to missing)
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}               0
{txt}{col 5}matched{col 30}{res}              46{txt}  (_merge==3)
{col 5}{hline 41}
file temp_dta/costs_temp.dta saved

{com}.                                                 *
.                         *2. Now collapse all of the categorical variables just by total
.                                 drop ar_capital-a_uns_unspecified
{txt}
{com}.                                 keep if ar_narrow1=="full costing total" | ar_narrow1=="partial costing"
{txt}(69 observations deleted)

{com}.                                         save temp_dta/c_categoricals.dta,replace
{txt}file temp_dta/c_categoricals.dta saved

{com}.                                         merge m:1 unit_cost using temp_dta/costs_temp.dta
{res}
{txt}{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              12
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              12{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                                         drop if _merge!=3
{txt}(12 observations deleted)

{com}.                                                                         * In this case, drops 6 that we dont want anyway
.                                                         drop _merge
{txt}
{com}.                                                         
.                                 * reorder for ease of finding 
.                                 * (This could be done in a better way, problem is the above procedure reverses the order)       
.                                 order id unit_cost broad_asreported ar_broad ar_capital ar_facility ar_overhead ar_personnel ar_recurring_goods ar_recurring_services ar_subtotal  ar_vehicles ar_total /// 
>                                 ar_narrow narrow_asreported ar_cap_building ar_cap_unspecified ar_cap_vehicles ar_fac_maint_and_util ar_fac_maintenance ar_fac_rental ar_ove_unspecified ar_per_unspecified ar_recgoods_clinical_consumables ar_recgoods_consumables ar_recgoods_key_drugs ar_recgoods_unspecified ar_recservices_lab_test ar_recservices_maintenance ar_recservices_training ar_recservices_transport ar_veh_maint_and_util ar_sub_subtotal ar_tot_full_costing_total /// 
>                                 broad_stdinput si_broad si_capital si_combined si_mixed si_personnel si_recurrent ///
>                                 narrow_stdinput si_narrow si_cap_building_space si_cap_equip_non_medical_inter si_cap_medical_equip si_cap_other si_cap_vehicles si_com_unit_cost_total si_mix_mixed si_per_mixed_unspec si_per_support si_rec_building_space si_rec_key_drugs si_rec_med_int_supplies si_rec_nonmed_int_supplies si_rec_other ///
>                                 broad_activity a_combo a_mixed a_operational a_primary_sd a_unspecified ///
>                                 narrow_activity a_narrow a_com_combo a_mix_mixed a_ope_bldg_equip a_ope_mass_education a_ope_primary_sd_unspec a_ope_supervision a_ope_training a_ope_transportation a_ope_unspecified a_prisd_lab_services a_prisd_primary_sd_unspec a_uns_unspecified
{txt}
{com}.                                 
.                                 
.                                 
.                                 * First label organizational variables after resort
.                                 label variable broad_asreported "----------------------------------"
{txt}
{com}.                                 label variable narrow_asreported "----------------------------------"
{txt}
{com}.                                 label variable broad_stdinput "----------------------------------"      
{txt}
{com}.                                 label variable narrow_stdinput "----------------------------------"
{txt}
{com}.                                 label variable broad_activity "----------------------------------"
{txt}
{com}.                                 label variable narrow_activity "----------------------------------"
{txt}
{com}.                         
.                                 * Generate a Unit Cost Total "uc_total"
.                                 move mean_cost ar_broad
{txt}
{com}.                                 
.                                 * Finally merge in study_attribute dataset
.                                 merge m:1 id using temp_dta/study_attributes.dta
{res}{txt}(label rs already defined)

{col 5}Result{col 38}# of obs.
{col 5}{hline 41}
{col 5}not matched{col 30}{res}              13
{txt}{col 9}from master{col 30}{res}               0{txt}  (_merge==1)
{col 9}from using{col 30}{res}              13{txt}  (_merge==2)

{col 5}matched{col 30}{res}              39{txt}  (_merge==3)
{col 5}{hline 41}

{com}.                                         drop if _merge!=3
{txt}(13 observations deleted)

{com}.                                                 * In this case it drops the 6 sub-studies that we dont want
.                                                 drop _merge
{txt}
{com}.                         
.                         
.                         *Final cleaning and creation of organizational variables
.                         *********************************************************
.                         drop cost_record subset_of ar_narrow1 ar_broad1 si_narrow1 si_broad1 a_narrow1 a_broad1
{txt}
{com}.         
.                         
.                         * Save version before importing GDPPC data:
.                         save final_dtas/wide_file.dta, replace
{txt}file final_dtas/wide_file.dta saved

{com}.                         
.                         * Finally, import GDPPC data for each study.
.                         ********************************************
.                                 * Underlying dataset can be found at https://data.worldbank.org/indicator/NY.GDP.PCAP.CD
.                                 * Simply download EXCEL file option for ALL countries (should be default). 
.                                 * Download for this presentation was done on 25 October 2017
.                                 * File name is: API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls
.                                 * place file in path along with data extraction template
.                                 * Presumably formatting for this file shouldnt change year-to-year, but possible 
.                                 * ...so check that import and file manipulation commands below work. 
.                         
.                         save  "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta", replace
{txt}file /Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta saved

{com}. 
.                         clear
{txt}
{com}.                         
.                         /*
> 
>         *Change directory to pull in outside data
>         cd "/Users/dcameron03/Documents/Berkeley/`GSI with Jim/Stata/GHCC/"
>                         
>                         import excel "API_NY.GDP.PCAP.CD_DS2_en_excel_v2.xls", firstrow sheet("Data") cellrange(A4) case(l)
>                                                 // Years wont translate to varnames, but will be retained as labels for cols e-bi
>                                                 // Need to manually rename the Years row (4) from #### to y####
>                                                 drop countrycode-y1999
>                                 STOP            
>                         *global years y2000-y2016
>                         reshape long y, i(countryname) j(year_d)
>                         rename y gdppc
>                         rename year_d currency_yr
>                         rename countryname country_alt
>                         save VMMC/temp_dta/gdppc.dta, replace
>                         
>                         clear
>                         
>                         *Now merge in the GDPPC data you've created: 
>                         use VMMC/final_dta/wide_file.dta
>                         
>                         merge m:1 country_alt currency_yr using "VMMC/temp_dta/gdppc.dta"
>                                 drop if _merge==2
>                                 drop _merge
>                                 
>                                 
>                         move gdppc country
>                         
>                         
>                         save VMMC/final_dta/wide_file.dta, replace
> 
> * And Binaries and amounts of global fund (GFAMTB) and PEPFAR funding
>         ** For dataset for this process visit: <http://ghdx.healthdata.org/record/development-assistance-health-database-1990-2015>.
>         ** To do this you will need to maintain a string variable with the country names in the same format as the WB country names.
> 
>                         clear
>                         use external_data/IHME_DAH_DATABASE_1990_2015_Y2016M04D25.DTA
> 
>                         * Get rid of unnecessary data
>                                 drop if year<2000
>                                 drop if channel!="BIL_USA" & channel!="GFATM"
>                                 gen hiv_funding=hiv_dah_15+hiv_treat_dah_15+hiv_prev_dah_15+hiv_pmtct_dah_15+hiv_ovc_dah_15+hiv_care_dah_15+hiv_ct_dah_15+hiv_unid_dah_15+hiv_tb_dah_15+hiv_hss_dah_15
>                                 
>                                 gen pepfar=0
>                                         replace pepfar=1 if channel=="BIL_USA" & year>2002 & hiv_funding!=0
>                                         label var pepfar "Country recieved PEPFAR funding y/n"
>                                 
>                                 gen pepfar_amt=0
>                                         replace pepfar_amt=hiv_dah_15 if channel=="BIL_USA" & year>2002 
>                                         label var pepfar_amt "Amnt of PEPFAR funding 2016 USD"
>                                 
>                                 gen global_fund=0
>                                         replace global_fund=1 if dah_15!=0 & channel=="GFATM"
>                                         label var global_fund "Country recieved Global Fund funding y/n"
>                                 
>                                 gen global_fund_amt=0
>                                         replace global_fund_amt=dah_15 if channel=="GFATM"
>                                         label var global_fund_amt "Amnt of GF funding 2016 USD"
>                                 
>                                 keep year recipient_country pepfar pepfar_amt global_fund global_fund_amt
>                                 rename year currency_yr
>                                 rename recipient_country country_alt
>                                 
>                 * Inflate to 2016 dollars using the GDP Price Deflator          
>                 gen gdp_current = 111.416                               
>                                 gen gdp_old=.                           
>                                         replace gdp_old=        66.773  if currency_yr==        1990
>                                         replace gdp_old=        68.996  if currency_yr==        1991
>                                         replace gdp_old=        70.569  if currency_yr==        1992
>                                         replace gdp_old=        72.248  if currency_yr==        1993
>                                         replace gdp_old=        73.785  if currency_yr==        1994
>                                         replace gdp_old=        75.324  if currency_yr==        1995
>                                         replace gdp_old=        76.699  if currency_yr==        1996
>                                         replace gdp_old=        78.012  if currency_yr==        1997
>                                         replace gdp_old=        78.859  if currency_yr==        1998
>                                         replace gdp_old=        80.065  if currency_yr==        1999
>                                         replace gdp_old=        81.887  if currency_yr==        2000
>                                         replace gdp_old=        83.754  if currency_yr==        2001
>                                         replace gdp_old=        85.039  if currency_yr==        2002
>                                         replace gdp_old=        86.735  if currency_yr==        2003
>                                         replace gdp_old=        89.12   if currency_yr==        2004
>                                         replace gdp_old=        91.988  if currency_yr==        2005
>                                         replace gdp_old=        94.814  if currency_yr==        2006
>                                         replace gdp_old=        97.337  if currency_yr==        2007
>                                         replace gdp_old=        99.246  if currency_yr==        2008
>                                         replace gdp_old=        100             if currency_yr==        2009
>                                         replace gdp_old=        101.221 if currency_yr==        2010
>                                         replace gdp_old=        103.311 if currency_yr==        2011
>                                         replace gdp_old=        105.214 if currency_yr==        2012
>                                         replace gdp_old=        106.913 if currency_yr==        2013
>                                         replace gdp_old=        108.832 if currency_yr==        2014
>                                         replace gdp_old=        110.012 if currency_yr==        2015
>                                                                 
>                                         replace global_fund_amt=global_fund_amt*(gdp_current/gdp_old)           
>                                         replace pepfar_amt=pepfar_amt*(gdp_current/gdp_old)     
>                                                 drop gdp_current gdp_old
>                                 collapse (sum) pepfar_amt global_fund_amt (max) pepfar global_fund, by(country_alt currency_yr)
>                                 
>                                 save VMMC/temp_dta/pepfar_gf_data.dta, replace
>                                 clear
>                                 use VMMC/final_dta/wide_file.dta
>                                 
>                                 merge m:1 country_alt currency_yr using "VMMC/temp_dta/pepfar_gf_data.dta"
>                                         drop if _merge==2
>                                         * There are problems here because missing data for South Africa (2014) and Zimbabwe (2014, 2015)
>                                         * Will need to check for other missing values by looking at data that didnt merge from master. 
>                                                 *Based on patterns, I assume:
>                                                 replace pepfar=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="Zimbabwe" & currency_yr>2013
>                                                 replace pepfar=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 replace global_fund=1 if country_alt=="South Africa" & currency_yr>2013
>                                                 drop _merge
>                                                 drop country_alt
>                                                 
>                         save VMMC/final_dta/wide_file.dta, replace                                              
> 
>         STOP
>                         
>         *** Finally, also add in the line that saves a copy of ART to the GitHub folder for Lily to see it                      
>         cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
>         save VMMC_wide_file.dta, replace                
>                                 
>                                 
>                                 
> ** STOP HERE                    
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>                         
>         

{txt}end of do-file

{com}. use "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files/STI_wide_file_Mar2018.dta"

. br

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. **************************************************************************
. **************************************************************************
. **************************************************************************
. ** Do file for export of STI studies to the UCSR, using select variables
. ** Lily Alexander
. ** University of Washington
. ** March 2018 
. ** lilyalexander18@gmail.com
. **************************************************************************
. **************************************************************************
. **************************************************************************
. 
. ** Data requirements
. **
. **  Must use data already formatted into wide file for GHCC analysis
. **              - These are available upon request
. **              - Procedure to be replicated for other intervention areas (ART, etc)
. **              - As well as other diseases (TB)
. **************************************************************************
. 
. set more off 
{txt}
{com}.         clear
{txt}
{com}.         *Drew's Path:
.         //cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
.         //use VMMC_wide_file.dta, replace       
.         
.         
.         *Lily's Path:
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files
{txt}
{com}.         use STI_wide_file_Mar2018.dta, replace
{txt}
{com}. 
. 
. **********************************              
. ** Cross-validation of costs **
. **********************************
.         
.         * 1. Check that broad standard input categories sum to mean cost 
.         ****************************************************************
.         egen check = rowtotal(si_recurrent si_personnel si_capital)
{txt}
{com}. 
{txt}end of do-file

{com}. br si*

. do "/var/folders/0y/5bmlgxmx39v_fqw0vs5vrp680000gn/T//SD00246.000000"
{txt}
{com}. **************************************************************************
. **************************************************************************
. **************************************************************************
. ** Do file for export of STI studies to the UCSR, using select variables
. ** Lily Alexander
. ** University of Washington
. ** March 2018 
. ** lilyalexander18@gmail.com
. **************************************************************************
. **************************************************************************
. **************************************************************************
. 
. ** Data requirements
. **
. **  Must use data already formatted into wide file for GHCC analysis
. **              - These are available upon request
. **              - Procedure to be replicated for other intervention areas (ART, etc)
. **              - As well as other diseases (TB)
. **************************************************************************
. 
. set more off 
{txt}
{com}.         clear
{txt}
{com}.         *Drew's Path:
.         //cd "/Users/dcameron03/Documents/GitHub/Post-Extraction-Processing/VMMC/"
.         //use VMMC_wide_file.dta, replace       
.         
.         
.         *Lily's Path:
.         cd "/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files"
{res}/Users/lilyalexander/Dropbox/ALL LIFE THINGS/INSP/Work with Sergio/GHCC/Post-Extraction-Processing/STI/wide_files
{txt}
{com}.         use STI_wide_file_Mar2018.dta, replace
{txt}
{com}. 
. 
. **********************************              
. ** Cross-validation of costs **
. **********************************
.         
.         * 1. Check that broad standard input categories sum to mean cost 
.         ****************************************************************
.         egen check = rowtotal(si_capital si_mixed si_personnel si_recurrent)
{txt}
{com}.         replace check = si_combined if check == 0
{txt}(31 real changes made)

{com}.         gen diff = check - mean_cost
{txt}
{com}.         gen flag = 1 if diff > 0.1
{txt}(29 missing values generated)

{com}.         
.         count if flag == 1
  {res}10
{txt}
{com}.         di in red `r(N)'
{res}{err}10
{txt}
{com}. 
{txt}end of do-file

{com}. br if flag == 1 

. br check flag

. br check mean_cost flag

. br check mean_cost flag if flag == 1 

. br check mean_cost flag si_* if flag == 1 

. br unit* check mean_cost flag si_* if flag == 1 

. br unit* check mean_cost  diff flag si_* if flag == 1 

. br unit* check mean_cost  diff flag si_* if flag == 1 

. 